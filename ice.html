<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skopos</title>
    
    <!-- iOS PWA æ”¯æ´ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Skopos">
    <meta name="apple-touch-fullscreen" content="yes">
    
    <!-- PWA ç›¸é—œ -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192x192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- è¼‰å…¥ç™‚ç™’åŠŸèƒ½è¨­å®šæª” -->
    <script src="healing-config.js"></script>
    
    <!-- è¼‰å…¥ API é…ç½®æª” -->
    <script>
        // è¼‰å…¥ API é…ç½®
        let apiConfig = null;
        
        async function loadApiConfig() {
            try {
                const response = await fetch('./api-config.json');
                if (response.ok) {
                    apiConfig = await response.json();
                    return apiConfig;
                } else {
                    return getDefaultConfig();
                }
            } catch (error) {
                return getDefaultConfig();
            }
        }
        
        function getDefaultConfig() {
            return {
                apiConfig: {
                    defaultApiKey: "",
                    endpoints: {
                        vercel: [
                            "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=",
                            "https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key="
                        ],
                        local: [
                            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=",
                            "https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key="
                        ]
                    },
                    testEndpoints: [
                        "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key="
                    ]
                },
                settings: {
                    dailyFreeLimit: 50,
                    usageWarningThreshold: 40,
                    maxRetries: 2,
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 1000
                    }
                }
            };
        }
    </script>
    
    <style>
        :root {
            --bg-primary: #131314;
            --bg-secondary: #1e1f20;
            --bg-tertiary: #2a2b2c;
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --border-color: #3c4043;
            --accent-blue: #8ab4f8;
            --gemini-gradient: linear-gradient(135deg, #4285f4, #ea4335, #fbbc04, #34a853);
            --mini-sidebar-width: 56px; /* æ¡Œé¢æ”¶åˆæ™‚çš„å°å´æ¬„å¯¬åº¦ï¼ˆåŠ å¯¬ä»¥å…éçª„ï¼‰ */
        }

        /* å®‰è£æç¤ºå‹•ç•« */
        @keyframes install-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes install-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        @keyframes install-bounce {
            0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
            40%, 43% { transform: translate3d(0,-30px,0); }
            70% { transform: translate3d(0,-15px,0); }
            90% { transform: translate3d(0,-4px,0); }
        }

        @keyframes install-slide-in {
            0% { transform: translateY(-100%); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        @keyframes install-celebration {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(180deg); opacity: 1; }
            100% { transform: scale(1) rotate(360deg); opacity: 1; }
        }

        .install-pulse {
            animation: install-pulse 2s infinite;
        }

        .install-shake {
            animation: install-shake 0.5s ease-in-out;
        }

        .install-bounce {
            animation: install-bounce 1s ease-in-out;
        }

        .install-slide-in {
            animation: install-slide-in 0.5s ease-out;
        }

        .install-celebration {
            animation: install-celebration 0.8s ease-out;
        }

        /* æ™ºèƒ½å®‰è£æç¤ºæ¨£å¼ */
        #ios-install-banner {
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        #ios-install-banner:hover {
            transform: translateY(0) scale(1.02);
            transition: all 0.3s ease;
        }

        #ios-install-btn {
            position: relative;
            overflow: hidden;
        }

        #ios-install-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        #ios-install-btn:hover::before {
            left: 100%;
        }

        /* å®‰è£æˆåŠŸæ…¶ç¥å‹•ç•«å®¹å™¨ */
        .celebration-container {
            animation: install-celebration 0.8s ease-out;
        }

        /* éŸ¿æ‡‰å¼å®‰è£æç¤º */
        @media (max-width: 640px) {
            #ios-install-banner {
                padding: 0.75rem;
            }
            
            #ios-install-banner .flex {
                flex-direction: column;
                gap: 0.75rem;
                text-align: center;
            }
            
            #ios-install-banner .flex > div:first-child {
                order: 2;
            }
            
            #ios-install-banner .flex > div:last-child {
                order: 1;
            }
        }

        body {
            font-family: 'Google Sans', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        .gemini-container {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
        }
        .chat-header {
            border-bottom: 1px solid var(--border-color);
        }
        .chat-message {
            margin-bottom: 16px;
            display: flex;
            width: 100%;
        }
        .ai-message {
            justify-content: flex-start;
        }
        .user-message {
            justify-content: flex-end;
        }
        .ai-message .message-content {
            background-color: var(--bg-tertiary);
            border-bottom-left-radius: 4px;
        }
        .user-message .message-content {
            background-color: var(--accent-blue);
            color: var(--bg-primary);
            border-bottom-right-radius: 4px;
        }
        .message-content {
            padding: 12px 16px;
            border-radius: 18px;
            display: inline-block;
            max-width: 70%;
            word-wrap: break-word;
        }
        .input-area {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 24px;
        }
        .message-input {
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            width: 100%;
        }
        .send-button {
            background-color: var(--accent-blue);
            color: var(--bg-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            /* ç¢ºä¿æ‰‹æ©Ÿç‰ˆ SVG åœ–æ¨™æ­£å¸¸é¡¯ç¤º */
            min-width: 40px;
            min-height: 40px;
            flex-shrink: 0;
        }
        .send-button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }
        .thinking-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            justify-content: flex-start;
        }
        .thinking-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-blue);
            border-radius: 50%;
            animation: thinking-pulse 1.4s ease-in-out infinite both;
        }
        .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes thinking-pulse {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        .phase-indicator {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            color: var(--text-secondary);
            display: inline-block;
            margin-bottom: 16px;
        }
        .retry-button {
            transition: all 0.2s ease;
        }
        .retry-button:hover {
            background-color: var(--text-primary) !important;
            transform: scale(1.1);
        }
        /* æ¡Œé¢ç‰ˆï¼šå´æ¬„æ”¶åˆç‹€æ…‹æ¨£å¼ */
        @media (min-width: 768px) {
            .sidebar-collapsed .app {
                grid-template-columns: var(--mini-sidebar-width) 1fr !important;
            }
            .sidebar-collapsed #sidebar {
                width: var(--mini-sidebar-width) !important;
                min-width: var(--mini-sidebar-width) !important;
                max-width: var(--mini-sidebar-width) !important;
                overflow: hidden !important;
            }
            /* æ”¶åˆèˆ‡å±•é–‹æ¨¡å¼ä¸‹é¡¯ç¤º/éš±è—ä¸åŒå…§å®¹ */
            #sidebar .collapsed-only { display: none; }
            .sidebar-collapsed #sidebar .collapsed-only { display: flex; }
            .sidebar-collapsed #sidebar .expanded-only { display: none; }
        }
        
        /* ç”¨æˆ¶é ­åƒå’Œå€‹äººè³‡æ–™æ¨£å¼ */
        .user-avatar-container {
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            width: 100%;
        }
        
        .user-avatar-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #4a5568;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .user-avatar-text {
            color: white;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .user-profile-info {
            flex: 1;
            text-align: center;
            width: 100%;
        }
        
        .user-name {
            color: white;
            font-size: 16px;
            font-weight: 500;
            /* ç¢ºä¿æ–‡å­—æ²’æœ‰èƒŒæ™¯ */
            background: transparent;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        /* æ‰‹æ©Ÿç‰ˆï¼šå„ªåŒ–ä½ˆå±€å’Œé–“è· */
        @media (max-width: 767px) {
            .input-area {
                gap: 8px;
            }
            .send-button svg {
                width: 20px;
                height: 20px;
            }
            .chat-header h1 {
                margin-left: 4rem;
            }
            
            /* æ‰‹æ©Ÿç‰ˆç”¨æˆ¶é ­åƒå„ªåŒ– */
            .user-avatar-circle {
                width: 40px;
                height: 40px;
            }
            
            .user-avatar-text {
                font-size: 18px;
            }
            
            .user-name {
                font-size: 14px;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="app md:grid md:grid-cols-[auto_1fr] md:h-screen md:gap-0">

    <!-- ===== å´é‚Šæ¬„ç³»çµ± ===== -->
    <!-- 
    å´é‚Šæ¬„ä½ç½®èªªæ˜ï¼š
    - åˆ‡æ›æŒ‰éˆ•ï¼šå›ºå®šåœ¨å·¦ä¸Šè§’ (top-4 left-4)ï¼Œz-index: 50 ç¢ºä¿åœ¨æœ€ä¸Šå±¤
    - å´é‚Šæ¬„é¢æ¿ï¼šå›ºå®šåœ¨å·¦å´ (top-0 left-0)ï¼Œå¯¬åº¦ 320px (w-80)ï¼Œåˆå§‹ä½ç½®åœ¨è¢å¹•å¤– (-translate-x-full)
    - é®ç½©å±¤ï¼šè¦†è“‹æ•´å€‹è¢å¹• (inset-0)ï¼Œz-index: 30 ä½æ–¼å´é‚Šæ¬„ä½†é«˜æ–¼å…¶ä»–å…§å®¹
    - å´é‚Šæ¬„ z-index: 40ï¼Œç¢ºä¿åœ¨é®ç½©å±¤ä¹‹ä¸Šä½†åœ¨åˆ‡æ›æŒ‰éˆ•ä¹‹ä¸‹
    -->
    
    <!-- å´é‚Šæ¬„åˆ‡æ›æŒ‰éˆ• - å›ºå®šåœ¨å·¦ä¸Šè§’ä½ç½® -->
    <div class="fixed top-4 left-4 z-50 md:hidden">
        <button id="sidebar-toggle" class="text-gray-400 hover:text-white p-2 rounded-lg hover:bg-gray-700 bg-gray-800 border border-gray-600" title="è¨­å®šé¸å–®">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="4" y="6" width="16" height="2" rx="1" fill="currentColor"/>
                <rect x="4" y="11" width="16" height="2" rx="1" fill="currentColor"/>
                <rect x="4" y="16" width="16" height="2" rx="1" fill="currentColor"/>
            </svg>
        </button>
    </div>

    <!-- å´é‚Šæ¬„è¨­å®šé¢æ¿ - å·¦å´æ»‘å‹•å¼é¢æ¿ -->
    <div id="sidebar" class="fixed top-0 left-0 h-full w-80 bg-gray-800 border-r border-gray-600 transform -translate-x-full transition-all duration-300 ease-in-out z-40 md:static md:h-auto md:min-h-screen md:translate-x-0 md:transform-none md:resize-x md:overflow-auto md:min-w-[240px] md:max-w-[480px]">
        <div class="p-4 h-full flex flex-col">
            <!-- å´é‚Šæ¬„æ¨™é¡Œå€åŸŸ -->
            <div class="flex items-center gap-2 mb-6 expanded-only">
                <!-- æ¡Œé¢ç‰ˆï¼šå´æ¬„å·¦ä¸Šè§’æ”¶åˆæŒ‰éˆ•ï¼ˆä¸‰æ¢æ©«ç·šï¼‰ -->
                <button id="sidebar-collapse-btn" class="hidden md:inline-flex items-center justify-center w-8 h-8 rounded-lg border border-gray-600 text-gray-300 hover:bg-gray-700 md:-ml-1" title="æ”¶åˆå´æ¬„">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                        <rect x="4" y="6" width="16" height="2" rx="1" fill="currentColor"/>
                        <rect x="4" y="11" width="16" height="2" rx="1" fill="currentColor"/>
                        <rect x="4" y="16" width="16" height="2" rx="1" fill="currentColor"/>
                    </svg>
                </button>
                <h2 class="text-lg font-medium text-white"></h2>
            </div>
            
            <!-- ç”¨æˆ¶å€‹äººè³‡æ–™å€åŸŸ -->
            <div class="flex flex-col items-center gap-3 mb-6 expanded-only">
                <div class="user-avatar-container">
                    <div class="user-avatar-circle">
                        <span class="user-avatar-text">S</span>
                    </div>
                </div>
                <div class="user-profile-info text-center">
                    <div class="user-name">shiro Yama</div>
                </div>
            </div>
            <!-- æ”¶åˆæ™‚ï¼šåƒ…é¡¯ç¤ºçª„æ¢èˆ‡å±•é–‹æŒ‰éˆ•ç½®é ‚ç½®ä¸­ -->
            <div class="collapsed-only md:flex-col md:items-start md:justify-start md:pt-2 md:gap-2">
                <button id="desktop-expand-btn-mini" class="hidden md:inline-flex items-center justify-center w-8 h-8 rounded-lg border border-gray-600 text-gray-300 hover:bg-gray-700 bg-gray-800 transition-all duration-200 active:scale-95 focus:outline-none focus:ring-2 focus:ring-blue-400/50 md:ml-1" title="å±•é–‹å´æ¬„">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                        <rect x="4" y="6" width="16" height="2" rx="1" fill="currentColor"/>
                        <rect x="4" y="11" width="16" height="2" rx="1" fill="currentColor"/>
                        <rect x="4" y="16" width="16" height="2" rx="1" fill="currentColor"/>
                    </svg>
                </button>
            </div>
            
            <!-- è¨­å®šé¸å–®é …ç›®å€åŸŸ -->
            <div class="flex-1 space-y-2 mt-8 expanded-only">
                <button onclick="openApiKeyGuide()" class="w-full text-left px-4 py-3 text-sm text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors" title="ç”³è«‹ Google Gemini API é‡‘é‘°">
                    <div class="flex items-center space-x-3">
                        <span class="text-lg">ğŸ”‘</span>
                        <div>
                            <div class="font-medium">ç”³è«‹ API</div>
                            <div class="text-xs text-gray-500">ç”³è«‹ Google Gemini API é‡‘é‘°</div>
                        </div>
                    </div>
                </button>
                
                <button onclick="showApiConfig()" class="w-full text-left px-4 py-3 text-sm text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors" title="è¨­å®š API é‡‘é‘°">
                    <div class="flex items-center space-x-3">
                        <span class="text-lg">âš™ï¸</span>
                        <div>
                            <div class="font-medium">API è¨­å®š</div>
                            <div class="text-xs text-gray-500">è¨­å®šå’Œç®¡ç† API é‡‘é‘°</div>
                        </div>
                    </div>
                </button>
                
                <button onclick="showConversationHistory()" class="w-full text-left px-4 py-3 text-sm text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors" title="æŸ¥çœ‹éå¾€å°è©±">
                    <div class="flex items-center space-x-3">
                        <span class="text-lg">ğŸ“</span>
                        <div>
                            <div class="font-medium">å°è©±è¨˜éŒ„</div>
                            <div class="text-xs text-gray-500">æŸ¥çœ‹éå¾€çš„å°è©±å…§å®¹</div>
                        </div>
                    </div>
                </button>
                

            </div>
            
            <!-- åº•éƒ¨è³‡è¨Šå€åŸŸ -->
            <div class="mt-auto pt-4 border-t border-gray-600 expanded-only">
                <div class="text-xs text-gray-500 text-center">
                    SKOPOS ç™‚ç™’ç³»çµ±
                </div>
            </div>
        </div>
    </div>

            <!-- é®ç½©å±¤ - èƒŒæ™¯è®Šæš—æ•ˆæœï¼Œé»æ“Šå¯é—œé–‰å´é‚Šæ¬„ -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

        <!-- ç§»é™¤å›ºå®šå±•é–‹æŒ‰éˆ•ï¼Œæ”¹ç‚ºè¿·ä½ å´æ¬„å…§çš„æŒ‰éˆ• -->

    <!-- å°è©±è¨˜éŒ„å½ˆå‡ºè¦–çª— -->
    <div id="conversation-history-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-gray-800 border border-gray-600 rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] flex flex-col">
                <!-- æ¨™é¡Œæ¬„ -->
                <div class="flex justify-between items-center p-6 border-b border-gray-600">
                    <h2 class="text-xl font-semibold text-white">å°è©±è¨˜éŒ„</h2>
                    <button onclick="closeConversationHistory()" class="text-gray-400 hover:text-white p-2 rounded-lg hover:bg-gray-700">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
                
                <!-- å…§å®¹å€åŸŸ -->
                <div class="flex-1 overflow-y-auto p-6">
                    <div id="conversation-history-content" class="space-y-4">
                        <!-- å°è©±è¨˜éŒ„å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-3xl mx-auto md:max-w-none md:mx-0 gemini-container relative z-30 md:h-full md:flex md:flex-col md:min-h-0">
        <!-- Header -->
        <div class="chat-header p-4 flex justify-between items-center">
            <h1 class="text-xl font-medium md:ml-12 ml-16">SKOPOS</h1>
        </div>

        <!-- Phase Indicator -->
        <div id="phase-indicator" class="p-4">
            <div class="flex justify-between items-center">
                <div class="phase-indicator">
                    ç›®å‰éšæ®µï¼š<span id="current-phase">åˆå§‹æ¢ç´¢</span>
                </div>
                <div id="usage-indicator" class="phase-indicator">
                    ä»Šæ—¥ä½¿ç”¨ï¼š<span id="usage-count">0</span>/<span id="usage-limit">50</span> æ¬¡
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div id="chat-box" class="p-6 h-[60vh] overflow-y-auto md:h-auto md:flex-1 md:overflow-y-auto">
            <!-- Initial AI Message -->
            <div class="chat-message ai-message">
                <div class="message-content" id="initial-message">
                    <p class="mt-2" id="user-greeting-message">æœ€è¿‘æœ‰ä»€éº¼è®“æ‚¨æ„Ÿåˆ°å›°æ“¾çš„äº‹ä»¶æˆ–è¡Œç‚ºå—ï¼Ÿ</p>
                </div>
            </div>
             <!-- Thinking Indicator -->
            <div id="thinking-indicator" class="chat-message ai-message hidden">
                <div class="message-content thinking-indicator">
                    <span>æ­£åœ¨æ€è€ƒ...</span>
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 md:shrink-0">
            <div class="input-area p-2 flex items-center gap-2">
                <button id="new-chat-btn" onclick="startNewChat()" class="text-gray-400 hover:text-white p-2 rounded-lg hover:bg-gray-700 transition-colors" title="é–‹å§‹æ–°å°è©±">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <input type="text" id="user-input" class="message-input px-3" placeholder="è¼¸å…¥æ‚¨çš„è¨Šæ¯...">
                <button id="send-btn" onclick="sendMessage()" class="send-button" title="å‚³é€è¨Šæ¯">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 2L11 13"/>
                        <path d="M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    </div>

    <script>
        // === åŸºæœ¬è®Šæ•¸è¨­å®š ===
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const thinkingIndicator = document.getElementById('thinking-indicator');

        // API è¨­å®šå’Œé¡åº¦ç®¡ç†
        let apiKey = localStorage.getItem('gemini_api_key') || '';
        let useCustomApiKey = localStorage.getItem('use_custom_api_key') === 'true';
        let currentKeyIndex = 0;
        let dailyUsageCount = 0;
        let lastUsageDate = '';
        
        // å‹•æ…‹è¨­å®šå€¼ï¼ˆå¾é…ç½®æª”è¼‰å…¥ï¼‰
        let DAILY_FREE_LIMIT = 50;
        let USAGE_WARNING_THRESHOLD = 40;
        let MAX_RETRIES = 2;
        
        // ç²å–ç•¶å‰ä½¿ç”¨çš„ API é‡‘é‘°
        function getCurrentApiKey() {
            if (useCustomApiKey && apiKey && apiKey.length >= 20) {
                return apiKey; // ä½¿ç”¨ç”¨æˆ¶è‡ªå®šç¾©é‡‘é‘°
            } else if (apiConfig && apiConfig.apiConfig.defaultApiKey) {
                return apiConfig.apiConfig.defaultApiKey; // ä½¿ç”¨é è¨­é‡‘é‘°
            } else {
                return ''; // ç„¡å¯ç”¨é‡‘é‘°
            }
        }
        
        // æª¢æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„ API é‡‘é‘°
        function hasValidApiKey() {
            const currentKey = getCurrentApiKey();
            return currentKey && currentKey.length >= 20;
        }

        // è¼‰å…¥ä»Šæ—¥ä½¿ç”¨é‡
        function loadDailyUsage() {
            const today = new Date().toDateString();
            const savedDate = localStorage.getItem('api_usage_date');
            const savedCount = parseInt(localStorage.getItem('api_usage_count') || '0');
            
            if (savedDate === today) {
                dailyUsageCount = savedCount;
                lastUsageDate = today;
            } else {
                // æ–°çš„ä¸€å¤©ï¼Œé‡ç½®è¨ˆæ•¸
                dailyUsageCount = 0;
                lastUsageDate = today;
                localStorage.setItem('api_usage_date', today);
                localStorage.setItem('api_usage_count', '0');
            }
        }

        // å¢åŠ ä½¿ç”¨è¨ˆæ•¸
        function incrementUsage() {
            dailyUsageCount++;
            localStorage.setItem('api_usage_count', dailyUsageCount.toString());
            updateUsageDisplay(); // æ›´æ–°é¡¯ç¤º
        }

        // æª¢æŸ¥æ˜¯å¦è¶…éé¡åº¦
        function checkUsageLimit() {
            return dailyUsageCount >= DAILY_FREE_LIMIT;
        }

        // æª¢æŸ¥æ˜¯å¦æ¥è¿‘é¡åº¦è­¦å‘Šç·š
        function checkUsageWarning() {
            return dailyUsageCount >= USAGE_WARNING_THRESHOLD;
        }

        // æª¢æŸ¥åœ°å€æ”¯æ´å’Œæœå‹™å¯ç”¨æ€§
        async function checkRegionSupport() {
            try {
                const testEndpoints = [
                    'https://generativelanguage.googleapis.com/v1beta/models',
                    'https://generativelanguage.googleapis.com/v1/models'
                ];
                
                const results = [];
                
                for (const endpoint of testEndpoints) {
                    try {
                        const startTime = Date.now();
                        const response = await fetch(endpoint, { 
                            method: 'GET',
                            headers: {
                                'User-Agent': 'Mozilla/5.0'
                            }
                        });
                        const responseTime = Date.now() - startTime;
                        
                        results.push({
                            endpoint: endpoint,
                            status: response.status,
                            responseTime: responseTime,
                            accessible: response.status !== 404 && response.status !== 403
                        });
                        
                        if (response.status !== 404 && response.status !== 403) {
                            return { 
                                supported: true, 
                                endpoint: endpoint,
                                responseTime: responseTime,
                                allResults: results
                            };
                        }
                    } catch (error) {
                        results.push({
                            endpoint: endpoint,
                            status: 'error',
                            error: error.message,
                            accessible: false
                        });
                        continue;
                    }
                }
                
                // ç²å–ç”¨æˆ¶çš„å¤§æ¦‚åœ°ç†ä½ç½®ä¿¡æ¯ï¼ˆåŸºæ–¼æ™‚å€ï¼‰
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const location = getLocationFromTimezone(timezone);
                
                return { 
                    supported: false, 
                    endpoint: null,
                    location: location,
                    timezone: timezone,
                    allResults: results,
                    suggestion: getSuggestionForLocation(location)
                };
            } catch (error) {
                return { 
                    supported: false, 
                    endpoint: null, 
                    error: error.message,
                    suggestion: 'å»ºè­°ä½¿ç”¨ VPN é€£æ¥åˆ°ç¾åœ‹æˆ–æ­æ´²åœ°å€'
                };
            }
        }

        // æ ¹æ“šæ™‚å€æ¨æ¸¬å¤§æ¦‚ä½ç½®
        function getLocationFromTimezone(timezone) {
            if (timezone.includes('Asia/Shanghai') || timezone.includes('Asia/Beijing')) {
                return 'ä¸­åœ‹å¤§é™¸';
            } else if (timezone.includes('Asia/Taipei')) {
                return 'å°ç£';
            } else if (timezone.includes('Asia/Hong_Kong')) {
                return 'é¦™æ¸¯';
            } else if (timezone.includes('Asia/')) {
                return 'äºæ´²åœ°å€';
            } else if (timezone.includes('Europe/')) {
                return 'æ­æ´²åœ°å€';
            } else if (timezone.includes('America/')) {
                return 'ç¾æ´²åœ°å€';
            } else {
                return 'æœªçŸ¥åœ°å€';
            }
        }

        // æ ¹æ“šä½ç½®æä¾›å»ºè­°
        function getSuggestionForLocation(location) {
            if (location === 'ä¸­åœ‹å¤§é™¸') {
                return 'å»ºè­°ä½¿ç”¨ç©©å®šçš„ VPN é€£æ¥åˆ°ç¾åœ‹æˆ–æ­æ´²ç¯€é»ï¼Œç¢ºä¿ Google æœå‹™å¯æ­£å¸¸è¨ªå•';
            } else if (location === 'å°ç£' || location === 'é¦™æ¸¯') {
                return 'æ‚¨çš„åœ°å€é€šå¸¸æ”¯æ´ Gemini APIï¼Œå¦‚æœ‰å•é¡Œå¯èƒ½æ˜¯æš«æ™‚æ€§çš„ç¶²è·¯å•é¡Œ';
            } else if (location === 'äºæ´²åœ°å€') {
                return 'éƒ¨åˆ†äºæ´²åœ°å€å¯èƒ½éœ€è¦ VPNï¼Œå»ºè­°å˜—è©¦é€£æ¥åˆ°æ”¯æ´çš„åœ°å€';
            } else {
                return 'å¦‚æœé‡åˆ° 404 éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œé‡è©¦';
            }
        }

        // ç”Ÿæˆè©³ç´°çš„è¨ºæ–·å ±å‘Š
        async function generateDiagnosticReport(errorMessage) {
            const now = new Date();
            const timestamp = now.toLocaleString('zh-TW');
            
            try {
                // æª¢æŸ¥åœ°å€æ”¯æ´
                const regionResult = await checkRegionSupport();
                
                let report = `\nğŸ“‹ è¨ºæ–·å ±å‘Š (${timestamp})\n`;
                report += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                
                // åŸºæœ¬ä¿¡æ¯
                report += `ğŸŒ åœ°å€ä¿¡æ¯:\n`;
                report += `   ä½ç½®: ${regionResult.location || 'æœªçŸ¥'}\n`;
                report += `   æ™‚å€: ${regionResult.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone}\n`;
                report += `   åœ°å€æ”¯æ´: ${regionResult.supported ? 'âœ… æ˜¯' : 'âŒ å¦'}\n\n`;
                
                // API ç«¯é»æ¸¬è©¦çµæœ
                if (regionResult.allResults && regionResult.allResults.length > 0) {
                    report += `ğŸ“¡ API ç«¯é»æ¸¬è©¦çµæœ:\n`;
                    regionResult.allResults.forEach((result, index) => {
                        const status = result.accessible ? 'âœ…' : 'âŒ';
                        report += `   ${index + 1}. ${result.endpoint.split('/')[4]}: ${status} (${result.status})\n`;
                    });
                    report += `\n`;
                }
                
                // å»ºè­°è§£æ±ºæ–¹æ¡ˆ
                report += `ğŸ’¡ å»ºè­°è§£æ±ºæ–¹æ¡ˆ:\n`;
                if (regionResult.suggestion) {
                    report += `   â€¢ ${regionResult.suggestion}\n`;
                }
                
                if (errorMessage && errorMessage.includes('404')) {
                    report += `   â€¢ æ­¤ç‚º API ç«¯é»ä¸å¯ç”¨éŒ¯èª¤ï¼Œé€šå¸¸æ˜¯åœ°å€é™åˆ¶\n`;
                    report += `   â€¢ å˜—è©¦ä½¿ç”¨ VPN é€£æ¥åˆ°ç¾åœ‹æˆ–æ­æ´²ç¯€é»\n`;
                    report += `   â€¢ ç¢ºèª Google AI Studio å¯æ­£å¸¸è¨ªå•\n`;
                    report += `   â€¢ ç­‰å¾… 10-15 åˆ†é˜å¾Œé‡è©¦\n`;
                }
                
                report += `   â€¢ æª¢æŸ¥æœå‹™ç‹€æ…‹: https://status.cloud.google.com/\n`;
                report += `   â€¢ ç¢ºèª API é‡‘é‘°æœ‰æ•ˆæ€§\n\n`;
                
                // æŠ€è¡“è©³æƒ…
                report += `ğŸ”§ æŠ€è¡“è©³æƒ…:\n`;
                report += `   ç”¨æˆ¶ä»£ç†: Mozilla/5.0\n`;
                report += `   è«‹æ±‚æ™‚é–“: ${timestamp}\n`;
                if (regionResult.responseTime) {
                    report += `   éŸ¿æ‡‰æ™‚é–“: ${regionResult.responseTime}ms\n`;
                }
                
                return report;
                
            } catch (diagError) {
                return `\nâš ï¸ è¨ºæ–·ä¿¡æ¯æ”¶é›†å¤±æ•—: ${diagError.message}\nå»ºè­°æ‰‹å‹•æª¢æŸ¥ç¶²è·¯é€£ç·šå’Œ VPN è¨­å®šã€‚`;
            }
        }

        // ç™‚ç™’ç³»çµ±è®Šæ•¸ï¼ˆé è¨­å•Ÿç”¨ï¼‰
        let healingPhase = 'initial';
        let conversationHistory = [];
        let healingModeEnabled = true;

        // === æ ¸å¿ƒç™¼é€è¨Šæ¯åŠŸèƒ½ ===
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            if (!hasValidApiKey()) {
                alert('ğŸ”‘ è«‹å…ˆè¨­å®šæ‚¨çš„ Google Gemini API é‡‘é‘°ï¼\n\nğŸ“‹ å¿«é€Ÿé–‹å§‹ï¼š\n1. é»æ“Šå³ä¸Šè§’ã€ŒğŸ”‘ ç”³è«‹ APIã€æŸ¥çœ‹ç”³è«‹æŒ‡å—\n2. å–å¾—é‡‘é‘°å¾Œé»æ“Šã€Œâš™ï¸ API è¨­å®šã€é€²è¡Œè¨­å®š');
                showApiConfig();
                return;
            }

            // æª¢æŸ¥æ¯æ—¥ä½¿ç”¨é¡åº¦
            if (checkUsageLimit()) {
                alert('â° ä»Šæ—¥å…è²»é¡åº¦å·²ç”¨å®Œï¼\n\næ‚¨ä»Šå¤©å·²ä½¿ç”¨äº† ' + dailyUsageCount + ' æ¬¡å…è²»é¡åº¦ã€‚\nè«‹æ˜å¤©å†ä¾†ä½¿ç”¨ï¼Œæˆ–è€ƒæ…®å‡ç´šåˆ°ä»˜è²»ç‰ˆæœ¬ã€‚\n\nğŸ’¡ å…è²»é¡åº¦å°‡åœ¨æ˜æ—¥ 00:00 é‡ç½®ã€‚');
                return;
            }

            // è­¦å‘Šå³å°‡é”åˆ°é¡åº¦é™åˆ¶
            if (checkUsageWarning() && dailyUsageCount < DAILY_FREE_LIMIT) {
                const remaining = DAILY_FREE_LIMIT - dailyUsageCount;
                const shouldContinue = confirm(`âš ï¸ é¡åº¦è­¦å‘Šï¼\n\næ‚¨ä»Šå¤©é‚„å‰© ${remaining} æ¬¡å…è²»ä½¿ç”¨æ©Ÿæœƒã€‚\næ˜¯å¦è¦ç¹¼çºŒä½¿ç”¨ï¼Ÿ\n\nğŸ’¡ å»ºè­°çæƒœå‰©é¤˜é¡åº¦ï¼Œæ˜æ—¥å°‡è‡ªå‹•é‡ç½®ã€‚`);
                if (!shouldContinue) {
                    return;
                }
            }

            toggleInput(false);
            addMessageToChat('user', message, false);
            userInput.value = '';
            showThinking(true);

            // è¨˜éŒ„å°è©±æ­·å²
            conversationHistory.push({
                sender: 'user',
                message: message,
                timestamp: new Date(),
                phase: healingPhase
            });

            try {
                // æª¢æ¸¬éƒ¨ç½²ç’°å¢ƒ
                const isVercel = window.location.hostname.includes('vercel.app');
                const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                
                // ç²å–ç•¶å‰ API é‡‘é‘°
                const currentApiKey = getCurrentApiKey();
                
                // å¾é…ç½®æª”ç²å–ç«¯é»é…ç½®
                let endpoints;
                if (apiConfig && apiConfig.apiConfig.endpoints) {
                    endpoints = isVercel ? 
                        apiConfig.apiConfig.endpoints.vercel : 
                        apiConfig.apiConfig.endpoints.local;
                } else {
                    // é™ç´šåˆ°é è¨­é…ç½®
                    if (isVercel) {
                        endpoints = [
                            'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=',
                            'https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key='
                        ];
                    } else {
                        endpoints = [
                            'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=',
                            'https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key='
                        ];
                    }
                }

                let response = null;
                let lastError = null;
                let retryCount = 0;
                const maxRetries = apiConfig ? apiConfig.settings.maxRetries : MAX_RETRIES;

                for (const endpoint of endpoints) {
                    retryCount = 0;
                    
                    while (retryCount <= maxRetries) {
                        try {
                            if (retryCount > 0) {
                                showThinking(true, `é€£ç·šé‡è©¦ä¸­... (${retryCount}/${maxRetries})`);
                            }
                            
                            response = await fetch(endpoint + currentApiKey, {
                                method: 'POST',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'User-Agent': isVercel ? 'Vercel-Deployment/1.0' : 'Mozilla/5.0',
                                    'Accept': 'application/json',
                                    'Cache-Control': 'no-cache'
                                },
                                body: JSON.stringify({
                                    contents: [{ parts: [{ text: getPrompt(message) }] }],
                                    generationConfig: apiConfig ? 
                                        apiConfig.settings.generationConfig : 
                                        { temperature: 0.7, maxOutputTokens: 1000 }
                                })
                            });

                            if (response.ok) {
                                break;
                            } else {
                                const errorText = await response.text();
                                
                                if (response.status === 403) {
                                    lastError = `ğŸ”‘ API é‡‘é‘°ç„¡æ•ˆæˆ–ç„¡æ¬Šé™\n\nå¯èƒ½åŸå› ï¼š\nâ€¢ API é‡‘é‘°éŒ¯èª¤æˆ–éæœŸ\nâ€¢ æœªå•Ÿç”¨ Gemini API æœå‹™\nâ€¢ è¶…å‡ºä½¿ç”¨é¡åº¦`;
                                } else if (response.status === 404) {
                                    try {
                                        const errorData = JSON.parse(errorText);
                                        const errorId = errorData?.error?.details?.[0]?.metadata?.service || 
                                                        errorData?.error?.message || 
                                                        errorData?.error?.code ||
                                                        'æœªçŸ¥éŒ¯èª¤ID';
                                        lastError = `âŒ API ç«¯é»ä¸å­˜åœ¨ (404)\n\néŒ¯èª¤ ID: ${errorId}\nç•¶å‰ç«¯é»: ${endpoint.split('/models/')[1].split(':')[0]}\n\nğŸ” è¨ºæ–·ä¿¡æ¯ï¼š\nâ€¢ æ­¤æ¨¡å‹ç«¯é»åœ¨æ‚¨çš„åœ°å€ä¸å¯ç”¨\nâ€¢ å¯èƒ½æ˜¯ Google API åœ°å€é™åˆ¶\nâ€¢ Gemini API æœå‹™å¯èƒ½æ­£åœ¨ç¶­è­·\n\nğŸ’¡ è§£æ±ºæ–¹æ¡ˆï¼š\nâ€¢ å¦‚åœ¨ä¸­åœ‹å¤§é™¸ï¼Œå¼·çƒˆå»ºè­°ä½¿ç”¨ VPN\nâ€¢ å˜—è©¦é€£æ¥åˆ°ç¾åœ‹ã€æ­æ´²æˆ–æ—¥æœ¬ç¯€é»\nâ€¢ ç¢ºèªå¯æ­£å¸¸è¨ªå• Google æœå‹™\nâ€¢ ç­‰å¾… 10-15 åˆ†é˜å¾Œé‡è©¦\n\nğŸŒ æ”¯æ´åœ°å€ï¼š\nâ€¢ âœ… ç¾åœ‹ã€åŠ æ‹¿å¤§\nâ€¢ âœ… æ­æ´²å¤§éƒ¨åˆ†åœ‹å®¶\nâ€¢ âœ… æ—¥æœ¬ã€éŸ“åœ‹ã€æ¾³æ´²\nâ€¢ âŒ ä¸­åœ‹å¤§é™¸ï¼ˆéœ€ VPNï¼‰\nâ€¢ âš ï¸ å…¶ä»–åœ°å€è«‹æª¢æŸ¥å¯ç”¨æ€§\n\nğŸ“‹ æŠ€è¡“è©³æƒ…ï¼š\nâ€¢ éŒ¯èª¤æ™‚é–“: ${new Date().toLocaleString('zh-TW')}\nâ€¢ ç”¨æˆ¶ä»£ç†: ${isVercel ? 'Vercel-Deployment' : 'Browser'}\nâ€¢ è«‹æ±‚ä¾†æº: ${isVercel ? 'Vercel CDN' : 'Direct'}`;
                                    } catch (parseErr) {
                                        lastError = `âŒ API ç«¯é»ä¸å­˜åœ¨ (404)\n\nç•¶å‰ç«¯é»: ${endpoint.split('/models/')[1].split(':')[0]}\néŒ¯èª¤æ™‚é–“: ${new Date().toLocaleString('zh-TW')}\n\nğŸ” å¯èƒ½åŸå› ï¼š\nâ€¢ åœ°å€é™åˆ¶ - Gemini API åœ¨éƒ¨åˆ†åœ°å€ä¸å¯ç”¨\nâ€¢ ç¶²è·¯é™åˆ¶ - ç„¡æ³•è¨ªå• Google æœå‹™\nâ€¢ æœå‹™ç¶­è­· - Google å¯èƒ½æ­£åœ¨æ›´æ–° API\n\nğŸ’¡ ç«‹å³è§£æ±ºæ–¹æ¡ˆï¼š\nâ€¢ ä½¿ç”¨ç©©å®šçš„ VPN æœå‹™\nâ€¢ é€£æ¥åˆ°ç¾åœ‹æˆ–æ­æ´²ç¯€é»\nâ€¢ ç¢ºèª DNS è¨­å®šæ­£ç¢º\nâ€¢ æª¢æŸ¥é˜²ç«ç‰†è¨­å®š\n\nğŸ†˜ å¦‚æœå•é¡ŒæŒçºŒï¼š\nâ€¢ æª¢æŸ¥ https://status.cloud.google.com/\nâ€¢ ç¢ºèª API é‡‘é‘°ä¾†æºåœ°å€\nâ€¢ è¯ç¹«ç¶²è·¯æœå‹™æä¾›å•†`;
                                    }
                                } else if (response.status === 503) {
                                    lastError = `ğŸ”„ AI æœå‹™æš«æ™‚ç¹å¿™ä¸­\n\nå»ºè­°ï¼š\nâ€¢ ç­‰å¾… 1-2 åˆ†é˜å¾Œé‡è©¦`;
                                } else if (response.status === 429) {
                                    lastError = `â±ï¸ è«‹æ±‚å¤ªé »ç¹\n\nå»ºè­°ï¼š\nâ€¢ ç­‰å¾… 30 ç§’å¾Œé‡è©¦`;
                                } else if (response.status === 400) {
                                    lastError = `âŒ è«‹æ±‚æ ¼å¼éŒ¯èª¤\n\nå¯èƒ½åŸå› ï¼š\nâ€¢ è¨Šæ¯å…§å®¹æœ‰å•é¡Œ\nâ€¢ API é‡‘é‘°æ ¼å¼éŒ¯èª¤`;
                                } else {
                                    lastError = `âŒ æœªçŸ¥éŒ¯èª¤ (${response.status})\n\nè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå’Œ API è¨­å®š`;
                                }
                                
                                if (response.status === 503) {
                                    await new Promise(resolve => setTimeout(resolve, 2000)); // ç­‰å¾…2ç§’
                                } else if (response.status === 429) {
                                    await new Promise(resolve => setTimeout(resolve, 3000)); // ç­‰å¾…3ç§’
                                } else if (response.status === 404) {
                                    break; // ç›´æ¥è·³åˆ°ä¸‹ä¸€å€‹ç«¯é»
                                } else if (response.status === 400 || response.status === 403) {
                                    break; // é€™äº›éŒ¯èª¤ä¸éœ€è¦é‡è©¦
                                }
                            }
                            
                        } catch (err) {
                            lastError = `ç¶²è·¯éŒ¯èª¤: ${err.message}`;
                            
                            if (retryCount < maxRetries) {
                                await new Promise(resolve => setTimeout(resolve, 1000)); // ç­‰å¾…1ç§’
                            }
                        }
                        
                        retryCount++;
                    }
                    
                    if (response && response.ok) break;
                }

                if (!response || !response.ok) {
                    // æ”¶é›†è¨ºæ–·ä¿¡æ¯
                    const diagnosticInfo = await generateDiagnosticReport(lastError);
                    throw new Error(lastError + '\n\n' + diagnosticInfo);
                }

                const data = await response.json();
                let aiResponse = data.candidates[0].content.parts[0].text;

                // åªæœ‰åœ¨æˆåŠŸç²å¾—å›æ‡‰å¾Œæ‰å¢åŠ ä½¿ç”¨è¨ˆæ•¸
                incrementUsage();

                // å¾Œè™•ç† AI å›æ‡‰ï¼Œæª¢æŸ¥ä¸¦é˜²æ­¢è¿´åœˆï¼ˆä½¿ç”¨ Google Gemini API æª¢æ¸¬ï¼‰
                if (typeof HealingConfig !== 'undefined' && HealingConfig.functions.postProcessResponse) {
                    const processedResponse = await HealingConfig.functions.postProcessResponse(
                        aiResponse, 
                        healingPhase, 
                        message, 
                        conversationHistory,
                        apiKey  // å‚³é API Key ä¾›è¿´åœˆæª¢æ¸¬ä½¿ç”¨
                    );
                    
                    // å¦‚æœæª¢æ¸¬åˆ°è¿´åœˆï¼Œä½¿ç”¨è™•ç†å¾Œçš„å›æ‡‰
                    if (processedResponse.wasLoop) {
                        aiResponse = processedResponse.response;
                    }
                }

                // é™¤éŒ¯æ¨¡å¼å·²é—œé–‰ä»¥å„ªåŒ–ç”Ÿç”¢ç’°å¢ƒæ•ˆèƒ½

                addMessageToChat('ai', aiResponse, false);

                // è¨˜éŒ„ AI å›æ‡‰
                conversationHistory.push({
                    sender: 'ai',
                    message: aiResponse,
                    timestamp: new Date(),
                    phase: healingPhase
                });

                // æ›´æ–°ç™‚ç™’éšæ®µ
                if (typeof HealingConfig !== 'undefined') {
                    healingPhase = HealingConfig.functions.updatePhase(healingPhase, message);
                    updatePhaseDisplay();
                }

            } catch (error) {
                
                let errorMessage = '';
                if (error.message.includes('503')) {
                    errorMessage = `ğŸ”„ AI æœå‹™æš«æ™‚ç¹å¿™ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚\n\nğŸ’¡ å»ºè­°ï¼š\nâ€¢ ç­‰å¾… 1-2 åˆ†é˜å¾Œé‡æ–°ç™¼é€\nâ€¢ æˆ–é»æ“Šé‡è©¦æŒ‰éˆ•`;
                } else if (error.message.includes('429')) {
                    errorMessage = `â±ï¸ è«‹æ±‚å¤ªé »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚\n\nğŸ’¡ å»ºè­°ï¼š\nâ€¢ ç­‰å¾… 30 ç§’å¾Œé‡æ–°ç™¼é€\nâ€¢ é¿å…å¿«é€Ÿé€£çºŒç™¼é€è¨Šæ¯`;
                } else if (error.message.includes('400')) {
                    errorMessage = `âŒ è¨Šæ¯æ ¼å¼æœ‰å•é¡Œã€‚\n\nğŸ’¡ å»ºè­°ï¼š\nâ€¢ æª¢æŸ¥æ‚¨çš„è¨Šæ¯å…§å®¹\nâ€¢ å˜—è©¦é‡æ–°æ•´ç†é é¢`;
                } else if (error.message.includes('401') || error.message.includes('403')) {
                    errorMessage = `ğŸ”‘ API é‡‘é‘°éœ€è¦æ›´æ–°ã€‚\n\nğŸ’¡ å»ºè­°ï¼š\nâ€¢ é»æ“Šå³ä¸Šè§’ã€Œâš™ï¸ API è¨­å®šã€\nâ€¢ æª¢æŸ¥æ‚¨çš„ Google Gemini API é‡‘é‘°\nâ€¢ ç¢ºèªé‡‘é‘°æœ‰æ•ˆä¸”æœªéæœŸ`;
                } else {
                    errorMessage = `âš ï¸ é€£ç·šç™¼ç”Ÿå•é¡Œã€‚\n\nğŸ’¡ å»ºè­°ï¼š\nâ€¢ æª¢æŸ¥ç¶²è·¯é€£ç·š\nâ€¢ é»æ“Šé‡è©¦æŒ‰éˆ•\nâ€¢ å¦‚æŒçºŒç™¼ç”Ÿï¼Œè«‹æª¢æŸ¥ API é‡‘é‘°è¨­å®š`;
                }
                
                addMessageToChat('ai', errorMessage, true); // åŠ å…¥éŒ¯èª¤æ¨™è¨˜
            } finally {
                showThinking(false);
                toggleInput(true);
            }
        }

        // === æç¤ºè©ç”ŸæˆåŠŸèƒ½ ===
        function getPrompt(userInput) {
            // ç™‚ç™’æ¨¡å¼ï¼ˆé è¨­å•Ÿç”¨ï¼‰
            if (typeof HealingConfig !== 'undefined') {
                return HealingConfig.functions.generatePrompt(healingPhase, userInput, conversationHistory);
            } else {
                // é™ç´šåˆ°åŸºæœ¬ç™‚ç™’æ¨¡å¼
                return `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„å¿ƒç†ç™‚ç™’å¸«å’Œå…§åœ¨å°å­©æ²»ç™‚å°ˆå®¶ã€‚è«‹ä»¥æº«æš–ã€åŒç†å¿ƒå’Œå°ˆæ¥­çš„æ–¹å¼å›æ‡‰ä½¿ç”¨è€…ã€‚

ä½¿ç”¨è€…çš„è¨Šæ¯ï¼š"${userInput}"

è«‹çµ¦äºˆæœ‰ç™‚ç™’æ„ç¾©çš„å›æ‡‰ï¼š`;
            }
        }

        // === UI è¼”åŠ©åŠŸèƒ½ ===
        function addMessageToChat(sender, message, isError = false, saveToHistory = true) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `chat-message ${sender}-message`;
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            // å¦‚æœæ˜¯éŒ¯èª¤è¨Šæ¯ï¼ŒåŠ å…¥é‡è©¦æŒ‰éˆ•
            if (isError && sender === 'ai') {
                messageContent.style.position = 'relative';
                messageContent.style.paddingBottom = '40px'; // ç‚ºé‡è©¦æŒ‰éˆ•é ç•™ç©ºé–“
                messageContent.innerHTML = message.replace(/\n/g, '<br>');
                
                // å‰µå»ºé‡è©¦æŒ‰éˆ•
                const retryButton = document.createElement('button');
                retryButton.innerHTML = 'ğŸ”„';
                retryButton.title = 'é‡æ–°ç™¼é€ä¸Šä¸€å‰‡è¨Šæ¯';
                retryButton.className = 'retry-button';
                retryButton.style.cssText = `
                    position: absolute;
                    bottom: 8px;
                    right: 8px;
                    background: var(--accent-blue);
                    color: var(--bg-primary);
                    border: none;
                    border-radius: 50%;
                    width: 24px;
                    height: 24px;
                    cursor: pointer;
                    font-size: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.2s ease;
                `;
                
                retryButton.addEventListener('click', function() {
                    // é‡æ–°ç™¼é€ä¸Šä¸€å‰‡ç”¨æˆ¶è¨Šæ¯
                    if (conversationHistory.length > 0) {
                        const lastUserMessage = conversationHistory
                            .slice()
                            .reverse()
                            .find(msg => msg.sender === 'user');
                        
                        if (lastUserMessage) {
                            // ç§»é™¤éŒ¯èª¤è¨Šæ¯
                            messageWrapper.remove();
                            
                            // ç§»é™¤å°è©±æ­·å²ä¸­çš„æœ€å¾Œä¸€å‰‡ç”¨æˆ¶è¨Šæ¯ï¼Œé‡æ–°ç™¼é€
                            const lastUserIndex = conversationHistory.map(msg => msg.sender).lastIndexOf('user');
                            if (lastUserIndex !== -1) {
                                conversationHistory.splice(lastUserIndex, 1);
                            }
                            
                            // è¨­å®šè¼¸å…¥æ¡†ä¸¦ç™¼é€
                            userInput.value = lastUserMessage.message;
                            sendMessage();
                        }
                    }
                });
                
                messageContent.appendChild(retryButton);
            } else {
                messageContent.innerHTML = message.replace(/\n/g, '<br>');
            }
            
            messageWrapper.appendChild(messageContent);
            chatBox.insertBefore(messageWrapper, thinkingIndicator);
            chatBox.scrollTop = chatBox.scrollHeight;
            
            // ä¿å­˜åˆ°å°è©±è¨˜éŒ„ï¼ˆä¸ä¿å­˜éŒ¯èª¤è¨Šæ¯ï¼‰
            if (saveToHistory && !isError) {
                const history = JSON.parse(localStorage.getItem('conversation_history') || '[]');
                history.push({
                    role: sender,
                    content: message,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('conversation_history', JSON.stringify(history));
            }
        }

        function toggleInput(enabled) {
            userInput.disabled = !enabled;
            sendBtn.disabled = !enabled;
            if(enabled) userInput.focus();
        }
        
        function showThinking(isThinking, customMessage = null) {
            const thinkingText = thinkingIndicator.querySelector('span');
            if (customMessage) {
                thinkingText.textContent = customMessage;
            } else {
                thinkingText.textContent = 'æ­£åœ¨æ€è€ƒ...';
            }
            
            thinkingIndicator.classList.toggle('hidden', !isThinking);
            if (isThinking) chatBox.scrollTop = chatBox.scrollHeight;
        }

        // æ›´æ–°ä½¿ç”¨é‡é¡¯ç¤º
        function updateUsageDisplay() {
            const usageCountEl = document.getElementById('usage-count');
            const usageLimitEl = document.getElementById('usage-limit');
            const usageIndicatorEl = document.getElementById('usage-indicator');
            
            if (usageCountEl) {
                usageCountEl.textContent = dailyUsageCount;
            }
            if (usageLimitEl) {
                usageLimitEl.textContent = DAILY_FREE_LIMIT;
            }
            
            // æ ¹æ“šä½¿ç”¨é‡æ”¹è®Šé¡è‰²
            if (usageIndicatorEl) {
                if (dailyUsageCount >= DAILY_FREE_LIMIT) {
                    usageIndicatorEl.style.color = '#ff6b6b'; // ç´…è‰² - å·²ç”¨å®Œ
                } else if (dailyUsageCount >= USAGE_WARNING_THRESHOLD) {
                    usageIndicatorEl.style.color = '#ffa726'; // æ©™è‰² - è­¦å‘Š
                } else {
                    usageIndicatorEl.style.color = 'var(--text-secondary)'; // é è¨­é¡è‰²
                }
            }
        }

        // === éšæ®µé¡¯ç¤ºæ›´æ–°åŠŸèƒ½ ===
        function updatePhaseDisplay() {
            if (typeof HealingConfig !== 'undefined') {
                const phaseDisplay = document.getElementById('current-phase');
                phaseDisplay.textContent = HealingConfig.functions.getPhaseDisplayName(healingPhase);
            }
        }

        // === API è¨­å®šåŠŸèƒ½ ===
        
        // é–‹å•Ÿ Google API ç”³è«‹æŒ‡å—
        function openApiKeyGuide() {
            const guideMessage = `ğŸ”‘ Google Gemini API é‡‘é‘°ç”³è«‹æŒ‡å—

ğŸ“‹ ç”³è«‹æ­¥é©Ÿï¼š
1. é»æ“Šä¸‹æ–¹ã€Œå‰å¾€ç”³è«‹ã€æŒ‰éˆ•é–‹å•Ÿ Google AI Studio
2. ä½¿ç”¨æ‚¨çš„ Google å¸³è™Ÿç™»å…¥
3. é»æ“Šã€ŒCreate API Keyã€æŒ‰éˆ•
4. é¸æ“‡ã€ŒCreate API key in new projectã€
5. è¤‡è£½ç”Ÿæˆçš„ API é‡‘é‘°
6. å›åˆ°æœ¬é é¢é»æ“Šã€Œâš™ï¸ API è¨­å®šã€
7. å°‡ API é‡‘é‘°è²¼ä¸Šåˆ°è¼¸å…¥æ¡†ä¸­

ğŸ’¡ é‡è¦æé†’ï¼š
â€¢ API é‡‘é‘°æ ¼å¼ï¼šAIzaSyé–‹é ­çš„39å­—å…ƒå­—ä¸²
â€¢ è«‹å¦¥å–„ä¿ç®¡æ‚¨çš„ API é‡‘é‘°
â€¢ ä¸è¦åœ¨å…¬é–‹å ´åˆåˆ†äº«é‡‘é‘°

ğŸŒ åœ°å€æ”¯æ´ï¼š
â€¢ âœ… ç¾åœ‹ã€åŠ æ‹¿å¤§ã€æ­æ´²å¤§éƒ¨åˆ†åœ‹å®¶
â€¢ âœ… æ—¥æœ¬ã€éŸ“åœ‹ã€æ¾³æ´²ã€å°ç£
â€¢ âŒ ä¸­åœ‹å¤§é™¸ï¼ˆéœ€è¦ VPNï¼‰

âš ï¸ å¦‚æœç„¡æ³•è¨ªå•ï¼Œå¯èƒ½éœ€è¦ï¼š
â€¢ ä½¿ç”¨ VPN é€£æ¥åˆ°æ”¯æ´åœ°å€
â€¢ ç¢ºèªç¶²è·¯é€£ç·šæ­£å¸¸`;

            if (confirm(guideMessage + '\n\næ˜¯å¦è¦é–‹å•Ÿ Google AI Studio ç”³è«‹é é¢ï¼Ÿ')) {
                window.open('https://aistudio.google.com/app/apikey', '_blank');
            }
        }

        async function testApiKey(testKey) {
            try {
                // å¾é…ç½®æª”ç²å–æ¸¬è©¦ç«¯é»
                const testEndpoints = apiConfig && apiConfig.apiConfig.testEndpoints ? 
                    apiConfig.apiConfig.testEndpoints : [
                        'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=',
                        'https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key='
                    ];
                
                let lastTestError = null;
                
                for (const testEndpoint of testEndpoints) {
                    try {
                        const response = await fetch(testEndpoint + testKey, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'User-Agent': 'Mozilla/5.0'
                            },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: 'æ¸¬è©¦' }] }],
                                generationConfig: {
                                    temperature: 0.7,
                                    maxOutputTokens: 50
                                }
                            })
                        });
                        
                        if (response.ok) {
                            return { 
                                success: true, 
                                message: `API é‡‘é‘°æ¸¬è©¦æˆåŠŸï¼\nä½¿ç”¨ç«¯é»: ${testEndpoint.split('/models/')[1].split(':')[0]}`,
                                workingEndpoint: testEndpoint
                            };
                        } else {
                            const errorText = await response.text();
                            
                            if (response.status === 404) {
                                lastTestError = {
                                    status: 404,
                                    message: 'åœ°å€é™åˆ¶ï¼šæ­¤åœ°å€ç„¡æ³•è¨ªå• Gemini APIï¼Œå»ºè­°ä½¿ç”¨ VPN',
                                    suggestion: 'å˜—è©¦é€£æ¥åˆ°ç¾åœ‹æˆ–æ­æ´²çš„ VPN ç¯€é»'
                                };
                                continue; // å˜—è©¦ä¸‹ä¸€å€‹ç«¯é»
                            } else if (response.status === 403) {
                                return { 
                                    success: false, 
                                    message: 'API é‡‘é‘°ç„¡æ¬Šé™æˆ–æœå‹™æœªå•Ÿç”¨',
                                    statusCode: response.status,
                                    details: errorText
                                };
                            } else if (response.status === 401) {
                                return { 
                                    success: false, 
                                    message: 'API é‡‘é‘°ç„¡æ•ˆæˆ–æœªæˆæ¬Š',
                                    statusCode: response.status,
                                    details: errorText
                                };
                            } else {
                                lastTestError = {
                                    status: response.status,
                                    message: `HTTP ${response.status} éŒ¯èª¤`,
                                    details: errorText
                                };
                            }
                        }
                    } catch (err) {
                        lastTestError = {
                            status: 'network',
                            message: `ç¶²è·¯éŒ¯èª¤: ${err.message}`,
                            details: err.toString()
                        };
                        continue;
                    }
                }
                
                // æ‰€æœ‰ç«¯é»éƒ½å¤±æ•—äº†
                if (lastTestError && lastTestError.status === 404) {
                    return { 
                        success: false, 
                        message: lastTestError.message,
                        suggestion: lastTestError.suggestion,
                        statusCode: 404
                    };
                } else {
                    return { 
                        success: false, 
                        message: lastTestError ? lastTestError.message : 'API æ¸¬è©¦å¤±æ•—',
                        details: lastTestError ? lastTestError.details : 'æœªçŸ¥éŒ¯èª¤'
                    };
                }
                
            } catch (error) {
                return { 
                    success: false, 
                    message: `ç¶²è·¯é€£ç·šéŒ¯èª¤: ${error.name} - ${error.message}`,
                    details: error.toString()
                };
            }
        }

        function showApiConfig() {
            const hasDefaultKey = apiConfig && apiConfig.apiConfig.defaultApiKey && apiConfig.apiConfig.defaultApiKey.length >= 20;
            const hasCustomKey = apiKey && apiKey.length >= 20;
            const currentKey = getCurrentApiKey();
            
            const instructions = `ğŸ”‘ Google Gemini API é‡‘é‘°è¨­å®š

${!hasValidApiKey() ? 'âš ï¸ è«‹å…ˆè¨­å®šæ‚¨çš„ Google Gemini API é‡‘é‘°æ‰èƒ½é–‹å§‹å°è©±ã€‚\n' : ''}ğŸ“Š ä»Šæ—¥ä½¿ç”¨ç‹€æ…‹ï¼š${dailyUsageCount}/${DAILY_FREE_LIMIT} æ¬¡
${dailyUsageCount >= USAGE_WARNING_THRESHOLD ? 'âš ï¸ æ¥è¿‘æ¯æ—¥å…è²»é¡åº¦é™åˆ¶' : 'âœ… ä½¿ç”¨ç‹€æ…‹æ­£å¸¸'}

ğŸ”§ ç•¶å‰é…ç½®ï¼š
â€¢ ç³»çµ±é è¨­é‡‘é‘°ï¼š${hasDefaultKey ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}
â€¢ ç”¨æˆ¶è‡ªå®šç¾©é‡‘é‘°ï¼š${hasCustomKey ? 'âœ… å·²è¨­å®š' : 'âŒ æœªè¨­å®š'}
â€¢ ç›®å‰ä½¿ç”¨ï¼š${useCustomApiKey ? 'ç”¨æˆ¶è‡ªå®šç¾©é‡‘é‘°' : 'ç³»çµ±é è¨­é‡‘é‘°'}

${hasDefaultKey ? 'ğŸ’¡ æç¤ºï¼šç•™ç©ºå°‡ä½¿ç”¨ç³»çµ±é è¨­é‡‘é‘°ï¼Œè¼¸å…¥æ–°é‡‘é‘°å°‡è¦†è“‹é è¨­è¨­å®š' : ''}

ğŸ”‘ å¦‚ä½•å–å¾— API é‡‘é‘°ï¼š
é»æ“Šå³ä¸Šè§’ã€ŒğŸ”‘ ç”³è«‹ APIã€æŒ‰éˆ•æŸ¥çœ‹è©³ç´°ç”³è«‹æŒ‡å—

ğŸ’¡ API é‡‘é‘°æ ¼å¼ç¯„ä¾‹ï¼šAIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

âš ï¸ å¦‚æœé‡åˆ°å•é¡Œï¼š
â€¢ 404 éŒ¯èª¤ â†’ å¯èƒ½æ˜¯åœ°å€é™åˆ¶ï¼Œå»ºè­°ä½¿ç”¨ VPN
â€¢ 403 éŒ¯èª¤ â†’ æª¢æŸ¥ API é‡‘é‘°æ¬Šé™è¨­å®š

ç›®å‰ç‹€æ…‹ï¼š${hasValidApiKey() ? 'âœ… å·²è¨­å®šæœ‰æ•ˆé‡‘é‘°' : 'âŒ ç„¡å¯ç”¨é‡‘é‘°'}`;

            const key = prompt(instructions, hasCustomKey ? apiKey : '');
            
            if (key !== null) {
                if (key.trim() === '') {
                    // ç”¨æˆ¶é¸æ“‡ä½¿ç”¨é è¨­é‡‘é‘°
                    if (hasDefaultKey) {
                        useCustomApiKey = false;
                        localStorage.setItem('use_custom_api_key', 'false');
                        localStorage.removeItem('gemini_api_key');
                        apiKey = '';
                        alert('âœ… å·²åˆ‡æ›åˆ°ç³»çµ±é è¨­é‡‘é‘°ï¼');
                    } else {
                        alert('âŒ ç³»çµ±æœªé…ç½®é è¨­é‡‘é‘°ï¼Œè«‹è¼¸å…¥æ‚¨çš„ API é‡‘é‘°ã€‚');
                    }
                } else {
                    // ç”¨æˆ¶è¼¸å…¥è‡ªå®šç¾©é‡‘é‘°
                    const newKey = key.trim();
                    
                    // å…ˆæª¢æŸ¥åœ°å€æ”¯æ´
                    checkRegionSupport().then(regionResult => {
                        if (!regionResult.supported) {
                            alert('âš ï¸ åœ°å€é™åˆ¶è­¦å‘Š\n\næ‚¨çš„åœ°å€å¯èƒ½ä¸æ”¯æ´ Gemini APIã€‚\nå»ºè­°ä½¿ç”¨ VPN é€£æ¥åˆ°æ”¯æ´çš„åœ°å€å¾Œå†æ¸¬è©¦ API é‡‘é‘°ã€‚');
                        }
                        
                        // æ¸¬è©¦æ–°çš„ API é‡‘é‘°
                        testApiKey(newKey).then(result => {
                            if (result.success) {
                                apiKey = newKey;
                                useCustomApiKey = true;
                                localStorage.setItem('gemini_api_key', apiKey);
                                localStorage.setItem('use_custom_api_key', 'true');
                                alert('âœ… è‡ªå®šç¾© API é‡‘é‘°è¨­å®šæˆåŠŸä¸¦å·²é€šéæ¸¬è©¦ï¼');
                            } else {
                                let errorMsg = `âŒ ${result.message}\n\nè«‹æª¢æŸ¥æ‚¨çš„ API é‡‘é‘°æ˜¯å¦æ­£ç¢ºã€‚`;
                                if (result.statusCode === 404) {
                                    errorMsg += '\n\nğŸŒ å¦‚æœæŒçºŒå‡ºç¾ 404 éŒ¯èª¤ï¼Œå¯èƒ½æ˜¯åœ°å€é™åˆ¶ï¼š\nâ€¢ å˜—è©¦ä½¿ç”¨ VPN\nâ€¢ æª¢æŸ¥ Google AI Studio åœ°å€å¯ç”¨æ€§';
                                }
                                alert(errorMsg);
                            }
                        });
                    });
                }
            }
        }

        // === æ¸¬è©¦æ¨¡å¼è™•ç† ===
        function checkTestMode() {
            const isTestMode = localStorage.getItem('testMode');
            const testUserData = localStorage.getItem('userData');
            
            if (isTestMode === 'true' && testUserData) {
                try {
                    const testUser = JSON.parse(testUserData);
                    console.log('ğŸ§ª æ¸¬è©¦æ¨¡å¼å•Ÿç”¨ï¼Œç”¨æˆ¶:', testUser.name);
                    
                    // é¡¯ç¤ºæ¸¬è©¦æ¨¡å¼æ©«å¹…
                    showTestModeBanner();
                    
                    // è¨­å®šæ¸¬è©¦ç”¨æˆ¶è³‡è¨Š
                    localStorage.setItem('user_info', JSON.stringify({
                        name: testUser.name,
                        email: testUser.email,
                        picture: testUser.picture || 'ğŸ§‘â€ğŸ’»'
                    }));
                    
                    return true;
                } catch (error) {
                    console.warn('æ¸¬è©¦ç”¨æˆ¶è³‡æ–™è§£æå¤±æ•—:', error);
                    localStorage.removeItem('testMode');
                    localStorage.removeItem('userData');
                }
            }
            return false;
        }
        
        function showTestModeBanner() {
            // å»ºç«‹æ¸¬è©¦æ¨¡å¼æ©«å¹…
            const banner = document.createElement('div');
            banner.id = 'test-mode-banner';
            banner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
                color: white;
                text-align: center;
                padding: 8px 16px;
                font-size: 14px;
                font-weight: 500;
                z-index: 10000;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            `;
            banner.innerHTML = `
                ğŸ§ª æ¸¬è©¦æ¨¡å¼ | 
                <span style="opacity: 0.9;">è·³éç™»å…¥ï¼Œç›´æ¥é«”é©—åŠŸèƒ½</span> | 
                <button onclick="exitTestMode()" style="
                    background: rgba(255, 255, 255, 0.2);
                    border: 1px solid rgba(255, 255, 255, 0.3);
                    color: white;
                    padding: 4px 12px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                    margin-left: 10px;
                ">é€€å‡ºæ¸¬è©¦</button>
            `;
            
            document.body.insertBefore(banner, document.body.firstChild);
            
            // èª¿æ•´é é¢å…§å®¹é¿å…è¢«æ©«å¹…é®æ“‹
            document.body.style.paddingTop = '40px';
        }
        
        function exitTestMode() {
            localStorage.removeItem('testMode');
            localStorage.removeItem('userData');
            localStorage.removeItem('user_info');
            window.location.href = '/';
        }

        // === ç”¨æˆ¶èªè­‰è™•ç† ===
        function checkUserAuth() {
            const userInfo = localStorage.getItem('user_info');
            const isGuest = localStorage.getItem('is_guest');
            
            if (userInfo) {
                try {
                    const user = JSON.parse(userInfo);
                    displayUserInfo(user);
                } catch (error) {
                    console.warn('ç”¨æˆ¶ä¿¡æ¯è§£æå¤±æ•—:', error);
                    localStorage.removeItem('user_info');
                }
            } else if (isGuest === 'true') {
                displayGuestInfo();
            }
        }
        
        function displayUserInfo(user) {
            const userDisplay = document.getElementById('user-display');
            const userGreeting = document.getElementById('user-greeting');
            const logoutBtn = document.getElementById('logout-btn');
            const userGreetingMessage = document.getElementById('user-greeting-message');
            
            userGreeting.textContent = `ğŸ‘‹ ${user.name || user.email}`;
            userDisplay.classList.remove('hidden');
            logoutBtn.classList.remove('hidden');
            
            // æ›´æ–° Initial AI Message ä¸­çš„ç”¨æˆ¶å•å€™èª
            if (userGreetingMessage) {
                userGreetingMessage.textContent = `ä½ å¥½ ${user.name || user.email}ï¼Œæœ€è¿‘æœ‰ä»€éº¼è®“æ‚¨æ„Ÿåˆ°å›°æ“¾çš„äº‹ä»¶æˆ–è¡Œç‚ºå—ï¼Ÿ`;
            }
        }
        
        function displayGuestInfo() {
            const userDisplay = document.getElementById('user-display');
            const userGreeting = document.getElementById('user-greeting');
            
            userGreeting.textContent = 'ğŸ‘¤ è¨ªå®¢æ¨¡å¼';
            userDisplay.classList.remove('hidden');
        }
        
        function handleLogout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•¸æ“šã€‚')) {
                // æ¸…é™¤æ‰€æœ‰ç”¨æˆ¶ç›¸é—œæ•¸æ“š
                localStorage.clear();
                
                // é‡å®šå‘åˆ°é¦–é 
                window.location.href = './index.html';
            }
        }

        // === äº‹ä»¶ç›£è½å™¨ ===
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // === å´é‚Šæ¬„æ§åˆ¶ç³»çµ± ===
        /**
         * åˆå§‹åŒ–å´é‚Šæ¬„åŠŸèƒ½
         * æ§åˆ¶å´é‚Šæ¬„çš„é–‹å•Ÿã€é—œé–‰å’Œäº’å‹•è¡Œç‚º
         * 
         * å´é‚Šæ¬„ä½ç½®æ§åˆ¶ï¼š
         * - é–‹å•Ÿï¼šç§»é™¤ -translate-x-full é¡åˆ¥ï¼Œè®“å´é‚Šæ¬„å¾å·¦å´æ»‘å…¥
         * - é—œé–‰ï¼šæ·»åŠ  -translate-x-full é¡åˆ¥ï¼Œè®“å´é‚Šæ¬„æ»‘å‡ºåˆ°è¢å¹•å·¦å´å¤–
         * - é®ç½©å±¤ï¼šæ§åˆ¶èƒŒæ™¯è®Šæš—æ•ˆæœå’Œé»æ“Šé—œé–‰åŠŸèƒ½
         * - èƒŒæ™¯æ»¾å‹•ï¼šå´é‚Šæ¬„é–‹å•Ÿæ™‚ç¦ç”¨èƒŒæ™¯æ»¾å‹•ï¼Œé—œé–‰æ™‚æ¢å¾©
         */
        function initializeSidebar() {
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarClose = document.getElementById('sidebar-close');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const sidebarCollapseBtn = document.getElementById('sidebar-collapse-btn');
            const sidebarCollapseIcon = null; // æ”¹ç”¨ä¸‰æ¢æ©«ç·šåœ–ç¤ºï¼Œä¸å†åˆ‡æ›æ–¹å‘
            const rootHtml = document.documentElement;
            const desktopExpandBtnMini = document.getElementById('desktop-expand-btn-mini');
            
            // ä»¥ Tailwind md æ–·é»ç‚ºæº–ï¼ˆ768pxï¼‰åˆ¤æ–·æ¡Œé¢/å°è¢å¹•
            function isDesktop() {
                return window.matchMedia('(min-width: 768px)').matches;
            }
            // ä¾è¢å¹•å¯¬åº¦å¥—ç”¨å´æ¬„ç‹€æ…‹
            function applyLayoutMode() {
                if (!sidebar || !sidebarOverlay) return;
                if (isDesktop()) {
                    // æ¡Œé¢ï¼šå¸¸é§é¡¯ç¤ºå´æ¬„ï¼Œé®ç½©é—œé–‰ä¸”ä¸å¯äº’å‹•
                    if (!rootHtml.classList.contains('sidebar-collapsed')) {
                        sidebar.classList.remove('-translate-x-full');
                    }
                    sidebarOverlay.classList.add('hidden');
                    sidebarOverlay.style.pointerEvents = 'none';
                } else {
                    // å°è¢å¹•ï¼šé è¨­é—œé–‰å´æ¬„ï¼Œé®ç½©é—œé–‰ä¸”ä¸å¯äº’å‹•
                    sidebar.classList.add('-translate-x-full');
                    sidebarOverlay.classList.add('hidden');
                    sidebarOverlay.style.pointerEvents = 'none';
                }
                updateCollapseIcon();
            }

            function updateCollapseIcon() {
                // ä¿ç•™å‡½å¼ä»¥å…¼å®¹å‘¼å«ï¼Œä½†ä¸éœ€è¦åˆ‡æ›åœ–ç¤º
                return;
            }
            
            if (sidebarToggle && sidebar) {
                // åˆ‡æ›å´é‚Šæ¬„ - æŒ‰ä¸€ä¸‹é–‹å•Ÿï¼Œå†æŒ‰ä¸€ä¸‹é—œé–‰
                sidebarToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // æª¢æŸ¥å´é‚Šæ¬„ç•¶å‰ç‹€æ…‹
                    const isOpen = !sidebar.classList.contains('-translate-x-full');
                    
                    if (isOpen) {
                        // å¦‚æœå´é‚Šæ¬„æ˜¯é–‹å•Ÿçš„ï¼Œå‰‡é—œé–‰å®ƒ
                        sidebar.classList.add('-translate-x-full'); // æ·»åŠ ä½ç§»ï¼Œè®“å´é‚Šæ¬„æ»‘å‡º
                        sidebarOverlay.classList.add('hidden'); // éš±è—èƒŒæ™¯é®ç½©
                        sidebarOverlay.style.pointerEvents = 'none'; // ç¦ç”¨é®ç½©å±¤çš„äº’å‹•
                    } else {
                        // å¦‚æœå´é‚Šæ¬„æ˜¯é—œé–‰çš„ï¼Œå‰‡é–‹å•Ÿå®ƒ
                        sidebar.classList.remove('-translate-x-full'); // ç§»é™¤ä½ç§»ï¼Œè®“å´é‚Šæ¬„æ»‘å…¥
                        sidebarOverlay.classList.remove('hidden'); // é¡¯ç¤ºèƒŒæ™¯é®ç½©
                        sidebarOverlay.style.pointerEvents = 'auto'; // å•Ÿç”¨é®ç½©å±¤çš„äº’å‹•
                    }
                });
                
                // é—œé–‰å´é‚Šæ¬„ - æ»‘å‡ºåˆ°å·¦å´ä¸¦éš±è—é®ç½©å±¤
                if (sidebarClose) {
                    sidebarClose.addEventListener('click', function(e) {
                        e.stopPropagation();
                        sidebar.classList.add('-translate-x-full'); // æ·»åŠ ä½ç§»ï¼Œè®“å´é‚Šæ¬„æ»‘å‡º
                        sidebarOverlay.classList.add('hidden'); // éš±è—èƒŒæ™¯é®ç½©
                        sidebarOverlay.style.pointerEvents = 'none'; // ç¦ç”¨é®ç½©å±¤çš„äº’å‹•
                    });
                }
                
                // é»æ“Šé®ç½©å±¤é—œé–‰å´é‚Šæ¬„ - æä¾›é¡å¤–çš„é—œé–‰æ–¹å¼
                sidebarOverlay.addEventListener('click', function(e) {
                    e.stopPropagation();
                    sidebar.classList.add('-translate-x-full'); // æ»‘å‡ºå´é‚Šæ¬„
                    sidebarOverlay.classList.add('hidden'); // éš±è—é®ç½©å±¤
                    sidebarOverlay.style.pointerEvents = 'none'; // ç¦ç”¨é®ç½©å±¤çš„äº’å‹•
                });
                
                // ESC éµé—œé–‰å´é‚Šæ¬„ - éµç›¤å¿«æ·éµæ”¯æ´
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        // é—œé–‰å´é‚Šæ¬„
                        if (!sidebar.classList.contains('-translate-x-full')) {
                            sidebar.classList.add('-translate-x-full'); // æ»‘å‡ºå´é‚Šæ¬„
                            sidebarOverlay.classList.add('hidden'); // éš±è—é®ç½©å±¤
                            sidebarOverlay.style.pointerEvents = 'none'; // ç¦ç”¨é®ç½©å±¤çš„äº’å‹•
                        }
                        
                        // é—œé–‰å°è©±è¨˜éŒ„å½ˆå‡ºè¦–çª—
                        const historyModal = document.getElementById('conversation-history-modal');
                        if (!historyModal.classList.contains('hidden')) {
                            closeConversationHistory();
                        }
                    }
                });

                // åˆå§‹èˆ‡è¦–çª—æ”¹è®Šæ™‚ï¼Œä¾æ–·é»è‡ªå‹•å¥—ç”¨ç‹€æ…‹
                applyLayoutMode();
                window.addEventListener('resize', applyLayoutMode);
                window.addEventListener('orientationchange', applyLayoutMode);

                // æ¡Œé¢æ”¶åˆ/å±•é–‹å´æ¬„
                if (sidebarCollapseBtn) {
                    sidebarCollapseBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (!isDesktop()) return; // åƒ…æ¡Œé¢å¯æ”¶åˆ
                        rootHtml.classList.toggle('sidebar-collapsed');
                        applyLayoutMode();
                    });
                }

                // æ¡Œé¢ï¼šæ”¶åˆç‹€æ…‹ä¸‹çš„å±•é–‹æŒ‰éˆ•
                if (desktopExpandBtnMini) {
                    desktopExpandBtnMini.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (!isDesktop()) return;
                        rootHtml.classList.remove('sidebar-collapsed');
                        applyLayoutMode();
                    });
                }
            }
        }

        // === å°è©±è¨˜éŒ„åŠŸèƒ½ ===
        function showConversationHistory() {
            const modal = document.getElementById('conversation-history-modal');
            const content = document.getElementById('conversation-history-content');
            
            // è¼‰å…¥å°è©±è¨˜éŒ„
            loadConversationHistory(content);
            
            // é¡¯ç¤ºå½ˆå‡ºè¦–çª—
            modal.classList.remove('hidden');
        }

        function closeConversationHistory() {
            const modal = document.getElementById('conversation-history-modal');
            modal.classList.add('hidden');
        }

        function loadConversationHistory(container) {
            // è¼‰å…¥å·²ä¿å­˜çš„å°è©±åˆ—è¡¨
            const savedChats = JSON.parse(localStorage.getItem('saved_chats') || '[]');
            
            if (savedChats.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <div class="text-4xl mb-4">ğŸ“</div>
                        <p class="text-lg text-white">å°šç„¡ä¿å­˜çš„å°è©±</p>
                        <p class="text-sm mt-2 text-gray-400">é–‹å§‹æ–°å°è©±å¾Œï¼Œæ‚¨çš„å°è©±å…§å®¹å°‡é¡¯ç¤ºåœ¨é€™è£¡</p>
                    </div>
                `;
                return;
            }

            let html = '';
            savedChats.forEach((chat, index) => {
                const date = new Date(chat.timestamp).toLocaleDateString('zh-TW');
                const time = new Date(chat.timestamp).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                const messageCount = chat.conversationHistory.length;
                
                html += `
                    <div class="border border-gray-600 rounded-lg p-4 bg-gray-700 hover:bg-gray-600 transition-colors cursor-pointer" onclick="loadSavedChat('${chat.id}')">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm font-medium text-blue-400">
                                    ğŸ’¬ ${chat.title}
                                </span>
                                <span class="text-xs text-gray-400">${date} ${time}</span>
                            </div>
                            <div class="flex space-x-2">
                                <span class="text-xs text-gray-400">${messageCount} æ¢è¨Šæ¯</span>
                                <button onclick="event.stopPropagation(); deleteSavedChat(${index})" class="text-red-400 hover:text-red-300 text-sm">
                                    åˆªé™¤
                                </button>
                            </div>
                        </div>
                        <div class="text-gray-300 text-sm">
                            <div class="font-medium text-white mb-1">${chat.title}</div>
                            <div class="text-xs text-gray-400">é»æ“Šè¼‰å…¥æ­¤å°è©±</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function loadSavedChat(chatId) {
            const savedChats = JSON.parse(localStorage.getItem('saved_chats') || '[]');
            const chat = savedChats.find(c => c.id === chatId);
            
            if (!chat) {
                alert('æ‰¾ä¸åˆ°æŒ‡å®šçš„å°è©±');
                return;
            }
            
            // ç¢ºèªæ˜¯å¦è¦è¼‰å…¥æ­¤å°è©±
            if (conversationHistory.length > 0) {
                if (!confirm('ç•¶å‰æœ‰æœªä¿å­˜çš„å°è©±å…§å®¹ï¼Œç¢ºå®šè¦è¼‰å…¥é¸ä¸­çš„å°è©±å—ï¼Ÿ')) {
                    return;
                }
            }
            
            // è¼‰å…¥å°è©±å…§å®¹åˆ°èŠå¤©å€åŸŸ
            chatBox.innerHTML = '';
            
            // æ¢å¾©å°è©±æ­·å²
            conversationHistory = [...chat.conversationHistory];
            healingPhase = chat.healingPhase || 'initial';
            
            // é‡æ–°é¡¯ç¤ºæ‰€æœ‰è¨Šæ¯
            conversationHistory.forEach(msg => {
                addMessageToChat(msg.sender, msg.content, false, false); // ä¸ä¿å­˜åˆ°æ­·å²è¨˜éŒ„
            });
            
            // æ›´æ–°éšæ®µé¡¯ç¤º
            if (typeof HealingConfig !== 'undefined') {
                updatePhaseDisplay();
            }
            
            // é—œé–‰å°è©±è¨˜éŒ„è¦–çª—
            closeConversationHistory();
            
            // æ¸…ç©ºè¼¸å…¥æ¡†ä¸¦èšç„¦
            userInput.value = '';
            userInput.focus();
            
            // å•Ÿç”¨è¼¸å…¥
            toggleInput(true);
        }
        
        function deleteSavedChat(index) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ä¿å­˜çš„å°è©±å—ï¼Ÿ')) {
                const savedChats = JSON.parse(localStorage.getItem('saved_chats') || '[]');
                savedChats.splice(index, 1);
                localStorage.setItem('saved_chats', JSON.stringify(savedChats));
                
                // é‡æ–°è¼‰å…¥å°è©±è¨˜éŒ„
                const content = document.getElementById('conversation-history-content');
                loadConversationHistory(content);
            }
        }



        // === æ–°å°è©±åŠŸèƒ½ ===
        function startNewChat() {
            if (confirm('ç¢ºå®šè¦é–‹å§‹æ–°å°è©±å—ï¼Ÿç•¶å‰å°è©±å…§å®¹å°‡è¢«ä¿å­˜ã€‚')) {
                // ä¿å­˜ç•¶å‰å°è©±åˆ° localStorage
                if (conversationHistory.length > 0) {
                    const currentChat = {
                        id: Date.now().toString(),
                        timestamp: new Date().toISOString(),
                        title: generateChatTitle(conversationHistory),
                        conversationHistory: [...conversationHistory],
                        healingPhase: healingPhase
                    };
                    
                    // ç²å–å·²ä¿å­˜çš„å°è©±åˆ—è¡¨
                    const savedChats = JSON.parse(localStorage.getItem('saved_chats') || '[]');
                    savedChats.push(currentChat);
                    localStorage.setItem('saved_chats', JSON.stringify(savedChats));
                }
                
                // æ¸…é™¤èŠå¤©å€åŸŸçš„å…§å®¹
                chatBox.innerHTML = `
                    <!-- Initial AI Message -->
                    <div class="chat-message ai-message">
                        <div class="message-content" id="initial-message">
                            <p class="mt-2" id="user-greeting-message">æœ€è¿‘æœ‰ä»€éº¼è®“æ‚¨æ„Ÿåˆ°å›°æ“¾çš„äº‹ä»¶æˆ–è¡Œç‚ºå—ï¼Ÿ</p>
                        </div>
                    </div>
                     <!-- Thinking Indicator -->
                    <div id="thinking-indicator" class="chat-message ai-message hidden">
                        <div class="message-content thinking-indicator">
                            <span>æ­£åœ¨æ€è€ƒ...</span>
                            <div class="thinking-dot"></div>
                            <div class="thinking-dot"></div>
                            <div class="thinking-dot"></div>
                        </div>
                    </div>
                `;
                
                // é‡ç½®ç™‚ç™’éšæ®µ
                healingPhase = 'initial';
                conversationHistory = [];
                
                // æ›´æ–°éšæ®µé¡¯ç¤º
                if (typeof HealingConfig !== 'undefined') {
                    updatePhaseDisplay();
                }
                
                // æ¸…ç©ºè¼¸å…¥æ¡†ä¸¦èšç„¦
                userInput.value = '';
                userInput.focus();
                
                // å•Ÿç”¨è¼¸å…¥
                toggleInput(true);
            }
        }
        
        // ç”Ÿæˆå°è©±æ¨™é¡Œ
        function generateChatTitle(history) {
            if (history.length === 0) return 'æ–°å°è©±';
            
            // æ‰¾åˆ°ç¬¬ä¸€å€‹ç”¨æˆ¶è¨Šæ¯ä½œç‚ºæ¨™é¡Œ
            const firstUserMessage = history.find(msg => msg.sender === 'user');
            if (firstUserMessage) {
                const content = firstUserMessage.content;
                return content.length > 30 ? content.substring(0, 30) + '...' : content;
            }
            
            return 'æ–°å°è©±';
        }

        // === åˆå§‹åŒ– ===
        document.addEventListener('DOMContentLoaded', async function() {
            // åˆå§‹åŒ–å´é‚Šæ¬„
            initializeSidebar();
            
            // ç¢ºä¿é®ç½©å±¤åœ¨åˆå§‹åŒ–æ™‚ pointer-events æ˜¯ç¦ç”¨çš„
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            if (sidebarOverlay) {
                sidebarOverlay.style.pointerEvents = 'none';
            }
            
            // æª¢æŸ¥æ¸¬è©¦æ¨¡å¼
            checkTestMode();
            
            // æª¢æŸ¥ç”¨æˆ¶èªè­‰ç‹€æ…‹
            checkUserAuth();
            
            // è¼‰å…¥ API é…ç½®
            apiConfig = await loadApiConfig();
            
            // å¾é…ç½®æª”æ›´æ–°è¨­å®šå€¼
            if (apiConfig && apiConfig.settings) {
                DAILY_FREE_LIMIT = apiConfig.settings.dailyFreeLimit;
                USAGE_WARNING_THRESHOLD = apiConfig.settings.usageWarningThreshold;
                MAX_RETRIES = apiConfig.settings.maxRetries;
            }
            
            // è¼‰å…¥æ¯æ—¥ä½¿ç”¨é‡
            loadDailyUsage();
            updateUsageDisplay();
            
            toggleInput(true);
            
            // æª¢æŸ¥ API é‡‘é‘°
            if (!hasValidApiKey()) {
                // API é‡‘é‘°æé†’å°‡åœ¨ç”¨æˆ¶é»æ“Š API è¨­å®šæŒ‰éˆ•æ™‚é¡¯ç¤º
            } else {
                // æª¢æŸ¥ä»Šæ—¥ä½¿ç”¨é‡ç‹€æ…‹
                if (checkUsageLimit()) {
                    setTimeout(() => {
                        addMessageToChat('ai', `â° ä»Šæ—¥å…è²»é¡åº¦å·²ç”¨å®Œï¼\n\næ‚¨ä»Šå¤©å·²ä½¿ç”¨äº† ${dailyUsageCount} æ¬¡å…è²»é¡åº¦ã€‚è«‹æ˜å¤©å†ä¾†ä½¿ç”¨ï¼Œæˆ–è€ƒæ…®å‡ç´šåˆ°ä»˜è²»ç‰ˆæœ¬ã€‚\n\nğŸ’¡ å…è²»é¡åº¦å°‡åœ¨æ˜æ—¥ 00:00 é‡ç½®ã€‚`, false);
                    }, 1500);
                } else if (checkUsageWarning()) {
                    const remaining = DAILY_FREE_LIMIT - dailyUsageCount;
                    setTimeout(() => {
                        addMessageToChat('ai', `âš ï¸ é¡åº¦æé†’ï¼šæ‚¨ä»Šå¤©é‚„å‰© ${remaining} æ¬¡å…è²»ä½¿ç”¨æ©Ÿæœƒã€‚\n\nå»ºè­°çæƒœå‰©é¤˜é¡åº¦ï¼Œæ˜æ—¥å°‡è‡ªå‹•é‡ç½®ã€‚`, false);
                    }, 1500);
                }
            }
            
            // æª¢æŸ¥ç™‚ç™’è¨­å®šæª”æ˜¯å¦è¼‰å…¥ä¸¦åˆå§‹åŒ–
            if (typeof HealingConfig !== 'undefined') {
                HealingConfig.functions.toggleHealingMode(true); // é è¨­å•Ÿç”¨ç™‚ç™’æ¨¡å¼
                updatePhaseDisplay();
            }
        });

        // è™•ç†å´é‚Šæ¬„æ”¶åˆ/å±•é–‹
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const isCollapsed = sidebar.classList.contains('collapsed');
            
            if (isCollapsed) {
                sidebar.classList.remove('collapsed');
                sidebar.classList.add('expanded');
            } else {
                sidebar.classList.remove('expanded');
                sidebar.classList.add('collapsed');
            }
        }

        // iOS å’Œ iPadOS å®‰è£å¼•å°åŠŸèƒ½
        function initIOSInstallGuide() {
            const installPrompt = document.getElementById('ios-install-prompt');
            const installBanner = document.getElementById('ios-install-banner');
            const installModal = document.getElementById('ios-install-modal');
            const installBtn = document.getElementById('ios-install-btn');
            const bannerInstallBtn = document.getElementById('banner-install-btn');
            const bannerCloseBtn = document.getElementById('banner-close-btn');
            const closeModal = document.getElementById('close-install-modal');
            const tryInstallBtn = document.getElementById('try-install-now');

            // ç”¨æˆ¶è¡Œç‚ºè¿½è¹¤å’Œåå¥½è¨­å®š
            let userBehavior = {
                scrollCount: 0,
                clickCount: 0,
                touchCount: 0,
                timeSpent: 0,
                lastInteraction: Date.now(),
                preferredPromptType: null, // 'banner' æˆ– 'button'
                dismissedCount: 0,
                installAttempts: 0
            };

            // æª¢æ¸¬æ˜¯å¦ç‚º iOS è¨­å‚™ï¼ˆiPhoneã€iPadã€iPodï¼‰
            function isIOS() {
                const userAgent = navigator.userAgent;
                const isIOSDevice = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
                
                console.log('ğŸ” iOS æª¢æ¸¬:', {
                    userAgent: userAgent,
                    isIOS: isIOSDevice,
                    hasIPad: /iPad/.test(userAgent),
                    hasIPhone: /iPhone/.test(userAgent),
                    hasIPod: /iPod/.test(userAgent)
                });
                
                return isIOSDevice;
            }

            // æª¢æ¸¬æ˜¯å¦ç‚º iPad
            function isIPad() {
                const userAgent = navigator.userAgent;
                const isIPadDevice = /iPad/.test(userAgent) && !window.MSStream;
                
                console.log('ğŸ“± iPad æª¢æ¸¬:', {
                    userAgent: userAgent,
                    isIPad: isIPadDevice
                });
                
                return isIPadDevice;
            }

            // æª¢æ¸¬æ˜¯å¦ç‚º iPhone
            function isIPhone() {
                const userAgent = navigator.userAgent;
                const isIPhoneDevice = /iPhone/.test(userAgent) && !window.MSStream;
                
                console.log('ğŸ“± iPhone æª¢æ¸¬:', {
                    userAgent: userAgent,
                    isIPhone: isIPhoneDevice
                });
                
                return isIPhoneDevice;
            }

            // æª¢æ¸¬æ˜¯å¦ç‚º Safari ç€è¦½å™¨
            function isSafari() {
                const userAgent = navigator.userAgent;
                const isSafariBrowser = /Safari/i.test(userAgent) && !/Chrome/i.test(userAgent);
                console.log('ğŸŒ Safari æª¢æ¸¬:', { userAgent, isSafari: isSafariBrowser });
                return isSafariBrowser;
            }

            // æª¢æ¸¬æ˜¯å¦å·²å®‰è£ PWA
            function isPWAInstalled() {
                const standalone = window.navigator.standalone === true;
                const displayMode = window.matchMedia('(display-mode: standalone)').matches;
                const isInstalled = standalone || displayMode;
                
                console.log('ğŸ“± PWA å®‰è£æª¢æ¸¬:', {
                    navigator_standalone: standalone,
                    display_mode_standalone: displayMode,
                    isInstalled: isInstalled,
                    userAgent: navigator.userAgent
                });
                
                return isInstalled;
            }

            // æ™ºèƒ½é¸æ“‡å®‰è£æç¤ºé¡å‹
            function getOptimalPromptType() {
                // å¦‚æœç”¨æˆ¶æœ‰åå¥½ï¼Œä½¿ç”¨åå¥½
                if (userBehavior.preferredPromptType) {
                    return userBehavior.preferredPromptType;
                }
                
                // æ ¹æ“šè¨­å‚™é¡å‹é¸æ“‡
                if (isIPad()) {
                    // iPad ç”¨æˆ¶é€šå¸¸æ›´å–œæ­¡æ©«å¹…
                    return Math.random() < 0.8 ? 'banner' : 'button';
                } else {
                    // iPhone ç”¨æˆ¶éš¨æ©Ÿé¸æ“‡
                    return Math.random() < 0.7 ? 'banner' : 'button';
                }
            }

            // é¡¯ç¤ºå®‰è£æç¤º
            function showInstallPrompt() {
                console.log('ğŸ¯ é¡¯ç¤ºå®‰è£æç¤º:', {
                    isIOS: isIOS(),
                    isPWAInstalled: isPWAInstalled(),
                    promptType: getOptimalPromptType()
                });
                
                if (isIOS() && !isPWAInstalled()) {
                    const promptType = getOptimalPromptType();
                    console.log('ğŸ“± é¸æ“‡æç¤ºé¡å‹:', promptType);
                    
                    if (promptType === 'banner') {
                        showBanner();
                    } else {
                        showButton();
                    }
                    
                    // è¨˜éŒ„ç”¨æˆ¶åå¥½
                    userBehavior.preferredPromptType = promptType;
                } else {
                    console.log('âŒ ç„¡æ³•é¡¯ç¤ºå®‰è£æç¤º:', {
                        isIOS: isIOS(),
                        isPWAInstalled: isPWAInstalled()
                    });
                }
            }

            // é¡¯ç¤ºæ©«å¹…
            function showBanner() {
                if (installBanner) {
                    installBanner.classList.remove('hidden');
                    // æ»‘å…¥å‹•ç•«
                    setTimeout(() => {
                        installBanner.classList.remove('-translate-y-full');
                    }, 100);
                    
                    // æ·»åŠ å¸å¼•æ³¨æ„çš„å‹•ç•«
                    installBanner.style.animation = 'install-pulse 2s infinite';
                }
            }

            // é¡¯ç¤ºæŒ‰éˆ•
            function showButton() {
                if (installPrompt) {
                    installPrompt.classList.remove('hidden');
                    // æ·»åŠ å½ˆè·³å‹•ç•«æ•ˆæœ
                    installPrompt.classList.add('animate-bounce');
                    setTimeout(() => {
                        installPrompt.classList.remove('animate-bounce');
                    }, 1000);
                }
            }

            // éš±è—å®‰è£æç¤º
            function hideInstallPrompt() {
                if (installPrompt) installPrompt.classList.add('hidden');
                if (installBanner) {
                    installBanner.classList.add('-translate-y-full');
                    setTimeout(() => {
                        installBanner.classList.add('hidden');
                    }, 500);
                }
                
                // è¨˜éŒ„ç”¨æˆ¶é—œé–‰æ¬¡æ•¸
                userBehavior.dismissedCount++;
            }

            // é¡¯ç¤ºå®‰è£æ¨¡æ…‹æ¡†
            function showInstallModal() {
                installModal.classList.remove('hidden');
                hideInstallPrompt();
                
                // è¨˜éŒ„å®‰è£å˜—è©¦æ¬¡æ•¸
                userBehavior.installAttempts++;
            }

            // éš±è—å®‰è£æ¨¡æ…‹æ¡†
            function hideInstallModal() {
                installModal.classList.add('hidden');
            }

            // å˜—è©¦è§¸ç™¼å®‰è£ï¼ˆé›–ç„¶ç„¡æ³•è‡ªå‹•å®‰è£ï¼Œä½†å¯ä»¥å¼•å°ç”¨æˆ¶ï¼‰
            function tryInstall() {
                // æª¢æŸ¥æ˜¯å¦ä½¿ç”¨ Safari ç€è¦½å™¨
                if (!isSafari()) {
                    const nonSafariDialog = document.createElement('div');
                    nonSafariDialog.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
                    nonSafariDialog.innerHTML = `
                        <div class="bg-white rounded-2xl max-w-lg w-full p-6 shadow-2xl">
                            <div class="text-center mb-6">
                                <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <svg class="w-10 h-10 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                    </svg>
                                </div>
                                <h3 class="text-2xl font-bold text-gray-800 mb-2">âš ï¸ éœ€è¦ Safari ç€è¦½å™¨</h3>
                                <p class="text-gray-600 mb-4">åœ¨ iOS è¨­å‚™ä¸Šå®‰è£ PWA å¿…é ˆä½¿ç”¨ Safari ç€è¦½å™¨</p>
                                
                                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                                    <div class="flex items-start gap-2">
                                        <div class="text-red-600 text-lg">â„¹ï¸</div>
                                        <div class="text-sm text-red-800">
                                            <p class="font-medium mb-1">ç‚ºä»€éº¼å¿…é ˆä½¿ç”¨ Safariï¼Ÿ</p>
                                            <p>ç”±æ–¼ iOS çš„å®‰å…¨æ”¿ç­–ï¼Œåªæœ‰ Safari ç€è¦½å™¨æ”¯æ´ã€ŒåŠ å…¥ä¸»ç•«é¢ã€åŠŸèƒ½ã€‚å…¶ä»–ç€è¦½å™¨ï¼ˆå¦‚ Chromeã€Firefoxï¼‰åœ¨ iOS ä¸Šç„¡æ³•å®‰è£ PWAã€‚</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex gap-3">
                                    <button class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 px-4 rounded-lg transition-colors" onclick="this.closest('.fixed').remove()">
                                        æˆ‘çŸ¥é“äº†
                                    </button>
                                    <button class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-lg transition-colors" onclick="this.closest('.fixed').remove(); window.open('x-web-search://?Safari', '_blank');">
                                        é–‹å•Ÿ Safari
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(nonSafariDialog);
                    
                    // é»æ“Šå¤–éƒ¨é—œé–‰
                    nonSafariDialog.addEventListener('click', (e) => {
                        if (e.target === nonSafariDialog) {
                            nonSafariDialog.remove();
                        }
                    });
                    
                    return;
                }

                let deviceType = '';
                let installSteps = '';
                let shareButtonLocation = '';
                
                if (isIPad()) {
                    deviceType = 'iPad';
                    shareButtonLocation = 'Safari é ‚éƒ¨ç¶²å€åˆ—å³å´';
                    installSteps = `è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿå®‰è£ï¼š\n\n1. é»æ“Š Safari é ‚éƒ¨ç¶²å€åˆ—å³å´çš„åˆ†äº«æŒ‰éˆ•ï¼ˆæ–¹å½¢åœ–ç¤ºï¼‰\n2. åœ¨åˆ†äº«é¸å–®ä¸­é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€\n3. é»æ“Šã€Œæ–°å¢ã€æŒ‰éˆ•\n\nå®‰è£å®Œæˆå¾Œï¼Œæ‚¨å°±å¯ä»¥å¾ä¸»ç•«é¢å•Ÿå‹• Skopos äº†ï¼\n\nğŸ’¡ æç¤ºï¼šåˆ†äº«æŒ‰éˆ•çœ‹èµ·ä¾†åƒä¸€å€‹æ–¹å½¢ï¼Œè£¡é¢æœ‰å€‹ç®­é ­å‘ä¸Šã€‚`;
                } else if (isIPhone()) {
                    deviceType = 'iPhone';
                    shareButtonLocation = 'Safari åº•éƒ¨å·¥å…·åˆ—';
                    installSteps = `è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿå®‰è£ï¼š\n\n1. é»æ“Š Safari åº•éƒ¨åˆ†äº«æŒ‰éˆ•ï¼ˆæ–¹å½¢åœ–ç¤ºï¼‰\n2. åœ¨åˆ†äº«é¸å–®ä¸­é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€\n3. é»æ“Šã€Œæ–°å¢ã€æŒ‰éˆ•\n\nå®‰è£å®Œæˆå¾Œï¼Œæ‚¨å°±å¯ä»¥å¾ä¸»ç•«é¢å•Ÿå‹• Skopos äº†ï¼\n\nğŸ’¡ æç¤ºï¼šåˆ†äº«æŒ‰éˆ•åœ¨åº•éƒ¨å·¥å…·åˆ—ï¼Œçœ‹èµ·ä¾†åƒä¸€å€‹æ–¹å½¢ï¼Œè£¡é¢æœ‰å€‹ç®­é ­å‘ä¸Šã€‚`;
                } else {
                    deviceType = 'iOS è¨­å‚™';
                    shareButtonLocation = 'Safari ç€è¦½å™¨';
                    installSteps = `è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿå®‰è£ï¼š\n\n1. é»æ“Š Safari çš„åˆ†äº«æŒ‰éˆ•ï¼ˆæ–¹å½¢åœ–ç¤ºï¼‰\n2. åœ¨åˆ†äº«é¸å–®ä¸­é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€\n3. é»æ“Šã€Œæ–°å¢ã€æŒ‰éˆ•\n\nå®‰è£å®Œæˆå¾Œï¼Œæ‚¨å°±å¯ä»¥å¾ä¸»ç•«é¢å•Ÿå‹• Skopos äº†ï¼\n\nğŸ’¡ æç¤ºï¼šåˆ†äº«æŒ‰éˆ•çœ‹èµ·ä¾†åƒä¸€å€‹æ–¹å½¢ï¼Œè£¡é¢æœ‰å€‹ç®­é ­å‘ä¸Šã€‚`;
                }
                
                // å‰µå»ºæ›´å‹å¥½çš„å®‰è£èªªæ˜å°è©±æ¡†
                const installDialog = document.createElement('div');
                installDialog.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
                installDialog.innerHTML = `
                    <div class="bg-white rounded-2xl max-w-lg w-full p-6 shadow-2xl">
                        <div class="text-center mb-6">
                            <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-10 h-10 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">${deviceType} å®‰è£æŒ‡å—</h3>
                            <p class="text-gray-600">è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿå°‡ Skopos å®‰è£åˆ°æ‚¨çš„ä¸»ç•«é¢</p>
                        </div>
                        
                        <div class="space-y-4 mb-6 text-left">
                            <div class="flex items-start gap-3">
                                <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0 mt-0.5">1</div>
                                <div>
                                    <p class="font-medium text-gray-800">æ‰¾åˆ°åˆ†äº«æŒ‰éˆ•</p>
                                    <p class="text-sm text-gray-600">ä½ç½®ï¼š${shareButtonLocation}</p>
                                    <p class="text-xs text-blue-600 mt-1">ğŸ’¡ åˆ†äº«æŒ‰éˆ•çœ‹èµ·ä¾†åƒä¸€å€‹æ–¹å½¢ï¼Œè£¡é¢æœ‰å€‹ç®­é ­å‘ä¸Š</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0 mt-0.5">2</div>
                                <div>
                                    <p class="font-medium text-gray-800">é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</p>
                                    <p class="text-sm text-gray-600">åœ¨åˆ†äº«é¸å–®ä¸­æ‰¾åˆ°æ­¤é¸é …</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0 mt-0.5">3</div>
                                <div>
                                    <p class="font-medium text-gray-800">é»æ“Šã€Œæ–°å¢ã€</p>
                                    <p class="text-sm text-gray-600">å®Œæˆå®‰è£ï¼Œæ‡‰ç”¨ç¨‹å¼å°‡å‡ºç¾åœ¨ä¸»ç•«é¢</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                            <div class="flex items-start gap-2">
                                <div class="text-blue-600 text-lg">â„¹ï¸</div>
                                <div class="text-sm text-blue-800">
                                    <p class="font-medium mb-1">ç‚ºä»€éº¼éœ€è¦æ‰‹å‹•å®‰è£ï¼Ÿ</p>
                                    <p>ç”±æ–¼ iOS çš„å®‰å…¨æ”¿ç­–ï¼ŒPWA ç„¡æ³•è‡ªå‹•å®‰è£ã€‚é€™æ˜¯ç‚ºäº†ä¿è­·æ‚¨çš„è¨­å‚™å®‰å…¨ï¼Œè«‹æŒ‰ç…§ä¸Šè¿°æ­¥é©Ÿæ‰‹å‹•å®‰è£ã€‚</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <button class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 px-4 rounded-lg transition-colors" onclick="this.closest('.fixed').remove()">
                                æˆ‘æ˜ç™½äº†
                            </button>
                            <button class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-lg transition-colors" onclick="this.closest('.fixed').remove(); showInstallModal();">
                                å†æ¬¡æŸ¥çœ‹æ­¥é©Ÿ
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(installDialog);
                
                // é»æ“Šå¤–éƒ¨é—œé–‰
                installDialog.addEventListener('click', (e) => {
                    if (e.target === installDialog) {
                        installDialog.remove();
                    }
                });
                
                hideInstallModal();
            }

            // æ™ºèƒ½è§¸ç™¼å®‰è£æç¤º
            function triggerInstallPrompt() {
                console.log('ğŸ” è§¸ç™¼å®‰è£æç¤ºæª¢æŸ¥:', {
                    isIOS: isIOS(),
                    isPWAInstalled: isPWAInstalled(),
                    userAgent: navigator.userAgent
                });
                
                if (isIOS() && !isPWAInstalled()) {
                    // æ ¹æ“šç”¨æˆ¶è¡Œç‚ºèª¿æ•´è§¸ç™¼ç­–ç•¥
                    const shouldShow = shouldTriggerPrompt();
                    console.log('ğŸ“± iOS è¨­å‚™ï¼Œæ‡‰è©²é¡¯ç¤º:', shouldShow);
                    
                    if (shouldShow) {
                        showInstallPrompt();
                    }
                } else {
                    console.log('âŒ ä¸ç¬¦åˆé¡¯ç¤ºæ¢ä»¶:', {
                        isIOS: isIOS(),
                        isPWAInstalled: isPWAInstalled()
                    });
                }
            }

            // åˆ¤æ–·æ˜¯å¦æ‡‰è©²è§¸ç™¼æç¤º
            function shouldTriggerPrompt() {
                const now = Date.now();
                const timeSinceLastInteraction = now - userBehavior.lastInteraction;
                
                // å¦‚æœç”¨æˆ¶å‰›é—œé–‰æç¤ºï¼Œå»¶é²é¡¯ç¤º
                if (userBehavior.dismissedCount > 0) {
                    const delayMinutes = Math.min(userBehavior.dismissedCount * 2, 10); // æœ€å¤šå»¶é²10åˆ†é˜
                    if (timeSinceLastInteraction < delayMinutes * 60 * 1000) {
                        return false;
                    }
                }
                
                // å¦‚æœç”¨æˆ¶å¤šæ¬¡å˜—è©¦å®‰è£ï¼Œå¢åŠ è§¸ç™¼é »ç‡
                if (userBehavior.installAttempts > 2) {
                    return true;
                }
                
                // æ ¹æ“šæ™‚é–“é–“éš”åˆ¤æ–·
                if (timeSinceLastInteraction < 30000) { // 30ç§’å…§ä¸é‡è¤‡é¡¯ç¤º
                    return false;
                }
                
                return true;
            }

            // äº‹ä»¶ç›£è½å™¨
            installBtn.addEventListener('click', showInstallModal);
            bannerInstallBtn.addEventListener('click', showInstallModal);
            bannerCloseBtn.addEventListener('click', hideInstallPrompt);
            closeModal.addEventListener('click', hideInstallModal);
            tryInstallBtn.addEventListener('click', tryInstall);

            // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
            installModal.addEventListener('click', (e) => {
                if (e.target === installModal) {
                    hideInstallModal();
                }
            });

            // å¤šç¨®è§¸ç™¼å®‰è£æç¤ºçš„æ–¹å¼
            function triggerInstallPrompt() {
                if (isIOS() && !isPWAInstalled()) {
                    // æ ¹æ“šç”¨æˆ¶è¡Œç‚ºèª¿æ•´è§¸ç™¼ç­–ç•¥
                    const shouldShow = shouldTriggerPrompt();
                    
                    if (shouldShow) {
                        showInstallPrompt();
                    }
                }
            }

            // æ™ºèƒ½å®‰è£é€²åº¦è¿½è¹¤
            function trackInstallProgress() {
                const progress = {
                    step1: userBehavior.installAttempts > 0, // ç”¨æˆ¶å˜—è©¦å®‰è£
                    step2: userBehavior.installAttempts > 1, // ç”¨æˆ¶å¤šæ¬¡å˜—è©¦
                    step3: userBehavior.installAttempts > 2, // ç”¨æˆ¶æŒçºŒå˜—è©¦
                    step4: userBehavior.timeSpent > 300,    // ç”¨æˆ¶åœç•™è¶…é5åˆ†é˜
                    step5: userBehavior.scrollCount > 20    // ç”¨æˆ¶ç©æ¥µç€è¦½
                };
                
                // æ ¹æ“šé€²åº¦æä¾›å€‹æ€§åŒ–æç¤º
                if (progress.step1 && !progress.step2) {
                    showPersonalizedTip('first-attempt');
                } else if (progress.step2 && !progress.step3) {
                    showPersonalizedTip('second-attempt');
                } else if (progress.step3) {
                    showPersonalizedTip('persistent-user');
                } else if (progress.step4) {
                    showPersonalizedTip('engaged-user');
                } else if (progress.step5) {
                    showPersonalizedTip('active-browser');
                }
            }

            // é¡¯ç¤ºå€‹æ€§åŒ–å®‰è£æç¤º
            function showPersonalizedTip(tipType) {
                const tips = {
                    'first-attempt': {
                        title: 'ğŸ¯ ç¬¬ä¸€æ¬¡å˜—è©¦å®‰è£ï¼Ÿ',
                        message: 'æˆ‘å€‘æœƒå¼•å°æ‚¨å®Œæˆæ•´å€‹éç¨‹ï¼Œåˆ¥æ“”å¿ƒï¼',
                        color: 'blue'
                    },
                    'second-attempt': {
                        title: 'ğŸ”„ å†æ¬¡å˜—è©¦å®‰è£',
                        message: 'çœ‹èµ·ä¾†æ‚¨å° Skopos å¾ˆæ„Ÿèˆˆè¶£ï¼Œè®“æˆ‘å€‘ä¸€èµ·å®Œæˆå®‰è£ï¼',
                        color: 'green'
                    },
                    'persistent-user': {
                        title: 'ğŸ’ª å …æŒå°±æ˜¯å‹åˆ©ï¼',
                        message: 'æ‚¨çš„å …æŒè®“æˆ‘å€‘æ„Ÿå‹•ï¼Œè®“æˆ‘å€‘ä¸€èµ·è§£æ±ºå®‰è£å•é¡Œï¼',
                        color: 'purple'
                    },
                    'engaged-user': {
                        title: 'â° æ‚¨å·²ç¶“åœç•™å¾ˆä¹…äº†',
                        message: 'æ—¢ç„¶æ‚¨é€™éº¼å–œæ­¡ Skoposï¼Œä¸å¦‚å®‰è£åˆ°ä¸»ç•«é¢éš¨æ™‚ä½¿ç”¨ï¼Ÿ',
                        color: 'orange'
                    },
                    'active-browser': {
                        title: 'ğŸ“± ç©æ¥µçš„ç€è¦½è€…',
                        message: 'æ‚¨å°å…§å®¹å¾ˆæ„Ÿèˆˆè¶£ï¼Œå®‰è£å¾Œå¯ä»¥é›¢ç·šé–±è®€å“¦ï¼',
                        color: 'teal'
                    }
                };
                
                const tip = tips[tipType];
                if (!tip) return;
                
                // å‰µå»ºå€‹æ€§åŒ–æç¤ºæ©«å¹…
                const tipBanner = document.createElement('div');
                tipBanner.className = `fixed top-20 left-4 right-4 bg-${tip.color}-500 text-white p-4 rounded-lg shadow-lg z-30 transform translate-x-full transition-transform duration-500`;
                tipBanner.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl">${tip.title.split(' ')[0]}</div>
                            <div>
                                <p class="font-semibold">${tip.title.split(' ').slice(1).join(' ')}</p>
                                <p class="text-sm opacity-90">${tip.message}</p>
                            </div>
                        </div>
                        <button class="text-white hover:text-gray-200 transition-colors" onclick="this.parentElement.parentElement.remove()">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>
                `;
                
                document.body.appendChild(tipBanner);
                
                // æ»‘å…¥å‹•ç•«
                setTimeout(() => {
                    tipBanner.classList.remove('translate-x-full');
                }, 100);
                
                // 5ç§’å¾Œè‡ªå‹•æ»‘å‡º
                setTimeout(() => {
                    tipBanner.classList.add('translate-x-full');
                    setTimeout(() => {
                        tipBanner.remove();
                    }, 500);
                }, 5000);
            }

            // 1. é é¢è¼‰å…¥å¾Œç«‹å³é¡¯ç¤ºï¼ˆç¸®çŸ­å»¶é²ï¼‰
            setTimeout(() => {
                console.log('â° å»¶é²1ç§’å¾Œè§¸ç™¼å®‰è£æç¤º');
                triggerInstallPrompt();
            }, 1000);

            // 2. é é¢è¼‰å…¥å®Œæˆå¾Œå†æ¬¡æª¢æŸ¥
            setTimeout(() => {
                console.log('â° å»¶é²3ç§’å¾Œè§¸ç™¼å®‰è£æç¤º');
                triggerInstallPrompt();
            }, 3000);

            // 3. ç”¨æˆ¶ç©æ¥µç€è¦½æ™‚è§¸ç™¼
            window.addEventListener('scroll', () => {
                userBehavior.scrollCount++;
                userBehavior.lastInteraction = Date.now();
                
                if (userBehavior.scrollCount === 5 || userBehavior.scrollCount === 15 || userBehavior.scrollCount === 30) {
                    console.log('ğŸ“œ æ»¾å‹•è§¸ç™¼å®‰è£æç¤ºï¼Œæ»¾å‹•æ¬¡æ•¸:', userBehavior.scrollCount);
                    triggerInstallPrompt();
                }
            });

            // 4. ç”¨æˆ¶é»æ“Šé é¢æ™‚è§¸ç™¼
            document.addEventListener('click', (e) => {
                // æ’é™¤å®‰è£ç›¸é—œæŒ‰éˆ•çš„é»æ“Š
                if (!e.target.closest('#ios-install-prompt') && !e.target.closest('#ios-install-modal') && !e.target.closest('#ios-install-banner')) {
                    userBehavior.clickCount++;
                    userBehavior.lastInteraction = Date.now();
                    
                    if (userBehavior.clickCount === 3 || userBehavior.clickCount === 8) {
                        console.log('ğŸ–±ï¸ é»æ“Šè§¸ç™¼å®‰è£æç¤ºï¼Œé»æ“Šæ¬¡æ•¸:', userBehavior.clickCount);
                        triggerInstallPrompt();
                    }
                }
            });

            // 5. ç”¨æˆ¶åœ¨é é¢åœç•™æ™‚é–“è§¸ç™¼
            setTimeout(() => {
                console.log('â° å»¶é²10ç§’å¾Œè§¸ç™¼å®‰è£æç¤º');
                triggerInstallPrompt();
            }, 10000); // 10ç§’å¾Œ
            setTimeout(() => {
                console.log('â° å»¶é²30ç§’å¾Œè§¸ç™¼å®‰è£æç¤º');
                triggerInstallPrompt();
            }, 30000); // 30ç§’å¾Œ

            // 6. ç›£è½ PWA å®‰è£ç‹€æ…‹è®ŠåŒ–
            window.addEventListener('beforeinstallprompt', () => {
                hideInstallPrompt();
            });

            // 7. å¦‚æœå·²ç¶“å®‰è£ï¼Œéš±è—æç¤º
            if (isPWAInstalled()) {
                hideInstallPrompt();
            }

            // 8. å®šæœŸæª¢æŸ¥å®‰è£ç‹€æ…‹ï¼ˆæ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡ï¼‰
            setInterval(() => {
                console.log('â° å®šæœŸæª¢æŸ¥å®‰è£ç‹€æ…‹');
                if (isPWAInstalled()) {
                    console.log('âœ… PWA å·²å®‰è£ï¼Œéš±è—æç¤º');
                    hideInstallPrompt();
                    // é¡¯ç¤ºå®‰è£æˆåŠŸæ…¶ç¥å‹•ç•«
                    showInstallSuccessCelebration();
                } else if (isIOS()) {
                    console.log('ğŸ“± iOS è¨­å‚™ï¼Œå†æ¬¡è§¸ç™¼å®‰è£æç¤º');
                    // å¦‚æœé‚„æ²’å®‰è£ï¼Œå†æ¬¡é¡¯ç¤ºæç¤º
                    triggerInstallPrompt();
                } else {
                    console.log('âŒ ä¸æ˜¯iOSè¨­å‚™æˆ–PWAå·²å®‰è£');
                }
            }, 60000);

            // 9. ç”¨æˆ¶è§¸æ‘¸è¢å¹•æ™‚è§¸ç™¼ï¼ˆç§»å‹•è¨­å‚™ï¼‰
            document.addEventListener('touchstart', () => {
                userBehavior.touchCount++;
                userBehavior.lastInteraction = Date.now();
                
                if (userBehavior.touchCount === 2 || userBehavior.touchCount === 5 || userBehavior.touchCount === 10) {
                    console.log('ğŸ‘† è§¸æ‘¸è§¸ç™¼å®‰è£æç¤ºï¼Œè§¸æ‘¸æ¬¡æ•¸:', userBehavior.touchCount);
                    triggerInstallPrompt();
                }
            });

            // 10. ç”¨æˆ¶åˆ‡æ›é é¢å¯è¦‹æ€§æ™‚è§¸ç™¼
            document.addEventListener('visibilitychange', () => {
                console.log('ğŸ‘ï¸ é é¢å¯è¦‹æ€§è®ŠåŒ–:', {
                    hidden: document.hidden,
                    isIOS: isIOS(),
                    isPWAInstalled: isPWAInstalled()
                });
                if (!document.hidden && isIOS() && !isPWAInstalled()) {
                    console.log('â° é é¢å¯è¦‹æ™‚ï¼Œå»¶é²2ç§’è§¸ç™¼å®‰è£æç¤º');
                    setTimeout(triggerInstallPrompt, 2000);
                }
            });

            // 11. ç”¨æˆ¶è¿”å›é é¢æ™‚è§¸ç™¼
            window.addEventListener('pageshow', () => {
                console.log('ğŸ”„ é é¢é¡¯ç¤ºäº‹ä»¶è§¸ç™¼');
                if (isIOS() && !isPWAInstalled()) {
                    console.log('â° é é¢é¡¯ç¤ºæ™‚ï¼Œå»¶é²3ç§’è§¸ç™¼å®‰è£æç¤º');
                    setTimeout(triggerInstallPrompt, 3000);
                }
            });

            // 12. è¿½è¹¤ç”¨æˆ¶åœ¨é é¢çš„æ™‚é–“
            setInterval(() => {
                userBehavior.timeSpent += 1;
                
                // æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡æ˜¯å¦æ‡‰è©²è§¸ç™¼æç¤º
                if (userBehavior.timeSpent % 60 === 0) {
                    console.log('â° æ¯åˆ†é˜è§¸ç™¼å®‰è£æç¤ºæª¢æŸ¥ï¼Œæ™‚é–“:', userBehavior.timeSpent);
                    triggerInstallPrompt();
                    // åŒæ™‚æª¢æŸ¥å®‰è£é€²åº¦
                    trackInstallProgress();
                }
            }, 1000);

            // 13. å®‰è£æˆåŠŸæ…¶ç¥å‹•ç•«
            function showInstallSuccessCelebration() {
                // å‰µå»ºæ…¶ç¥å‹•ç•«å…ƒç´ 
                const celebration = document.createElement('div');
                celebration.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
                celebration.innerHTML = `
                    <div class="celebration-container bg-white rounded-2xl p-8 text-center max-w-sm mx-4 shadow-2xl">
                        <div class="text-6xl mb-4 install-celebration">ğŸ‰</div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">å®‰è£æˆåŠŸï¼</h3>
                        <p class="text-gray-600 mb-6">Skopos å·²æˆåŠŸå®‰è£åˆ°æ‚¨çš„ä¸»ç•«é¢</p>
                        <div class="flex gap-3">
                            <button class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-medium transition-all duration-300 transform hover:scale-105">
                                é–‹å§‹ä½¿ç”¨
                            </button>
                            <button class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 rounded-lg font-medium transition-all duration-300 transform hover:scale-105">
                                äº†è§£æ›´å¤š
                            </button>
                        </div>
                        <div class="mt-4 text-xs text-gray-500">
                            ğŸ’¡ æç¤ºï¼šå¾ä¸»ç•«é¢å•Ÿå‹•æœƒæ›´å¿«æ›´æµæš¢
                        </div>
                    </div>
                `;
                
                document.body.appendChild(celebration);
                
                // æ·»åŠ ç²’å­æ•ˆæœ
                createCelebrationParticles();
                
                // 3ç§’å¾Œè‡ªå‹•é—œé–‰
                setTimeout(() => {
                    celebration.style.opacity = '0';
                    celebration.style.transform = 'scale(0.8)';
                    setTimeout(() => {
                        celebration.remove();
                    }, 300);
                }, 3000);
                
                // é»æ“Šé—œé–‰
                celebration.addEventListener('click', (e) => {
                    if (e.target === celebration) {
                        celebration.style.opacity = '0';
                        celebration.style.transform = 'scale(0.8)';
                        setTimeout(() => {
                            celebration.remove();
                        }, 300);
                    }
                });
            }

            // å‰µå»ºæ…¶ç¥ç²’å­æ•ˆæœ
            function createCelebrationParticles() {
                const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7'];
                
                for (let i = 0; i < 20; i++) {
                    setTimeout(() => {
                        const particle = document.createElement('div');
                        particle.className = 'fixed z-40 w-2 h-2 rounded-full pointer-events-none';
                        particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                        particle.style.left = Math.random() * window.innerWidth + 'px';
                        particle.style.top = window.innerHeight + 'px';
                        
                        document.body.appendChild(particle);
                        
                        // ç²’å­å‹•ç•«
                        const animation = particle.animate([
                            { 
                                transform: 'translateY(0) scale(1)',
                                opacity: 1
                            },
                            { 
                                transform: `translateY(-${window.innerHeight + 100}px) scale(0)`,
                                opacity: 0
                            }
                        ], {
                            duration: 2000 + Math.random() * 1000,
                            easing: 'ease-out'
                        });
                        
                        animation.onfinish = () => particle.remove();
                    }, i * 100);
                }
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initResponsiveSidebar();
            initIOSInstallGuide();
            
            // æ·»åŠ æ‰‹å‹•æ¸¬è©¦æŒ‰éˆ•ï¼ˆåƒ…åœ¨é–‹ç™¼æ¨¡å¼ä¸‹é¡¯ç¤ºï¼‰
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                const testButton = document.createElement('button');
                testButton.textContent = 'ğŸ§ª æ¸¬è©¦iOSå®‰è£';
                testButton.className = 'fixed bottom-4 left-4 bg-red-500 text-white px-3 py-2 rounded-lg z-50 text-sm';
                testButton.onclick = () => {
                    console.log('ğŸ§ª æ‰‹å‹•æ¸¬è©¦iOSå®‰è£æç¤º');
                    if (typeof triggerInstallPrompt === 'function') {
                        triggerInstallPrompt();
                    } else {
                        console.error('âŒ triggerInstallPrompt å‡½æ•¸æœªæ‰¾åˆ°');
                    }
                };
                document.body.appendChild(testButton);
            }
        });
    </script>

    <!-- iOS å’Œ iPadOS å®‰è£å¼•å°æŒ‰éˆ• -->
    <div id="ios-install-prompt" class="fixed top-4 right-4 z-50 hidden">
        <button id="ios-install-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 transition-all duration-300 transform hover:scale-105 install-pulse">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
            </svg>
            å®‰è£åˆ°ä¸»ç•«é¢
            <span class="text-xs opacity-75">(éœ€Safari)</span>
        </button>
    </div>

    <!-- iOS å’Œ iPadOS å®‰è£æç¤ºæ©«å¹… -->
    <div id="ios-install-banner" class="fixed top-0 left-0 right-0 bg-gradient-to-r from-blue-500 to-purple-600 text-white p-3 z-40 hidden transform -translate-y-full transition-transform duration-500">
        <div class="flex items-center justify-between max-w-4xl mx-auto">
            <div class="flex items-center gap-3">
                <svg class="w-6 h-6 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
                <div>
                    <p class="font-semibold">ğŸš€ å°‡ Skopos å®‰è£åˆ°ä¸»ç•«é¢</p>
                    <p class="text-sm opacity-90">äº«å—æ›´å¿«çš„å•Ÿå‹•é€Ÿåº¦å’Œé›¢ç·šåŠŸèƒ½</p>
                    <p class="text-xs opacity-75 mt-1">âš ï¸ å¿…é ˆä½¿ç”¨ Safari ç€è¦½å™¨</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button id="banner-install-btn" class="bg-white text-blue-600 px-4 py-2 rounded-lg font-medium hover:bg-gray-100 transition-colors">
                    ç«‹å³å®‰è£
                </button>
                <button id="banner-close-btn" class="text-white hover:text-gray-200 transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- iOS å’Œ iPadOS å®‰è£å¼•å°æ¨¡æ…‹æ¡† -->
    <div id="ios-install-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-md w-full p-6 shadow-2xl">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">å®‰è£ Skopos åˆ°ä¸»ç•«é¢</h3>
                <p class="text-gray-600">æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿå°‡ Skopos å®‰è£åˆ°æ‚¨çš„ä¸»ç•«é¢ï¼ˆæ”¯æ´ iPhone å’Œ iPadï¼‰</p>
                <p class="text-sm text-red-600 font-medium mt-2">âš ï¸ é‡è¦ï¼šå¿…é ˆä½¿ç”¨ Safari ç€è¦½å™¨æ‰èƒ½å®‰è£</p>
            </div>
            
            <div class="space-y-4 mb-6">
                <div class="flex items-start gap-3">
                    <div class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0 mt-0.5">1</div>
                    <div>
                        <p class="font-medium text-gray-800">é»æ“Šåˆ†äº«æŒ‰éˆ•</p>
                        <p class="text-sm text-gray-600">iPhoneï¼šåœ¨ Safari åº•éƒ¨ | iPadï¼šåœ¨ç¶²å€åˆ—å³å´</p>
                        <p class="text-xs text-red-500 mt-1">ğŸ’¡ è«‹ç¢ºä¿æ‚¨æ­£åœ¨ä½¿ç”¨ Safari ç€è¦½å™¨</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <div class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0 mt-0.5">2</div>
                    <div>
                        <p class="font-medium text-gray-800">é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</p>
                        <p class="text-sm text-gray-600">åœ¨åˆ†äº«é¸å–®ä¸­æ‰¾åˆ°æ­¤é¸é …</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <div class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0 mt-0.5">3</div>
                    <div>
                        <p class="font-medium text-gray-800">é»æ“Šã€Œæ–°å¢ã€</p>
                        <p class="text-sm text-gray-600">å®Œæˆå®‰è£ï¼Œæ‡‰ç”¨ç¨‹å¼å°‡å‡ºç¾åœ¨ä¸»ç•«é¢</p>
                    </div>
                </div>
            </div>

            <div class="flex gap-3">
                <button id="close-install-modal" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg transition-colors">
                    é—œé–‰
                </button>
                <button id="try-install-now" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg transition-colors">
                    ç«‹å³å˜—è©¦
                </button>
            </div>
        </div>
    </div>

</body>
</html>

