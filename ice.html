<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obyssey</title>
    
    <!-- iOS PWA 支援 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Obyssey">
    <meta name="apple-touch-fullscreen" content="yes">
    
    <!-- PWA 相關 -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192x192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- 載入療癒功能設定檔 -->
    <script src="healing-config.js"></script>
    
    <!-- 載入 API 配置檔 -->
    <script>
        // 載入 API 配置
        let apiConfig = null;
        
        async function loadApiConfig() {
            try {
                const response = await fetch('./api-config.json');
                if (response.ok) {
                    apiConfig = await response.json();
                    return apiConfig;
                } else {
                    return getDefaultConfig();
                }
            } catch (error) {
                return getDefaultConfig();
            }
        }
        
        function getDefaultConfig() {
            return {
                apiConfig: {
                    defaultApiKey: "",
                    endpoints: {
                        vercel: [
                            "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=",
                            "https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key="
                        ],
                        local: [
                            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=",
                            "https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key="
                        ]
                    },
                    testEndpoints: [
                        "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key="
                    ]
                },
                settings: {
                    dailyFreeLimit: 50,
                    usageWarningThreshold: 40,
                    maxRetries: 2,
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 1000
                    }
                }
            };
        }
    </script>
    
    <style>
        /* 手機版側邊欄全螢幕覆蓋 */
        @media (max-width: 767px) {
            #sidebar {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                min-width: 0 !important;
                max-width: none !important;
                height: 100vh !important;
                z-index: 100;
                box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
                transition: transform 0.3s;
            }
            .sidebar-open #sidebar {
                transform: translateX(0) !important;
            }
            .sidebar-open #sidebar-overlay {
                display: block !important;
            }
            #sidebar-overlay {
                display: none;
            }
        }
        :root {
            --bg-primary: #131314;
            --bg-secondary: #1e1f20;
            --bg-tertiary: #2a2b2c;
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --border-color: #3c4043;
            --accent-blue: #8ab4f8;
            --gemini-gradient: linear-gradient(135deg, #4285f4, #ea4335, #fbbc04, #34a853);
            --mini-sidebar-width: 56px; /* 桌面收合時的小側欄寬度（加寬以免過窄） */
        }

        /* 安裝提示動畫 */
        @keyframes install-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes install-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        @keyframes install-bounce {
            0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
            40%, 43% { transform: translate3d(0,-30px,0); }
            70% { transform: translate3d(0,-15px,0); }
            90% { transform: translate3d(0,-4px,0); }
        }

        @keyframes install-slide-in {
            0% { transform: translateY(-100%); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        @keyframes install-celebration {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(180deg); opacity: 1; }
            100% { transform: scale(1) rotate(360deg); opacity: 1; }
        }

        .install-pulse {
            animation: install-pulse 2s infinite;
        }

        .install-shake {
            animation: install-shake 0.5s ease-in-out;
        }

        .install-bounce {
            animation: install-bounce 1s ease-in-out;
        }

        .install-slide-in {
            animation: install-slide-in 0.5s ease-out;
        }

        .install-celebration {
            animation: install-celebration 0.8s ease-out;
        }

        /* 智能安裝提示樣式 */
        #ios-install-banner {
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        #ios-install-banner:hover {
            transform: translateY(0) scale(1.02);
            transition: all 0.3s ease;
        }

        #ios-install-btn {
            position: relative;
            overflow: hidden;
        }

        #ios-install-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        #ios-install-btn:hover::before {
            left: 100%;
        }

        /* 安裝成功慶祝動畫容器 */
        .celebration-container {
            animation: install-celebration 0.8s ease-out;
        }

        /* 響應式安裝提示 */
        @media (max-width: 640px) {
            #ios-install-banner {
                padding: 0.75rem;
            }
            
            #ios-install-banner .flex {
                flex-direction: column;
                gap: 0.75rem;
                text-align: center;
            }
            
            #ios-install-banner .flex > div:first-child {
                order: 2;
            }
            
            #ios-install-banner .flex > div:last-child {
                order: 1;
            }
        }

        body {
            font-family: 'Google Sans', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        .gemini-container {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
        }
        .chat-header {
            border-bottom: 1px solid var(--border-color);
        }
        .chat-message {
            margin-bottom: 16px;
            display: flex;
            width: 100%;
        }
        .ai-message {
            justify-content: flex-start;
        }
        .user-message {
            justify-content: flex-end;
        }
        .ai-message .message-content {
            background-color: var(--bg-tertiary);
            border-bottom-left-radius: 4px;
        }
        .user-message .message-content {
            background-color: var(--accent-blue);
            color: var(--bg-primary);
            border-bottom-right-radius: 4px;
        }
        .message-content {
            padding: 12px 16px;
            border-radius: 18px;
            display: inline-block;
            max-width: 70%;
            word-wrap: break-word;
        }
        .input-area {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 24px;
        }
        .message-input {
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            width: 100%;
        }
        .send-button {
            background-color: var(--accent-blue);
            color: var(--bg-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            /* 確保手機版 SVG 圖標正常顯示 */
            min-width: 40px;
            min-height: 40px;
            flex-shrink: 0;
        }
        .send-button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }
        .thinking-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            justify-content: flex-start;
        }
        .thinking-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-blue);
            border-radius: 50%;
            animation: thinking-pulse 1.4s ease-in-out infinite both;
        }
        .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes thinking-pulse {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        .phase-indicator {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            color: var(--text-secondary);
            display: inline-block;
            margin-bottom: 16px;
        }
        .retry-button {
            transition: all 0.2s ease;
        }
        .retry-button:hover {
            background-color: var(--text-primary) !important;
            transform: scale(1.1);
        }
        /* 桌面版：側欄收合狀態樣式 */
        @media (min-width: 768px) {
            .sidebar-collapsed .app {
                grid-template-columns: var(--mini-sidebar-width) 1fr !important;
            }
            .sidebar-collapsed #sidebar {
                width: var(--mini-sidebar-width) !important;
                min-width: var(--mini-sidebar-width) !important;
                max-width: var(--mini-sidebar-width) !important;
                overflow: hidden !important;
            }
            /* 收合與展開模式下顯示/隱藏不同內容 */
            #sidebar .collapsed-only { display: none; }
            .sidebar-collapsed #sidebar .collapsed-only { display: flex; }
            .sidebar-collapsed #sidebar .expanded-only { display: none; }
        }
        
        /* 用戶頭像和個人資料樣式 */
        .user-avatar-container {
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            width: 100%;
        }
        
        .user-avatar-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #4a5568;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .user-avatar-text {
            color: white;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .user-profile-info {
            flex: 1;
            text-align: center;
            width: 100%;
        }
        
        .user-name {
            color: white;
            font-size: 16px;
            font-weight: 500;
            /* 確保文字沒有背景 */
            background: transparent;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        /* 手機版：優化佈局和間距 */
        @media (max-width: 767px) {
            .input-area {
                gap: 8px;
            }
            .send-button svg {
                width: 20px;
                height: 20px;
            }
            .chat-header h1 {
                margin-left: 4rem;
            }
            
            /* 手機版用戶頭像優化 */
            .user-avatar-circle {
                width: 40px;
                height: 40px;
            }
            
            .user-avatar-text {
                font-size: 18px;
            }
            
            .user-name {
                font-size: 14px;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="app md:grid md:grid-cols-[auto_1fr] md:h-screen md:gap-0">
    <script>
    // 手機版側邊欄開關（修正版，避免重複掛載與錯誤）
    document.addEventListener('DOMContentLoaded', function() {
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        if (sidebarToggle && overlay) {
            sidebarToggle.addEventListener('click', function() {
                document.body.classList.add('sidebar-open');
                overlay.style.display = 'block';
            });
            overlay.addEventListener('click', function() {
                document.body.classList.remove('sidebar-open');
                overlay.style.display = 'none';
            });
        }
    });
    </script>
    <!-- ===== 側邊欄系統 ===== -->
    <!-- 
    側邊欄位置說明：
    - 切換按鈕：固定在左上角 (top-4 left-4)，z-index: 50 確保在最上層
    - 側邊欄面板：固定在左側 (top-0 left-0)，寬度 320px (w-80)，初始位置在螢幕外 (-translate-x-full)
    - 遮罩層：覆蓋整個螢幕 (inset-0)，z-index: 30 低於側邊欄但高於其他內容
    - 側邊欄 z-index: 40，確保在遮罩層之上但在切換按鈕之下
    -->
    
    <!-- 側邊欄切換按鈕 - 固定在左上角位置 -->
    <div class="fixed top-4 left-4 z-50 md:hidden">
        <button id="sidebar-toggle" class="text-gray-400 hover:text-white p-2 rounded-lg hover:bg-gray-700 bg-gray-800 border border-gray-600" title="設定選單">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="4" y="6" width="16" height="2" rx="1" fill="currentColor"/>
                <rect x="4" y="11" width="16" height="2" rx="1" fill="currentColor"/>
                <rect x="4" y="16" width="16" height="2" rx="1" fill="currentColor"/>
            </svg>
        </button>
    </div>

    <!-- 側邊欄設定面板 - 左側滑動式面板 -->
    <div id="sidebar" class="fixed top-0 left-0 h-full w-80 bg-gray-800 border-r border-gray-600 transform -translate-x-full transition-all duration-300 ease-in-out z-40 md:static md:h-auto md:min-h-screen md:translate-x-0 md:transform-none md:resize-x md:overflow-auto md:min-w-[240px] md:max-w-[480px]">
        <div class="p-4 h-full flex flex-col">
            <!-- 側邊欄標題區域 -->
            <div class="flex items-center gap-2 mb-6 expanded-only">
                <!-- 桌面版：側欄左上角收合按鈕（三條橫線） -->
                <button id="sidebar-collapse-btn" class="hidden md:inline-flex items-center justify-center w-8 h-8 rounded-lg border border-gray-600 text-gray-300 hover:bg-gray-700 md:-ml-1" title="收合側欄">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                        <rect x="4" y="6" width="16" height="2" rx="1" fill="currentColor"/>
                        <rect x="4" y="11" width="16" height="2" rx="1" fill="currentColor"/>
                        <rect x="4" y="16" width="16" height="2" rx="1" fill="currentColor"/>
                    </svg>
                </button>
                <h2 class="text-lg font-medium text-white"></h2>
            </div>
            
            <!-- 用戶個人資料區域 -->
            <div class="flex flex-col items-center gap-3 mb-6 expanded-only">
                <div class="user-avatar-container">
                    <div id="user-avatar-circle" class="user-avatar-circle hidden">
                        <img id="user-avatar-img" src="" alt="用戶頭像" class="w-16 h-16 rounded-full object-cover" />
                    </div>
                </div>
                <div class="user-profile-info text-center">
                    <div id="user-name" class="user-name">未登入</div>
                </div>
                <!-- Google OAuth 登入元件 -->
                <div id="g_id_onload"
                    data-client_id="28263511849-3rk0avke93rn8rfdi5hq0boffkp6gm0j.apps.googleusercontent.com"
                    data-context="signin"
                    data-callback="handleGoogleSignIn"
                    data-auto_prompt="false">
                </div>
                <div class="g_id_signin"
                    data-type="standard"
                    data-size="large"
                    data-theme="outline"
                    data-text="sign_in_with"
                    data-shape="rectangular"
                    data-logo_alignment="left">
                </div>
                <button id="logout-btn" class="mt-2 px-4 py-2 bg-red-500 text-white rounded-lg shadow hover:bg-red-600 transition hidden">登出帳號</button>
            </div>
            <!-- 收合時：僅顯示窄條與展開按鈕置頂置中 -->
            <div class="collapsed-only md:flex-col md:items-start md:justify-start md:pt-2 md:gap-2">
                <button id="desktop-expand-btn-mini" class="hidden md:inline-flex items-center justify-center w-8 h-8 rounded-lg border border-gray-600 text-gray-300 hover:bg-gray-700 bg-gray-800 transition-all duration-200 active:scale-95 focus:outline-none focus:ring-2 focus:ring-blue-400/50 md:ml-1" title="展開側欄">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                        <rect x="4" y="6" width="16" height="2" rx="1" fill="currentColor"/>
                        <rect x="4" y="11" width="16" height="2" rx="1" fill="currentColor"/>
                        <rect x="4" y="16" width="16" height="2" rx="1" fill="currentColor"/>
                    </svg>
                </button>
            </div>
            
            <!-- 設定選單項目區域 -->
            <div class="flex-1 space-y-2 mt-8 expanded-only">
                <button onclick="openApiKeyGuide()" class="w-full text-left px-4 py-3 text-sm text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors" title="申請 Google Gemini API 金鑰">
                    <div class="flex items-center space-x-3">
                        <span class="text-lg">🔑</span>
                        <div>
                            <div class="font-medium">申請 API</div>
                            <div class="text-xs text-gray-500">申請 Google Gemini API 金鑰</div>
                        </div>
                    </div>
                </button>

                <button onclick="showApiConfig()" class="w-full text-left px-4 py-3 text-sm text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors" title="設定 API 金鑰">
                    <div class="flex items-center space-x-3">
                        <span class="text-lg">⚙️</span>
                        <div>
                            <div class="font-medium">API 設定</div>
                            <div class="text-xs text-gray-500">設定和管理 API 金鑰</div>
                        </div>
                    </div>
                </button>

                <button onclick="showConversationHistory()" class="w-full text-left px-4 py-3 text-sm text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors" title="查看過往對話">
                    <div class="flex items-center space-x-3">
                        <span class="text-lg">📝</span>
                        <div>
                            <div class="font-medium">對話記錄</div>
                            <div class="text-xs text-gray-500">查看過往的對話內容</div>
                        </div>
                    </div>
                </button>

                <!-- 新增選項：冥想音樂 -->
                <a href="meditation.html" class="w-full text-left px-4 py-3 text-sm text-blue-300 hover:bg-blue-700 hover:text-white rounded-lg transition-colors block" title="冥想音樂">
                    <div class="flex items-center space-x-3">
                        <span class="text-lg">🎵</span>
                        <div>
                            <div class="font-medium">冥想音樂</div>
                            <div class="text-xs text-blue-200">放鬆心情，進入冥想狀態</div>
                        </div>
                    </div>
                </a>

                <!-- 新增選項：每日閱讀 -->
                <button onclick="showDailyReading()" class="w-full text-left px-4 py-3 text-sm text-green-300 hover:bg-green-700 hover:text-white rounded-lg transition-colors" title="每日閱讀">
                    <div class="flex items-center space-x-3">
                        <span class="text-lg">📖</span>
                        <div>
                            <div class="font-medium">每日閱讀</div>
                            <div class="text-xs text-green-200">精選療癒文章/語錄</div>
                        </div>
                    </div>
                </button>
            </div>
            
            <!-- 底部資訊區域 -->
            <div class="mt-auto pt-4 border-t border-gray-600 expanded-only">
                <div class="text-xs text-gray-500 text-center">
                    Odyssey 溯源
                </div>
            </div>
        </div>
    </div>

            <!-- 遮罩層 - 背景變暗效果，點擊可關閉側邊欄 -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

        <!-- 移除固定展開按鈕，改為迷你側欄內的按鈕 -->

    <!-- 對話記錄彈出視窗 -->
    <div id="conversation-history-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-gray-800 border border-gray-600 rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] flex flex-col">
                <!-- 標題欄 -->
                <div class="flex justify-between items-center p-6 border-b border-gray-600">
                    <h2 class="text-xl font-semibold text-white">對話記錄</h2>
                    <button onclick="closeConversationHistory()" class="text-gray-400 hover:text-white p-2 rounded-lg hover:bg-gray-700" title="關閉對話記錄" aria-label="關閉對話記錄">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
                
                <!-- 內容區域 -->
                <div class="flex-1 overflow-y-auto p-6">
                    <div id="conversation-history-content" class="space-y-4">
                        <!-- 對話記錄將在這裡動態載入 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-3xl mx-auto md:max-w-none md:mx-0 gemini-container relative z-30 md:h-full md:flex md:flex-col md:min-h-0 flex flex-col h-screen">
        <!-- Header -->
        <div class="chat-header p-4 flex justify-between items-center flex-shrink-0">
            <div class="flex items-center justify-between w-full">
                <h1 class="text-xl font-medium md:ml-12 ml-16">Obyssey</h1>
                <div class="flex items-center gap-4">
                    <div class="phase-indicator text-sm text-gray-400">目前階段：表層探索 (行為→感受)</div>
                    <div id="usage-indicator" class="phase-indicator text-sm text-gray-400">
                        今日使用：<span id="usage-count">0</span>/<span id="usage-limit">50</span> 次
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div id="chat-box" class="p-6 flex-1 overflow-y-auto">
            <!-- Initial AI Message -->
            <div class="chat-message ai-message">
                <div class="message-content" id="initial-message">
                    <p class="mt-2" id="user-greeting-message">最近有什麼讓您感到困擾的事件嗎？</p>
                </div>
            </div>
             <!-- Thinking Indicator -->
            <div id="thinking-indicator" class="chat-message ai-message hidden">
                <div class="message-content thinking-indicator">
                    <span>正在思考...</span>
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 flex-shrink-0">
            <div class="input-area p-2 flex items-center gap-2">
                <button id="new-chat-btn" onclick="startNewChat()" class="text-gray-400 hover:text-white p-2 rounded-lg hover:bg-gray-700 transition-colors" title="開始新對話">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <input type="text" id="user-input" class="message-input px-3" placeholder="輸入您的訊息...">
                <button id="send-btn" onclick="sendMessage()" class="send-button" title="傳送訊息">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 2L11 13"/>
                        <path d="M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    </div>

    <script>
        // === 基本變數設定 ===
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const thinkingIndicator = document.getElementById('thinking-indicator');

        // API 設定和額度管理
        let apiKey = localStorage.getItem('gemini_api_key') || '';
        let useCustomApiKey = localStorage.getItem('use_custom_api_key') === 'true';
        let currentKeyIndex = 0;
        let dailyUsageCount = 0;
        let lastUsageDate = '';
        
        // 動態設定值（從配置檔載入）
        let DAILY_FREE_LIMIT = 50;
        let USAGE_WARNING_THRESHOLD = 40;
        let MAX_RETRIES = 2;
        
        // 獲取當前使用的 API 金鑰
        function getCurrentApiKey() {
            if (useCustomApiKey && apiKey && apiKey.length >= 20) {
                return apiKey; // 使用用戶自定義金鑰
            } else if (apiConfig && apiConfig.apiConfig.defaultApiKey) {
                return apiConfig.apiConfig.defaultApiKey; // 使用預設金鑰
            } else {
                return ''; // 無可用金鑰
            }
        }
        
        // 檢查是否有可用的 API 金鑰
        function hasValidApiKey() {
            const currentKey = getCurrentApiKey();
            return currentKey && currentKey.length >= 20;
        }

        // 載入今日使用量
        function loadDailyUsage() {
            const today = new Date().toDateString();
            const savedDate = localStorage.getItem('api_usage_date');
            const savedCount = parseInt(localStorage.getItem('api_usage_count') || '0');
            
            if (savedDate === today) {
                dailyUsageCount = savedCount;
                lastUsageDate = today;
            } else {
                // 新的一天，重置計數
                dailyUsageCount = 0;
                lastUsageDate = today;
                localStorage.setItem('api_usage_date', today);
                localStorage.setItem('api_usage_count', '0');
            }
        }

        // 增加使用計數
        function incrementUsage() {
            dailyUsageCount++;
            localStorage.setItem('api_usage_count', dailyUsageCount.toString());
            updateUsageDisplay(); // 更新顯示
        }

        // 檢查是否超過額度
        function checkUsageLimit() {
            return dailyUsageCount >= DAILY_FREE_LIMIT;
        }

        // 檢查是否接近額度警告線
        function checkUsageWarning() {
            return dailyUsageCount >= USAGE_WARNING_THRESHOLD;
        }

        // 檢查地區支援和服務可用性
        async function checkRegionSupport() {
            try {
                const testEndpoints = [
                    'https://generativelanguage.googleapis.com/v1beta/models',
                    'https://generativelanguage.googleapis.com/v1/models'
                ];
                
                const results = [];
                
                for (const endpoint of testEndpoints) {
                    try {
                        const startTime = Date.now();
                        const response = await fetch(endpoint, { 
                            method: 'GET',
                            headers: {
                                'User-Agent': 'Mozilla/5.0'
                            }
                        });
                        const responseTime = Date.now() - startTime;
                        
                        results.push({
                            endpoint: endpoint,
                            status: response.status,
                            responseTime: responseTime,
                            accessible: response.status !== 404 && response.status !== 403
                        });
                        
                        if (response.status !== 404 && response.status !== 403) {
                            return { 
                                supported: true, 
                                endpoint: endpoint,
                                responseTime: responseTime,
                                allResults: results
                            };
                        }
                    } catch (error) {
                        results.push({
                            endpoint: endpoint,
                            status: 'error',
                            error: error.message,
                            accessible: false
                        });
                        continue;
                    }
                }
                
                // 獲取用戶的大概地理位置信息（基於時區）
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const location = getLocationFromTimezone(timezone);
                
                return { 
                    supported: false, 
                    endpoint: null,
                    location: location,
                    timezone: timezone,
                    allResults: results,
                    suggestion: getSuggestionForLocation(location)
                };
            } catch (error) {
                return { 
                    supported: false, 
                    endpoint: null, 
                    error: error.message,
                    suggestion: '建議使用 VPN 連接到美國或歐洲地區'
                };
            }
        }

        // 根據時區推測大概位置
        function getLocationFromTimezone(timezone) {
            if (timezone.includes('Asia/Shanghai') || timezone.includes('Asia/Beijing')) {
                return '中國大陸';
            } else if (timezone.includes('Asia/Taipei')) {
                return '台灣';
            } else if (timezone.includes('Asia/Hong_Kong')) {
                return '香港';
            } else if (timezone.includes('Asia/')) {
                return '亞洲地區';
            } else if (timezone.includes('Europe/')) {
                return '歐洲地區';
            } else if (timezone.includes('America/')) {
                return '美洲地區';
            } else {
                return '未知地區';
            }
        }

        // 根據位置提供建議
        function getSuggestionForLocation(location) {
            if (location === '中國大陸') {
                return '建議使用穩定的 VPN 連接到美國或歐洲節點，確保 Google 服務可正常訪問';
            } else if (location === '台灣' || location === '香港') {
                return '您的地區通常支援 Gemini API，如有問題可能是暫時性的網路問題';
            } else if (location === '亞洲地區') {
                return '部分亞洲地區可能需要 VPN，建議嘗試連接到支援的地區';
            } else {
                return '如果遇到 404 錯誤，請檢查網路連線或稍後重試';
            }
        }

        // 生成詳細的診斷報告
        async function generateDiagnosticReport(errorMessage) {
            const now = new Date();
            const timestamp = now.toLocaleString('zh-TW');
            
            try {
                // 檢查地區支援
                const regionResult = await checkRegionSupport();
                
                let report = `\n📋 診斷報告 (${timestamp})\n`;
                report += `━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;
                
                // 基本信息
                report += `🌍 地區信息:\n`;
                report += `   位置: ${regionResult.location || '未知'}\n`;
                report += `   時區: ${regionResult.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone}\n`;
                report += `   地區支援: ${regionResult.supported ? '✅ 是' : '❌ 否'}\n\n`;
                
                // API 端點測試結果
                if (regionResult.allResults && regionResult.allResults.length > 0) {
                    report += `📡 API 端點測試結果:\n`;
                    regionResult.allResults.forEach((result, index) => {
                        const status = result.accessible ? '✅' : '❌';
                        report += `   ${index + 1}. ${result.endpoint.split('/')[4]}: ${status} (${result.status})\n`;
                    });
                    report += `\n`;
                }
                
                // 建議解決方案
                report += `💡 建議解決方案:\n`;
                if (regionResult.suggestion) {
                    report += `   • ${regionResult.suggestion}\n`;
                }
                
                if (errorMessage && errorMessage.includes('404')) {
                    report += `   • 此為 API 端點不可用錯誤，通常是地區限制\n`;
                    report += `   • 嘗試使用 VPN 連接到美國或歐洲節點\n`;
                    report += `   • 確認 Google AI Studio 可正常訪問\n`;
                    report += `   • 等待 10-15 分鐘後重試\n`;
                }
                
                report += `   • 檢查服務狀態: https://status.cloud.google.com/\n`;
                report += `   • 確認 API 金鑰有效性\n\n`;
                
                // 技術詳情
                report += `🔧 技術詳情:\n`;
                report += `   用戶代理: Mozilla/5.0\n`;
                report += `   請求時間: ${timestamp}\n`;
                if (regionResult.responseTime) {
                    report += `   響應時間: ${regionResult.responseTime}ms\n`;
                }
                
                return report;
                
            } catch (diagError) {
                return `\n⚠️ 診斷信息收集失敗: ${diagError.message}\n建議手動檢查網路連線和 VPN 設定。`;
            }
        }

        // 療癒系統變數（預設啟用）
        let healingPhase = 'initial';
        let conversationHistory = [];
        let healingModeEnabled = true;

        // === 核心發送訊息功能 ===
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            if (!hasValidApiKey()) {
                alert('🔑 請先設定您的 Google Gemini API 金鑰！\n\n📋 快速開始：\n1. 點擊右上角「🔑 申請 API」查看申請指南\n2. 取得金鑰後點擊「⚙️ API 設定」進行設定');
                showApiConfig();
                return;
            }

            // 檢查每日使用額度
            if (checkUsageLimit()) {
                alert('⏰ 今日免費額度已用完！\n\n您今天已使用了 ' + dailyUsageCount + ' 次免費額度。\n請明天再來使用，或考慮升級到付費版本。\n\n💡 免費額度將在明日 00:00 重置。');
                return;
            }

            // 警告即將達到額度限制
            if (checkUsageWarning() && dailyUsageCount < DAILY_FREE_LIMIT) {
                const remaining = DAILY_FREE_LIMIT - dailyUsageCount;
                const shouldContinue = confirm(`⚠️ 額度警告！\n\n您今天還剩 ${remaining} 次免費使用機會。\n是否要繼續使用？\n\n💡 建議珍惜剩餘額度，明日將自動重置。`);
                if (!shouldContinue) {
                    return;
                }
            }

            toggleInput(false);
            addMessageToChat('user', message, false);
            userInput.value = '';
            showThinking(true);

            // 記錄對話歷史
            conversationHistory.push({
                sender: 'user',
                message: message,
                timestamp: new Date(),
                phase: healingPhase
            });

            try {
                // 檢測部署環境
                const isVercel = window.location.hostname.includes('vercel.app');
                const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                
                // 獲取當前 API 金鑰
                const currentApiKey = getCurrentApiKey();
                
                // 從配置檔獲取端點配置
                let endpoints;
                if (apiConfig && apiConfig.apiConfig.endpoints) {
                    endpoints = isVercel ? 
                        apiConfig.apiConfig.endpoints.vercel : 
                        apiConfig.apiConfig.endpoints.local;
                } else {
                    // 降級到預設配置
                    if (isVercel) {
                        endpoints = [
                            'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=',
                            'https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key='
                        ];
                    } else {
                        endpoints = [
                            'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=',
                            'https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key='
                        ];
                    }
                }

                let response = null;
                let lastError = null;
                let retryCount = 0;
                const maxRetries = apiConfig ? apiConfig.settings.maxRetries : MAX_RETRIES;

                for (const endpoint of endpoints) {
                    retryCount = 0;
                    
                    while (retryCount <= maxRetries) {
                        try {
                            if (retryCount > 0) {
                                showThinking(true, `連線重試中... (${retryCount}/${maxRetries})`);
                            }
                            
                            response = await fetch(endpoint + currentApiKey, {
                                method: 'POST',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'User-Agent': isVercel ? 'Vercel-Deployment/1.0' : 'Mozilla/5.0',
                                    'Accept': 'application/json',
                                    'Cache-Control': 'no-cache'
                                },
                                body: JSON.stringify({
                                    contents: [{ parts: [{ text: getPrompt(message) }] }],
                                    generationConfig: apiConfig ? 
                                        apiConfig.settings.generationConfig : 
                                        { temperature: 0.7, maxOutputTokens: 1000 }
                                })
                            });

                            if (response.ok) {
                                break;
                            } else {
                                const errorText = await response.text();
                                
                                if (response.status === 403) {
                                    lastError = `🔑 API 金鑰無效或無權限\n\n可能原因：\n• API 金鑰錯誤或過期\n• 未啟用 Gemini API 服務\n• 超出使用額度`;
                                } else if (response.status === 404) {
                                    try {
                                        const errorData = JSON.parse(errorText);
                                        const errorId = errorData?.error?.details?.[0]?.metadata?.service || 
                                                        errorData?.error?.message || 
                                                        errorData?.error?.code ||
                                                        '未知錯誤ID';
                                        lastError = `❌ API 端點不存在 (404)\n\n錯誤 ID: ${errorId}\n當前端點: ${endpoint.split('/models/')[1].split(':')[0]}\n\n🔍 診斷信息：\n• 此模型端點在您的地區不可用\n• 可能是 Google API 地區限制\n• Gemini API 服務可能正在維護\n\n💡 解決方案：\n• 如在中國大陸，強烈建議使用 VPN\n• 嘗試連接到美國、歐洲或日本節點\n• 確認可正常訪問 Google 服務\n• 等待 10-15 分鐘後重試\n\n🌍 支援地區：\n• ✅ 美國、加拿大\n• ✅ 歐洲大部分國家\n• ✅ 日本、韓國、澳洲\n• ❌ 中國大陸（需 VPN）\n• ⚠️ 其他地區請檢查可用性\n\n📋 技術詳情：\n• 錯誤時間: ${new Date().toLocaleString('zh-TW')}\n• 用戶代理: ${isVercel ? 'Vercel-Deployment' : 'Browser'}\n• 請求來源: ${isVercel ? 'Vercel CDN' : 'Direct'}`;
                                    } catch (parseErr) {
                                        lastError = `❌ API 端點不存在 (404)\n\n當前端點: ${endpoint.split('/models/')[1].split(':')[0]}\n錯誤時間: ${new Date().toLocaleString('zh-TW')}\n\n🔍 可能原因：\n• 地區限制 - Gemini API 在部分地區不可用\n• 網路限制 - 無法訪問 Google 服務\n• 服務維護 - Google 可能正在更新 API\n\n💡 立即解決方案：\n• 使用穩定的 VPN 服務\n• 連接到美國或歐洲節點\n• 確認 DNS 設定正確\n• 檢查防火牆設定\n\n🆘 如果問題持續：\n• 檢查 https://status.cloud.google.com/\n• 確認 API 金鑰來源地區\n• 聯繫網路服務提供商`;
                                    }
                                } else if (response.status === 503) {
                                    lastError = `🔄 AI 服務暫時繁忙中\n\n建議：\n• 等待 1-2 分鐘後重試`;
                                } else if (response.status === 429) {
                                    lastError = `⏱️ 請求太頻繁\n\n建議：\n• 等待 30 秒後重試`;
                                } else if (response.status === 400) {
                                    lastError = `❌ 請求格式錯誤\n\n可能原因：\n• 訊息內容有問題\n• API 金鑰格式錯誤`;
                                } else {
                                    lastError = `❌ 未知錯誤 (${response.status})\n\n請檢查網路連線和 API 設定`;
                                }
                                
                                if (response.status === 503) {
                                    await new Promise(resolve => setTimeout(resolve, 2000)); // 等待2秒
                                } else if (response.status === 429) {
                                    await new Promise(resolve => setTimeout(resolve, 3000)); // 等待3秒
                                } else if (response.status === 404) {
                                    break; // 直接跳到下一個端點
                                } else if (response.status === 400 || response.status === 403) {
                                    break; // 這些錯誤不需要重試
                                }
                            }
                            
                        } catch (err) {
                            lastError = `網路錯誤: ${err.message}`;
                            
                            if (retryCount < maxRetries) {
                                await new Promise(resolve => setTimeout(resolve, 1000)); // 等待1秒
                            }
                        }
                        
                        retryCount++;
                    }
                    
                    if (response && response.ok) break;
                }

                if (!response || !response.ok) {
                    // 收集診斷信息
                    const diagnosticInfo = await generateDiagnosticReport(lastError);
                    throw new Error(lastError + '\n\n' + diagnosticInfo);
                }

                const data = await response.json();
                let aiResponse = data.candidates[0].content.parts[0].text;

                // 只有在成功獲得回應後才增加使用計數
                incrementUsage();

                // 後處理 AI 回應，檢查並防止迴圈（使用 Google Gemini API 檢測）
                if (typeof HealingConfig !== 'undefined' && HealingConfig.functions.postProcessResponse) {
                    const processedResponse = await HealingConfig.functions.postProcessResponse(
                        aiResponse, 
                        healingPhase, 
                        message, 
                        conversationHistory,
                        apiKey  // 傳遞 API Key 供迴圈檢測使用
                    );
                    
                    // 如果檢測到迴圈，使用處理後的回應
                    if (processedResponse.wasLoop) {
                        aiResponse = processedResponse.response;
                    }
                }

                // 除錯模式已關閉以優化生產環境效能

                addMessageToChat('ai', aiResponse, false);

                // 記錄 AI 回應
                conversationHistory.push({
                    sender: 'ai',
                    message: aiResponse,
                    timestamp: new Date(),
                    phase: healingPhase
                });

                // 更新療癒階段
                if (typeof HealingConfig !== 'undefined') {
                    healingPhase = HealingConfig.functions.updatePhase(healingPhase, message);
                    updatePhaseDisplay();
                }

            } catch (error) {
                
                let errorMessage = '';
                if (error.message.includes('503')) {
                    errorMessage = `🔄 AI 服務暫時繁忙中，請稍後再試。\n\n💡 建議：\n• 等待 1-2 分鐘後重新發送\n• 或點擊重試按鈕`;
                } else if (error.message.includes('429')) {
                    errorMessage = `⏱️ 請求太頻繁，請稍後再試。\n\n💡 建議：\n• 等待 30 秒後重新發送\n• 避免快速連續發送訊息`;
                } else if (error.message.includes('400')) {
                    errorMessage = `❌ 訊息格式有問題。\n\n💡 建議：\n• 檢查您的訊息內容\n• 嘗試重新整理頁面`;
                } else if (error.message.includes('401') || error.message.includes('403')) {
                    errorMessage = `🔑 API 金鑰需要更新。\n\n💡 建議：\n• 點擊右上角「⚙️ API 設定」\n• 檢查您的 Google Gemini API 金鑰\n• 確認金鑰有效且未過期`;
                } else {
                    errorMessage = `⚠️ 連線發生問題。\n\n💡 建議：\n• 檢查網路連線\n• 點擊重試按鈕\n• 如持續發生，請檢查 API 金鑰設定`;
                }
                
                addMessageToChat('ai', errorMessage, true); // 加入錯誤標記
            } finally {
                showThinking(false);
                toggleInput(true);
            }
        }

        // === 提示詞生成功能 ===
        function getPrompt(userInput) {
            // 療癒模式（預設啟用）
            if (typeof HealingConfig !== 'undefined') {
                return HealingConfig.functions.generatePrompt(healingPhase, userInput, conversationHistory);
            } else {
                // 降級到基本療癒模式
                return `你是一個專業的心理療癒師和內在小孩治療專家。請以溫暖、同理心和專業的方式回應使用者。

使用者的訊息："${userInput}"

請給予有療癒意義的回應：`;
            }
        }

        // === UI 輔助功能 ===
        function addMessageToChat(sender, message, isError = false, saveToHistory = true) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `chat-message ${sender}-message`;
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            // 如果是錯誤訊息，加入重試按鈕
            if (isError && sender === 'ai') {
                messageContent.style.position = 'relative';
                messageContent.style.paddingBottom = '40px'; // 為重試按鈕預留空間
                messageContent.innerHTML = message.replace(/\n/g, '<br>');
                
                // 創建重試按鈕
                const retryButton = document.createElement('button');
                retryButton.innerHTML = '🔄';
                retryButton.title = '重新發送上一則訊息';
                retryButton.className = 'retry-button';
                retryButton.style.cssText = `
                    position: absolute;
                    bottom: 8px;
                    right: 8px;
                    background: var(--accent-blue);
                    color: var(--bg-primary);
                    border: none;
                    border-radius: 50%;
                    width: 24px;
                    height: 24px;
                    cursor: pointer;
                    font-size: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.2s ease;
                `;
                
                retryButton.addEventListener('click', function() {
                    // 重新發送上一則用戶訊息
                    if (conversationHistory.length > 0) {
                        const lastUserMessage = conversationHistory
                            .slice()
                            .reverse()
                            .find(msg => msg.sender === 'user');
                        
                        if (lastUserMessage) {
                            // 移除錯誤訊息
                            messageWrapper.remove();
                            
                            // 移除對話歷史中的最後一則用戶訊息，重新發送
                            const lastUserIndex = conversationHistory.map(msg => msg.sender).lastIndexOf('user');
                            if (lastUserIndex !== -1) {
                                conversationHistory.splice(lastUserIndex, 1);
                            }
                            
                            // 設定輸入框並發送
                            userInput.value = lastUserMessage.message;
                            sendMessage();
                        }
                    }
                });
                
                messageContent.appendChild(retryButton);
            } else {
                messageContent.innerHTML = message.replace(/\n/g, '<br>');
            }
            
            messageWrapper.appendChild(messageContent);
            chatBox.insertBefore(messageWrapper, thinkingIndicator);
            chatBox.scrollTop = chatBox.scrollHeight;
            
            // 保存到對話記錄（不保存錯誤訊息）
            if (saveToHistory && !isError) {
                const history = JSON.parse(localStorage.getItem('conversation_history') || '[]');
                history.push({
                    role: sender,
                    content: message,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('conversation_history', JSON.stringify(history));
            }
        }

        function toggleInput(enabled) {
            userInput.disabled = !enabled;
            sendBtn.disabled = !enabled;
            if(enabled) userInput.focus();
        }
        
        function showThinking(isThinking, customMessage = null) {
            const thinkingText = thinkingIndicator.querySelector('span');
            if (customMessage) {
                thinkingText.textContent = customMessage;
            } else {
                thinkingText.textContent = '正在思考...';
            }
            
            thinkingIndicator.classList.toggle('hidden', !isThinking);
            if (isThinking) chatBox.scrollTop = chatBox.scrollHeight;
        }

        // 更新使用量顯示
        function updateUsageDisplay() {
            const usageCountEl = document.getElementById('usage-count');
            const usageLimitEl = document.getElementById('usage-limit');
            const usageIndicatorEl = document.getElementById('usage-indicator');
            
            if (usageCountEl) {
                usageCountEl.textContent = dailyUsageCount;
            }
            if (usageLimitEl) {
                usageLimitEl.textContent = DAILY_FREE_LIMIT;
            }
            
            // 根據使用量改變顏色
            if (usageIndicatorEl) {
                if (dailyUsageCount >= DAILY_FREE_LIMIT) {
                    usageIndicatorEl.style.color = '#ff6b6b'; // 紅色 - 已用完
                } else if (dailyUsageCount >= USAGE_WARNING_THRESHOLD) {
                    usageIndicatorEl.style.color = '#ffa726'; // 橙色 - 警告
                } else {
                    usageIndicatorEl.style.color = 'var(--text-secondary)'; // 預設顏色
                }
            }
        }

        // === 階段顯示更新功能 ===
        function updatePhaseDisplay() {
            if (typeof HealingConfig !== 'undefined') {
                const phaseDisplay = document.getElementById('current-phase');
                phaseDisplay.textContent = HealingConfig.functions.getPhaseDisplayName(healingPhase);
            }
        }

        // === API 設定功能 ===
        
        // 開啟 Google API 申請指南
        function openApiKeyGuide() {
            const guideMessage = `🔑 Google Gemini API 金鑰申請指南

📋 申請步驟：
1. 點擊下方「前往申請」按鈕開啟 Google AI Studio
2. 使用您的 Google 帳號登入
3. 點擊「Create API Key」按鈕
4. 選擇「Create API key in new project」
5. 複製生成的 API 金鑰
6. 回到本頁面點擊「⚙️ API 設定」
7. 將 API 金鑰貼上到輸入框中

💡 重要提醒：
• API 金鑰格式：AIzaSy開頭的39字元字串
• 請妥善保管您的 API 金鑰
• 不要在公開場合分享金鑰

🌍 地區支援：
• ✅ 美國、加拿大、歐洲大部分國家
• ✅ 日本、韓國、澳洲、台灣
• ❌ 中國大陸（需要 VPN）

⚠️ 如果無法訪問，可能需要：
• 使用 VPN 連接到支援地區
• 確認網路連線正常`;

            if (confirm(guideMessage + '\n\n是否要開啟 Google AI Studio 申請頁面？')) {
                window.open('https://aistudio.google.com/app/apikey', '_blank');
            }
        }

        async function testApiKey(testKey) {
            try {
                // 從配置檔獲取測試端點
                const testEndpoints = apiConfig && apiConfig.apiConfig.testEndpoints ? 
                    apiConfig.apiConfig.testEndpoints : [
                        'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=',
                        'https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key='
                    ];
                
                let lastTestError = null;
                
                for (const testEndpoint of testEndpoints) {
                    try {
                        const response = await fetch(testEndpoint + testKey, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'User-Agent': 'Mozilla/5.0'
                            },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: '測試' }] }],
                                generationConfig: {
                                    temperature: 0.7,
                                    maxOutputTokens: 50
                                }
                            })
                        });
                        
                        if (response.ok) {
                            return { 
                                success: true, 
                                message: `API 金鑰測試成功！\n使用端點: ${testEndpoint.split('/models/')[1].split(':')[0]}`,
                                workingEndpoint: testEndpoint
                            };
                        } else {
                            const errorText = await response.text();
                            
                            if (response.status === 404) {
                                lastTestError = {
                                    status: 404,
                                    message: '地區限制：此地區無法訪問 Gemini API，建議使用 VPN',
                                    suggestion: '嘗試連接到美國或歐洲的 VPN 節點'
                                };
                                continue; // 嘗試下一個端點
                            } else if (response.status === 403) {
                                return { 
                                    success: false, 
                                    message: 'API 金鑰無權限或服務未啟用',
                                    statusCode: response.status,
                                    details: errorText
                                };
                            } else if (response.status === 401) {
                                return { 
                                    success: false, 
                                    message: 'API 金鑰無效或未授權',
                                    statusCode: response.status,
                                    details: errorText
                                };
                            } else {
                                lastTestError = {
                                    status: response.status,
                                    message: `HTTP ${response.status} 錯誤`,
                                    details: errorText
                                };
                            }
                        }
                    } catch (err) {
                        lastTestError = {
                            status: 'network',
                            message: `網路錯誤: ${err.message}`,
                            details: err.toString()
                        };
                        continue;
                    }
                }
                
                // 所有端點都失敗了
                if (lastTestError && lastTestError.status === 404) {
                    return { 
                        success: false, 
                        message: lastTestError.message,
                        suggestion: lastTestError.suggestion,
                        statusCode: 404
                    };
                } else {
                    return { 
                        success: false, 
                        message: lastTestError ? lastTestError.message : 'API 測試失敗',
                        details: lastTestError ? lastTestError.details : '未知錯誤'
                    };
                }
                
            } catch (error) {
                return { 
                    success: false, 
                    message: `網路連線錯誤: ${error.name} - ${error.message}`,
                    details: error.toString()
                };
            }
        }

        function showApiConfig() {
            const hasDefaultKey = apiConfig && apiConfig.apiConfig.defaultApiKey && apiConfig.apiConfig.defaultApiKey.length >= 20;
            const hasCustomKey = apiKey && apiKey.length >= 20;
            const currentKey = getCurrentApiKey();
            
            const instructions = `🔑 Google Gemini API 金鑰設定

${!hasValidApiKey() ? '⚠️ 請先設定您的 Google Gemini API 金鑰才能開始對話。\n' : ''}📊 今日使用狀態：${dailyUsageCount}/${DAILY_FREE_LIMIT} 次
${dailyUsageCount >= USAGE_WARNING_THRESHOLD ? '⚠️ 接近每日免費額度限制' : '✅ 使用狀態正常'}

🔧 當前配置：
• 系統預設金鑰：${hasDefaultKey ? '✅ 已配置' : '❌ 未配置'}
• 用戶自定義金鑰：${hasCustomKey ? '✅ 已設定' : '❌ 未設定'}
• 目前使用：${useCustomApiKey ? '用戶自定義金鑰' : '系統預設金鑰'}

${hasDefaultKey ? '💡 提示：留空將使用系統預設金鑰，輸入新金鑰將覆蓋預設設定' : ''}

🔑 如何取得 API 金鑰：
點擊右上角「🔑 申請 API」按鈕查看詳細申請指南

💡 API 金鑰格式範例：AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

⚠️ 如果遇到問題：
• 404 錯誤 → 可能是地區限制，建議使用 VPN
• 403 錯誤 → 檢查 API 金鑰權限設定

目前狀態：${hasValidApiKey() ? '✅ 已設定有效金鑰' : '❌ 無可用金鑰'}`;

            const key = prompt(instructions, hasCustomKey ? apiKey : '');
            
            if (key !== null) {
                if (key.trim() === '') {
                    // 用戶選擇使用預設金鑰
                    if (hasDefaultKey) {
                        useCustomApiKey = false;
                        localStorage.setItem('use_custom_api_key', 'false');
                        localStorage.removeItem('gemini_api_key');
                        apiKey = '';
                        alert('✅ 已切換到系統預設金鑰！');
                    } else {
                        alert('❌ 系統未配置預設金鑰，請輸入您的 API 金鑰。');
                    }
                } else {
                    // 用戶輸入自定義金鑰
                    const newKey = key.trim();
                    
                    // 先檢查地區支援
                    checkRegionSupport().then(regionResult => {
                        if (!regionResult.supported) {
                            alert('⚠️ 地區限制警告\n\n您的地區可能不支援 Gemini API。\n建議使用 VPN 連接到支援的地區後再測試 API 金鑰。');
                        }
                        
                        // 測試新的 API 金鑰
                        testApiKey(newKey).then(result => {
                            if (result.success) {
                                apiKey = newKey;
                                useCustomApiKey = true;
                                localStorage.setItem('gemini_api_key', apiKey);
                                localStorage.setItem('use_custom_api_key', 'true');
                                alert('✅ 自定義 API 金鑰設定成功並已通過測試！');
                            } else {
                                let errorMsg = `❌ ${result.message}\n\n請檢查您的 API 金鑰是否正確。`;
                                if (result.statusCode === 404) {
                                    errorMsg += '\n\n🌍 如果持續出現 404 錯誤，可能是地區限制：\n• 嘗試使用 VPN\n• 檢查 Google AI Studio 地區可用性';
                                }
                                alert(errorMsg);
                            }
                        });
                    });
                }
            }
        }

        // === 測試模式處理 ===
        function checkTestMode() {
            const isTestMode = localStorage.getItem('testMode');
            const testUserData = localStorage.getItem('userData');
            
            if (isTestMode === 'true' && testUserData) {
                try {
                    const testUser = JSON.parse(testUserData);
                    console.log('🧪 測試模式啟用，用戶:', testUser.name);
                    
                    // 顯示測試模式橫幅
                    showTestModeBanner();
                    
                    // 設定測試用戶資訊
                    localStorage.setItem('user_info', JSON.stringify({
                        name: testUser.name,
                        email: testUser.email,
                        picture: testUser.picture || '🧑‍💻'
                    }));
                    
                    return true;
                } catch (error) {
                    console.warn('測試用戶資料解析失敗:', error);
                    localStorage.removeItem('testMode');
                    localStorage.removeItem('userData');
                }
            }
            return false;
        }
        
        function showTestModeBanner() {
            // 建立測試模式橫幅
            const banner = document.createElement('div');
            banner.id = 'test-mode-banner';
            banner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
                color: white;
                text-align: center;
                padding: 8px 16px;
                font-size: 14px;
                font-weight: 500;
                z-index: 10000;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            `;
            banner.innerHTML = `
                🧪 測試模式 | 
                <span style="opacity: 0.9;">跳過登入，直接體驗功能</span> | 
                <button onclick="exitTestMode()" style="
                    background: rgba(255, 255, 255, 0.2);
                    border: 1px solid rgba(255, 255, 255, 0.3);
                    color: white;
                    padding: 4px 12px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                    margin-left: 10px;
                ">退出測試</button>
            `;
            
            document.body.insertBefore(banner, document.body.firstChild);
            
            // 調整頁面內容避免被橫幅遮擋
            document.body.style.paddingTop = '40px';
        }
        
        function exitTestMode() {
            localStorage.removeItem('testMode');
            localStorage.removeItem('userData');
            localStorage.removeItem('user_info');
            window.location.href = '/';
        }

        // === 用戶認證處理 ===
        function checkUserAuth() {
            const userInfo = localStorage.getItem('user_info');
            const isGuest = localStorage.getItem('is_guest');
            
            if (userInfo) {
                try {
                    const user = JSON.parse(userInfo);
                    displayUserInfo(user);
                } catch (error) {
                    console.warn('用戶信息解析失敗:', error);
                    localStorage.removeItem('user_info');
                }
            } else if (isGuest === 'true') {
                displayGuestInfo();
            }
        }
        
        function displayUserInfo(user) {
            const userDisplay = document.getElementById('user-display');
            const userGreeting = document.getElementById('user-greeting');
            const logoutBtn = document.getElementById('logout-btn');
            const userGreetingMessage = document.getElementById('user-greeting-message');
            
            userGreeting.textContent = `👋 ${user.name || user.email}`;
            userDisplay.classList.remove('hidden');
            logoutBtn.classList.remove('hidden');
            
            // 更新 Initial AI Message 中的用戶問候語
            if (userGreetingMessage) {
                userGreetingMessage.textContent = `你好 ${user.name || user.email}，最近有什麼讓您感到困擾的事件或行為嗎？`;
            }
        }
        
        function displayGuestInfo() {
            const userDisplay = document.getElementById('user-display');
            const userGreeting = document.getElementById('user-greeting');
            
            userGreeting.textContent = '👤 訪客模式';
            userDisplay.classList.remove('hidden');
        }
        
        // 登出功能
        function handleLogout() {
            const avatarImg = document.getElementById('user-avatar-img');
            const avatarCircle = document.getElementById('user-avatar-circle');
            const userNameDiv = document.getElementById('user-name');
            const logoutBtn = document.getElementById('logout-btn');
            const googleSignin = document.querySelector('.g_id_signin');
            avatarImg.src = '';
            avatarCircle.classList.add('hidden');
            if (userNameDiv) userNameDiv.textContent = '未登入';
            if (logoutBtn) logoutBtn.classList.add('hidden');
            if (googleSignin) googleSignin.style.display = '';
            if (window.google && window.google.accounts && window.google.accounts.id) {
                window.google.accounts.id.disableAutoSelect();
            }
            alert('已登出 Google 帳號');
        }

        // Google OAuth callback
        function handleGoogleSignIn(response) {
            const id_token = response.credential;
            const payload = JSON.parse(atob(id_token.split('.')[1]));
            const avatarUrl = payload.picture || '';
            const userName = payload.name || payload.email || 'Google 用戶';
            const avatarImg = document.getElementById('user-avatar-img');
            const avatarCircle = document.getElementById('user-avatar-circle');
            const userNameDiv = document.getElementById('user-name');
            const logoutBtn = document.getElementById('logout-btn');
            const googleSignin = document.querySelector('.g_id_signin');
            if (avatarUrl) {
                avatarImg.src = avatarUrl;
                avatarCircle.classList.remove('hidden');
            } else {
                avatarCircle.classList.add('hidden');
            }
            if (userNameDiv) userNameDiv.textContent = userName;
            if (googleSignin) googleSignin.style.display = 'none';
            if (logoutBtn) logoutBtn.classList.remove('hidden');
            alert('Google 登入成功！');
        }

        // 頁面載入時初始化用戶資訊
        function initUserProfile() {
            const avatarImg = document.getElementById('user-avatar-img');
            const avatarCircle = document.getElementById('user-avatar-circle');
            const userNameDiv = document.getElementById('user-name');
            avatarImg.src = '';
            avatarCircle.classList.add('hidden');
            if (userNameDiv) userNameDiv.textContent = '未登入';
        }
        document.addEventListener('DOMContentLoaded', function() {
            initUserProfile();
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
        });
    </script>

    <!-- Google Identity Services SDK -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- iOS 和 iPadOS 安裝引導按鈕 -->
    <div id="ios-install-prompt" class="fixed top-4 right-4 z-50 hidden">
        <button id="ios-install-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 transition-all duration-300 transform hover:scale-105 install-pulse">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
            </svg>
            安裝到主畫面
            <div class="flex flex-col items-start">
                <span class="text-xs opacity-75">(需Safari)</span>
                <span class="text-xs text-yellow-200">Chrome無法安裝</span>
            </div>
        </button>
    </div>

    <!-- iOS 和 iPadOS 安裝提示橫幅 -->
    <div id="ios-install-banner" class="fixed top-0 left-0 right-0 bg-gradient-to-r from-blue-500 to-purple-600 text-white p-3 z-40 hidden transform -translate-y-full transition-transform duration-500">
        <div class="flex items-center justify-between max-w-4xl mx-auto">
            <div class="flex items-center gap-3">
                <svg class="w-6 h-6 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
                <div>
                    <p class="font-semibold">🚀 將 Obyssey 安裝到主畫面</p>
                    <p class="text-sm opacity-90">享受更快的啟動速度和離線功能</p>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-xs opacity-75">⚠️ 必須使用 Safari 瀏覽器</span>
                        <span class="text-xs bg-yellow-500 bg-opacity-20 px-2 py-0.5 rounded">Chrome 無法安裝</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button id="banner-install-btn" class="bg-white text-blue-600 px-4 py-2 rounded-lg font-medium hover:bg-gray-100 transition-colors">
                    立即安裝
                </button>
                <button id="banner-close-btn" class="text-white hover:text-gray-200 transition-colors" title="關閉安裝提示">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- iOS 和 iPadOS 安裝引導模態框 -->
    <div id="ios-install-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-md w-full p-6 shadow-2xl">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                    </svg>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">安裝 Obyssey 到主畫面</h3>
                <p class="text-gray-600">按照以下步驟將 Obyssey 安裝到您的主畫面（支援 iPhone 和 iPad）</p>
                <p class="text-sm text-red-600 font-medium mt-2">⚠️ 重要：必須使用 Safari 瀏覽器才能安裝</p>
            </div>
            
            <div class="space-y-4 mb-6">
                <div class="flex items-start gap-3">
                    <div class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0 mt-0.5">1</div>
                    <div>
                        <p class="font-medium text-gray-800">點擊分享按鈕</p>
                        <p class="text-sm text-gray-600">iPhone：在 Safari 底部 | iPad：在網址列右側</p>
                        <p class="text-xs text-red-500 mt-1">💡 請確保您正在使用 Safari 瀏覽器</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <div class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0 mt-0.5">2</div>
                    <div>
                        <p class="font-medium text-gray-800">選擇「加入主畫面」</p>
                        <p class="text-sm text-gray-600">在分享選單中找到此選項</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <div class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0 mt-0.5">3</div>
                    <div>
                        <p class="font-medium text-gray-800">點擊「新增」</p>
                        <p class="text-sm text-gray-600">完成安裝，應用程式將出現在主畫面</p>
                    </div>
                </div>
            </div>

            <div class="flex gap-3">
                <button id="close-install-modal" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg transition-colors">
                    關閉
                </button>
                <button id="try-install-now" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg transition-colors">
                    立即嘗試
                </button>
            </div>
        </div>
    </div>

</body>
</html>

