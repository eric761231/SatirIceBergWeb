<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 互動介面</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- 載入療癒功能設定檔 -->
    <script src="healing-config.js"></script>
    
    <style>
        :root {
            --bg-primary: #131314;
            --bg-secondary: #1e1f20;
            --bg-tertiary: #2a2b2c;
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --border-color: #3c4043;
            --accent-blue: #8ab4f8;
            --gemini-gradient: linear-gradient(135deg, #4285f4, #ea4335, #fbbc04, #34a853);
        }
        body {
            font-family: 'Google Sans', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        .gemini-container {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
        }
        .chat-header {
            border-bottom: 1px solid var(--border-color);
        }
        .chat-message {
            margin-bottom: 16px;
            display: flex;
            width: 100%;
        }
        .ai-message {
            justify-content: flex-start;
        }
        .user-message {
            justify-content: flex-end;
        }
        .ai-message .message-content {
            background-color: var(--bg-tertiary);
            border-bottom-left-radius: 4px;
        }
        .user-message .message-content {
            background-color: var(--accent-blue);
            color: var(--bg-primary);
            border-bottom-right-radius: 4px;
        }
        .message-content {
            padding: 12px 16px;
            border-radius: 18px;
            display: inline-block;
            max-width: 70%;
            word-wrap: break-word;
        }
        .input-area {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 24px;
        }
        .message-input {
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            width: 100%;
        }
        .send-button {
            background-color: var(--accent-blue);
            color: var(--bg-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
        }
        .send-button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }
        .thinking-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            justify-content: flex-start;
        }
        .thinking-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-blue);
            border-radius: 50%;
            animation: thinking-pulse 1.4s ease-in-out infinite both;
        }
        .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes thinking-pulse {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        .phase-indicator {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            color: var(--text-secondary);
            display: inline-block;
            margin-bottom: 16px;
        }
        .retry-button {
            transition: all 0.2s ease;
        }
        .retry-button:hover {
            background-color: var(--text-primary) !important;
            transform: scale(1.1);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-3xl mx-auto gemini-container">
        <!-- Header -->
        <div class="chat-header p-4 flex justify-between items-center">
            <h1 class="text-xl font-medium">薩提爾冰山探索者</h1>
            <div class="flex gap-2">
                <button onclick="showApiConfig()" class="text-sm bg-gray-600 hover:bg-gray-500 py-1 px-3 rounded-lg">
                    ⚙️ API 設定
                </button>
            </div>
        </div>

        <!-- Phase Indicator -->
        <div id="phase-indicator" class="p-4">
            <div class="flex justify-between items-center">
                <div class="phase-indicator">
                    目前階段：<span id="current-phase">初始探索</span>
                </div>
                <div id="usage-indicator" class="phase-indicator">
                    今日使用：<span id="usage-count">0</span>/<span id="usage-limit">50</span> 次
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div id="chat-box" class="p-6 h-[60vh] overflow-y-auto">
            <!-- Initial AI Message -->
            <div class="chat-message ai-message">
                <div class="message-content" id="initial-message">
                    <p>歡迎來到內在探索的安全空間。</p>
                    <p class="mt-2">最近有什麼讓您感到困擾的事件或行為嗎？</p>
                </div>
            </div>
             <!-- Thinking Indicator -->
            <div id="thinking-indicator" class="chat-message ai-message hidden">
                <div class="message-content thinking-indicator">
                    <span>正在思考...</span>
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4">
            <div class="input-area p-2 flex items-center">
                <input type="text" id="user-input" class="message-input px-3" placeholder="輸入您的訊息...">
                <button id="send-btn" onclick="sendMessage()" class="send-button" title="傳送訊息">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // === 基本變數設定 ===
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const thinkingIndicator = document.getElementById('thinking-indicator');

        // API 設定和額度管理
        let apiKey = localStorage.getItem('gemini_api_key') || '';
        let currentKeyIndex = 0;
        let dailyUsageCount = 0;
        let lastUsageDate = '';
        
        // 每日免費額度限制 (Gemini API 免費層通常為每日50-60次請求)
        const DAILY_FREE_LIMIT = 50;
        const USAGE_WARNING_THRESHOLD = 40; // 80% 時警告

        // 載入今日使用量
        function loadDailyUsage() {
            const today = new Date().toDateString();
            const savedDate = localStorage.getItem('api_usage_date');
            const savedCount = parseInt(localStorage.getItem('api_usage_count') || '0');
            
            if (savedDate === today) {
                dailyUsageCount = savedCount;
                lastUsageDate = today;
            } else {
                // 新的一天，重置計數
                dailyUsageCount = 0;
                lastUsageDate = today;
                localStorage.setItem('api_usage_date', today);
                localStorage.setItem('api_usage_count', '0');
            }
        }

        // 增加使用計數
        function incrementUsage() {
            dailyUsageCount++;
            localStorage.setItem('api_usage_count', dailyUsageCount.toString());
            updateUsageDisplay(); // 更新顯示
        }

        // 檢查是否超過額度
        function checkUsageLimit() {
            return dailyUsageCount >= DAILY_FREE_LIMIT;
        }

        // 檢查是否接近額度警告線
        function checkUsageWarning() {
            return dailyUsageCount >= USAGE_WARNING_THRESHOLD;
        }

        // 檢查地區支援和服務可用性
        async function checkRegionSupport() {
            try {
                console.log('🌍 檢查地區支援狀態...');
                
                const testEndpoints = [
                    'https://generativelanguage.googleapis.com/v1beta/models',
                    'https://generativelanguage.googleapis.com/v1/models'
                ];
                
                const results = [];
                
                for (const endpoint of testEndpoints) {
                    try {
                        const startTime = Date.now();
                        const response = await fetch(endpoint, { 
                            method: 'GET',
                            headers: {
                                'User-Agent': 'Mozilla/5.0'
                            }
                        });
                        const responseTime = Date.now() - startTime;
                        
                        console.log(`📡 端點測試: ${endpoint} - 狀態: ${response.status} (${responseTime}ms)`);
                        
                        results.push({
                            endpoint: endpoint,
                            status: response.status,
                            responseTime: responseTime,
                            accessible: response.status !== 404 && response.status !== 403
                        });
                        
                        if (response.status !== 404 && response.status !== 403) {
                            return { 
                                supported: true, 
                                endpoint: endpoint,
                                responseTime: responseTime,
                                allResults: results
                            };
                        }
                    } catch (error) {
                        console.warn(`⚠️ 端點 ${endpoint} 測試失敗:`, error.message);
                        results.push({
                            endpoint: endpoint,
                            status: 'error',
                            error: error.message,
                            accessible: false
                        });
                        continue;
                    }
                }
                
                // 獲取用戶的大概地理位置信息（基於時區）
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const location = getLocationFromTimezone(timezone);
                
                console.log(`🌍 檢測到位置: ${location} (時區: ${timezone})`);
                
                return { 
                    supported: false, 
                    endpoint: null,
                    location: location,
                    timezone: timezone,
                    allResults: results,
                    suggestion: getSuggestionForLocation(location)
                };
            } catch (error) {
                console.error('❌ 地區支援檢查失敗:', error);
                return { 
                    supported: false, 
                    endpoint: null, 
                    error: error.message,
                    suggestion: '建議使用 VPN 連接到美國或歐洲地區'
                };
            }
        }

        // 根據時區推測大概位置
        function getLocationFromTimezone(timezone) {
            if (timezone.includes('Asia/Shanghai') || timezone.includes('Asia/Beijing')) {
                return '中國大陸';
            } else if (timezone.includes('Asia/Taipei')) {
                return '台灣';
            } else if (timezone.includes('Asia/Hong_Kong')) {
                return '香港';
            } else if (timezone.includes('Asia/')) {
                return '亞洲地區';
            } else if (timezone.includes('Europe/')) {
                return '歐洲地區';
            } else if (timezone.includes('America/')) {
                return '美洲地區';
            } else {
                return '未知地區';
            }
        }

        // 根據位置提供建議
        function getSuggestionForLocation(location) {
            if (location === '中國大陸') {
                return '建議使用穩定的 VPN 連接到美國或歐洲節點，確保 Google 服務可正常訪問';
            } else if (location === '台灣' || location === '香港') {
                return '您的地區通常支援 Gemini API，如有問題可能是暫時性的網路問題';
            } else if (location === '亞洲地區') {
                return '部分亞洲地區可能需要 VPN，建議嘗試連接到支援的地區';
            } else {
                return '如果遇到 404 錯誤，請檢查網路連線或稍後重試';
            }
        }

        // 生成詳細的診斷報告
        async function generateDiagnosticReport(errorMessage) {
            const now = new Date();
            const timestamp = now.toLocaleString('zh-TW');
            
            console.log('🔍 生成診斷報告...');
            
            try {
                // 檢查地區支援
                const regionResult = await checkRegionSupport();
                
                let report = `\n📋 診斷報告 (${timestamp})\n`;
                report += `━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;
                
                // 基本信息
                report += `🌍 地區信息:\n`;
                report += `   位置: ${regionResult.location || '未知'}\n`;
                report += `   時區: ${regionResult.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone}\n`;
                report += `   地區支援: ${regionResult.supported ? '✅ 是' : '❌ 否'}\n\n`;
                
                // API 端點測試結果
                if (regionResult.allResults && regionResult.allResults.length > 0) {
                    report += `📡 API 端點測試結果:\n`;
                    regionResult.allResults.forEach((result, index) => {
                        const status = result.accessible ? '✅' : '❌';
                        report += `   ${index + 1}. ${result.endpoint.split('/')[4]}: ${status} (${result.status})\n`;
                    });
                    report += `\n`;
                }
                
                // 建議解決方案
                report += `💡 建議解決方案:\n`;
                if (regionResult.suggestion) {
                    report += `   • ${regionResult.suggestion}\n`;
                }
                
                if (errorMessage && errorMessage.includes('404')) {
                    report += `   • 此為 API 端點不可用錯誤，通常是地區限制\n`;
                    report += `   • 嘗試使用 VPN 連接到美國或歐洲節點\n`;
                    report += `   • 確認 Google AI Studio 可正常訪問\n`;
                    report += `   • 等待 10-15 分鐘後重試\n`;
                }
                
                report += `   • 檢查服務狀態: https://status.cloud.google.com/\n`;
                report += `   • 確認 API 金鑰有效性\n\n`;
                
                // 技術詳情
                report += `🔧 技術詳情:\n`;
                report += `   用戶代理: Mozilla/5.0\n`;
                report += `   請求時間: ${timestamp}\n`;
                if (regionResult.responseTime) {
                    report += `   響應時間: ${regionResult.responseTime}ms\n`;
                }
                
                console.log('✅ 診斷報告生成完成');
                return report;
                
            } catch (diagError) {
                console.error('❌ 診斷報告生成失敗:', diagError);
                return `\n⚠️ 診斷信息收集失敗: ${diagError.message}\n建議手動檢查網路連線和 VPN 設定。`;
            }
        }

        // 療癒系統變數（預設啟用）
        let healingPhase = 'initial';
        let conversationHistory = [];
        let healingModeEnabled = true;

        // === 核心發送訊息功能 ===
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            if (!apiKey || apiKey.length < 20) {
                alert('🔑 請先設定您的 Google Gemini API 金鑰！\n\n點擊右上角「⚙️ API 設定」來設定您的金鑰。');
                showApiConfig();
                return;
            }

            // 檢查每日使用額度
            if (checkUsageLimit()) {
                alert('⏰ 今日免費額度已用完！\n\n您今天已使用了 ' + dailyUsageCount + ' 次免費額度。\n請明天再來使用，或考慮升級到付費版本。\n\n💡 免費額度將在明日 00:00 重置。');
                return;
            }

            // 警告即將達到額度限制
            if (checkUsageWarning() && dailyUsageCount < DAILY_FREE_LIMIT) {
                const remaining = DAILY_FREE_LIMIT - dailyUsageCount;
                const shouldContinue = confirm(`⚠️ 額度警告！\n\n您今天還剩 ${remaining} 次免費使用機會。\n是否要繼續使用？\n\n💡 建議珍惜剩餘額度，明日將自動重置。`);
                if (!shouldContinue) {
                    return;
                }
            }

            toggleInput(false);
            addMessageToChat('user', message, false);
            userInput.value = '';
            showThinking(true);

            // 記錄對話歷史
            conversationHistory.push({
                sender: 'user',
                message: message,
                timestamp: new Date(),
                phase: healingPhase
            });

            try {
                // 2025年1月 - 使用最新穩定的 API 端點配置
                const endpoints = [
                    'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=',
                    'https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=',
                    'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=',
                    'https://generativelanguage.googleapis.com/v1/models/gemini-1.5-pro:generateContent?key=',
                    'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=',
                    'https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key='
                ];

                let response = null;
                let lastError = null;
                let retryCount = 0;
                const maxRetries = 2;

                for (const endpoint of endpoints) {
                    retryCount = 0;
                    
                    while (retryCount <= maxRetries) {
                        try {
                            console.log(`🔄 嘗試端點: ${endpoint.split('?')[0]} (重試 ${retryCount}/${maxRetries})`);
                            
                            if (retryCount > 0) {
                                showThinking(true, `連線重試中... (${retryCount}/${maxRetries})`);
                            }
                            
                            response = await fetch(endpoint + apiKey, {
                                method: 'POST',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'User-Agent': 'Mozilla/5.0'
                                },
                                body: JSON.stringify({
                                    contents: [{ parts: [{ text: getPrompt(message) }] }],
                                    generationConfig: {
                                        temperature: 0.7,
                                        maxOutputTokens: 1000
                                    }
                                })
                            });

                            if (response.ok) {
                                console.log('✅ API 請求成功');
                                console.log(`🎯 使用端點: ${endpoint.split('/models/')[1].split(':')[0]} (${endpoint.includes('v1beta') ? 'v1beta' : 'v1'})`);
                                break;
                            } else {
                                const errorText = await response.text();
                                console.log(`❌ 端點 ${endpoint.split('/')[4]} 失敗:`, response.status);
                                
                                if (response.status === 403) {
                                    lastError = `🔑 API 金鑰無效或無權限\n\n可能原因：\n• API 金鑰錯誤或過期\n• 未啟用 Gemini API 服務\n• 超出使用額度`;
                                } else if (response.status === 404) {
                                    try {
                                        const errorData = JSON.parse(errorText);
                                        const errorId = errorData?.error?.details?.[0]?.metadata?.service || 
                                                        errorData?.error?.message || 
                                                        '未知錯誤ID';
                                        lastError = `❌ API 端點不存在 (404)\n\n錯誤 ID: ${errorId}\n\n當前嘗試端點: ${endpoint.split('/models/')[1].split(':')[0]}\n\n🔍 診斷信息：\n• 此端點在您的地區可能不可用\n• API 服務可能正在維護或更新\n• 可能需要使用不同的模型版本\n\n💡 解決方案：\n• 檢查您是否在支援的地區（美國、歐洲等）\n• 嘗試使用 VPN 連接到支援的地區\n• 確認 Google AI Studio 可正常訪問\n• 等待 5-10 分鐘後重試\n• 檢查服務狀態: https://status.cloud.google.com/\n\n🌍 地區支援信息：\n• Gemini API 主要支援：美國、歐洲、日本\n• 部分地區可能需要 VPN 訪問\n• 中國大陸地區通常需要使用代理`;
                                        console.error(`❌ 404 錯誤詳情:`, errorData);
                                    } catch (parseErr) {
                                        lastError = `❌ API 端點不存在 (404)\n\n當前嘗試端點: ${endpoint.split('/models/')[1].split(':')[0]}\n\n🔍 可能的原因：\n• 地區限制 - Gemini API 在某些地區不可用\n• 服務維護 - Google 可能正在更新服務\n• 模型版本變更 - 端點可能已更新\n\n💡 建議解決方案：\n• 使用 VPN 連接到美國或歐洲\n• 檢查 Google AI Studio 可用性\n• 等待 10-15 分鐘後重試\n• 確認您的 API 金鑰有效`;
                                        console.error(`❌ 404 錯誤: 無法解析錯誤詳情`, parseErr);
                                    }
                                } else if (response.status === 503) {
                                    lastError = `🔄 AI 服務暫時繁忙中\n\n建議：\n• 等待 1-2 分鐘後重試`;
                                } else if (response.status === 429) {
                                    lastError = `⏱️ 請求太頻繁\n\n建議：\n• 等待 30 秒後重試`;
                                } else if (response.status === 400) {
                                    lastError = `❌ 請求格式錯誤\n\n可能原因：\n• 訊息內容有問題\n• API 金鑰格式錯誤`;
                                } else {
                                    lastError = `❌ 未知錯誤 (${response.status})\n\n請檢查網路連線和 API 設定`;
                                }
                                
                                if (response.status === 503) {
                                    console.warn('⚠️ 503 錯誤，等待後重試...');
                                    await new Promise(resolve => setTimeout(resolve, 2000)); // 等待2秒
                                } else if (response.status === 429) {
                                    console.warn('⚠️ 429 錯誤，等待後重試...');
                                    await new Promise(resolve => setTimeout(resolve, 3000)); // 等待3秒
                                } else if (response.status === 404) {
                                    console.error(`❌ 404 錯誤: 端點不存在，跳轉到下一個端點`);
                                    break; // 直接跳到下一個端點
                                } else if (response.status === 400 || response.status === 403) {
                                    console.error(`❌ ${response.status} 錯誤:`, errorText);
                                    break; // 這些錯誤不需要重試
                                }
                            }
                            
                        } catch (err) {
                            lastError = `網路錯誤: ${err.message}`;
                            console.error('❌ 網路錯誤:', err);
                            
                            if (retryCount < maxRetries) {
                                console.log('⏳ 等待後重試...');
                                await new Promise(resolve => setTimeout(resolve, 1000)); // 等待1秒
                            }
                        }
                        
                        retryCount++;
                    }
                    
                    if (response && response.ok) break;
                }

                if (!response || !response.ok) {
                    // 收集診斷信息
                    const diagnosticInfo = await generateDiagnosticReport(lastError);
                    throw new Error(lastError + '\n\n' + diagnosticInfo);
                }

                const data = await response.json();
                let aiResponse = data.candidates[0].content.parts[0].text;

                // 只有在成功獲得回應後才增加使用計數
                incrementUsage();

                // 後處理 AI 回應，檢查並防止迴圈（使用 Google Gemini API 檢測）
                if (typeof HealingConfig !== 'undefined' && HealingConfig.functions.postProcessResponse) {
                    const processedResponse = await HealingConfig.functions.postProcessResponse(
                        aiResponse, 
                        healingPhase, 
                        message, 
                        conversationHistory,
                        apiKey  // 傳遞 API Key 供迴圈檢測使用
                    );
                    
                    // 如果檢測到迴圈，使用處理後的回應
                    if (processedResponse.wasLoop) {
                        console.log('🔄 已防止迴圈回應');
                        if (processedResponse.analysisResult) {
                            console.log('🤖 AI 分析結果:', processedResponse.analysisResult);
                        }
                        if (processedResponse.loopType) {
                            console.log('📊 檢測方式:', processedResponse.loopType);
                        }
                        aiResponse = processedResponse.response;
                        
                        // 可選：在除錯模式下顯示資訊
                        if (false) { // 設為 true 可啟用除錯模式
                            console.log('原始回應:', processedResponse.originalResponse);
                            console.log('防迴圈回應:', aiResponse);
                        }
                    }
                }

                addMessageToChat('ai', aiResponse, false);

                // 記錄 AI 回應
                conversationHistory.push({
                    sender: 'ai',
                    message: aiResponse,
                    timestamp: new Date(),
                    phase: healingPhase
                });

                // 更新療癒階段
                if (typeof HealingConfig !== 'undefined') {
                    healingPhase = HealingConfig.functions.updatePhase(healingPhase, message);
                    updatePhaseDisplay();
                }

            } catch (error) {
                console.error('API Error:', error);
                
                let errorMessage = '';
                if (error.message.includes('503')) {
                    errorMessage = `🔄 AI 服務暫時繁忙中，請稍後再試。\n\n💡 建議：\n• 等待 1-2 分鐘後重新發送\n• 或點擊重試按鈕`;
                } else if (error.message.includes('429')) {
                    errorMessage = `⏱️ 請求太頻繁，請稍後再試。\n\n💡 建議：\n• 等待 30 秒後重新發送\n• 避免快速連續發送訊息`;
                } else if (error.message.includes('400')) {
                    errorMessage = `❌ 訊息格式有問題。\n\n💡 建議：\n• 檢查您的訊息內容\n• 嘗試重新整理頁面`;
                } else if (error.message.includes('401') || error.message.includes('403')) {
                    errorMessage = `🔑 API 金鑰需要更新。\n\n💡 建議：\n• 點擊右上角「⚙️ API 設定」\n• 檢查您的 Google Gemini API 金鑰\n• 確認金鑰有效且未過期`;
                } else {
                    errorMessage = `⚠️ 連線發生問題。\n\n💡 建議：\n• 檢查網路連線\n• 點擊重試按鈕\n• 如持續發生，請檢查 API 金鑰設定`;
                }
                
                addMessageToChat('ai', errorMessage, true); // 加入錯誤標記
            } finally {
                showThinking(false);
                toggleInput(true);
            }
        }

        // === 提示詞生成功能 ===
        function getPrompt(userInput) {
            // 療癒模式（預設啟用）
            if (typeof HealingConfig !== 'undefined') {
                return HealingConfig.functions.generatePrompt(healingPhase, userInput, conversationHistory);
            } else {
                // 降級到基本療癒模式
                return `你是一個專業的心理療癒師和內在小孩治療專家。請以溫暖、同理心和專業的方式回應使用者。

使用者的訊息："${userInput}"

請給予有療癒意義的回應：`;
            }
        }

        // === UI 輔助功能 ===
        function addMessageToChat(sender, message, isError = false) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `chat-message ${sender}-message`;
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            // 如果是錯誤訊息，加入重試按鈕
            if (isError && sender === 'ai') {
                messageContent.style.position = 'relative';
                messageContent.style.paddingBottom = '40px'; // 為重試按鈕預留空間
                messageContent.innerHTML = message.replace(/\n/g, '<br>');
                
                // 創建重試按鈕
                const retryButton = document.createElement('button');
                retryButton.innerHTML = '🔄';
                retryButton.title = '重新發送上一則訊息';
                retryButton.className = 'retry-button';
                retryButton.style.cssText = `
                    position: absolute;
                    bottom: 8px;
                    right: 8px;
                    background: var(--accent-blue);
                    color: var(--bg-primary);
                    border: none;
                    border-radius: 50%;
                    width: 24px;
                    height: 24px;
                    cursor: pointer;
                    font-size: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.2s ease;
                `;
                
                retryButton.addEventListener('click', function() {
                    // 重新發送上一則用戶訊息
                    if (conversationHistory.length > 0) {
                        const lastUserMessage = conversationHistory
                            .slice()
                            .reverse()
                            .find(msg => msg.sender === 'user');
                        
                        if (lastUserMessage) {
                            // 移除錯誤訊息
                            messageWrapper.remove();
                            
                            // 移除對話歷史中的最後一則用戶訊息，重新發送
                            const lastUserIndex = conversationHistory.map(msg => msg.sender).lastIndexOf('user');
                            if (lastUserIndex !== -1) {
                                conversationHistory.splice(lastUserIndex, 1);
                            }
                            
                            // 設定輸入框並發送
                            userInput.value = lastUserMessage.message;
                            sendMessage();
                        }
                    }
                });
                
                messageContent.appendChild(retryButton);
            } else {
                messageContent.innerHTML = message.replace(/\n/g, '<br>');
            }
            
            messageWrapper.appendChild(messageContent);
            chatBox.insertBefore(messageWrapper, thinkingIndicator);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function toggleInput(enabled) {
            userInput.disabled = !enabled;
            sendBtn.disabled = !enabled;
            if(enabled) userInput.focus();
        }
        
        function showThinking(isThinking, customMessage = null) {
            const thinkingText = thinkingIndicator.querySelector('span');
            if (customMessage) {
                thinkingText.textContent = customMessage;
            } else {
                thinkingText.textContent = '正在思考...';
            }
            
            thinkingIndicator.classList.toggle('hidden', !isThinking);
            if (isThinking) chatBox.scrollTop = chatBox.scrollHeight;
        }

        // 更新使用量顯示
        function updateUsageDisplay() {
            const usageCountEl = document.getElementById('usage-count');
            const usageLimitEl = document.getElementById('usage-limit');
            const usageIndicatorEl = document.getElementById('usage-indicator');
            
            if (usageCountEl) {
                usageCountEl.textContent = dailyUsageCount;
            }
            if (usageLimitEl) {
                usageLimitEl.textContent = DAILY_FREE_LIMIT;
            }
            
            // 根據使用量改變顏色
            if (usageIndicatorEl) {
                if (dailyUsageCount >= DAILY_FREE_LIMIT) {
                    usageIndicatorEl.style.color = '#ff6b6b'; // 紅色 - 已用完
                } else if (dailyUsageCount >= USAGE_WARNING_THRESHOLD) {
                    usageIndicatorEl.style.color = '#ffa726'; // 橙色 - 警告
                } else {
                    usageIndicatorEl.style.color = 'var(--text-secondary)'; // 預設顏色
                }
            }
        }

        // === 階段顯示更新功能 ===
        function updatePhaseDisplay() {
            if (typeof HealingConfig !== 'undefined') {
                const phaseDisplay = document.getElementById('current-phase');
                phaseDisplay.textContent = HealingConfig.functions.getPhaseDisplayName(healingPhase);
            }
        }

        // === API 設定功能 ===
        async function testApiKey(testKey) {
            try {
                console.log('🧪 測試 API 金鑰...');
                // 使用最穩定的端點進行測試
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=' + testKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: '測試' }] }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 100
                        }
                    })
                });
                
                if (response.ok) {
                    console.log('✅ API 金鑰有效');
                    return { success: true, message: 'API 金鑰測試成功！' };
                } else {
                    const errorText = await response.text();
                    console.log('❌ API 測試失敗:', response.status, errorText);
                    
                    let errorMessage = '';
                    switch (response.status) {
                        case 400:
                            errorMessage = '請求格式錯誤或金鑰格式不正確';
                            break;
                        case 401:
                            errorMessage = 'API 金鑰無效或未授權';
                            break;
                        case 403:
                            errorMessage = 'API 金鑰無權限或服務未啟用';
                            break;
                        case 404:
                            errorMessage = 'API 端點不存在或模型不可用';
                            break;
                        case 429:
                            errorMessage = '請求頻率過高，請稍後再試';
                            break;
                        case 500:
                            errorMessage = 'Google 服務器內部錯誤';
                            break;
                        case 503:
                            errorMessage = 'Google 服務暫時不可用';
                            break;
                        default:
                            errorMessage = `HTTP ${response.status} 錯誤`;
                    }
                    
                    return { 
                        success: false, 
                        message: errorMessage,
                        statusCode: response.status,
                        details: errorText
                    };
                }
            } catch (error) {
                console.log('❌ API 測試錯誤:', error);
                return { 
                    success: false, 
                    message: `網路連線錯誤: ${error.name} - ${error.message}`,
                    details: error.toString()
                };
            }
        }

        function showApiConfig() {
            const instructions = `🔑 Google Gemini API 金鑰設定

📊 今日使用狀態：${dailyUsageCount}/${DAILY_FREE_LIMIT} 次
${dailyUsageCount >= USAGE_WARNING_THRESHOLD ? '⚠️ 接近每日免費額度限制' : '✅ 使用狀態正常'}

⚠️ 如果遇到 404 錯誤，可能是地區限制問題

📝 如何申請 Google Gemini API 金鑰：
1. 前往 https://aistudio.google.com/app/apikey
2. 登入您的 Google 帳號
3. 點擊「Create API Key」
4. 選擇「Create API key in new project」
5. 複製生成的 API 金鑰
6. 將 API 金鑰貼上到下方輸入框

🌍 如果持續遇到 404 錯誤：
• 您的地區可能不支援 Gemini API
• 嘗試使用 VPN 連接到美國或歐洲
• 檢查 Google AI Studio 的地區可用性

💡 API 金鑰格式範例：AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

目前狀態：${apiKey ? '✅ 已設定API金鑰' : '❌ 尚未設定API金鑰'}`;

            const key = prompt(instructions, '');
            if (key !== null && key.trim() !== '') {
                const newKey = key.trim();
                
                // 先檢查地區支援
                checkRegionSupport().then(regionResult => {
                    if (!regionResult.supported) {
                        alert('⚠️ 地區限制警告\n\n您的地區可能不支援 Gemini API。\n建議使用 VPN 連接到支援的地區後再測試 API 金鑰。');
                    }
                    
                    // 測試新的 API 金鑰
                    testApiKey(newKey).then(result => {
                        if (result.success) {
                            apiKey = newKey;
                            localStorage.setItem('gemini_api_key', apiKey);
                            alert('✅ API 金鑰設定成功並已通過測試！');
                        } else {
                            let errorMsg = `❌ ${result.message}\n\n請檢查您的 API 金鑰是否正確。`;
                            if (result.statusCode === 404) {
                                errorMsg += '\n\n🌍 如果持續出現 404 錯誤，可能是地區限制：\n• 嘗試使用 VPN\n• 檢查 Google AI Studio 地區可用性';
                            }
                            alert(errorMsg);
                        }
                    });
                });
            }
        }

        // === 事件監聽器 ===
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // === 初始化 ===
        document.addEventListener('DOMContentLoaded', function() {
            // 載入每日使用量
            loadDailyUsage();
            updateUsageDisplay();
            
            toggleInput(true);
            
            // 檢查 API 金鑰
            if (!apiKey || apiKey.length < 20) {
                console.warn('⚠️ 未設定有效的 API 金鑰');
                
                // 在初始訊息後面加入設定提示
                setTimeout(() => {
                    addMessageToChat('ai', `🔑 請先設定您的 Google Gemini API 金鑰才能開始對話。\n\n點擊右上角「⚙️ API 設定」來設定您的金鑰。\n\n📝 如何申請：前往 https://aistudio.google.com/app/apikey`, false);
                }, 1000);
            } else {
                // 檢查今日使用量狀態
                if (checkUsageLimit()) {
                    setTimeout(() => {
                        addMessageToChat('ai', `⏰ 今日免費額度已用完！\n\n您今天已使用了 ${dailyUsageCount} 次免費額度。請明天再來使用，或考慮升級到付費版本。\n\n💡 免費額度將在明日 00:00 重置。`, false);
                    }, 1500);
                } else if (checkUsageWarning()) {
                    const remaining = DAILY_FREE_LIMIT - dailyUsageCount;
                    setTimeout(() => {
                        addMessageToChat('ai', `⚠️ 額度提醒：您今天還剩 ${remaining} 次免費使用機會。\n\n建議珍惜剩餘額度，明日將自動重置。`, false);
                    }, 1500);
                }
            }
            
            // 檢查療癒設定檔是否載入並初始化
            if (typeof HealingConfig !== 'undefined') {
                console.log('✅ 療癒功能設定檔已載入');
                HealingConfig.functions.toggleHealingMode(true); // 預設啟用療癒模式
                updatePhaseDisplay();
            } else {
                console.log('⚠️ 療癒功能設定檔未載入，將以基本療癒模式運行');
            }
        });
    </script>

</body>
</html>
