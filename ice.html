<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI äº’å‹•ä»‹é¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- è¼‰å…¥ç™‚ç™’åŠŸèƒ½è¨­å®šæª” -->
    <script src="healing-config.js"></script>
    
    <style>
        :root {
            --bg-primary: #131314;
            --bg-secondary: #1e1f20;
            --bg-tertiary: #2a2b2c;
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --border-color: #3c4043;
            --accent-blue: #8ab4f8;
            --gemini-gradient: linear-gradient(135deg, #4285f4, #ea4335, #fbbc04, #34a853);
        }
        body {
            font-family: 'Google Sans', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        .gemini-container {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
        }
        .chat-header {
            border-bottom: 1px solid var(--border-color);
        }
        .chat-message {
            margin-bottom: 16px;
            display: flex;
            width: 100%;
        }
        .ai-message {
            justify-content: flex-start;
        }
        .user-message {
            justify-content: flex-end;
        }
        .ai-message .message-content {
            background-color: var(--bg-tertiary);
            border-bottom-left-radius: 4px;
        }
        .user-message .message-content {
            background-color: var(--accent-blue);
            color: var(--bg-primary);
            border-bottom-right-radius: 4px;
        }
        .message-content {
            padding: 12px 16px;
            border-radius: 18px;
            display: inline-block;
            max-width: 70%;
            word-wrap: break-word;
        }
        .input-area {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 24px;
        }
        .message-input {
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            width: 100%;
        }
        .send-button {
            background-color: var(--accent-blue);
            color: var(--bg-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
        }
        .send-button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }
        .thinking-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            justify-content: flex-start;
        }
        .thinking-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-blue);
            border-radius: 50%;
            animation: thinking-pulse 1.4s ease-in-out infinite both;
        }
        .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes thinking-pulse {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        .phase-indicator {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            color: var(--text-secondary);
            display: inline-block;
            margin-bottom: 16px;
        }
        .retry-button {
            transition: all 0.2s ease;
        }
        .retry-button:hover {
            background-color: var(--text-primary) !important;
            transform: scale(1.1);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-3xl mx-auto gemini-container">
        <!-- Header -->
        <div class="chat-header p-4 flex justify-between items-center">
            <h1 class="text-xl font-medium">è–©æçˆ¾å†°å±±æ¢ç´¢è€…</h1>
            <div class="flex gap-2">
                <button onclick="showApiConfig()" class="text-sm bg-gray-600 hover:bg-gray-500 py-1 px-3 rounded-lg">
                    âš™ï¸ API è¨­å®š
                </button>
            </div>
        </div>

        <!-- Phase Indicator -->
        <div id="phase-indicator" class="p-4">
            <div class="flex justify-between items-center">
                <div class="phase-indicator">
                    ç›®å‰éšæ®µï¼š<span id="current-phase">åˆå§‹æ¢ç´¢</span>
                </div>
                <div id="usage-indicator" class="phase-indicator">
                    ä»Šæ—¥ä½¿ç”¨ï¼š<span id="usage-count">0</span>/<span id="usage-limit">50</span> æ¬¡
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div id="chat-box" class="p-6 h-[60vh] overflow-y-auto">
            <!-- Initial AI Message -->
            <div class="chat-message ai-message">
                <div class="message-content" id="initial-message">
                    <p>æ­¡è¿ä¾†åˆ°å…§åœ¨æ¢ç´¢çš„å®‰å…¨ç©ºé–“ã€‚</p>
                    <p class="mt-2">æœ€è¿‘æœ‰ä»€éº¼è®“æ‚¨æ„Ÿåˆ°å›°æ“¾çš„äº‹ä»¶æˆ–è¡Œç‚ºå—ï¼Ÿ</p>
                </div>
            </div>
             <!-- Thinking Indicator -->
            <div id="thinking-indicator" class="chat-message ai-message hidden">
                <div class="message-content thinking-indicator">
                    <span>æ­£åœ¨æ€è€ƒ...</span>
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4">
            <div class="input-area p-2 flex items-center">
                <input type="text" id="user-input" class="message-input px-3" placeholder="è¼¸å…¥æ‚¨çš„è¨Šæ¯...">
                <button id="send-btn" onclick="sendMessage()" class="send-button" title="å‚³é€è¨Šæ¯">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // === åŸºæœ¬è®Šæ•¸è¨­å®š ===
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const thinkingIndicator = document.getElementById('thinking-indicator');

        // API è¨­å®šå’Œé¡åº¦ç®¡ç†
        let apiKey = localStorage.getItem('gemini_api_key') || '';
        let currentKeyIndex = 0;
        let dailyUsageCount = 0;
        let lastUsageDate = '';
        
        // æ¯æ—¥å…è²»é¡åº¦é™åˆ¶ (Gemini API å…è²»å±¤é€šå¸¸ç‚ºæ¯æ—¥50-60æ¬¡è«‹æ±‚)
        const DAILY_FREE_LIMIT = 50;
        const USAGE_WARNING_THRESHOLD = 40; // 80% æ™‚è­¦å‘Š

        // è¼‰å…¥ä»Šæ—¥ä½¿ç”¨é‡
        function loadDailyUsage() {
            const today = new Date().toDateString();
            const savedDate = localStorage.getItem('api_usage_date');
            const savedCount = parseInt(localStorage.getItem('api_usage_count') || '0');
            
            if (savedDate === today) {
                dailyUsageCount = savedCount;
                lastUsageDate = today;
            } else {
                // æ–°çš„ä¸€å¤©ï¼Œé‡ç½®è¨ˆæ•¸
                dailyUsageCount = 0;
                lastUsageDate = today;
                localStorage.setItem('api_usage_date', today);
                localStorage.setItem('api_usage_count', '0');
            }
        }

        // å¢åŠ ä½¿ç”¨è¨ˆæ•¸
        function incrementUsage() {
            dailyUsageCount++;
            localStorage.setItem('api_usage_count', dailyUsageCount.toString());
            updateUsageDisplay(); // æ›´æ–°é¡¯ç¤º
        }

        // æª¢æŸ¥æ˜¯å¦è¶…éé¡åº¦
        function checkUsageLimit() {
            return dailyUsageCount >= DAILY_FREE_LIMIT;
        }

        // æª¢æŸ¥æ˜¯å¦æ¥è¿‘é¡åº¦è­¦å‘Šç·š
        function checkUsageWarning() {
            return dailyUsageCount >= USAGE_WARNING_THRESHOLD;
        }

        // ç™‚ç™’ç³»çµ±è®Šæ•¸ï¼ˆé è¨­å•Ÿç”¨ï¼‰
        let healingPhase = 'initial';
        let conversationHistory = [];
        let healingModeEnabled = true;

        // === æ ¸å¿ƒç™¼é€è¨Šæ¯åŠŸèƒ½ ===
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            if (!apiKey || apiKey.length < 20) {
                alert('ğŸ”‘ è«‹å…ˆè¨­å®šæ‚¨çš„ Google Gemini API é‡‘é‘°ï¼\n\né»æ“Šå³ä¸Šè§’ã€Œâš™ï¸ API è¨­å®šã€ä¾†è¨­å®šæ‚¨çš„é‡‘é‘°ã€‚');
                showApiConfig();
                return;
            }

            // æª¢æŸ¥æ¯æ—¥ä½¿ç”¨é¡åº¦
            if (checkUsageLimit()) {
                alert('â° ä»Šæ—¥å…è²»é¡åº¦å·²ç”¨å®Œï¼\n\næ‚¨ä»Šå¤©å·²ä½¿ç”¨äº† ' + dailyUsageCount + ' æ¬¡å…è²»é¡åº¦ã€‚\nè«‹æ˜å¤©å†ä¾†ä½¿ç”¨ï¼Œæˆ–è€ƒæ…®å‡ç´šåˆ°ä»˜è²»ç‰ˆæœ¬ã€‚\n\nğŸ’¡ å…è²»é¡åº¦å°‡åœ¨æ˜æ—¥ 00:00 é‡ç½®ã€‚');
                return;
            }

            // è­¦å‘Šå³å°‡é”åˆ°é¡åº¦é™åˆ¶
            if (checkUsageWarning() && dailyUsageCount < DAILY_FREE_LIMIT) {
                const remaining = DAILY_FREE_LIMIT - dailyUsageCount;
                const shouldContinue = confirm(`âš ï¸ é¡åº¦è­¦å‘Šï¼\n\næ‚¨ä»Šå¤©é‚„å‰© ${remaining} æ¬¡å…è²»ä½¿ç”¨æ©Ÿæœƒã€‚\næ˜¯å¦è¦ç¹¼çºŒä½¿ç”¨ï¼Ÿ\n\nğŸ’¡ å»ºè­°çæƒœå‰©é¤˜é¡åº¦ï¼Œæ˜æ—¥å°‡è‡ªå‹•é‡ç½®ã€‚`);
                if (!shouldContinue) {
                    return;
                }
            }

            toggleInput(false);
            addMessageToChat('user', message, false);
            userInput.value = '';
            showThinking(true);

            // è¨˜éŒ„å°è©±æ­·å²
            conversationHistory.push({
                sender: 'user',
                message: message,
                timestamp: new Date(),
                phase: healingPhase
            });

            try {
                // ä½¿ç”¨ Gemini 1.5 Flash (v1) ä½œç‚ºé¦–é¸ç«¯é»
                const endpoints = [
                    'https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=',
                    'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=',
                    'https://generativelanguage.googleapis.com/v1/models/gemini-1.5-pro:generateContent?key=',
                    'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key='
                ];

                let response = null;
                let lastError = null;
                let retryCount = 0;
                const maxRetries = 2;

                for (const endpoint of endpoints) {
                    retryCount = 0;
                    
                    while (retryCount <= maxRetries) {
                        try {
                            console.log(`ğŸ”„ å˜—è©¦ç«¯é»: ${endpoint.split('?')[0]} (é‡è©¦ ${retryCount}/${maxRetries})`);
                            
                            if (retryCount > 0) {
                                showThinking(true, `é€£ç·šé‡è©¦ä¸­... (${retryCount}/${maxRetries})`);
                            }
                            
                            response = await fetch(endpoint + apiKey, {
                                method: 'POST',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'User-Agent': 'Mozilla/5.0'
                                },
                                body: JSON.stringify({
                                    contents: [{ parts: [{ text: getPrompt(message) }] }],
                                    generationConfig: {
                                        temperature: 0.7,
                                        maxOutputTokens: 1000
                                    }
                                })
                            });

                            if (response.ok) {
                                console.log('âœ… API è«‹æ±‚æˆåŠŸ');
                                console.log(`ğŸ¯ ä½¿ç”¨ç«¯é»: ${endpoint.split('/models/')[1].split(':')[0]} (${endpoint.includes('v1beta') ? 'v1beta' : 'v1'})`);
                                break;
                            } else {
                                const errorText = await response.text();
                                console.log(`âŒ ç«¯é» ${endpoint.split('/')[4]} å¤±æ•—:`, response.status);
                                
                                if (response.status === 403) {
                                    lastError = `ğŸ”‘ API é‡‘é‘°ç„¡æ•ˆæˆ–ç„¡æ¬Šé™\n\nå¯èƒ½åŸå› ï¼š\nâ€¢ API é‡‘é‘°éŒ¯èª¤æˆ–éæœŸ\nâ€¢ æœªå•Ÿç”¨ Gemini API æœå‹™\nâ€¢ è¶…å‡ºä½¿ç”¨é¡åº¦`;
                                } else if (response.status === 404) {
                                    lastError = `âŒ API ç«¯é»ä¸å­˜åœ¨\n\nå¯èƒ½åŸå› ï¼š\nâ€¢ ä½¿ç”¨äº†å·²æ£„ç”¨çš„æ¨¡å‹åç¨±ï¼ˆå¦‚ gemini-proï¼‰\nâ€¢ API ç‰ˆæœ¬ä¸æ­£ç¢º\nâ€¢ æ‚¨çš„åœ°å€å¯èƒ½ä¸æ”¯æ´æ­¤ API\n\nå»ºè­°ï¼š\nâ€¢ ä½¿ç”¨ gemini-1.5-flash æ›¿ä»£ gemini-pro\nâ€¢ å˜—è©¦ v1beta API ç‰ˆæœ¬\nâ€¢ æª¢æŸ¥ Google AI Studio æœå‹™ç‹€æ…‹`;
                                } else if (response.status === 503) {
                                    lastError = `ğŸ”„ AI æœå‹™æš«æ™‚ç¹å¿™ä¸­\n\nå»ºè­°ï¼š\nâ€¢ ç­‰å¾… 1-2 åˆ†é˜å¾Œé‡è©¦`;
                                } else if (response.status === 429) {
                                    lastError = `â±ï¸ è«‹æ±‚å¤ªé »ç¹\n\nå»ºè­°ï¼š\nâ€¢ ç­‰å¾… 30 ç§’å¾Œé‡è©¦`;
                                } else if (response.status === 400) {
                                    lastError = `âŒ è«‹æ±‚æ ¼å¼éŒ¯èª¤\n\nå¯èƒ½åŸå› ï¼š\nâ€¢ è¨Šæ¯å…§å®¹æœ‰å•é¡Œ\nâ€¢ API é‡‘é‘°æ ¼å¼éŒ¯èª¤`;
                                } else {
                                    lastError = `âŒ æœªçŸ¥éŒ¯èª¤ (${response.status})\n\nè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå’Œ API è¨­å®š`;
                                }
                                
                                if (response.status === 503) {
                                    console.warn('âš ï¸ 503 éŒ¯èª¤ï¼Œç­‰å¾…å¾Œé‡è©¦...');
                                    await new Promise(resolve => setTimeout(resolve, 2000)); // ç­‰å¾…2ç§’
                                } else if (response.status === 429) {
                                    console.warn('âš ï¸ 429 éŒ¯èª¤ï¼Œç­‰å¾…å¾Œé‡è©¦...');
                                    await new Promise(resolve => setTimeout(resolve, 3000)); // ç­‰å¾…3ç§’
                                } else if (response.status === 400 || response.status === 403 || response.status === 404) {
                                    console.error(`âŒ ${response.status} éŒ¯èª¤:`, errorText);
                                    break; // é€™äº›éŒ¯èª¤ä¸éœ€è¦é‡è©¦
                                }
                            }
                            
                        } catch (err) {
                            lastError = `ç¶²è·¯éŒ¯èª¤: ${err.message}`;
                            console.error('âŒ ç¶²è·¯éŒ¯èª¤:', err);
                            
                            if (retryCount < maxRetries) {
                                console.log('â³ ç­‰å¾…å¾Œé‡è©¦...');
                                await new Promise(resolve => setTimeout(resolve, 1000)); // ç­‰å¾…1ç§’
                            }
                        }
                        
                        retryCount++;
                    }
                    
                    if (response && response.ok) break;
                }

                if (!response || !response.ok) {
                    throw new Error(lastError || 'API è«‹æ±‚å¤±æ•—');
                }

                const data = await response.json();
                let aiResponse = data.candidates[0].content.parts[0].text;

                // åªæœ‰åœ¨æˆåŠŸç²å¾—å›æ‡‰å¾Œæ‰å¢åŠ ä½¿ç”¨è¨ˆæ•¸
                incrementUsage();

                // å¾Œè™•ç† AI å›æ‡‰ï¼Œæª¢æŸ¥ä¸¦é˜²æ­¢è¿´åœˆï¼ˆä½¿ç”¨ Google Gemini API æª¢æ¸¬ï¼‰
                if (typeof HealingConfig !== 'undefined' && HealingConfig.functions.postProcessResponse) {
                    const processedResponse = await HealingConfig.functions.postProcessResponse(
                        aiResponse, 
                        healingPhase, 
                        message, 
                        conversationHistory,
                        apiKey  // å‚³é API Key ä¾›è¿´åœˆæª¢æ¸¬ä½¿ç”¨
                    );
                    
                    // å¦‚æœæª¢æ¸¬åˆ°è¿´åœˆï¼Œä½¿ç”¨è™•ç†å¾Œçš„å›æ‡‰
                    if (processedResponse.wasLoop) {
                        console.log('ğŸ”„ å·²é˜²æ­¢è¿´åœˆå›æ‡‰');
                        if (processedResponse.analysisResult) {
                            console.log('ğŸ¤– AI åˆ†æçµæœ:', processedResponse.analysisResult);
                        }
                        if (processedResponse.loopType) {
                            console.log('ğŸ“Š æª¢æ¸¬æ–¹å¼:', processedResponse.loopType);
                        }
                        aiResponse = processedResponse.response;
                        
                        // å¯é¸ï¼šåœ¨é™¤éŒ¯æ¨¡å¼ä¸‹é¡¯ç¤ºè³‡è¨Š
                        if (false) { // è¨­ç‚º true å¯å•Ÿç”¨é™¤éŒ¯æ¨¡å¼
                            console.log('åŸå§‹å›æ‡‰:', processedResponse.originalResponse);
                            console.log('é˜²è¿´åœˆå›æ‡‰:', aiResponse);
                        }
                    }
                }

                addMessageToChat('ai', aiResponse, false);

                // è¨˜éŒ„ AI å›æ‡‰
                conversationHistory.push({
                    sender: 'ai',
                    message: aiResponse,
                    timestamp: new Date(),
                    phase: healingPhase
                });

                // æ›´æ–°ç™‚ç™’éšæ®µ
                if (typeof HealingConfig !== 'undefined') {
                    healingPhase = HealingConfig.functions.updatePhase(healingPhase, message);
                    updatePhaseDisplay();
                }

            } catch (error) {
                console.error('API Error:', error);
                
                let errorMessage = '';
                if (error.message.includes('503')) {
                    errorMessage = `ğŸ”„ AI æœå‹™æš«æ™‚ç¹å¿™ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚\n\nğŸ’¡ å»ºè­°ï¼š\nâ€¢ ç­‰å¾… 1-2 åˆ†é˜å¾Œé‡æ–°ç™¼é€\nâ€¢ æˆ–é»æ“Šé‡è©¦æŒ‰éˆ•`;
                } else if (error.message.includes('429')) {
                    errorMessage = `â±ï¸ è«‹æ±‚å¤ªé »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚\n\nğŸ’¡ å»ºè­°ï¼š\nâ€¢ ç­‰å¾… 30 ç§’å¾Œé‡æ–°ç™¼é€\nâ€¢ é¿å…å¿«é€Ÿé€£çºŒç™¼é€è¨Šæ¯`;
                } else if (error.message.includes('400')) {
                    errorMessage = `âŒ è¨Šæ¯æ ¼å¼æœ‰å•é¡Œã€‚\n\nğŸ’¡ å»ºè­°ï¼š\nâ€¢ æª¢æŸ¥æ‚¨çš„è¨Šæ¯å…§å®¹\nâ€¢ å˜—è©¦é‡æ–°æ•´ç†é é¢`;
                } else if (error.message.includes('401') || error.message.includes('403')) {
                    errorMessage = `ğŸ”‘ API é‡‘é‘°éœ€è¦æ›´æ–°ã€‚\n\nğŸ’¡ å»ºè­°ï¼š\nâ€¢ é»æ“Šå³ä¸Šè§’ã€Œâš™ï¸ API è¨­å®šã€\nâ€¢ æª¢æŸ¥æ‚¨çš„ Google Gemini API é‡‘é‘°\nâ€¢ ç¢ºèªé‡‘é‘°æœ‰æ•ˆä¸”æœªéæœŸ`;
                } else {
                    errorMessage = `âš ï¸ é€£ç·šç™¼ç”Ÿå•é¡Œã€‚\n\nğŸ’¡ å»ºè­°ï¼š\nâ€¢ æª¢æŸ¥ç¶²è·¯é€£ç·š\nâ€¢ é»æ“Šé‡è©¦æŒ‰éˆ•\nâ€¢ å¦‚æŒçºŒç™¼ç”Ÿï¼Œè«‹æª¢æŸ¥ API é‡‘é‘°è¨­å®š`;
                }
                
                addMessageToChat('ai', errorMessage, true); // åŠ å…¥éŒ¯èª¤æ¨™è¨˜
            } finally {
                showThinking(false);
                toggleInput(true);
            }
        }

        // === æç¤ºè©ç”ŸæˆåŠŸèƒ½ ===
        function getPrompt(userInput) {
            // ç™‚ç™’æ¨¡å¼ï¼ˆé è¨­å•Ÿç”¨ï¼‰
            if (typeof HealingConfig !== 'undefined') {
                return HealingConfig.functions.generatePrompt(healingPhase, userInput, conversationHistory);
            } else {
                // é™ç´šåˆ°åŸºæœ¬ç™‚ç™’æ¨¡å¼
                return `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„å¿ƒç†ç™‚ç™’å¸«å’Œå…§åœ¨å°å­©æ²»ç™‚å°ˆå®¶ã€‚è«‹ä»¥æº«æš–ã€åŒç†å¿ƒå’Œå°ˆæ¥­çš„æ–¹å¼å›æ‡‰ä½¿ç”¨è€…ã€‚

ä½¿ç”¨è€…çš„è¨Šæ¯ï¼š"${userInput}"

è«‹çµ¦äºˆæœ‰ç™‚ç™’æ„ç¾©çš„å›æ‡‰ï¼š`;
            }
        }

        // === UI è¼”åŠ©åŠŸèƒ½ ===
        function addMessageToChat(sender, message, isError = false) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `chat-message ${sender}-message`;
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            // å¦‚æœæ˜¯éŒ¯èª¤è¨Šæ¯ï¼ŒåŠ å…¥é‡è©¦æŒ‰éˆ•
            if (isError && sender === 'ai') {
                messageContent.style.position = 'relative';
                messageContent.style.paddingBottom = '40px'; // ç‚ºé‡è©¦æŒ‰éˆ•é ç•™ç©ºé–“
                messageContent.innerHTML = message.replace(/\n/g, '<br>');
                
                // å‰µå»ºé‡è©¦æŒ‰éˆ•
                const retryButton = document.createElement('button');
                retryButton.innerHTML = 'ğŸ”„';
                retryButton.title = 'é‡æ–°ç™¼é€ä¸Šä¸€å‰‡è¨Šæ¯';
                retryButton.className = 'retry-button';
                retryButton.style.cssText = `
                    position: absolute;
                    bottom: 8px;
                    right: 8px;
                    background: var(--accent-blue);
                    color: var(--bg-primary);
                    border: none;
                    border-radius: 50%;
                    width: 24px;
                    height: 24px;
                    cursor: pointer;
                    font-size: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.2s ease;
                `;
                
                retryButton.addEventListener('click', function() {
                    // é‡æ–°ç™¼é€ä¸Šä¸€å‰‡ç”¨æˆ¶è¨Šæ¯
                    if (conversationHistory.length > 0) {
                        const lastUserMessage = conversationHistory
                            .slice()
                            .reverse()
                            .find(msg => msg.sender === 'user');
                        
                        if (lastUserMessage) {
                            // ç§»é™¤éŒ¯èª¤è¨Šæ¯
                            messageWrapper.remove();
                            
                            // ç§»é™¤å°è©±æ­·å²ä¸­çš„æœ€å¾Œä¸€å‰‡ç”¨æˆ¶è¨Šæ¯ï¼Œé‡æ–°ç™¼é€
                            const lastUserIndex = conversationHistory.map(msg => msg.sender).lastIndexOf('user');
                            if (lastUserIndex !== -1) {
                                conversationHistory.splice(lastUserIndex, 1);
                            }
                            
                            // è¨­å®šè¼¸å…¥æ¡†ä¸¦ç™¼é€
                            userInput.value = lastUserMessage.message;
                            sendMessage();
                        }
                    }
                });
                
                messageContent.appendChild(retryButton);
            } else {
                messageContent.innerHTML = message.replace(/\n/g, '<br>');
            }
            
            messageWrapper.appendChild(messageContent);
            chatBox.insertBefore(messageWrapper, thinkingIndicator);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function toggleInput(enabled) {
            userInput.disabled = !enabled;
            sendBtn.disabled = !enabled;
            if(enabled) userInput.focus();
        }
        
        function showThinking(isThinking, customMessage = null) {
            const thinkingText = thinkingIndicator.querySelector('span');
            if (customMessage) {
                thinkingText.textContent = customMessage;
            } else {
                thinkingText.textContent = 'æ­£åœ¨æ€è€ƒ...';
            }
            
            thinkingIndicator.classList.toggle('hidden', !isThinking);
            if (isThinking) chatBox.scrollTop = chatBox.scrollHeight;
        }

        // æ›´æ–°ä½¿ç”¨é‡é¡¯ç¤º
        function updateUsageDisplay() {
            const usageCountEl = document.getElementById('usage-count');
            const usageLimitEl = document.getElementById('usage-limit');
            const usageIndicatorEl = document.getElementById('usage-indicator');
            
            if (usageCountEl) {
                usageCountEl.textContent = dailyUsageCount;
            }
            if (usageLimitEl) {
                usageLimitEl.textContent = DAILY_FREE_LIMIT;
            }
            
            // æ ¹æ“šä½¿ç”¨é‡æ”¹è®Šé¡è‰²
            if (usageIndicatorEl) {
                if (dailyUsageCount >= DAILY_FREE_LIMIT) {
                    usageIndicatorEl.style.color = '#ff6b6b'; // ç´…è‰² - å·²ç”¨å®Œ
                } else if (dailyUsageCount >= USAGE_WARNING_THRESHOLD) {
                    usageIndicatorEl.style.color = '#ffa726'; // æ©™è‰² - è­¦å‘Š
                } else {
                    usageIndicatorEl.style.color = 'var(--text-secondary)'; // é è¨­é¡è‰²
                }
            }
        }

        // === éšæ®µé¡¯ç¤ºæ›´æ–°åŠŸèƒ½ ===
        function updatePhaseDisplay() {
            if (typeof HealingConfig !== 'undefined') {
                const phaseDisplay = document.getElementById('current-phase');
                phaseDisplay.textContent = HealingConfig.functions.getPhaseDisplayName(healingPhase);
            }
        }

        // === API è¨­å®šåŠŸèƒ½ ===
        async function testApiKey(testKey) {
            try {
                console.log('ğŸ§ª æ¸¬è©¦ API é‡‘é‘°...');
                // ä½¿ç”¨ Gemini 1.5 Flash (v1) ä½œç‚ºæ¸¬è©¦ç«¯é»
                const response = await fetch('https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=' + testKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: 'æ¸¬è©¦' }] }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 100
                        }
                    })
                });
                
                if (response.ok) {
                    console.log('âœ… API é‡‘é‘°æœ‰æ•ˆ');
                    return { success: true, message: 'API é‡‘é‘°æ¸¬è©¦æˆåŠŸï¼' };
                } else {
                    const errorText = await response.text();
                    console.log('âŒ API æ¸¬è©¦å¤±æ•—:', response.status, errorText);
                    
                    let errorMessage = '';
                    switch (response.status) {
                        case 400:
                            errorMessage = 'è«‹æ±‚æ ¼å¼éŒ¯èª¤æˆ–é‡‘é‘°æ ¼å¼ä¸æ­£ç¢º';
                            break;
                        case 401:
                            errorMessage = 'API é‡‘é‘°ç„¡æ•ˆæˆ–æœªæˆæ¬Š';
                            break;
                        case 403:
                            errorMessage = 'API é‡‘é‘°ç„¡æ¬Šé™æˆ–æœå‹™æœªå•Ÿç”¨';
                            break;
                        case 404:
                            errorMessage = 'API ç«¯é»ä¸å­˜åœ¨æˆ–æ¨¡å‹ä¸å¯ç”¨';
                            break;
                        case 429:
                            errorMessage = 'è«‹æ±‚é »ç‡éé«˜ï¼Œè«‹ç¨å¾Œå†è©¦';
                            break;
                        case 500:
                            errorMessage = 'Google æœå‹™å™¨å…§éƒ¨éŒ¯èª¤';
                            break;
                        case 503:
                            errorMessage = 'Google æœå‹™æš«æ™‚ä¸å¯ç”¨';
                            break;
                        default:
                            errorMessage = `HTTP ${response.status} éŒ¯èª¤`;
                    }
                    
                    return { 
                        success: false, 
                        message: errorMessage,
                        statusCode: response.status,
                        details: errorText
                    };
                }
            } catch (error) {
                console.log('âŒ API æ¸¬è©¦éŒ¯èª¤:', error);
                return { 
                    success: false, 
                    message: `ç¶²è·¯é€£ç·šéŒ¯èª¤: ${error.name} - ${error.message}`,
                    details: error.toString()
                };
            }
        }

        function showApiConfig() {
            const instructions = `ğŸ”‘ Google Gemini API é‡‘é‘°è¨­å®š

ğŸ“Š ä»Šæ—¥ä½¿ç”¨ç‹€æ…‹ï¼š${dailyUsageCount}/${DAILY_FREE_LIMIT} æ¬¡
${dailyUsageCount >= USAGE_WARNING_THRESHOLD ? 'âš ï¸ æ¥è¿‘æ¯æ—¥å…è²»é¡åº¦é™åˆ¶' : 'âœ… ä½¿ç”¨ç‹€æ…‹æ­£å¸¸'}

ğŸ“ å¦‚ä½•ç”³è«‹ Google Gemini API é‡‘é‘°ï¼š
1. å‰å¾€ https://aistudio.google.com/app/apikey
2. ç™»å…¥æ‚¨çš„ Google å¸³è™Ÿ
3. é»æ“Šã€ŒCreate API Keyã€
4. é¸æ“‡ã€ŒCreate API key in new projectã€
5. è¤‡è£½ç”Ÿæˆçš„ API é‡‘é‘°
6. å°‡ API é‡‘é‘°è²¼ä¸Šåˆ°ä¸‹æ–¹è¼¸å…¥æ¡†

ğŸ’¡ API é‡‘é‘°æ ¼å¼ç¯„ä¾‹ï¼šAIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

ç›®å‰ç‹€æ…‹ï¼š${apiKey ? 'âœ… å·²è¨­å®šAPIé‡‘é‘°' : 'âŒ å°šæœªè¨­å®šAPIé‡‘é‘°'}`;

            const key = prompt(instructions, '');
            if (key !== null && key.trim() !== '') {
                const newKey = key.trim();
                
                // æ¸¬è©¦æ–°çš„ API é‡‘é‘°
                testApiKey(newKey).then(result => {
                    if (result.success) {
                        apiKey = newKey;
                        localStorage.setItem('gemini_api_key', apiKey);
                        alert('âœ… API é‡‘é‘°è¨­å®šæˆåŠŸä¸¦å·²é€šéæ¸¬è©¦ï¼');
                    } else {
                        alert(`âŒ ${result.message}\n\nè«‹æª¢æŸ¥æ‚¨çš„ API é‡‘é‘°æ˜¯å¦æ­£ç¢ºã€‚`);
                    }
                });
            }
        }

        // === äº‹ä»¶ç›£è½å™¨ ===
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // === åˆå§‹åŒ– ===
        document.addEventListener('DOMContentLoaded', function() {
            // è¼‰å…¥æ¯æ—¥ä½¿ç”¨é‡
            loadDailyUsage();
            updateUsageDisplay();
            
            toggleInput(true);
            
            // æª¢æŸ¥ API é‡‘é‘°
            if (!apiKey || apiKey.length < 20) {
                console.warn('âš ï¸ æœªè¨­å®šæœ‰æ•ˆçš„ API é‡‘é‘°');
                
                // åœ¨åˆå§‹è¨Šæ¯å¾Œé¢åŠ å…¥è¨­å®šæç¤º
                setTimeout(() => {
                    addMessageToChat('ai', `ğŸ”‘ è«‹å…ˆè¨­å®šæ‚¨çš„ Google Gemini API é‡‘é‘°æ‰èƒ½é–‹å§‹å°è©±ã€‚\n\né»æ“Šå³ä¸Šè§’ã€Œâš™ï¸ API è¨­å®šã€ä¾†è¨­å®šæ‚¨çš„é‡‘é‘°ã€‚\n\nğŸ“ å¦‚ä½•ç”³è«‹ï¼šå‰å¾€ https://aistudio.google.com/app/apikey`, false);
                }, 1000);
            } else {
                // æª¢æŸ¥ä»Šæ—¥ä½¿ç”¨é‡ç‹€æ…‹
                if (checkUsageLimit()) {
                    setTimeout(() => {
                        addMessageToChat('ai', `â° ä»Šæ—¥å…è²»é¡åº¦å·²ç”¨å®Œï¼\n\næ‚¨ä»Šå¤©å·²ä½¿ç”¨äº† ${dailyUsageCount} æ¬¡å…è²»é¡åº¦ã€‚è«‹æ˜å¤©å†ä¾†ä½¿ç”¨ï¼Œæˆ–è€ƒæ…®å‡ç´šåˆ°ä»˜è²»ç‰ˆæœ¬ã€‚\n\nğŸ’¡ å…è²»é¡åº¦å°‡åœ¨æ˜æ—¥ 00:00 é‡ç½®ã€‚`, false);
                    }, 1500);
                } else if (checkUsageWarning()) {
                    const remaining = DAILY_FREE_LIMIT - dailyUsageCount;
                    setTimeout(() => {
                        addMessageToChat('ai', `âš ï¸ é¡åº¦æé†’ï¼šæ‚¨ä»Šå¤©é‚„å‰© ${remaining} æ¬¡å…è²»ä½¿ç”¨æ©Ÿæœƒã€‚\n\nå»ºè­°çæƒœå‰©é¤˜é¡åº¦ï¼Œæ˜æ—¥å°‡è‡ªå‹•é‡ç½®ã€‚`, false);
                    }, 1500);
                }
            }
            
            // æª¢æŸ¥ç™‚ç™’è¨­å®šæª”æ˜¯å¦è¼‰å…¥ä¸¦åˆå§‹åŒ–
            if (typeof HealingConfig !== 'undefined') {
                console.log('âœ… ç™‚ç™’åŠŸèƒ½è¨­å®šæª”å·²è¼‰å…¥');
                HealingConfig.functions.toggleHealingMode(true); // é è¨­å•Ÿç”¨ç™‚ç™’æ¨¡å¼
                updatePhaseDisplay();
            } else {
                console.log('âš ï¸ ç™‚ç™’åŠŸèƒ½è¨­å®šæª”æœªè¼‰å…¥ï¼Œå°‡ä»¥åŸºæœ¬ç™‚ç™’æ¨¡å¼é‹è¡Œ');
            }
        });
    </script>

</body>
</html>
