<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔧 OAuth 診斷工具</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin: 16px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .error {
            background: #fff5f5;
            border: 2px solid #fed7d7;
            color: #c53030;
        }
        .success {
            background: #f0fff4;
            border: 2px solid #9ae6b4;
            color: #22543d;
        }
        .warning {
            background: #fffbf0;
            border: 2px solid #fbd38d;
            color: #c05621;
        }
        .info {
            background: #ebf8ff;
            border: 2px solid #90cdf4;
            color: #2a69ac;
        }
        h1 { color: #2d3748; margin-bottom: 8px; }
        h2 { color: #4a5568; margin-top: 24px; margin-bottom: 12px; }
        code {
            background: #f7fafc;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: Monaco, Consolas, monospace;
        }
        .btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px 4px;
            font-size: 14px;
        }
        .btn:hover { background: #3182ce; }
        .btn-success { background: #48bb78; }
        .btn-success:hover { background: #38a169; }
        .btn-danger { background: #e53e3e; }
        .btn-danger:hover { background: #c53030; }
        pre {
            background: #f7fafc;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 13px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>🔧 Google OAuth 診斷工具</h1>
    <p>檢測和修復 OAuth 配置問題</p>
    
    <div class="card error">
        <h2>❌ 當前錯誤</h2>
        <p><strong>錯誤 400：origin_mismatch</strong></p>
        <p>來源：<code>http://localhost:8080</code></p>
        <p>流程：<code>GeneralOAuthFlow</code></p>
    </div>
    
    <div class="status-grid">
        <div class="card" id="server-status">
            <h3>🖥️ 服務器狀態</h3>
            <p id="server-info">檢測中...</p>
        </div>
        
        <div class="card" id="oauth-status">
            <h3>🔐 OAuth 設定</h3>
            <p id="oauth-info">檢測中...</p>
        </div>
        
        <div class="card" id="pwa-status">
            <h3>📱 PWA 狀態</h3>
            <p id="pwa-info">檢測中...</p>
        </div>
        
        <div class="card" id="icon-status">
            <h3>🎨 圖標狀態</h3>
            <p id="icon-info">檢測中...</p>
        </div>
    </div>
    
    <div class="card info">
        <h2>🔧 修復步驟</h2>
        <h3>1. 立即修復（推薦）</h3>
        <p>在 Google Cloud Console 中添加授權來源：</p>
        <pre>http://localhost:8080
http://127.0.0.1:8080
https://satir-ice-berg-web.vercel.app</pre>
        
        <div>
            <button class="btn btn-success" onclick="openGoogleConsole()">
                🚀 開啟 Google Cloud Console
            </button>
            <button class="btn" onclick="openDocumentation()">
                📖 查看詳細教學
            </button>
        </div>
        
        <h3>2. 臨時解決方案</h3>
        <p>使用測試模式跳過 OAuth 登入：</p>
        <div>
            <button class="btn btn-success" onclick="openTestMode()">
                🧪 進入測試模式
            </button>
            <button class="btn" onclick="generateIcons()">
                🎨 生成 PWA 圖標
            </button>
        </div>
    </div>
    
    <div class="card warning">
        <h2>⏰ 重要提醒</h2>
        <ul>
            <li>OAuth 設定變更需要 <strong>5-10 分鐘</strong> 才會生效</li>
            <li>修改後請清除瀏覽器快取並重新載入</li>
            <li>確保使用正確的 Client ID</li>
            <li>本地開發使用 HTTP，生產環境使用 HTTPS</li>
        </ul>
    </div>
    
    <div class="card">
        <h2>🎯 快速測試</h2>
        <div>
            <button class="btn" onclick="testMainApp()">
                🏠 測試主應用
            </button>
            <button class="btn" onclick="testPWA()">
                📱 測試 PWA 功能
            </button>
            <button class="btn" onclick="testOffline()">
                🔌 測試離線功能
            </button>
        </div>
    </div>

    <script>
        // 檢測狀態
        async function checkStatus() {
            // 檢測服務器
            try {
                const response = await fetch('/manifest.json');
                if (response.ok) {
                    document.getElementById('server-info').innerHTML = '✅ 服務器運行正常<br><small>端口: 8080</small>';
                    document.getElementById('server-status').className = 'card success';
                } else {
                    throw new Error('服務器響應異常');
                }
            } catch (error) {
                document.getElementById('server-info').innerHTML = '❌ 服務器連接失敗<br><small>' + error.message + '</small>';
                document.getElementById('server-status').className = 'card error';
            }
            
            // 檢測 OAuth
            const clientId = '28263511849-3rk0avke93rn8rfdi5hq0boffkp6gm0j.apps.googleusercontent.com';
            document.getElementById('oauth-info').innerHTML = `⚠️ 需要修復<br><small>Client ID: ${clientId.substring(0, 20)}...</small>`;
            document.getElementById('oauth-status').className = 'card warning';
            
            // 檢測 PWA
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration('/sw.js');
                    if (registration) {
                        document.getElementById('pwa-info').innerHTML = '✅ Service Worker 已註冊<br><small>PWA 功能正常</small>';
                        document.getElementById('pwa-status').className = 'card success';
                    } else {
                        document.getElementById('pwa-info').innerHTML = '⚠️ Service Worker 未註冊<br><small>正在註冊中...</small>';
                        document.getElementById('pwa-status').className = 'card warning';
                    }
                } catch (error) {
                    document.getElementById('pwa-info').innerHTML = '❌ PWA 檢測失敗<br><small>' + error.message + '</small>';
                    document.getElementById('pwa-status').className = 'card error';
                }
            } else {
                document.getElementById('pwa-info').innerHTML = '❌ 瀏覽器不支援 PWA<br><small>請使用現代瀏覽器</small>';
                document.getElementById('pwa-status').className = 'card error';
            }
            
            // 檢測圖標
            checkIcons();
        }
        
        async function checkIcons() {
            const iconSizes = ['72x72', '96x96', '128x128', '144x144', '152x152', '192x192', '384x384', '512x512'];
            let successCount = 0;
            
            for (const size of iconSizes) {
                try {
                    const response = await fetch(`/icons/icon-${size}.png`);
                    if (response.ok) successCount++;
                } catch (error) {
                    // 忽略錯誤
                }
            }
            
            if (successCount === iconSizes.length) {
                document.getElementById('icon-info').innerHTML = `✅ 所有圖標完整<br><small>${successCount}/${iconSizes.length} 個圖標</small>`;
                document.getElementById('icon-status').className = 'card success';
            } else if (successCount > 0) {
                document.getElementById('icon-info').innerHTML = `⚠️ 部分圖標缺失<br><small>${successCount}/${iconSizes.length} 個圖標</small>`;
                document.getElementById('icon-status').className = 'card warning';
            } else {
                document.getElementById('icon-info').innerHTML = `❌ 圖標尚未生成<br><small>需要生成 PWA 圖標</small>`;
                document.getElementById('icon-status').className = 'card error';
            }
        }
        
        // 功能函數
        function openGoogleConsole() {
            window.open('https://console.cloud.google.com/apis/credentials', '_blank');
        }
        
        function openDocumentation() {
            window.open('/OAUTH_FIX_DETAILED.md', '_blank');
        }
        
        function openTestMode() {
            window.location.href = '/test.html';
        }
        
        function generateIcons() {
            window.open('/icon-generator.html', '_blank');
        }
        
        function testMainApp() {
            window.location.href = '/';
        }
        
        function testPWA() {
            window.location.href = '/test.html';
        }
        
        function testOffline() {
            alert('請手動關閉網路連線測試離線功能');
        }
        
        // 初始化
        checkStatus();
        
        // 定期更新狀態
        setInterval(checkStatus, 30000);
    </script>
</body>
</html>
