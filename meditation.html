<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å†¥æƒ³éŸ³æ¨‚æ’­æ”¾å™¨</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#00aaff" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="å†¥æƒ³éŸ³æ¨‚" />
  <meta name="mobile-web-app-capable" content="yes" />
  
  <!-- Manifest -->
  <link rel="manifest" href="./manifest.json" />
  
  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" sizes="152x152" href="./icons/icon-152x152.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="./icons/icon-192x192.png" />
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="./favicon.ico" />
  
  <style>
    /* å´é‚Šå°èˆªæ¬„æ¨£å¼ from meditation.html */
    .sidebar {
      position: fixed;
      top: 0;
      left: -250px;
      width: 250px;
      height: 100vh;
      background: rgba(0, 0, 0, 0.9);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      transition: left 0.3s ease;
      z-index: 1000;
      padding: 20px;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      box-sizing: border-box;
    }
    .sidebar.open { left: 0; }
    .sidebar * { max-width: 100%; box-sizing: border-box; }
    .sidebar-header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.2); width: 100%; box-sizing: border-box; }
    .sidebar-title { color: #00aaff; font-size: 1.5em; font-weight: bold; width: 100%; word-wrap: break-word; overflow-wrap: break-word; }
    .sidebar-close { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 2em; color: #ffffff; cursor: pointer; padding: 5px; line-height: 1; z-index: 1002; }
    .sidebar-close:hover { color: #00aaff; }
    .nav-menu { list-style: none; margin: 0; padding: 0; width: 100%; text-align: center; display: flex; flex-direction: column; align-items: center; }
    .nav-item { margin-bottom: 15px; width: 100%; text-align: center; display: flex; justify-content: center; }
    .nav-link { display: inline-block; color: #ffffff; text-decoration: none; padding: 12px 20px; border-radius: 8px; transition: all 0.3s ease; font-size: 1.1em; min-width: 120px; box-sizing: border-box; word-wrap: break-word; overflow-wrap: break-word; text-align: center; }
    .nav-link:hover { background: rgba(0, 170, 255, 0.2); color: #00aaff; transform: translateX(5px); }
    .nav-link.active { background: rgba(0, 170, 255, 0.3); color: #00aaff; border-left: 3px solid #00aaff; }
    .hamburger { position: fixed; top: 20px; left: 20px; width: 40px; height: 40px; background: rgba(0, 170, 255, 0.8); border: none; border-radius: 8px; cursor: pointer; z-index: 1001; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: all 0.3s ease; }
    .hamburger:hover { background: rgba(0, 170, 255, 1); }
    .hamburger:hover:not(.open) { transform: scale(1.1); }
    .hamburger span { width: 20px; height: 2px; background: white; margin: 2px 0; transition: all 0.3s ease; }
    .hamburger.open span:nth-child(1) { transform: rotate(45deg) translate(4.5px, 4.5px) !important; }
    .hamburger.open span:nth-child(2) { opacity: 0 !important; }
    .hamburger.open span:nth-child(3) { transform: rotate(-45deg) translate(4.5px, -4.5px) !important; }
    .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
    .sidebar-overlay.active { opacity: 1; visibility: visible; }
    :root {
      --bg-primary: #131314;
      --bg-secondary: #1e1f20;
      --bg-tertiary: #2a2b2c;
      --text-primary: #e8eaed;
      --text-secondary: #9aa0a6;
      --border-color: #3c4043;
      --accent-blue: #8ab4f8;
      --accent-cyan: #00aaff;
      --card: #2a2b2c;
      --text: #ffffff;
      --sub: #e0e0e0;
      --accent: #00aaff;
      --muted: #9aa0a6;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', 'Google Sans', Arial, sans-serif;
      color: var(--text);
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      display: grid;
      place-items: center;
    }
    .phone {
      width: min(420px, 100vw);
      height: min(860px, 100vh);
      border-radius: 28px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
      background: rgba(30, 30, 45, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: grid;
      grid-template-rows: auto 1fr auto;
    }

    /* Top bar */
    .topbar {
      display: flex; align-items: center; gap: 12px;
      padding: 18px 18px 10px 18px;
      color: var(--text-primary);
      font-weight: 700;
    }
    .chev { width: 26px; height: 26px; display: grid; place-items: center; cursor: pointer; color: var(--text-secondary); }
    .subtitle { font-size: 12px; font-weight: 600; opacity: .9; color: var(--text-secondary); }
    .title { font-size: 18px; color: var(--accent-cyan); }

    /* Artwork card */
    .artwrap { padding: 18px; display: grid; place-items: center; }
    .art {
      aspect-ratio: 1 / 1; width: 100%; max-width: 720px;
      border-radius: 16px;
      background: rgba(45, 45, 60, 0.8);
      display: grid; place-items: center;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      position: relative;
      /* border: 1px solid rgba(255,255,255,0.07); */
      overflow: hidden;
    }
    
    .art-bg {
      position: absolute;
      inset: 0;
      background-size: cover;
      background-position: center;
      opacity: 0.8;
      z-index: 1;
      transition: background-image 0.5s ease-in-out;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    .loading-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #00aaff;
      animation: spin 1s ease-in-out infinite;
      z-index: 3;
      display: none;
    }
    
    .art-bg.loading .loading-indicator {
      display: block;
    }
    
    @keyframes spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    .lyrics-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(30, 30, 45, 0.1), rgba(30, 30, 45, 0.4));
      z-index: 2;
      pointer-events: none;
    }

    .lyrics-scroll-container {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      position: relative;
      inset: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
    }

    .lyrics-text.warriors-creed-style {
      color: #111;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
    }

    .lyrics-scroll-container::-webkit-scrollbar {
      width: 8px;
      background: transparent;
    }
    .lyrics-scroll-container::-webkit-scrollbar-thumb {
      background: transparent;
    }

    .lyrics-text {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 16px;
      line-height: 1.6;
      font-weight: 600;
      color: #fff;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.7);
      position: relative;
      width: 100%;
      white-space: pre-line;
      cursor: grab; /* æ”¹ç‚º grab è¡¨ç¤ºå¯æ‹–å‹• */
      -webkit-user-select: none;
      user-select: none;
      transform: translateY(0px); /* ç”± JS æ§åˆ¶ */
    }
    .lyrics-text.dragging {
      cursor: grabbing;
    }
    
    /* Track info */
    .info { padding: 6px 18px 0; }
    .trackTitle { font-size: 28px; font-weight: 800; letter-spacing:.5px; color: var(--text-primary); }
    .artist { margin-top: 6px; color: var(--text-secondary); font-weight: 600; }

    /* Seek bar */
    .seek { padding: 8px 18px 0 18px; }
    .time { display:flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
    input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 4px; border-radius: 999px; background: rgba(255,255,255,.1); outline: none; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 14px; height: 14px; border-radius: 50%; background: var(--accent-cyan); box-shadow: 0 0 0 6px rgba(0,170,255,.2); cursor: pointer; }

    /* Controls */
    .controls { padding: 16px 18px 8px; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; }
    .left, .right { display: flex; align-items: center; gap: 16px; }
    .btn { background: none; border: none; padding: 0; width: 40px; height: 40px; display:grid; place-items:center; cursor:pointer; opacity:.9; color: var(--text-secondary); border-radius: 50%; transition: all 0.2s ease; position: relative; }
    .btn.active { color: var(--accent-cyan); opacity: 1; }
    .btn svg { width: 24px; height: 24px; }
    .btn:hover { opacity: 1; background: rgba(0, 170, 255, 0.1); }
    .btn.active { background: rgba(0, 170, 255, 0.2); }

    .playwrap { display:grid; place-items:center; }
    .play { width: 84px; height: 84px; background: var(--accent-cyan); border-radius: 50%; display:grid; place-items:center; cursor:pointer; box-shadow: 0 10px 24px rgba(0,170,255,.3); border: none; padding: 0;}
    .play svg { width: 40px; height: 40px; color: white; }
    .play[data-state="pause"] .play-icon { display: none; }
    .play[data-state="pause"] .pause-icon { display: block; }
    .play[data-state="play"] .play-icon { display: block; }
    .play[data-state="play"] .pause-icon { display: none; }

    /* Bottom */
    .bottom { padding: 0 18px 18px; display:flex; align-items:center; justify-content: space-between; color: var(--text-secondary); }
    .device { display:flex; gap:10px; align-items:center; font-size: 14px; }
    .mini { display:flex; gap:14px; align-items:center; }
    .mini .btn { width: 34px; height: 34px; opacity:.85; }
    .justify-end { justify-content: flex-end; }
    .playlist-btn { margin-left: auto; background: rgba(0,170,255,.2); -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); padding: 8px 16px; border-radius: 999px; font-size: 12px; color: var(--text-primary); font-weight: 700; cursor: pointer; border: 1px solid rgba(0,170,255,.3); transition: all 0.2s ease; }
    .playlist-btn:hover { background: rgba(0,170,255,.3); transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,170,255,0.3); }

    /* Playlist modal */
    .playlist-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,.8); display: none; place-items: center; z-index: 1000; }
    .playlist-content { background: var(--bg-secondary); border-radius: 16px; padding: 24px; max-width: 400px; width: 90%; max-height: 80vh; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); }
    .playlist-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .playlist-title { font-size: 20px; font-weight: 700; color: var(--accent-cyan); }
    .close-btn { background: none; border: none; color: var(--text-primary); font-size: 24px; cursor: pointer; }
    #playlistItems { display: flex; flex-direction: column; gap: 8px; }
    .playlist-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; cursor: pointer; transition: background .2s; -webkit-user-select: none; user-select: none; }
    .playlist-item:hover { background: rgba(0,170,255,.1); }
    .playlist-item.active { background: var(--accent-cyan); }
    .playlist-item.active .playlist-item-title, .playlist-item.active .playlist-item-duration { color: var(--bg-primary); }
    .playlist-item-number { width: 24px; height: 24px; border-radius: 50%; background: rgba(255,255,255,.2); display: grid; place-items: center; font-size: 12px; font-weight: 600; flex-shrink: 0; }
    .playlist-item.active .playlist-item-number { background: rgba(0,0,0,.3); }
    .playlist-item-info { flex: 1; }
    .playlist-item-title { font-weight: 600; color: var(--text-primary); }
    .playlist-item-duration { font-size: 12px; color: var(--text-secondary); opacity: .7; }
    .drag-handle { 
      width: 24px; 
      height: 24px; 
      cursor: grab; 
      opacity: 0.6; 
      display: grid; 
      place-items: center; 
      touch-action: none; 
      -webkit-user-select: none;
      user-select: none;
      transition: opacity 0.2s ease;
    }
    .drag-handle:active { cursor: grabbing; opacity: 1; }
    .playlist-item.dragging { 
      opacity: 0.8; 
      transform: scale(1.02); 
      transition: none; 
      z-index: 1000;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .playlist-item.placeholder { 
      height: 60px; 
      background: rgba(0,170,255,0.1); 
      border: 2px dashed rgba(0,170,255,0.3); 
      border-radius: 8px; 
      display: flex; 
      align-items: center; 
      justify-content: center;
      margin: 4px 0;
      transition: all 0.2s ease;
    }
    #artBackground { border: none; }

    /* Utilities extracted from inline styles */
    .mt-20 { margin-top: 20px; }
    .mt-12 { margin-top: 12px; }
    .text-center { text-align: center; }
    .note-small { color: var(--text-secondary); font-size: 12px; }
    .btn-reset { background: rgba(255,255,255,0.1); color: var(--text-secondary); border: 1px solid rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s ease; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <!-- å´é‚Šå°èˆªæ¬„ from meditation.html -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">é¸å–®</div>
    </div>
    <ul class="nav-menu">
      <li class="nav-item"><a href="articles.html" class="nav-link">æ¯æ—¥é–±è®€</a></li>
      <li class="nav-item"><a href="yoga.html" class="nav-link">ç‘œçˆ</a></li>
      <li class="nav-item"><a href="#" class="nav-link" id="mandala-link">æ›¼è¼ç¾…</a></li>
      <li class="nav-item"><a href="guide.html" class="nav-link">æ¯æ—¥æŒ‡å¼•</a></li>
    </ul>
  </div>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <button class="hamburger" id="hamburger" title="å±•é–‹é¸å–®">
    <span></span>
    <span></span>
    <span></span>
  </button>
  <div class="phone">
    <div class="topbar">
      <div class="chev" title="è¿”å›"><svg viewBox="0 0 24 24" width="26" height="26" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></div>
      <div>
        <div class="subtitle">æ’­æ”¾è‡ªæ’­æ”¾æ¸…å–®</div>
        <div class="title" id="playlistName">å†¥æƒ³éŸ³æ¨‚ åˆè¼¯</div>
      </div>
      <button class="playlist-btn" id="playlistBtn">æ’­æ”¾æ¸…å–®</button>
    </div>
    <div class="artwrap">
      <div class="art">
        <div class="art-bg" id="artBackground">
          <div class="loading-indicator"></div>
          <div class="lyrics-scroll-container">
            <div class="lyrics-text" id="lyricsText">éœå¿ƒè†è½ï¼Œæ„Ÿå—å…§åœ¨çš„å¯§éœèˆ‡å’Œè«§</div>
          </div>
        </div>
        <div class="lyrics-overlay"></div>
      </div>
    </div>

    <div class="info">
      <div class="trackTitle" id="trackTitle">å½©è™¹å†¥æƒ³</div>
      <div class="artist" id="artist">å†¥æƒ³éŸ³æ¨‚åˆè¼¯</div>
    </div>

    <div class="seek">
      <input id="seek" type="range" min="0" max="100" value="0" step="0.1" aria-label="æ’­æ”¾é€²åº¦" title="æ’­æ”¾é€²åº¦" />
      <div class="time"><span id="cur">0:00</span><span id="dur">0:00</span></div>
    </div>

    <div class="controls">
      <div class="left">
        <button class="btn" id="shuffle" title="éš¨æ©Ÿæ’­æ”¾"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg></button>
        <button class="btn" id="prev" title="ä¸Šä¸€é¦–"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 19 2 12 11 5 11 19"></polygon><line x1="22" y1="5" x2="22" y2="19"></line></svg></button>
      </div>
      <div class="playwrap">
        <button class="play" id="play" data-state="play" title="æ’­æ”¾ / æš«åœ"><svg viewBox="0 0 48 48" fill="currentColor"><path class="play-icon" d="M18 14 L36 24 L18 34 Z" /><path class="pause-icon" d="M16 14 H22 V34 H16 Z M26 14 H32 V34 H26 Z" /></svg></button>
      </div>
      <div class="right justify-end">
        <button class="btn" id="next" title="ä¸‹ä¸€é¦–"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 19 22 12 13 5 13 19"></polygon><line x1="2" y1="5" x2="2" y2="19"/></svg></button>
        <button class="btn" id="repeat" title="å¾ªç’°æ’­æ”¾"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg></button>
      </div>
    </div>

    <div class="bottom">
      <div class="device">
        <svg id="deviceIcon" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" title="éŸ³è¨Šè¼¸å‡ºè£ç½®"><rect x="2" y="7" width="20" height="14" rx="2"/><line x1="8" y1="7" x2="8" y2="3"/><line x1="16" y1="7" x2="16" y2="3"/></svg>
        <span id="deviceName">æœ¬æ©Ÿæ’­æ”¾</span>
      </div>
      <div class="mini">
      </div>
    </div>
    <audio id="audio" preload="metadata"></audio>
  </div>

  <div class="playlist-modal" id="playlistModal">
    <div class="playlist-content">
      <div class="playlist-header">
        <div class="playlist-title">å†¥æƒ³éŸ³æ¨‚æ’­æ”¾æ¸…å–®</div>
        <button class="close-btn" id="closePlaylist">&times;</button>
      </div>
      <div id="playlistItems"></div>
      <div class="mt-20 text-center note-small">ğŸ’¡ æŒ‰ä½æ‹–æ›³åœ–ç¤ºå¯é‡æ–°æ’åº</div>
      <div class="mt-12 text-center">
        <button id="resetPlaylistOrder" class="btn-reset">é‡ç½®ç‚ºåŸå§‹é †åº</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // å´é‚Šæ¬„/æ¼¢å ¡é¸å–®äº’å‹• from meditation.html
      function detectDeviceAndSetMandalaLink() {
        const mandalaLink = document.getElementById('mandala-link');
        if (mandalaLink) {
          const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
          const screenWidth = window.screen.width;
          let isMobileDevice = false;
          if (isMobile || screenWidth < 768) {
            isMobileDevice = true;
          }
          if (isMobileDevice) {
            mandalaLink.href = 'mobile-mandala.html';
            mandalaLink.title = 'æ›¼è¼ç¾… (æ‰‹æ©Ÿç‰ˆ)';
          } else {
            mandalaLink.href = 'mandala.html';
            mandalaLink.title = 'æ›¼è¼ç¾… (æ¡Œé¢ç‰ˆ)';
          }
        }
      }
      detectDeviceAndSetMandalaLink();
      const sidebar = document.getElementById('sidebar');
      const hamburger = document.getElementById('hamburger');
      const sidebarOverlay = document.getElementById('sidebarOverlay');
      function toggleSidebar() {
        sidebar.classList.toggle('open');
        hamburger.classList.toggle('open');
        sidebarOverlay.classList.toggle('active');
      }
      function closeSidebar() {
        sidebar.classList.remove('open');
        hamburger.classList.remove('open');
        sidebarOverlay.classList.remove('active');
      }
      hamburger.addEventListener('click', toggleSidebar);
      sidebarOverlay.addEventListener('click', closeSidebar);
      const playlist = [
        { id: "rainbow", title: "å½©è™¹å†¥æƒ³", artist: "å†¥æƒ³éŸ³æ¨‚åˆè¼¯", file: "meditationMusic/meditation1_rainbow.mp3", duration: "0:00", background: "images/rainbow.png" },
        { id: "hamsa", title: "å“ˆå§†è–©å†¥æƒ³", artist: "å†¥æƒ³éŸ³æ¨‚åˆè¼¯", file: "meditationMusic/meditation2_hamsa.mp3", duration: "0:00", background: "images/HamSa.png" },
        { id: "mindfulness", title: "æ­£å¿µå†¥æƒ³", artist: "å†¥æƒ³éŸ³æ¨‚åˆè¼¯", file: "meditationMusic/meditation3_mindfulness.mp3", duration: "0:00", background: "images/mindfulness.png" },
        { id: "warriors_creed", title: "æˆ°å£«ä¿¡æ¢", artist: "å†¥æƒ³éŸ³æ¨‚åˆè¼¯", file: "meditationMusic/meditation4_warriorscreed.mp3", duration: "0:00", background: "images/warroirscreed.png" },
        { id: "hollow_body", title: "ç©ºå¿ƒå†¥æƒ³", artist: "å†¥æƒ³éŸ³æ¨‚åˆè¼¯", file: "meditationMusic/meditation5_hollowbody.mp3", duration: "0:00", background: "images/hollow.png" },
        { id: "pearl_ocean", title: "çç èˆ‡æµ·æ´‹", artist: "å†¥æƒ³éŸ³æ¨‚åˆè¼¯", file: "meditationMusic/meditation6_pearl&ocean.mp3", duration: "0:00", background: "images/pearOcean.png" }
      ];

      let currentTrackIndex = 0;
      let isShuffled = false;
      let isRepeating = false;
      let originalPlaylist = playlist.map(track => ({ ...track }));
      let currentPlaylist = playlist.map(track => ({ ...track }));
      
      let isLyricsDragging = false;
      let scrollSpeed = 0;

      const audio = document.getElementById('audio');
      const playBtn = document.getElementById('play');
      const seek = document.getElementById('seek');
      const cur = document.getElementById('cur');
      const dur = document.getElementById('dur');
      const titleEl = document.getElementById('trackTitle');
      const artistEl = document.getElementById('artist');
      const artBackground = document.getElementById('artBackground');
      const lyricsText = document.getElementById('lyricsText');
      const lyricsContainer = lyricsText.parentElement;
      const prevBtn = document.getElementById('prev');
      const nextBtn = document.getElementById('next');
      const shuffleBtn = document.getElementById('shuffle');
      const repeatBtn = document.getElementById('repeat');
      const playlistBtn = document.getElementById('playlistBtn');
      const playlistModal = document.getElementById('playlistModal');
      const closePlaylist = document.getElementById('closePlaylist');
      const playlistItemsContainer = document.getElementById('playlistItems');
      const resetPlaylistOrderBtn = document.getElementById('resetPlaylistOrder');

      const formatTime = (seconds) => {
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return `${min}:${sec < 10 ? '0' : ''}${sec}`;
      };

      // é è¼‰å…¥æ‰€æœ‰èƒŒæ™¯åœ–ç‰‡
      const preloadImages = () => {
        let loadedCount = 0;
        const totalCount = playlist.length;
        
        const imagePromises = playlist.map(track => {
          return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => {
              loadedCount++;
              // æ›´æ–°é€²åº¦åˆ°æ§åˆ¶å°
              console.log(`èƒŒæ™¯åœ–ç‰‡é è¼‰å…¥é€²åº¦: ${loadedCount}/${totalCount}`);
              resolve(track.background);
            };
            img.onerror = () => {
              loadedCount++;
              console.warn(`èƒŒæ™¯åœ–ç‰‡è¼‰å…¥å¤±æ•—: ${track.background}`);
              reject(track.background);
            };
            img.src = track.background;
          });
        });
        
        Promise.allSettled(imagePromises).then(results => {
          const successCount = results.filter(result => result.status === 'fulfilled').length;
          console.log(`èƒŒæ™¯åœ–ç‰‡é è¼‰å…¥å®Œæˆ: ${successCount}/${totalCount} æˆåŠŸè¼‰å…¥`);
        });
      };

      // åœ–ç‰‡å¿«å–ç‰©ä»¶
      const imageCache = new Map();
      
      // é è¼‰å…¥å–®å¼µåœ–ç‰‡åˆ°å¿«å–
      const preloadImage = (url) => {
        if (imageCache.has(url)) return Promise.resolve();
        
        return new Promise((resolve, reject) => {
          const startTime = performance.now();
          const img = new Image();
          img.onload = () => {
            const loadTime = performance.now() - startTime;
            imageCache.set(url, img);
            console.log(`åœ–ç‰‡è¼‰å…¥å®Œæˆ: ${url} (${loadTime.toFixed(2)}ms)`);
            resolve();
          };
          img.onerror = () => {
            const loadTime = performance.now() - startTime;
            console.warn(`åœ–ç‰‡è¼‰å…¥å¤±æ•—: ${url} (${loadTime.toFixed(2)}ms)`);
            reject();
          };
          img.src = url;
        });
      };

      const loadTrack = (index) => {
        const track = currentPlaylist[index];
        if (!track) return;

        // æš«åœç•¶å‰æ’­æ”¾ä¸¦é‡ç½®ç‹€æ…‹
        audio.pause();
        playBtn.dataset.state = 'play';
        
        titleEl.textContent = track.title;
        artistEl.textContent = track.artist;
        
        // é‡ç½®é€²åº¦æ¢
        cur.textContent = '0:00';
        dur.textContent = '0:00';
        seek.value = 0;
        seek.max = 0;
        
        // è¨­ç½®éŸ³é »æºä¸¦è™•ç†éŒ¯èª¤
        audio.src = track.file;
        audio.load(); // å¼·åˆ¶é‡æ–°åŠ è¼‰
        
        // å„ªåŒ–èƒŒæ™¯åœ–è¼‰å…¥
        if (imageCache.has(track.background)) {
          // å¦‚æœåœ–ç‰‡å·²åœ¨å¿«å–ä¸­ï¼Œç›´æ¥ä½¿ç”¨
          artBackground.style.backgroundImage = `url(${track.background})`;
          artBackground.classList.remove('loading');
        } else {
          // å¦‚æœåœ–ç‰‡æœªå¿«å–ï¼Œé¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
          artBackground.classList.add('loading');
          artBackground.style.backgroundImage = 'none';
          artBackground.style.backgroundColor = 'rgba(45, 45, 60, 0.8)';
          
          preloadImage(track.background).then(() => {
            artBackground.style.backgroundImage = `url(${track.background})`;
            artBackground.style.backgroundColor = 'transparent';
            artBackground.classList.remove('loading');
          }).catch(() => {
            console.warn(`èƒŒæ™¯åœ–ç‰‡è¼‰å…¥å¤±æ•—: ${track.background}`);
            artBackground.style.backgroundColor = 'rgba(45, 45, 60, 0.8)';
            artBackground.classList.remove('loading');
          });
        }
        
        // è¼‰å…¥æˆ°å£«ä¿¡æ¢æ­Œè©
        if (track.id === "warriors_creed") {
          fetch("warrior'sCreed/warror'sCreed.txt")
            .then(res => res.ok ? res.text() : Promise.reject("æ­Œè©æª”æ¡ˆè¼‰å…¥å¤±æ•—"))
            .then(text => {
              lyricsText.textContent = text;
              lyricsText.classList.add('warriors-creed-style');
            })
            .catch(() => {
              lyricsText.textContent = 'æ­Œè©è¼‰å…¥å¤±æ•—';
              lyricsText.classList.add('warriors-creed-style');
            });
        } else {
          lyricsText.textContent = '';
          lyricsText.classList.remove('warriors-creed-style');
        }
        
        isLyricsDragging = false;
        lyricsContainer.scrollTop = 0;
        
        currentTrackIndex = index;
        updatePlaylistUI();
      };

      const setPlayState = (isPlaying) => {
        if (isPlaying) {
          // æª¢æŸ¥éŸ³é »æ˜¯å¦å·²åŠ è¼‰
          if (audio.readyState >= 2) {
            // éŸ³é »å·²åŠ è¼‰ï¼Œå¯ä»¥æ’­æ”¾
            audio.play().then(() => {
              playBtn.dataset.state = 'pause';
            }).catch(e => {
              console.error("æ’­æ”¾å¤±æ•—:", e);
              playBtn.dataset.state = 'play';
              alert('ç„¡æ³•æ’­æ”¾éŸ³é »ï¼Œè«‹æª¢æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨æˆ–ç€è¦½å™¨æ˜¯å¦æ”¯æ´æ­¤æ ¼å¼ã€‚');
            });
          } else {
            // ç­‰å¾…éŸ³é »åŠ è¼‰å®Œæˆ
            const playWhenReady = () => {
              if (audio.readyState >= 2) {
                audio.play().then(() => {
                  playBtn.dataset.state = 'pause';
                }).catch(e => {
                  console.error("æ’­æ”¾å¤±æ•—:", e);
                  playBtn.dataset.state = 'play';
                  alert('ç„¡æ³•æ’­æ”¾éŸ³é »ï¼Œè«‹æª¢æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨æˆ–ç€è¦½å™¨æ˜¯å¦æ”¯æ´æ­¤æ ¼å¼ã€‚');
                });
                audio.removeEventListener('canplay', playWhenReady);
                audio.removeEventListener('error', playWhenReady);
              }
            };
            audio.addEventListener('canplay', playWhenReady, { once: true });
            audio.addEventListener('error', () => {
              console.error('éŸ³é »è¼‰å…¥å¤±æ•—:', audio.src);
              playBtn.dataset.state = 'play';
              alert('éŸ³é »æ–‡ä»¶è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚');
              audio.removeEventListener('canplay', playWhenReady);
            }, { once: true });
          }
        } else {
          audio.pause();
          playBtn.dataset.state = 'play';
        }
      };
      
      const playNext = () => {
        const wasPlaying = !audio.paused;
        currentTrackIndex = (currentTrackIndex + 1) % currentPlaylist.length;
        loadTrack(currentTrackIndex);
        if (wasPlaying) {
          // å¦‚æœä¹‹å‰æ­£åœ¨æ’­æ”¾ï¼Œå‰‡è‡ªå‹•æ’­æ”¾æ–°æ›²ç›®
          audio.addEventListener('loadedmetadata', () => {
            setPlayState(true);
          }, { once: true });
        }
      };
      
      const playPrev = () => {
        const wasPlaying = !audio.paused;
        currentTrackIndex = (currentTrackIndex - 1 + currentPlaylist.length) % currentPlaylist.length;
        loadTrack(currentTrackIndex);
        if (wasPlaying) {
          // å¦‚æœä¹‹å‰æ­£åœ¨æ’­æ”¾ï¼Œå‰‡è‡ªå‹•æ’­æ”¾æ–°æ›²ç›®
          audio.addEventListener('loadedmetadata', () => {
            setPlayState(true);
          }, { once: true });
        }
      };
      
      playBtn.addEventListener('click', () => setPlayState(audio.paused));
      prevBtn.addEventListener('click', playPrev);
      nextBtn.addEventListener('click', playNext);
      
      repeatBtn.addEventListener('click', () => {
        isRepeating = !isRepeating;
        repeatBtn.classList.toggle('active', isRepeating);
        audio.loop = isRepeating;
      });

      shuffleBtn.addEventListener('click', () => {
        isShuffled = !isShuffled;
        shuffleBtn.classList.toggle('active', isShuffled);
        const currentTrackId = currentPlaylist[currentTrackIndex].id;
        if (isShuffled) {
          let shuffled = [...originalPlaylist].sort(() => 0.5 - Math.random());
          const currentTrackInShuffled = shuffled.find(t => t.id === currentTrackId);
          shuffled = shuffled.filter(t => t.id !== currentTrackId);
          shuffled.unshift(currentTrackInShuffled);
          currentPlaylist = shuffled;
        } else {
          // æ¢å¾©åˆ°åŸå§‹é †åºæˆ–ä¿å­˜çš„é †åº
          loadPlaylistOrder();
        }
        currentTrackIndex = currentPlaylist.findIndex(t => t.id === currentTrackId);
        
        // ä¿å­˜æ’­æ”¾æ¸…å–®é †åº
        savePlaylistOrder();
        
        initPlaylistUI();
      });
      
      // éŸ³é »éŒ¯èª¤è™•ç†
      audio.addEventListener('error', (e) => {
        console.error('éŸ³é »è¼‰å…¥éŒ¯èª¤:', e);
        const track = currentPlaylist[currentTrackIndex];
        console.error('ç„¡æ³•è¼‰å…¥éŸ³é »:', track ? track.file : 'æœªçŸ¥');
        playBtn.dataset.state = 'play';
        cur.textContent = '0:00';
        dur.textContent = '0:00';
        seek.value = 0;
        seek.max = 0;
        alert(`éŸ³é »æ–‡ä»¶è¼‰å…¥å¤±æ•—: ${track ? track.title : 'æœªçŸ¥æ›²ç›®'}\nè«‹æª¢æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨: ${track ? track.file : ''}`);
      });

      audio.addEventListener('loadedmetadata', () => {
        dur.textContent = formatTime(audio.duration);
        seek.max = audio.duration;
        const track = currentPlaylist[currentTrackIndex];
        if (track && track.id === "warriors_creed") {
          const totalScrollDistance = lyricsText.scrollHeight - lyricsContainer.clientHeight;
          if (totalScrollDistance > 0) {
            scrollSpeed = (totalScrollDistance + 20) / audio.duration * 25; // é€Ÿåº¦å¯èª¿æ•´
          } else {
            scrollSpeed = 0;
          }
        } else {
          scrollSpeed = 0;
        }
      });

      audio.addEventListener('timeupdate', () => {
        cur.textContent = formatTime(audio.currentTime);
        seek.value = audio.currentTime;
        const track = currentPlaylist[currentTrackIndex];
        if (
          track && track.id === "warriors_creed" &&
          !isLyricsDragging && audio.duration && scrollSpeed > 0
        ) {
          // å¾ªç’°æ»¾å‹•æ­Œè©
          const totalScrollDistance = lyricsText.scrollHeight - lyricsContainer.clientHeight;
          if (totalScrollDistance > 0) {
            // è¨ˆç®—æ»¾å‹•ä½ç½®ï¼Œä½¿ç”¨æ¨¡é‹ç®—å¯¦ç¾å¾ªç’°æ»¾å‹•
            const scrollPos = (audio.currentTime * scrollSpeed) % (totalScrollDistance + 100);
            lyricsContainer.scrollTop = Math.min(scrollPos, totalScrollDistance);
          }
        }
      });

      audio.addEventListener('ended', () => {
        if (!audio.loop) playNext();
      });
      
      seek.addEventListener('input', () => {
        audio.currentTime = seek.value;
      });

      const addLyricsEventListeners = () => {
        let startDragY = 0;
        let startScrollY = 0;

        const handleDragStart = (e) => {
          e.preventDefault();
          isLyricsDragging = true;
          lyricsText.classList.add('dragging');
          startDragY = e.clientY || e.touches[0].clientY;
          startScrollY = lyricsContainer.scrollTop;

          window.addEventListener('mousemove', handleDragMove);
          window.addEventListener('mouseup', handleDragEnd);
          window.addEventListener('touchmove', handleDragMove, { passive: false });
          window.addEventListener('touchend', handleDragEnd);
        };

        const handleDragMove = (e) => {
          if (!isLyricsDragging) return;
          e.preventDefault();
          const clientY = e.clientY || e.touches[0].clientY;
          const deltaY = clientY - startDragY;
          lyricsContainer.scrollTop = startScrollY - deltaY;
        };

        const handleDragEnd = () => {
          if (!isLyricsDragging) return;
          isLyricsDragging = false;
          lyricsText.classList.remove('dragging');
          window.removeEventListener('mousemove', handleDragMove);
          window.removeEventListener('mouseup', handleDragEnd);
          window.removeEventListener('touchmove', handleDragMove);
          window.removeEventListener('touchend', handleDragEnd);
        };

        lyricsContainer.addEventListener('scroll', () => {
          if (!isLyricsDragging) {
            clearTimeout(lyricsContainer.scrollTimeout);
            lyricsContainer.scrollTimeout = setTimeout(() => {
              if (audio.duration && scrollSpeed > 0) {
                lyricsContainer.scrollTop = audio.currentTime * scrollSpeed;
              }
            }, 500); 
          }
        });

        lyricsText.addEventListener('mousedown', handleDragStart);
        lyricsText.addEventListener('touchstart', handleDragStart, { passive: false });
      };

      playlistBtn.addEventListener('click', () => {
        playlistModal.style.display = 'grid';
        initPlaylistUI();
      });
      closePlaylist.addEventListener('click', () => playlistModal.style.display = 'none');
      
      const initPlaylistUI = () => {
        playlistItemsContainer.innerHTML = '';
        currentPlaylist.forEach((track, index) => {
          const item = document.createElement('div');
          item.className = `playlist-item ${index === currentTrackIndex ? 'active' : ''}`;
          item.dataset.id = track.id;
          item.innerHTML = `<div class="drag-handle" draggable="true" style="touch-action: none; -webkit-user-select: none; user-select: none;"><svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M10 5h3v2h-3zm-7 0h3v2H3zm7 12h3v2h-3zm-7 0h3v2H3zm7-6h3v2h-3zm-7 0h3v2H3z"></path></svg></div><div class="playlist-item-number">${index + 1}</div><div class="playlist-item-info"><div class="playlist-item-title">${track.title}</div><div class="playlist-item-duration">${track.duration}</div></div>`;
          
          // ç‚ºæ’­æ”¾æ¸…å–®é …ç›®æ·»åŠ åœ–ç‰‡é è¼‰å…¥
          item.addEventListener('mouseenter', () => {
            // é è¼‰å…¥ç•¶å‰æ›²ç›®çš„èƒŒæ™¯åœ–
            if (!imageCache.has(track.background)) {
              preloadImage(track.background);
            }
            
            // é è¼‰å…¥ç›¸é„°æ›²ç›®çš„èƒŒæ™¯åœ–ï¼ˆæ™ºèƒ½é è¼‰å…¥ï¼‰
            const currentIndex = currentPlaylist.findIndex(t => t.id === track.id);
            const prevIndex = (currentIndex - 1 + currentPlaylist.length) % currentPlaylist.length;
            const nextIndex = (currentIndex + 1) % currentPlaylist.length;
            
            const prevTrack = currentPlaylist[prevIndex];
            const nextTrack = currentPlaylist[nextIndex];
            
            if (prevTrack && !imageCache.has(prevTrack.background)) {
              preloadImage(prevTrack.background);
            }
            if (nextTrack && !imageCache.has(nextTrack.background)) {
              preloadImage(nextTrack.background);
            }
          });
          
          item.addEventListener('click', (e) => {
            if (e.target.closest('.drag-handle')) return;
            const clickedIndex = currentPlaylist.findIndex(t => t.id === track.id);
            loadTrack(clickedIndex);
            // è‡ªå‹•æ’­æ”¾é¸ä¸­çš„æ›²ç›®
            audio.addEventListener('loadedmetadata', () => {
              setPlayState(true);
            }, { once: true });
            playlistModal.style.display = 'none';
          });
          playlistItemsContainer.appendChild(item);
        });
      };
      
      const updatePlaylistUI = () => {
        playlistItemsContainer.querySelectorAll('.playlist-item').forEach(item => {
          item.classList.toggle('active', item.dataset.id === currentPlaylist[currentTrackIndex].id);
        });
      };

      // ä¿å­˜æ’­æ”¾æ¸…å–®é †åºåˆ° localStorage
      const savePlaylistOrder = () => {
        const playlistOrder = currentPlaylist.map(track => track.id);
        localStorage.setItem('meditationPlaylistOrder', JSON.stringify(playlistOrder));
        console.log('æ’­æ”¾æ¸…å–®é †åºå·²ä¿å­˜:', playlistOrder);
      };

      // å¾ localStorage è¼‰å…¥æ’­æ”¾æ¸…å–®é †åº
      const loadPlaylistOrder = () => {
        const savedOrder = localStorage.getItem('meditationPlaylistOrder');
        if (savedOrder) {
          try {
            const playlistOrder = JSON.parse(savedOrder);
            console.log('è¼‰å…¥æ’­æ”¾æ¸…å–®é †åº:', playlistOrder);
            
            // æ ¹æ“šä¿å­˜çš„é †åºé‡æ–°æ’åˆ—æ’­æ”¾æ¸…å–®
            const reorderedPlaylist = [];
            playlistOrder.forEach(id => {
              const track = originalPlaylist.find(t => t.id === id);
              if (track) {
                reorderedPlaylist.push({ ...track });
              }
            });
            
            // å¦‚æœæœ‰äº›æ›²ç›®ä¸åœ¨ä¿å­˜çš„é †åºä¸­ï¼Œæ·»åŠ å®ƒå€‘
            originalPlaylist.forEach(track => {
              if (!playlistOrder.includes(track.id)) {
                reorderedPlaylist.push({ ...track });
              }
            });
            
            currentPlaylist = reorderedPlaylist;
            console.log('æ’­æ”¾æ¸…å–®é †åºå·²æ¢å¾©');
          } catch (error) {
            console.error('è¼‰å…¥æ’­æ”¾æ¸…å–®é †åºå¤±æ•—:', error);
          }
        }
      };
      
      resetPlaylistOrderBtn.addEventListener('click', () => {
        const currentTrackId = currentPlaylist[currentTrackIndex].id;
        currentPlaylist = [...originalPlaylist];
        currentTrackIndex = currentPlaylist.findIndex(t => t.id === currentTrackId);
        isShuffled = false;
        shuffleBtn.classList.remove('active');
        
        // æ¸…é™¤ä¿å­˜çš„æ’­æ”¾æ¸…å–®é †åº
        localStorage.removeItem('meditationPlaylistOrder');
        console.log('æ’­æ”¾æ¸…å–®é †åºå·²é‡ç½®');
        
        initPlaylistUI();
      });

      let draggedItem = null;
      let isDragging = false;
      let touchStartY = 0;
      let touchStartX = 0;
      let placeholder = null;

      // è§¸è¦ºå›é¥‹å‡½æ•¸ï¼ˆiOSæ”¯æ´ï¼‰
      function triggerHapticFeedback(type = 'light') {
        if ('vibrate' in navigator) {
          // Android éœ‡å‹•
          navigator.vibrate(type === 'light' ? 10 : 50);
        }
        // iOS è§¸è¦ºå›é¥‹ï¼ˆéœ€è¦åœ¨è§¸æ§äº‹ä»¶ä¸­èª¿ç”¨ï¼‰
        if (window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === 'function') {
          // iOS 13+ è§¸è¦ºå›é¥‹ï¼ˆé€™è£¡åªæ˜¯ç¤ºä¾‹ï¼Œå¯¦éš›éœ€è¦ç”¨æˆ¶äº’å‹•æ‰èƒ½è§¸ç™¼ï¼‰
        }
      }

      // å‰µå»ºä½”ä½å…ƒç´ 
      function createPlaceholder() {
        const placeholder = document.createElement('div');
        placeholder.className = 'playlist-item placeholder';
        placeholder.innerHTML = '<div style="text-align: center; color: var(--text-secondary); font-size: 12px; opacity: 0.7;">ç§»å‹•åˆ°é€™è£¡</div>';
        return placeholder;
      }

      // æ¡Œé¢æ‹–æ›³äº‹ä»¶
      playlistItemsContainer.addEventListener('dragstart', e => {
        if (e.target.closest('.drag-handle')) {
          draggedItem = e.target.closest('.playlist-item');
          draggedItem.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/html', draggedItem.outerHTML);
        } else {
          e.preventDefault();
        }
      });

      playlistItemsContainer.addEventListener('dragend', () => {
        if (draggedItem) {
          draggedItem.classList.remove('dragging');
          draggedItem = null;
        }
        if (placeholder && placeholder.parentNode) {
          placeholder.parentNode.removeChild(placeholder);
          placeholder = null;
        }
      });

      playlistItemsContainer.addEventListener('dragover', e => {
        e.preventDefault();
        if (!draggedItem) return;
        
        const afterElement = getDragAfterElement(playlistItemsContainer, e.clientY);
        if (afterElement == null) {
          playlistItemsContainer.appendChild(draggedItem);
        } else {
          playlistItemsContainer.insertBefore(draggedItem, afterElement);
        }
      });

      playlistItemsContainer.addEventListener('drop', e => {
        e.preventDefault();
        if (!draggedItem) return;
        
        const newOrderedIds = [...playlistItemsContainer.children].map(item => item.dataset.id).filter(id => id);
        const currentTrackId = currentPlaylist[currentTrackIndex].id;

        currentPlaylist = newOrderedIds.map(id => originalPlaylist.find(track => track.id === id));
        currentTrackIndex = currentPlaylist.findIndex(track => track.id === currentTrackId);

        savePlaylistOrder();
        initPlaylistUI();
      });

      // è§¸æ§æ‹–æ›³äº‹ä»¶ (iOS æ”¯æ´)
      playlistItemsContainer.addEventListener('touchstart', e => {
        const dragHandle = e.target.closest('.drag-handle');
        if (dragHandle) {
          e.preventDefault(); // é˜²æ­¢é è¨­æ»¾å‹•è¡Œç‚º
          draggedItem = dragHandle.closest('.playlist-item');
          isDragging = true;
          
          // è§¸è¦ºå›é¥‹
          triggerHapticFeedback('light');
          
          const touch = e.touches[0];
          touchStartY = touch.clientY;
          touchStartX = touch.clientX;
          
          draggedItem.classList.add('dragging');
          
          // å‰µå»ºè¦–è¦ºå›é¥‹
          draggedItem.style.transform = 'scale(1.05)';
          draggedItem.style.zIndex = '1000';
          draggedItem.style.boxShadow = '0 10px 30px rgba(0,0,0,0.3)';
          
          // æ·»åŠ ä½”ä½å…ƒç´ 
          placeholder = createPlaceholder();
          draggedItem.parentNode.insertBefore(placeholder, draggedItem.nextSibling);
        }
      }, { passive: false });

      playlistItemsContainer.addEventListener('touchmove', e => {
        if (!isDragging || !draggedItem) return;
        
        e.preventDefault(); // é˜²æ­¢é é¢æ»¾å‹•
        
        const touch = e.touches[0];
        const deltaY = touch.clientY - touchStartY;
        
        // ç§»å‹•è¢«æ‹–æ›³çš„é …ç›®
        draggedItem.style.transform = `translateY(${deltaY}px) scale(1.05)`;
        
        // æ‰¾åˆ°æ‡‰è©²æ’å…¥çš„ä½ç½®
        const afterElement = getDragAfterElement(playlistItemsContainer, touch.clientY);
        
        if (placeholder && placeholder.parentNode) {
          placeholder.parentNode.removeChild(placeholder);
        }
        
        if (afterElement == null) {
          playlistItemsContainer.appendChild(placeholder);
        } else {
          playlistItemsContainer.insertBefore(placeholder, afterElement);
        }
      }, { passive: false });

      playlistItemsContainer.addEventListener('touchend', e => {
        if (!isDragging || !draggedItem) return;
        
        e.preventDefault();
        
        // é‡ç½®æ¨£å¼
        draggedItem.style.transform = '';
        draggedItem.style.zIndex = '';
        draggedItem.style.boxShadow = '';
        draggedItem.classList.remove('dragging');
        
        // å°‡é …ç›®ç§»å‹•åˆ°ä½”ä½å…ƒç´ çš„ä½ç½®
        if (placeholder && placeholder.parentNode) {
          placeholder.parentNode.insertBefore(draggedItem, placeholder);
          placeholder.parentNode.removeChild(placeholder);
        }
        
        // æ›´æ–°æ’­æ”¾æ¸…å–®é †åº
        const newOrderedIds = [...playlistItemsContainer.children]
          .filter(item => !item.classList.contains('placeholder'))
          .map(item => item.dataset.id);
        const currentTrackId = currentPlaylist[currentTrackIndex].id;

        currentPlaylist = newOrderedIds.map(id => originalPlaylist.find(track => track.id === id));
        currentTrackIndex = currentPlaylist.findIndex(track => track.id === currentTrackId);

        savePlaylistOrder();
        initPlaylistUI();
        
        // é‡ç½®ç‹€æ…‹
        draggedItem = null;
        isDragging = false;
        placeholder = null;
      }, { passive: false });
      
      // ä¿®æ­£çš„æ‹–æ”¾è¼”åŠ©å‡½æ•¸ï¼Œæ’é™¤æ‹–æ›³ä¸­çš„é …ç›®å’Œä½”ä½å…ƒç´ 
      function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.playlist-item:not(.dragging):not(.placeholder)')];
        return draggableElements.reduce((closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = y - box.top - box.height / 2;
          if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
          } else {
            return closest;
          }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
      }

      // é é¢è¼‰å…¥æ™‚é è¼‰å…¥æ‰€æœ‰èƒŒæ™¯åœ–ç‰‡
      preloadImages();
      // å…ˆè¼‰å…¥ä¿å­˜çš„æ’­æ”¾æ¸…å–®é †åºï¼Œä¹‹å¾Œå¾ç¬¬ 1 é¦–é–‹å§‹
      loadPlaylistOrder();
      currentTrackIndex = 0;
      loadTrack(currentTrackIndex);
      addLyricsEventListeners();
      // å˜—è©¦è‡ªå‹•æ’­æ”¾ï¼ˆè‹¥è¢«ç€è¦½å™¨é˜»æ“‹å‰‡éœé»˜å¤±æ•—ï¼‰
      setTimeout(() => {
        try {
          setPlayState(true);
        } catch (e) {
          console.log('è‡ªå‹•æ’­æ”¾è¢«é˜»æ“‹');
        }
      }, 0);
    });
    
    // PWA å’Œ Service Worker è¨»å†Š
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const registration = await navigator.serviceWorker.register('./service-worker.js');
          console.log('Service Worker è¨»å†ŠæˆåŠŸ:', registration);
          
          // æª¢æŸ¥æ¨é€é€šçŸ¥æ”¯æ´
          if ('PushManager' in window) {
            console.log('æ¨é€é€šçŸ¥æ”¯æ´å·²å•Ÿç”¨');
          }
        } catch (error) {
          console.error('Service Worker è¨»å†Šå¤±æ•—:', error);
        }
      });
    }
    
    // è¼‰å…¥ PWA é…ç½®
    const pwaScript = document.createElement('script');
    pwaScript.src = './public/pwa-config.js';
    pwaScript.onload = () => {
      console.log('PWA é…ç½®å·²è¼‰å…¥');
    };
    document.head.appendChild(pwaScript);
  </script>
</body>
</html>