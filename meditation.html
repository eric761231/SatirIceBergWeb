<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>冥想音樂播放器</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#00aaff" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="冥想音樂" />
  <meta name="mobile-web-app-capable" content="yes" />
  
      <!-- Manifest -->
    <link rel="manifest" href="./manifest.json" />
  
  <!-- Apple Touch Icons -->
      <link rel="apple-touch-icon" href="./icons/icon-152x152.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="./icons/icon-152x152.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="./icons/icon-192x192.png" />
  
  <!-- Favicon -->
      <link rel="icon" type="image/x-icon" href="./favicon.ico" />
  
  <style>
    /* 側邊導航欄樣式 from meditation.html */
    .sidebar {
      position: fixed;
      top: 0;
      left: -250px;
      width: 250px;
      height: 100vh;
      background: rgba(0, 0, 0, 0.9);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      transition: left 0.3s ease;
      z-index: 1000;
      padding: 20px;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      box-sizing: border-box;
    }
    .sidebar.open { left: 0; }
    .sidebar * { max-width: 100%; box-sizing: border-box; }
    .sidebar-header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.2); width: 100%; box-sizing: border-box; }
    .sidebar-title { color: #00aaff; font-size: 1.5em; font-weight: bold; width: 100%; word-wrap: break-word; overflow-wrap: break-word; }
    .sidebar-close { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 2em; color: #ffffff; cursor: pointer; padding: 5px; line-height: 1; z-index: 1002; }
    .sidebar-close:hover { color: #00aaff; }
    .nav-menu { list-style: none; margin: 0; padding: 0; width: 100%; text-align: center; display: flex; flex-direction: column; align-items: center; }
    .nav-item { margin-bottom: 15px; width: 100%; text-align: center; display: flex; justify-content: center; }
    .nav-link { display: inline-block; color: #ffffff; text-decoration: none; padding: 12px 20px; border-radius: 8px; transition: all 0.3s ease; font-size: 1.1em; min-width: 120px; box-sizing: border-box; word-wrap: break-word; overflow-wrap: break-word; text-align: center; }
    .nav-link:hover { background: rgba(0, 170, 255, 0.2); color: #00aaff; transform: translateX(5px); }
    .nav-link.active { background: rgba(0, 170, 255, 0.3); color: #00aaff; border-left: 3px solid #00aaff; }
    .hamburger { position: fixed; top: 20px; left: 20px; width: 40px; height: 40px; background: rgba(0, 170, 255, 0.8); border: none; border-radius: 8px; cursor: pointer; z-index: 1001; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: all 0.3s ease; }
    .hamburger:hover { background: rgba(0, 170, 255, 1); }
    .hamburger:hover:not(.open) { transform: scale(1.1); }
    .hamburger span { width: 20px; height: 2px; background: white; margin: 2px 0; transition: all 0.3s ease; }
    .hamburger.open span:nth-child(1) { transform: rotate(45deg) translate(4.5px, 4.5px) !important; }
    .hamburger.open span:nth-child(2) { opacity: 0 !important; }
    .hamburger.open span:nth-child(3) { transform: rotate(-45deg) translate(4.5px, -4.5px) !important; }
    .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
    .sidebar-overlay.active { opacity: 1; visibility: visible; }
    :root {
      --bg-primary: #131314;
      --bg-secondary: #1e1f20;
      --bg-tertiary: #2a2b2c;
      --text-primary: #e8eaed;
      --text-secondary: #9aa0a6;
      --border-color: #3c4043;
      --accent-blue: #8ab4f8;
      --accent-cyan: #00aaff;
      --card: #2a2b2c;
      --text: #ffffff;
      --sub: #e0e0e0;
      --accent: #00aaff;
      --muted: #9aa0a6;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', 'Google Sans', Arial, sans-serif;
      color: var(--text);
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      display: grid;
      place-items: center;
    }
    .phone {
      width: min(420px, 100vw);
      height: min(860px, 100vh);
      border-radius: 28px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
      background: rgba(30, 30, 45, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: grid;
      grid-template-rows: auto 1fr auto;
    }

    /* Top bar */
    .topbar {
      display: flex; align-items: center; gap: 12px;
      padding: 18px 18px 10px 18px;
      color: var(--text-primary);
      font-weight: 700;
    }
    .chev { width: 26px; height: 26px; display: grid; place-items: center; cursor: pointer; color: var(--text-secondary); }
    .subtitle { font-size: 12px; font-weight: 600; opacity: .9; color: var(--text-secondary); }
    .title { font-size: 18px; color: var(--accent-cyan); }

    /* Artwork card */
    .artwrap { padding: 18px; display: grid; place-items: center; }
    .art {
      aspect-ratio: 1 / 1; width: 100%; max-width: 720px;
      border-radius: 16px;
      background: rgba(45, 45, 60, 0.8);
      display: grid; place-items: center;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      position: relative;
      /* border: 1px solid rgba(255,255,255,0.07); */
      overflow: hidden;
    }
    
    .art-bg {
      position: absolute;
      inset: 0;
      background-size: cover;
      background-position: center;
      opacity: 0.8;
      z-index: 1;
      transition: background-image 0.5s ease-in-out;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .lyrics-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(30, 30, 45, 0.1), rgba(30, 30, 45, 0.4));
      z-index: 2;
      pointer-events: none;
    }

    .lyrics-scroll-container {
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      position: relative;
      .lyrics-text.warriors-creed-style {
        color: #111;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
      }
      align-items: flex-start;
      justify-content: center;
    }

    .lyrics-scroll-container::-webkit-scrollbar {
      width: 8px;
      background: transparent;
    }
    .lyrics-scroll-container::-webkit-scrollbar-thumb {
      background: transparent;
    }

    .lyrics-text {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 16px;
      line-height: 1.6;
      font-weight: 600;
      color: #fff;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.7);
      position: relative;
      width: 100%;
      white-space: pre-line;
      cursor: grab; /* 改為 grab 表示可拖動 */
      user-select: none;
      transform: translateY(0px); /* 由 JS 控制 */
    }
    .lyrics-text.dragging {
      cursor: grabbing;
    }
    
    /* Track info */
    .info { padding: 6px 18px 0; }
    .trackTitle { font-size: 28px; font-weight: 800; letter-spacing:.5px; color: var(--text-primary); }
    .artist { margin-top: 6px; color: var(--text-secondary); font-weight: 600; }

    /* Seek bar */
    .seek { padding: 8px 18px 0 18px; }
    .time { display:flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
    input[type="range"] { -webkit-appearance: none; width: 100%; height: 4px; border-radius: 999px; background: rgba(255,255,255,.1); outline: none; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 14px; height: 14px; border-radius: 50%; background: var(--accent-cyan); box-shadow: 0 0 0 6px rgba(0,170,255,.2); cursor: pointer; }

    /* Controls */
    .controls { padding: 16px 18px 8px; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; }
    .left, .right { display: flex; align-items: center; gap: 16px; }
    .btn { background: none; border: none; padding: 0; width: 40px; height: 40px; display:grid; place-items:center; cursor:pointer; opacity:.9; color: var(--text-secondary); border-radius: 50%; transition: all 0.2s ease; }
    .btn.active { color: var(--accent-cyan); opacity: 1; }
    .btn svg { width: 24px; height: 24px; }
    .btn:hover { opacity: 1; background: rgba(0, 170, 255, 0.1); }
    .btn.active { background: rgba(0, 170, 255, 0.2); }

    .playwrap { display:grid; place-items:center; }
    .play { width: 84px; height: 84px; background: var(--accent-cyan); border-radius: 50%; display:grid; place-items:center; cursor:pointer; box-shadow: 0 10px 24px rgba(0,170,255,.3); border: none; padding: 0;}
    .play svg { width: 40px; height: 40px; color: white; }
    .play[data-state="pause"] .play-icon { display: none; }
    .play[data-state="pause"] .pause-icon { display: block; }
    .play[data-state="play"] .play-icon { display: block; }
    .play[data-state="play"] .pause-icon { display: none; }

    /* Bottom */
    .bottom { padding: 0 18px 18px; display:flex; align-items:center; justify-content: space-between; color: var(--text-secondary); }
    .device { display:flex; gap:10px; align-items:center; font-size: 14px; }
    .mini { display:flex; gap:14px; align-items:center; }
    .mini .btn { width: 34px; height: 34px; opacity:.85; }
    .playlist-btn { margin-left: auto; background: rgba(0,170,255,.2); backdrop-filter: blur(10px); padding: 8px 16px; border-radius: 999px; font-size: 12px; color: var(--text-primary); font-weight: 700; cursor: pointer; border: 1px solid rgba(0,170,255,.3); transition: all 0.2s ease; }
    .playlist-btn:hover { background: rgba(0,170,255,.3); transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,170,255,0.3); }

    /* Playlist modal */
    .playlist-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,.8); display: none; place-items: center; z-index: 1000; }
    .playlist-content { background: var(--bg-secondary); border-radius: 16px; padding: 24px; max-width: 400px; width: 90%; max-height: 80vh; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); }
    .playlist-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .playlist-title { font-size: 20px; font-weight: 700; color: var(--accent-cyan); }
    .close-btn { background: none; border: none; color: var(--text-primary); font-size: 24px; cursor: pointer; }
    #playlistItems { display: flex; flex-direction: column; gap: 8px; }
    .playlist-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; cursor: pointer; transition: background .2s; user-select: none; }
    .playlist-item:hover { background: rgba(0,170,255,.1); }
    .playlist-item.active { background: var(--accent-cyan); }
    .playlist-item.active .playlist-item-title, .playlist-item.active .playlist-item-duration { color: var(--bg-primary); }
    .playlist-item-number { width: 24px; height: 24px; border-radius: 50%; background: rgba(255,255,255,.2); display: grid; place-items: center; font-size: 12px; font-weight: 600; flex-shrink: 0; }
    .playlist-item.active .playlist-item-number { background: rgba(0,0,0,.3); }
    .playlist-item-info { flex: 1; }
    .playlist-item-title { font-weight: 600; color: var(--text-primary); }
    .playlist-item-duration { font-size: 12px; color: var(--text-secondary); opacity: .7; }
    .drag-handle { width: 24px; height: 24px; cursor: grab; opacity: 0.6; display: grid; place-items: center; }
    .drag-handle:active { cursor: grabbing; }
    .playlist-item.dragging { opacity: 0.4; }

    /* Reminder Modal */
    .reminder-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,.8); display: none; place-items: center; z-index: 1000; }
    .reminder-content { background: var(--bg-secondary); border-radius: 16px; padding: 24px; max-width: 450px; width: 90%; max-height: 85vh; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); }
    .reminder-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .reminder-title { font-size: 20px; font-weight: 700; color: var(--accent-cyan); }
    .reminder-section { margin-bottom: 24px; }
    .reminder-section h3 { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px; }
    .time-inputs input[type="time"] { background: var(--bg-tertiary); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; color: var(--text-primary); font-size: 16px; width: 100%; }
    .frequency-options { display: flex; flex-direction: column; gap: 12px; }
    .radio-option { display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 8px; border-radius: 8px; transition: background 0.2s ease; }
    .radio-option:hover { background: rgba(0,170,255,0.1); }
    .radio-option input[type="radio"] { width: 18px; height: 18px; accent-color: var(--accent-cyan); }
    .day-checkboxes { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px; }
    .day-checkbox { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s ease; }
    .day-checkbox:hover { background: rgba(0,170,255,0.1); }
    .reminder-section textarea { background: var(--bg-tertiary); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; color: var(--text-primary); font-size: 14px; width: 100%; resize: vertical; font-family: inherit; }
    .reminder-actions { display: flex; gap: 12px; margin-top: 24px; }
    .btn-save, .btn-test { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
    .btn-save { background: var(--accent-cyan); color: var(--bg-primary); }
    .btn-save:hover { background: #0099e6; transform: translateY(-1px); }
    .btn-test { background: rgba(255,255,255,0.1); color: var(--text-primary); border: 1px solid rgba(255,255,255,0.2); }
    .btn-test:hover { background: rgba(255,255,255,0.15); transform: translateY(-1px); }
    .reminder-status { margin-top: 16px; padding: 12px; border-radius: 8px; font-size: 14px; text-align: center; display: none; }
    .reminder-status.success { background: rgba(76, 175, 80, 0.2); color: #4caf50; border: 1px solid rgba(76, 175, 80, 0.3); display: block; }
    .reminder-status.error { background: rgba(244, 67, 54, 0.2); color: #f44336; border: 1px solid rgba(244, 67, 54, 0.3); display: block; }
    #artBackground { border: none; }
  </style>
</head>
<body>
  <!-- 側邊導航欄 from meditation.html -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">選單</div>
    </div>
    <ul class="nav-menu">
      <li class="nav-item"><a href="articles.html" class="nav-link">每日閱讀</a></li>
      <li class="nav-item"><a href="yoga.html" class="nav-link">瑜珈</a></li>
      <li class="nav-item"><a href="#" class="nav-link" id="mandala-link">曼荼羅</a></li>
      <li class="nav-item"><a href="guide.html" class="nav-link">每日指引</a></li>
    </ul>
  </div>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <button class="hamburger" id="hamburger" title="展開選單">
    <span></span>
    <span></span>
    <span></span>
  </button>
  <div class="phone">
    <div class="topbar">
      <div class="chev" title="返回"><svg viewBox="0 0 24 24" width="26" height="26" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></div>
      <div>
        <div class="subtitle">播放自播放清單</div>
        <div class="title" id="playlistName">冥想音樂 合輯</div>
      </div>
      <button class="playlist-btn" id="playlistBtn">播放清單</button>
    </div>

    <div class="artwrap">
      <div class="art">
        <div class="art-bg" id="artBackground">
          <div class="lyrics-scroll-container">
            <div class="lyrics-text" id="lyricsText">靜心聆聽，感受內在的寧靜與和諧</div>
          </div>
        </div>
        <div class="lyrics-overlay"></div>
      </div>
    </div>

    <div class="info">
      <div class="trackTitle" id="trackTitle">彩虹冥想</div>
      <div class="artist" id="artist">冥想音樂合輯</div>
    </div>

    <div class="seek">
      <input id="seek" type="range" min="0" max="100" value="0" step="0.1" />
      <div class="time"><span id="cur">0:00</span><span id="dur">0:00</span></div>
    </div>

    <div class="controls">
      <div class="left">
        <button class="btn" id="shuffle" title="隨機播放"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg></button>
        <button class="btn" id="prev" title="上一首"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 19 2 12 11 5 11 19"></polygon><line x1="22" y1="5" x2="22" y2="19"></line></svg></button>
      </div>
      <div class="playwrap">
        <button class="play" id="play" data-state="play" title="播放 / 暫停"><svg viewBox="0 0 48 48" fill="currentColor"><path class="play-icon" d="M18 14 L36 24 L18 34 Z" /><path class="pause-icon" d="M16 14 H22 V34 H16 Z M26 14 H32 V34 H26 Z" /></svg></button>
      </div>
      <div class="right" style="justify-content:end">
        <button class="btn" id="next" title="下一首"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 19 22 12 13 5 13 19"></polygon><line x1="2" y1="5" x2="2" y2="19"/></svg></button>
        <button class="btn" id="repeat" title="循環播放"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg></button>
      </div>
    </div>

    <div class="bottom">
      <div class="device">
        <svg id="deviceIcon" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" title="音訊輸出裝置"><rect x="2" y="7" width="20" height="14" rx="2"/><line x1="8" y1="7" x2="8" y2="3"/><line x1="16" y1="7" x2="16" y2="3"/></svg>
        <span id="deviceName">本機播放</span>
      </div>
      <div class="mini">
        <button class="btn" id="reminder" title="冥想提醒設定"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg></button>
      </div>
    </div>
    <audio id="audio" preload="metadata"></audio>
  </div>

  <div class="playlist-modal" id="playlistModal">
    <div class="playlist-content">
      <div class="playlist-header">
        <div class="playlist-title">冥想音樂播放清單</div>
        <button class="close-btn" id="closePlaylist">&times;</button>
      </div>
      <div id="playlistItems"></div>
      <div style="margin-top: 20px; text-align: center; color: var(--text-secondary); font-size: 12px;">💡 按住拖曳圖示可重新排序</div>
      <div style="margin-top: 12px; text-align: center;">
        <button id="resetPlaylistOrder" style="background: rgba(255,255,255,0.1); color: var(--text-secondary); border: 1px solid rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s ease;">重置為原始順序</button>
      </div>
    </div>
  </div>
  
  <div class="reminder-modal" id="reminderModal">
    <div class="reminder-content">
      <div class="reminder-header">
        <div class="reminder-title">冥想提醒設定</div>
        <button class="close-btn" id="closeReminder">&times;</button>
      </div>
      <div class="reminder-body">
        <div class="reminder-section">
          <h3>每日提醒時間</h3>
          <div class="time-inputs"><input type="time" id="reminderTime" value="08:00"></div>
        </div>
        <div class="reminder-section">
          <h3>提醒頻率</h3>
          <div class="frequency-options">
            <label class="radio-option"><input type="radio" name="frequency" value="daily" checked><span>每日</span></label>
            <label class="radio-option"><input type="radio" name="frequency" value="weekdays"><span>工作日 (週一至週五)</span></label>
            <label class="radio-option"><input type="radio" name="frequency" value="custom"><span>自訂</span></label>
          </div>
        </div>
        <div class="reminder-section" id="customDaysSection" style="display: none;">
          <h3>自訂提醒日期</h3>
          <div class="day-checkboxes">
            <label class="day-checkbox"><input type="checkbox" value="1"><span>週一</span></label>
            <label class="day-checkbox"><input type="checkbox" value="2"><span>週二</span></label>
            <label class="day-checkbox"><input type="checkbox" value="3"><span>週三</span></label>
            <label class="day-checkbox"><input type="checkbox" value="4"><span>週四</span></label>
            <label class="day-checkbox"><input type="checkbox" value="5"><span>週五</span></label>
            <label class="day-checkbox"><input type="checkbox" value="6"><span>週六</span></label>
            <label class="day-checkbox"><input type="checkbox" value="0"><span>週日</span></label>
          </div>
        </div>
        <div class="reminder-section">
          <h3>提醒訊息</h3>
          <textarea id="reminderMessage" placeholder="輸入您的冥想提醒訊息..." rows="3">該是冥想的時候了！讓我們一起靜心，感受內在的寧靜。</textarea>
        </div>
        <div class="reminder-actions">
          <button class="btn-save" id="saveReminder">儲存設定</button>
          <button class="btn-test" id="testReminder">測試提醒</button>
                      <a href="./notification-test.html" class="btn-test" style="text-decoration: none; display: inline-block; text-align: center;">通知測試</a>
        </div>
        <div class="reminder-status" id="reminderStatus"></div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // 恢復已儲存的提醒設定
      const savedReminder = localStorage.getItem('meditationReminder');
      if (savedReminder) {
        try {
          const reminderSettings = JSON.parse(savedReminder);
          if (reminderSettings.enabled) {
            // 恢復提醒設定到 UI
            if (reminderSettings.time) {
              const timeInput = document.getElementById('reminderTime');
              if (timeInput) timeInput.value = reminderSettings.time;
            }
            if (reminderSettings.message) {
              const messageTextarea = document.getElementById('reminderMessage');
              if (messageTextarea) messageTextarea.value = reminderSettings.message;
            }
            if (reminderSettings.frequency) {
              const frequencyRadio = document.querySelector(`input[name="frequency"][value="${reminderSettings.frequency}"]`);
              if (frequencyRadio) frequencyRadio.checked = true;
            }
            if (reminderSettings.customDays && reminderSettings.frequency === 'custom') {
              reminderSettings.customDays.forEach(day => {
                const checkbox = document.querySelector(`input[name="customDays"][value="${day}"]`);
                if (checkbox) checkbox.checked = true;
              });
            }
            
            // 通知 Service Worker 恢復提醒
            if ('serviceWorker' in navigator) {
              navigator.serviceWorker.ready.then(registration => {
                registration.active.postMessage({
                  type: 'SET_REMINDER',
                  data: reminderSettings
                });
              });
            }
          }
        } catch (error) {
          console.error('恢復提醒設定失敗:', error);
        }
      }
      
      // 側邊欄/漢堡選單互動 from meditation.html
      function detectDeviceAndSetMandalaLink() {
        const mandalaLink = document.getElementById('mandala-link');
        if (mandalaLink) {
          const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
          const screenWidth = window.screen.width;
          let isMobileDevice = false;
          if (isMobile || screenWidth < 768) {
            isMobileDevice = true;
          }
          if (isMobileDevice) {
            mandalaLink.href = 'mobile-mandala.html';
            mandalaLink.title = '曼荼羅 (手機版)';
          } else {
            mandalaLink.href = 'mandala.html';
            mandalaLink.title = '曼荼羅 (桌面版)';
          }
        }
      }
      detectDeviceAndSetMandalaLink();
      const sidebar = document.getElementById('sidebar');
      const hamburger = document.getElementById('hamburger');
      const sidebarOverlay = document.getElementById('sidebarOverlay');
      function toggleSidebar() {
        sidebar.classList.toggle('open');
        hamburger.classList.toggle('open');
        sidebarOverlay.classList.toggle('active');
      }
      function closeSidebar() {
        sidebar.classList.remove('open');
        hamburger.classList.remove('open');
        sidebarOverlay.classList.remove('active');
      }
      hamburger.addEventListener('click', toggleSidebar);
      sidebarOverlay.addEventListener('click', closeSidebar);
      const playlist = [
        { id: "rainbow", title: "彩虹冥想", artist: "冥想音樂合輯", file: "meditationMusic/meditation1_rainbow.mp3", duration: "0:00", background: "images/rainbow.png" },
        { id: "hamsa", title: "哈姆薩冥想", artist: "冥想音樂合輯", file: "meditationMusic/meditation2_hamsa.mp3", duration: "0:00", background: "images/HamSa.png" },
        { id: "mindfulness", title: "正念冥想", artist: "冥想音樂合輯", file: "meditationMusic/meditation3_mindfulness.mp3", duration: "0:00", background: "images/mindfulness.png" },
  { id: "warriors_creed", title: "戰士信條", artist: "冥想音樂合輯", file: "meditationMusic/meditation4_warriorscreed.mp3", duration: "0:00", background: "images/warroirscreed.png" },
        { id: "hollow_body", title: "空心冥想", artist: "冥想音樂合輯", file: "meditationMusic/meditation5_hollowbody.mp3", duration: "0:00", background: "images/hollow.png" },
        { id: "pearl_ocean", title: "珍珠與海洋", artist: "冥想音樂合輯", file: "meditationMusic/meditation6_pearl&ocean.mp3", duration: "0:00", background: "images/pearOcean.png" }
      ];

      let currentTrackIndex = 0;
      let isShuffled = false;
      let isRepeating = false;
      let originalPlaylist = playlist.map(track => ({ ...track }));
      let currentPlaylist = playlist.map(track => ({ ...track }));
      
      let isLyricsDragging = false;
      let scrollSpeed = 0;
      let reminderIntervalId = null;

      const audio = document.getElementById('audio');
      const playBtn = document.getElementById('play');
      const seek = document.getElementById('seek');
      const cur = document.getElementById('cur');
      const dur = document.getElementById('dur');
      const titleEl = document.getElementById('trackTitle');
      const artistEl = document.getElementById('artist');
      const artBackground = document.getElementById('artBackground');
      const lyricsText = document.getElementById('lyricsText');
      const lyricsContainer = lyricsText.parentElement;
      const prevBtn = document.getElementById('prev');
      const nextBtn = document.getElementById('next');
      const shuffleBtn = document.getElementById('shuffle');
      const repeatBtn = document.getElementById('repeat');
      const playlistBtn = document.getElementById('playlistBtn');
      const playlistModal = document.getElementById('playlistModal');
      const closePlaylist = document.getElementById('closePlaylist');
      const playlistItemsContainer = document.getElementById('playlistItems');
      const resetPlaylistOrderBtn = document.getElementById('resetPlaylistOrder');
      const reminderBtn = document.getElementById('reminder');
      const reminderModal = document.getElementById('reminderModal');
      const closeReminder = document.getElementById('closeReminder');
      
      // 修正後的提醒相關元素宣告
      const reminderTimeInput = document.getElementById('reminderTime');
      const reminderMessageTextarea = document.getElementById('reminderMessage');
      const saveReminderBtn = document.getElementById('saveReminder');
      const testReminderBtn = document.getElementById('testReminder');
      const reminderStatusDiv = document.getElementById('reminderStatus');
      const frequencyRadios = document.querySelectorAll('input[name="frequency"]');
      const customDaysSection = document.getElementById('customDaysSection');
      const customDayCheckboxes = document.querySelectorAll('.day-checkbox input');


      const formatTime = (seconds) => {
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return `${min}:${sec < 10 ? '0' : ''}${sec}`;
      };
      
      const loadTrack = (index) => {
        const track = currentPlaylist[index];
        if (!track) return;

        titleEl.textContent = track.title;
        artistEl.textContent = track.artist;
        audio.src = track.file;
        artBackground.style.backgroundImage = `url(${track.background})`;
        
        // Fix: Use correct file path for warrior's creed lyrics. You may need to adjust this path.
          if (track.id === "warriors_creed") {
            fetch("warrior'sCreed/warror'sCreed.txt")
              .then(res => res.ok ? res.text() : Promise.reject("歌詞檔案載入失敗"))
              .then(text => {
                lyricsText.textContent = text;
                lyricsText.classList.add('warriors-creed-style');
              })
              .catch(() => {
                lyricsText.textContent = '歌詞載入失敗';
                lyricsText.classList.add('warriors-creed-style');
              });
          } else {
            lyricsText.textContent = '';
            lyricsText.classList.remove('warriors-creed-style');
          }
        
        isLyricsDragging = false;
        lyricsContainer.scrollTop = 0;
        
        currentTrackIndex = index;
        updatePlaylistUI();
      };
      
      const setPlayState = (isPlaying) => {
        if (isPlaying) {
          audio.play().catch(e => console.error("Playback failed:", e));
          playBtn.dataset.state = 'pause';
        } else {
          audio.pause();
          playBtn.dataset.state = 'play';
        }
      };
      
      const playNext = () => {
        currentTrackIndex = (currentTrackIndex + 1) % currentPlaylist.length;
        loadTrack(currentTrackIndex);
        setPlayState(true);
      };
      
      const playPrev = () => {
        currentTrackIndex = (currentTrackIndex - 1 + currentPlaylist.length) % currentPlaylist.length;
        loadTrack(currentTrackIndex);
        setPlayState(true);
      };
      
      playBtn.addEventListener('click', () => setPlayState(audio.paused));
      prevBtn.addEventListener('click', playPrev);
      nextBtn.addEventListener('click', playNext);
      
      repeatBtn.addEventListener('click', () => {
        isRepeating = !isRepeating;
        repeatBtn.classList.toggle('active', isRepeating);
        audio.loop = isRepeating;
      });

      shuffleBtn.addEventListener('click', () => {
        isShuffled = !isShuffled;
        shuffleBtn.classList.toggle('active', isShuffled);
        const currentTrackId = currentPlaylist[currentTrackIndex].id;
        if (isShuffled) {
          let shuffled = [...originalPlaylist].sort(() => 0.5 - Math.random());
          const currentTrackInShuffled = shuffled.find(t => t.id === currentTrackId);
          shuffled = shuffled.filter(t => t.id !== currentTrackId);
          shuffled.unshift(currentTrackInShuffled);
          currentPlaylist = shuffled;
        } else {
          currentPlaylist = [...originalPlaylist];
        }
        currentTrackIndex = currentPlaylist.findIndex(t => t.id === currentTrackId);
        initPlaylistUI();
      });
      
      audio.addEventListener('loadedmetadata', () => {
        dur.textContent = formatTime(audio.duration);
        seek.max = audio.duration;
        const track = currentPlaylist[currentTrackIndex];
        if (track && track.id === "warriors_creed") {
          const totalScrollDistance = lyricsText.scrollHeight - lyricsContainer.clientHeight;
          if (totalScrollDistance > 0) {
            scrollSpeed = (totalScrollDistance + 20) / audio.duration * 25; // 速度可調整
          } else {
            scrollSpeed = 0;
          }
        } else {
          scrollSpeed = 0;
        }
      });

      audio.addEventListener('timeupdate', () => {
        cur.textContent = formatTime(audio.currentTime);
        seek.value = audio.currentTime;
        const track = currentPlaylist[currentTrackIndex];
        if (
          track && track.id === "warriors_creed" &&
          !isLyricsDragging && audio.duration && scrollSpeed > 0
        ) {
          // 循環滾動歌詞
          const totalScrollDistance = lyricsText.scrollHeight - lyricsContainer.clientHeight;
          let scrollPos = audio.currentTime * scrollSpeed;
          if (scrollPos >= totalScrollDistance) {
            // 到底後自動回頂繼續滾動
            lyricsContainer.scrollTop = 0;
            audio.currentTime = 0;
          } else {
            lyricsContainer.scrollTop = scrollPos;
          }
        }
      });

      audio.addEventListener('ended', () => {
        if (!audio.loop) playNext();
      });
      
      seek.addEventListener('input', () => {
        audio.currentTime = seek.value;
      });

      const addLyricsEventListeners = () => {
        let startDragY = 0;
        let startScrollY = 0;

        const handleDragStart = (e) => {
          e.preventDefault();
          isLyricsDragging = true;
          lyricsText.classList.add('dragging');
          startDragY = e.clientY || e.touches[0].clientY;
          startScrollY = lyricsContainer.scrollTop;

          window.addEventListener('mousemove', handleDragMove);
          window.addEventListener('mouseup', handleDragEnd);
          window.addEventListener('touchmove', handleDragMove, { passive: false });
          window.addEventListener('touchend', handleDragEnd);
        };

        const handleDragMove = (e) => {
          if (!isLyricsDragging) return;
          e.preventDefault();
          const clientY = e.clientY || e.touches[0].clientY;
          const deltaY = clientY - startDragY;
          lyricsContainer.scrollTop = startScrollY - deltaY;
        };

        const handleDragEnd = () => {
          if (!isLyricsDragging) return;
          isLyricsDragging = false;
          lyricsText.classList.remove('dragging');
          window.removeEventListener('mousemove', handleDragMove);
          window.removeEventListener('mouseup', handleDragEnd);
          window.removeEventListener('touchmove', handleDragMove);
          window.removeEventListener('touchend', handleDragEnd);
        };

        lyricsContainer.addEventListener('scroll', () => {
          if (!isLyricsDragging) {
            clearTimeout(lyricsContainer.scrollTimeout);
            lyricsContainer.scrollTimeout = setTimeout(() => {
              if (audio.duration && scrollSpeed > 0) {
                lyricsContainer.scrollTop = audio.currentTime * scrollSpeed;
              }
            }, 500); 
          }
        });

        lyricsText.addEventListener('mousedown', handleDragStart);
        lyricsText.addEventListener('touchstart', handleDragStart, { passive: false });
      };

      playlistBtn.addEventListener('click', () => {
        playlistModal.style.display = 'grid';
        initPlaylistUI();
      });
      closePlaylist.addEventListener('click', () => playlistModal.style.display = 'none');
      
      const initPlaylistUI = () => {
        playlistItemsContainer.innerHTML = '';
        currentPlaylist.forEach((track, index) => {
          const item = document.createElement('div');
          item.className = `playlist-item ${index === currentTrackIndex ? 'active' : ''}`;
          item.dataset.id = track.id;
          item.innerHTML = `<div class="drag-handle" draggable="true"><svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M10 5h3v2h-3zm-7 0h3v2H3zm7 12h3v2h-3zm-7 0h3v2H3zm7-6h3v2h-3zm-7 0h3v2H3z"></path></svg></div><div class="playlist-item-number">${index + 1}</div><div class="playlist-item-info"><div class="playlist-item-title">${track.title}</div><div class="playlist-item-duration">${track.duration}</div></div>`;
          item.addEventListener('click', (e) => {
            // Fix: Syntax error `if e.target.closest(...)` corrected to `if (e.target.closest(...))`
            if (e.target.closest('.drag-handle')) return;
            const clickedIndex = currentPlaylist.findIndex(t => t.id === track.id);
            loadTrack(clickedIndex);
            setPlayState(true);
            playlistModal.style.display = 'none';
          });
          playlistItemsContainer.appendChild(item);
        });
      };
      
      const updatePlaylistUI = () => {
        playlistItemsContainer.querySelectorAll('.playlist-item').forEach(item => {
          item.classList.toggle('active', item.dataset.id === currentPlaylist[currentTrackIndex].id);
        });
      };
      
      resetPlaylistOrderBtn.addEventListener('click', () => {
        const currentTrackId = currentPlaylist[currentTrackIndex].id;
        currentPlaylist = [...originalPlaylist];
        currentTrackIndex = currentPlaylist.findIndex(t => t.id === currentTrackId);
        isShuffled = false;
        shuffleBtn.classList.remove('active');
        initPlaylistUI();
      });

      let draggedItem = null;
      playlistItemsContainer.addEventListener('dragstart', e => {
        if (e.target.closest('.drag-handle')) {
          draggedItem = e.target.closest('.playlist-item');
          setTimeout(() => draggedItem.classList.add('dragging'), 0);
        }
      });
      playlistItemsContainer.addEventListener('dragend', () => {
        if(draggedItem) {
          draggedItem.classList.remove('dragging');
          draggedItem = null;
        }
      });
      playlistItemsContainer.addEventListener('dragover', e => {
        e.preventDefault();
        const afterElement = getDragAfterElement(playlistItemsContainer, e.clientY);
        if (draggedItem) {
          if (afterElement == null) {
            playlistItemsContainer.appendChild(draggedItem);
          } else {
            playlistItemsContainer.insertBefore(draggedItem, afterElement);
          }
        }
      });
      playlistItemsContainer.addEventListener('drop', e => {
        e.preventDefault();
        if (!draggedItem) return;
        
        const newOrderedIds = [...playlistItemsContainer.children].map(item => item.dataset.id);
        const currentTrackId = currentPlaylist[currentTrackIndex].id;

        currentPlaylist = newOrderedIds.map(id => originalPlaylist.find(track => track.id === id));
        currentTrackIndex = currentPlaylist.findIndex(track => track.id === currentTrackId);

        initPlaylistUI();
      });
      
      // Fix: Complete the drag-and-drop helper function
      function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.playlist-item:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = y - box.top - box.height / 2;
          if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
          } else {
            return closest;
          }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
      }

      // Reminder Modal Logic - The missing part
      const showReminderStatus = (message, isSuccess = true) => {
          reminderStatusDiv.textContent = message;
          reminderStatusDiv.classList.remove('success', 'error');
          reminderStatusDiv.classList.add(isSuccess ? 'success' : 'error');
          reminderStatusDiv.style.display = 'block';
      };

      const saveReminder = () => {
          const reminderTime = reminderTimeInput.value;
          const reminderMessage = reminderMessageTextarea.value;
          const frequency = document.querySelector('input[name="frequency"]:checked').value;
          
          let customDays = [];
          if (frequency === 'custom') {
              customDayCheckboxes.forEach(checkbox => {
                  if (checkbox.checked) {
                      customDays.push(parseInt(checkbox.value));
                  }
              });
          }

          if (reminderIntervalId) {
              clearInterval(reminderIntervalId);
          }

          // 儲存提醒設定到 localStorage
          const reminderSettings = {
              time: reminderTime,
              message: reminderMessage,
              frequency: frequency,
              customDays: customDays,
              enabled: true,
              lastSet: Date.now()
          };
          localStorage.setItem('meditationReminder', JSON.stringify(reminderSettings));

          if ('Notification' in window) {
              Notification.requestPermission().then(permission => {
                  if (permission === 'granted') {
                      // 使用 Service Worker 處理背景通知
                      if ('serviceWorker' in navigator) {
                          navigator.serviceWorker.ready.then(registration => {
                              // 發送訊息給 Service Worker 設定提醒
                              registration.active.postMessage({
                                  type: 'SET_REMINDER',
                                  data: reminderSettings
                              });
                          });
                      }
                      
                      // 同時保留本地檢查作為備用
                      reminderIntervalId = setInterval(() => {
                          const now = new Date();
                          const [targetHour, targetMinute] = reminderTime.split(':').map(Number);
                          const currentDay = now.getDay();
                          
                          let shouldRemind = false;
                          if (frequency === 'daily') {
                              shouldRemind = true;
                          } else if (frequency === 'weekdays') {
                              if (currentDay >= 1 && currentDay <= 5) {
                                  shouldRemind = true;
                              }
                          } else if (frequency === 'custom') {
                              if (customDays.includes(currentDay)) {
                                  shouldRemind = true;
                              }
                          }
                          
                          if (shouldRemind && now.getHours() === targetHour && now.getMinutes() === targetMinute) {
                              // 使用 Service Worker 顯示通知
                              if ('serviceWorker' in navigator) {
                                  navigator.serviceWorker.ready.then(registration => {
                                      registration.showNotification('冥想提醒', {
                                          body: reminderMessage,
                                          icon: '/favicon.ico',
                                          badge: '/favicon.ico',
                                          tag: 'meditation-reminder',
                                          requireInteraction: true,
                                          actions: [
                                              {
                                                  action: 'open',
                                                  title: '開始冥想',
                                                  icon: '/favicon.ico'
                                              },
                                              {
                                                  action: 'snooze',
                                                  title: '稍後提醒',
                                                  icon: '/favicon.ico'
                                              }
                                          ],
                                          data: {
                                              url: window.location.href,
                                              timestamp: Date.now()
                                          }
                                      });
                                  });
                              } else {
                                  // 備用方案
                                  new Notification('冥想提醒', {
                                      body: reminderMessage,
                                      icon: '/favicon.ico'
                                  });
                              }
                          }
                      }, 60 * 1000); // Check every minute

                      showReminderStatus('提醒已成功儲存！', true);
                  } else {
                      showReminderStatus('無法啟用提醒功能，請允許通知權限。', false);
                  }
              });
          } else {
              showReminderStatus('您的瀏覽器不支援通知功能。', false);
          }
      };

      reminderBtn.addEventListener('click', () => {
        reminderModal.style.display = 'grid';
      });

      closeReminder.addEventListener('click', () => {
        reminderModal.style.display = 'none';
        reminderStatusDiv.style.display = 'none';
      });

      frequencyRadios.forEach(radio => {
        radio.addEventListener('change', () => {
          if (radio.value === 'custom') {
            customDaysSection.style.display = 'block';
          } else {
            customDaysSection.style.display = 'none';
          }
        });
      });

      saveReminderBtn.addEventListener('click', saveReminder);

      testReminderBtn.addEventListener('click', () => {
        if ('Notification' in window) {
          Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
              // 使用 Service Worker 發送測試通知
              if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                  registration.showNotification('冥想提醒測試', {
                    body: '這是一個測試通知，您的通知功能運作正常！',
                    icon: '/favicon.ico',
                    badge: '/favicon.ico',
                    tag: 'test-notification',
                    requireInteraction: true,
                    actions: [
                      {
                        action: 'open',
                        title: '開啟應用',
                        icon: '/favicon.ico'
                      }
                    ],
                    data: {
                      url: window.location.href,
                      timestamp: Date.now()
                    }
                  });
                  showReminderStatus('測試通知已發送！', true);
                });
              } else {
                // 備用方案
                new Notification('冥想提醒測試', {
                  body: '這是一個測試通知，您的通知功能運作正常！',
                  icon: '/favicon.ico'
                });
                showReminderStatus('測試通知已發送！', true);
              }
            } else {
              showReminderStatus('無法發送測試通知，請允許通知權限。', false);
            }
          });
        } else {
          showReminderStatus('您的瀏覽器不支援通知功能。', false);
        }
      });

      loadTrack(currentTrackIndex);
      addLyricsEventListeners();
    });
    
    // PWA 和 Service Worker 註冊
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const registration = await navigator.serviceWorker.register('./service-worker.js');
          console.log('Service Worker 註冊成功:', registration);
          
          // 檢查推送通知支援
          if ('PushManager' in window) {
            console.log('推送通知支援已啟用');
          }
        } catch (error) {
          console.error('Service Worker 註冊失敗:', error);
        }
      });
    }
    
         // 載入 PWA 配置
     const pwaScript = document.createElement('script');
     pwaScript.src = './public/pwa-config.js';
     pwaScript.onload = () => {
       console.log('PWA 配置已載入');
     };
     document.head.appendChild(pwaScript);
  </script>
</body>
</html>