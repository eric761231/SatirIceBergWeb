<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>安裝 Obyssey App 到手機</title>
    <link rel="manifest" href="manifest.json">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Obyssey">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        .main-welcome {
            text-align: center;
            margin-top: 120px;
        }
        .main-link {
            display: inline-block;
            margin-top: 24px;
            font-size: 1.2em;
            color: #3498db;
            text-decoration: underline;
        }
        :root {
            --bg-primary: #131314;
            --bg-secondary: #1e1f20;
            --bg-tertiary: #2a2b2c;
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --border-color: #3c4043;
            --accent-blue: #8ab4f8;
        }
        .share-icon {
            font-size: 1.2em;
            vertical-align: middle;
        }
        body {
            font-family: 'Noto Sans TC', 'Google Sans', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 480px;
            margin: 40px auto;
            background: var(--bg-secondary);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            padding: 40px 28px;
        }
        h1 {
            font-size: 2rem;
            color: var(--accent-blue);
            text-align: center;
            margin-bottom: 22px;
            font-weight: 700;
            letter-spacing: 1px;
        }
        .guide {
            margin-top: 22px;
        }
        .guide h2 {
            font-size: 1.15rem;
            color: var(--accent-blue);
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 4px;
            font-weight: 500;
        }
        .guide ul {
            padding-left: 20px;
            margin: 0 0 18px 0;
        }
        .guide li {
            margin-bottom: 10px;
            font-size: 1.05rem;
            color: var(--text-primary);
        }
        .note {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-top: 16px;
            text-align: center;
        }
        .install-app-btn {
            margin-top: 28px;
            padding: 14px 28px;
            border-radius: 10px;
            background: var(--accent-blue);
            color: var(--bg-primary);
            border: none;
            font-size: 1.15rem;
            font-weight: bold;
            cursor: pointer;
            display: inline-block;
            box-shadow: 0 2px 8px #0002;
            transition: background-color 0.3s, opacity 0.3s;
        }
        .install-app-btn:disabled {
            background-color: var(--border-color);
            color: var(--text-secondary);
            cursor: not-allowed;
        }
        .centered {
            text-align: center;
        }
        .ios-guide {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>安裝 Obyssey App</h1>
        <div class="centered">
            <button id="installAppBtn" class="install-app-btn">安裝 App 到手機</button>
        </div>
        
        <div class="guide">
            <h2>安裝前提醒</h2>
            <ul>
                <li>請「使用手機預設瀏覽器」(iOS 請用 Safari，Android 請用 Chrome) 開啟本頁面。</li>
                <li>若您在 LINE 或 Facebook 等 App 中開啟，請先複製網址並貼到預設瀏覽器中。</li>
            </ul>

            <div id="ios-guide" class="ios-guide">
                <h2>iOS / iPad 安裝教學</h2>
                <ul>
                    <li>1. 請點選 Safari 瀏覽器下方的「分享」按鈕 <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%233498db' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='feather feather-share'%3E%3Cpath d='M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8'%3E%3C/path%3E%3Cpolyline points='16 6 12 2 8 6'%3E%3C/polyline%3E%3Cline x1='12' y1='2' x2='12' y2='15'%3E%3C/line%3E%3C/svg%3E" alt="分享圖示" class="share-icon"></li>
                    <li>2. 在彈出的選單中，向下滑動並選擇「加入主畫面」(Add to Home Screen)</li>
                    <li>3. 點擊右上角的「新增」，即可在桌面上看到 App 圖示</li>
                </ul>
            </div>
            <div id="android-guide" class="android-guide">
                <h2>Android 安裝教學</h2>
                <ul>
                    <li>1. 點擊上方的「安裝 App 到手機」按鈕</li>
                    <li>2. 若按鈕無效或未出現，請點選瀏覽器右上角的「選單 ⋮」</li>
                    <li>3. 選擇「<b>安裝應用程式</b>」(Install app)</li>
                    <li>4. 按照提示完成安裝，桌面將會出現 App 圖示</li>
                </ul>
            </div>
        </div>
        <div class="note">若安裝遇到問題，請確保您的瀏覽器為最新版本。</div>
    </div>

        <script>
        // --- 確保 Service Worker 和 Manifest 存在 ---
        // 1. 建立一個名為 manifest.json 的檔案在網站根目錄。
        // 2. 建立一個名為 service-worker.js 的檔案在網站根目錄。

        // --- Service Worker 註冊 ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // 使用相對路徑，確保在任何路徑下都能正確註冊
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker 註冊成功:', registration);
                    })
          .catch(error => {
            console.error('Service Worker 註冊失敗:', error);
          });
      });
    }

    // --- PWA 安裝邏輯 ---
    const installBtn = document.getElementById('installAppBtn');
    const iosGuide = document.getElementById('ios-guide');
    let deferredPrompt = null;

    // 判斷是否為 iOS 裝置
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    // 判斷 App 是否已經以 PWA 模式開啟
    const isInStandaloneMode = () =>
        (window.matchMedia('(display-mode: standalone)').matches) || (window.navigator.standalone);

    window.addEventListener('beforeinstallprompt', (e) => {
        // 防止 Chrome 67 以下版本自動顯示安裝提示
        e.preventDefault();
        // 儲存事件，以便後續觸發
        deferredPrompt = e;
        // 顯示安裝按鈕 (如果原本是隱藏的)
        installBtn.style.display = 'inline-block';
    });

    installBtn.addEventListener('click', async () => {
        // iOS 裝置的處理方式
        if (isIOS) {
            alert('iOS 用戶請依照下方的教學手動安裝。');
            iosGuide.style.display = 'block'; // 顯示 iOS 安裝教學
            window.scrollTo(0, document.body.scrollHeight); // 捲動到頁面底部方便查看
            return;
        }

        // Android 或桌面版的處理方式
        if (deferredPrompt) {
            // 顯示安裝提示
            deferredPrompt.prompt();
            // 等待使用者回應
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`使用者回應: ${outcome}`);
            if (outcome === 'accepted') {
                installBtn.textContent = '安裝成功！';
                installBtn.disabled = true;
            }
            deferredPrompt = null;
        } else {
             // 如果 deferredPrompt 為 null，可能代表 App 已安裝或不支援
             alert('應用程式可能已經安裝，或您的瀏覽器不支援自動安裝。請參考下方的 Android 教學手動操作。');
        }
    });

    // 頁面載入時檢查狀態
    window.addEventListener('DOMContentLoaded', () => {
        if (isInStandaloneMode()) {
            installBtn.textContent = '已在主畫面開啟';
            installBtn.disabled = true;
        } else if (isIOS) {
            // 在 iOS 上，永遠顯示手動教學提示
            installBtn.textContent = 'iOS 手動安裝教學';
            iosGuide.style.display = 'block';
        }
    });