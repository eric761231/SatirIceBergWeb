<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>繪畫壇城</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Base color variables for easy theme management */
        :root {
            --bg-dark: #18181c;
            --bg-medium: #22223a;
            --bg-light: rgba(30, 30, 45, 0.98);
            --text-light: #f3f3f3;
            --primary-accent: #3498db;
            --danger-accent: #e74c3c;
            --border-color: rgba(255, 255, 255, 0.12);
            --shadow-color: rgba(0, 0, 0, 0.18);
        }

        /* Color button styling */
        .color-btn.color-blue { background-color: #3498db; }
        .color-btn.color-red { background-color: #e74c3c; }
        .color-btn.color-yellow { background-color: #f1c40f; }
        .color-btn.color-orange { background-color: #ff9800; }
        .color-btn.color-green { background-color: #2ecc71; }
        .color-btn.color-purple { background-color: #9b59b6; }
        .color-btn.color-white { background-color: #ffffff; border-color: #888; }
        .color-btn.color-black { background-color: #000000; }

        body {
            background: var(--bg-dark);
            color: var(--text-light);
            font-family: 'Noto Sans TC', Arial, sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .main-layout {
            display: flex;
            flex-direction: row;
            height: 100vh;
            width: 100vw;
        }

        /* Sidebar styles */
        .sidebar {
            width: 300px;
            background: #16213e; 
            box-shadow: 2px 0 16px #0006;
            padding: 24px;
            box-sizing: border-box;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .canvas-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-medium);
            height: 100vh;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            overflow: auto;
            position: relative;
        }

        .toolbar-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-bottom: 20px;
        }
        /* Separator lines for desktop */
        .toolbar-group:not(:last-child) {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 16px;
        }

        .toolbar-group-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 4px;
            color: var(--primary-accent);
            text-align: center;
        }

        .toolbar-row {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
        }
        
        .sidebar button, .sidebar select, .sidebar input[type="range"] {
            font-family: inherit;
        }

        .sidebar label {
            white-space: nowrap;
        }

        .icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            background: transparent;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.18);
            border: 1px solid rgba(255,255,255,0.12);
            transition: background 0.2s, box-shadow 0.2s;
            padding: 0;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
        }

        .icon-btn.active {
            background: var(--primary-accent);
            color: #fff;
            border-color: var(--primary-accent);
        }
        
        .icon-btn:hover {
            background: #444;
        }
        
        .icon-btn:active {
            transform: translateY(1px);
        }

        .color-palette {
            display: flex;
            flex-wrap: wrap;
            flex-direction: row;
            gap: 8px;
            width: auto;
            height: auto;
            justify-content: center;
        }

        .color-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #fff;
            padding: 0;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s, transform 0.1s;
        }
        
        .color-btn:hover {
            transform: scale(1.1);
        }

        .color-btn.active {
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 3px var(--primary-accent);
        }

        .icon-btn.eraser.active {
            background: var(--danger-accent);
            border-color: var(--danger-accent);
        }

        .shape-select, .symmetry-select {
            background: #2a2a3a;
            color: #fff;
            border-radius: 8px;
            border: 1px solid #888;
            padding: 6px 12px;
            font-size: 1em;
            min-width: 60px;
            cursor: pointer;
        }

        #mandala-canvas {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 24px #0006;
            touch-action: none;
            cursor: crosshair;
            /* 響應式畫布尺寸調整 */
            max-width: calc(100vw - 40px); /* 手機版左右各留20px邊距 */
            max-height: calc(100vh - 200px); /* 手機版上下留出空間給標題和工具列 */
            width: min(calc(100vw - 40px), calc(100vh - 200px));
            height: min(calc(100vw - 40px), calc(100vh - 200px));
        }

        /* 桌面版畫布尺寸 */
        @media (min-width: 769px) {
            #mandala-canvas {
                max-width: calc(100vw - 340px);
                max-height: calc(100vh - 40px);
                width: min(calc(100vw - 340px), calc(100vh - 40px));
                height: min(calc(100vw - 340px), calc(100vh - 40px));
            }
        }

        /* Mobile specific styles */
        .controls-mobile {
            display: none;
        }
        
        /* 手機版顏色按鈕特殊樣式 */
        .controls-mobile .color-palette {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            width: 100%;
            max-width: 280px;
            margin: 0 auto;
        }
        
        .controls-mobile .color-btn {
            width: 40px;
            height: 40px;
            margin: 0;
        }

        .mobile-header {
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: rgba(30, 30, 45, 0.95);
            border-radius: 20px;
            margin: 16px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }

        .mobile-title {
            color: #e0e0e0;
            font-size: 1.5em;
            font-weight: 300;
            margin: 0;
            flex: 1;
            text-align: center;
        }

        #mobile-nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 240px;
            height: 100vh;
            background: #16213e;
            box-shadow: 2px 0 16px #0006;
            z-index: 200;
            transform: translateX(-100%);
            transition: transform 0.3s;
            overflow-y: auto;
        }
        
        #mobile-nav.show {
            transform: translateX(0);
        }

        #mobile-nav h2 {
            color: #00aaff;
            margin: 24px 0 16px 0;
            text-align: center;
            font-size: 1.2em;
            padding: 16px 0 8px 0;
        }
        
        .nav-link {
            display: block;
            padding: 12px 32px;
            color: #fff;
            font-size: 1.1em;
            text-decoration: none;
            text-align: center;
        }

        #nav-close {
            position: absolute;
            top: 16px;
            right: 16px;
        }
        
        /* Responsive design for smaller screens */
        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column-reverse;
            }
            .sidebar {
                display: none;
            }

            .mobile-header {
                display: flex;
                /* 手機版標題置中優化 */
                justify-content: center;
                align-items: center;
                text-align: center;
            }

            .controls-mobile {
                display: flex;
                flex-direction: column;
                background: var(--bg-light);
                box-shadow: 0 -2px 16px var(--shadow-color);
                padding: 16px;
                gap: 16px;
                width: 100%;
                box-sizing: border-box;
                position: fixed;
                bottom: 0;
                left: 0;
                z-index: 10;
            }
            .controls-mobile .toolbar-row {
                justify-content: center;
                flex-wrap: wrap;
                gap: 12px;
            }
            #brush-size-mobile {
                flex: 1;
                min-width: 120px;
            }
            .canvas-area {
                padding: 0;
                height: 100vh;
                width: 100vw;
                box-sizing: border-box;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
                /* 手機版畫布區域置中優化 */
                overflow: hidden;
                /* 手機版背景色調整 - 消除暗色區域 */
                background: transparent;
            }
            #mandala-canvas {
                /* 手機版畫布尺寸優化 - 垂直置中在螢幕中央 */
                width: calc(100vw - 40px);
                height: calc(100vh - 320px);
                max-width: calc(100vw - 40px);
                max-height: calc(100vh - 320px);
                /* 垂直置中：移除絕對定位，使用flexbox置中 */
                position: relative;
                /* 確保畫布在手機上正確顯示 */
                border-radius: 12px;
                /* 手機版畫布背景色 - 與頁面背景一致 */
                background: var(--bg-dark);
            }
            .toolbar-group-title {
                display: none;
            }
            .toolbar-group {
                border-bottom: none;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                gap: 16px;
            }
            
            /* 手機版顏色按鈕優化 */
            .controls-mobile .color-palette {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
                width: 100%;
                max-width: 320px;
                margin: 0 auto;
            }
            
            .controls-mobile .color-btn {
                width: 44px;
                height: 44px;
                margin: 0;
            }
        }
        
        /* 額外的響應式設計 */
        @media (max-width: 480px) {
            #mandala-canvas {
                /* 小螢幕手機畫布尺寸優化 */
                width: calc(100vw - 32px);
                height: calc(100vh - 280px);
                max-width: calc(100vw - 32px);
                max-height: calc(100vh - 280px);
                /* 垂直置中：使用flexbox置中，移除絕對定位 */
                position: relative;
                /* 小螢幕手機畫布背景色 - 與頁面背景一致 */
                background: var(--bg-dark);
            }
            .canvas-area {
                padding: 0;
                /* 小螢幕手機畫布區域優化 */
                overflow: hidden;
                /* 小螢幕手機背景色調整 - 消除暗色區域 */
                background: transparent;
            }
            /* 小螢幕手機標題優化 */
            .mobile-header {
                padding: 8px 16px;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            #mandala-canvas {
                width: min(calc(100vw - 360px), calc(100vh - 60px));
                height: min(calc(100vw - 360px), calc(100vh - 60px));
                max-width: calc(100vw - 360px);
                max-height: calc(100vh - 60px);
            }
        }
        
        @media (min-width: 1025px) {
            #mandala-canvas {
                width: min(calc(100vw - 380px), calc(100vh - 80px));
                height: min(calc(100vw - 380px), calc(100vh - 80px));
                max-width: calc(100vw - 380px);
                max-height: calc(100vh - 80px);
            }
        }
    </style>
</head>
<body>
    <!-- 橘色標題區塊（手機版） -->
    <!-- 手機版深色標題區塊 -->
    <div class="mobile-header" style="display:flex;align-items:center;justify-content:flex-start;padding:18px 18px 10px 18px;background:rgba(30,30,45,0.98);border-radius:24px;margin:0 0 8px 0;box-shadow:0 2px 12px #0002;">
        <button id="hamburger" class="icon-btn" title="展開選單" style="margin-right:16px;">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
        </button>
        <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;">
            <!-- 曼荼羅標題置中調整 -->
            <span style="font-size:1.5em;font-weight:bold;color:#3498db;letter-spacing:2px;text-align:center;width:100%;">曼荼羅</span>
            <span style="font-size:1em;color:#fff;margin-top:4px;">曼荼羅是心靈的鏡子，反映你的內在世界</span>
        </div>
    </div>

    <!-- 桌面版側邊欄 -->
    <div class="sidebar">
        <div class="toolbar-group">
            <div class="toolbar-group-title">畫筆設定</div>
            <div class="toolbar-row">
                <label for="brush-size">大小：</label>
                <input type="range" id="brush-size" min="1" max="100" value="10">
            </div>
        </div>
        
        <div class="toolbar-group">
            <div class="toolbar-group-title">顏色選擇</div>
            <div class="toolbar-row color-palette" id="color-palette">
                <button class="color-btn color-red active" data-color="#e74c3c" title="紅色"></button>
                <button class="color-btn color-orange" data-color="#ff9800" title="橙色"></button>
                <button class="color-btn color-yellow" data-color="#f1c40f" title="黃色"></button>
                <button class="color-btn color-green" data-color="#2ecc71" title="綠色"></button>
                <button class="color-btn color-blue" data-color="#3498db" title="藍色"></button>
                <button class="color-btn color-purple" data-color="#9b59b6" title="紫色"></button>
                <button class="color-btn color-white" data-color="#ffffff" title="白色"></button>
                <button class="color-btn color-black" data-color="#000000" title="黑色"></button>
            </div>
        </div>
        
        <div class="toolbar-group">
            <div class="toolbar-group-title">繪圖工具</div>
            <div class="toolbar-row" id="shape-tools">
                <button class="icon-btn active" data-shape="freehand" title="自由筆">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 21v-2a4 4 0 0 1 4-4h2"/>
                        <path d="M16 3a2.828 2.828 0 0 1 4 4L7 20l-4 1 1-4L17 3z"/>
                    </svg>
                </button>
                <button class="icon-btn" data-shape="line">─</button>
                <button class="icon-btn eraser" id="eraser-btn" title="橡皮擦">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="17" width="18" height="4" rx="2"/>
                        <path d="M5 17L19 3"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="toolbar-group">
            <div class="toolbar-group-title">對稱設定</div>
            <div class="toolbar-row">
                <label for="symmetry-count">對稱:</label>
                <select class="symmetry-select" id="symmetry-count">
                    <option value="0" selected>0</option>
                    <option value="2">2</option>
                    <option value="4">4</option>
                    <option value="6">6</option>
                    <option value="8">8</option>
                    <option value="12">12</option>
                </select>
            </div>
        </div>
        
        <div class="toolbar-group">
            <div class="toolbar-group-title">操作工具</div>
            <div class="toolbar-row">
                <button class="icon-btn" id="undo-btn">↩️</button>
                <button class="icon-btn" id="redo-btn">↪️</button>
                <button class="icon-btn" id="clear-btn">🗑️</button>
                <button class="icon-btn" id="save-btn">💾</button>
            </div>
        </div>
    </div>

    <div class="canvas-area">
        <canvas id="mandala-canvas"></canvas>
    </div>

    <!-- 手機版繪圖工具收合區塊（橘色底） -->
    <div class="controls-mobile" style="background:linear-gradient(90deg,#ff9800 80%,#ffb74d 100%);padding:0 0 8px 0;border-radius:24px 24px 0 0;box-shadow:0 -2px 12px #0002;position:fixed;bottom:0;left:0;width:100vw;z-index:20;">
        <button id="toggle-tools-btn" style="width:100%;background:#ff9800;color:#fff;font-size:1.1em;padding:10px 0;border:none;border-radius:24px 24px 0 0;box-shadow:0 -2px 8px #0002;">繪畫工具 ▼</button>
        <div id="mobile-tools-content" style="display:none;padding:8px 0 0 0;">
            <div class="toolbar-group">
                <div class="toolbar-row">
                    <label for="brush-size-mobile">大小：</label>
                    <input type="range" id="brush-size-mobile" min="1" max="100" value="10">
                </div>
                <div class="toolbar-row color-palette" id="color-palette-mobile">
                    <button class="color-btn color-red active" data-color="#e74c3c" title="紅色"></button>
                    <button class="color-btn color-orange" data-color="#ff9800" title="橙色"></button>
                    <button class="color-btn color-yellow" data-color="#f1c40f" title="黃色"></button>
                    <button class="color-btn color-green" data-color="#2ecc71" title="綠色"></button>
                    <button class="color-btn color-blue" data-color="#3498db" title="藍色"></button>
                    <button class="color-btn color-purple" data-color="#9b59b6" title="紫色"></button>
                    <button class="color-btn color-white" data-color="#ffffff" title="白色"></button>
                    <button class="color-btn color-black" data-color="#000000" title="黑色"></button>
                </div>
                <div class="toolbar-row" id="shape-tools-mobile">
                    <button class="icon-btn active" data-shape="freehand" title="自由筆">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 21v-2a4 4 0 0 1 4-4h2"/>
                            <path d="M16 3a2.828 2.828 0 0 1 4 4L7 20l-4 1 1-4L17 3z"/>
                        </svg>
                    </button>
                    <button class="icon-btn" data-shape="line">─</button>
                    <button class="icon-btn eraser" id="eraser-btn-mobile" title="橡皮擦">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="17" width="18" height="4" rx="2"/>
                            <path d="M5 17L19 3"/>
                        </svg>
                    </button>
                </div>
                <div class="toolbar-row">
                    <label for="symmetry-count-mobile">對稱:</label>
                    <select class="symmetry-select" id="symmetry-count-mobile">
                        <option value="0" selected>0</option>
                        <option value="2">2</option>
                        <option value="4">4</option>
                        <option value="6">6</option>
                        <option value="8">8</option>
                        <option value="12">12</option>
                    </select>
                    <button class="icon-btn" id="undo-btn-mobile">↩️</button>
                    <button class="icon-btn" id="redo-btn-mobile">↪️</button>
                    <button class="icon-btn" id="clear-btn-mobile">🗑️</button>
                    <button class="icon-btn" id="save-btn-mobile">💾</button>
                </div>
            </div>
        </div>
    </div>

    <nav id="mobile-nav">
        <h2>選單</h2>
        <a href="meditation.html" class="nav-link">冥想音樂</a>
        <a href="articles.html" class="nav-link">每日閱讀</a>
        <a href="guide.html" class="nav-link">每日指引</a>
        <button id="nav-close" class="icon-btn" title="關閉選單">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
    </nav>

<script>
    // 手機版繪圖工具收合/展開功能
    const controlsMobile = document.querySelector('.controls-mobile');
    const mobileToolsContent = document.getElementById('mobile-tools-content');
    const toggleToolsBtn = document.getElementById('toggle-tools-btn');
    let toolsOpen = false;
    toggleToolsBtn.addEventListener('click', function() {
        toolsOpen = !toolsOpen;
        if (toolsOpen) {
            mobileToolsContent.style.display = 'block';
            toggleToolsBtn.innerHTML = '繪畫工具 ▲';
        } else {
            mobileToolsContent.style.display = 'none';
            toggleToolsBtn.innerHTML = '繪畫工具 ▼';
        }
    });
    window.addEventListener('DOMContentLoaded', () => {
        // --- DOM Element Selection ---
        const canvas = document.getElementById('mandala-canvas');
        const ctx = canvas.getContext('2d');
        const canvasArea = document.querySelector('.canvas-area');
        
        // Desktop controls (main)
        const desktopControls = {
            brushSize: document.getElementById('brush-size'),
            colorPalette: document.getElementById('color-palette'),
            shapeTools: document.getElementById('shape-tools'),
            eraserBtn: document.getElementById('eraser-btn'),
            symmetrySelect: document.getElementById('symmetry-count'),
            undoBtn: document.getElementById('undo-btn'),
            redoBtn: document.getElementById('redo-btn'),
            clearBtn: document.getElementById('clear-btn'),
            saveBtn: document.getElementById('save-btn'),
        };
        
        // Mobile controls
        const mobileControls = {
            brushSize: document.getElementById('brush-size-mobile'),
            colorPalette: document.getElementById('color-palette-mobile'),
            shapeTools: document.getElementById('shape-tools-mobile'),
            eraserBtn: document.getElementById('eraser-btn-mobile'),
            symmetrySelect: document.getElementById('symmetry-count-mobile'),
            undoBtn: document.getElementById('undo-btn-mobile'),
            redoBtn: document.getElementById('redo-btn-mobile'),
            clearBtn: document.getElementById('clear-btn-mobile'),
            saveBtn: document.getElementById('save-btn-mobile'),
        };

        // Mobile sidebar control
        const hamburgerBtn = document.getElementById('hamburger');
        const sidebarNav = document.getElementById('mobile-nav');
        const sidebarClose = document.getElementById('nav-close');
        
        // --- State Variables ---
        let isDrawing = false;
        let isDraggingShape = false;
        let brushSize = 10;
        let brushColor = '#000000';
        let lastSelectedColor = '#000000';
        let symmetry = 0;
        let currentShape = 'freehand';
        let lastX = 0;
        let lastY = 0;
        let startX = 0;
        let startY = 0;
        let history = [];
        let historyIndex = -1;
        
        // --- Canvas Setup ---
        function resizeCanvas() {
            // 檢測是否為手機版
            const isMobile = window.innerWidth <= 768;
            
            let size;
            if (isMobile) {
                // 手機版：自動充滿螢幕剩餘空間
                const headerHeight = 120; // 標題欄高度
                const toolsHeight = 200;  // 底部工具列高度
                const margin = 20;        // 左右邊距
                
                const availableHeight = window.innerHeight - headerHeight - toolsHeight;
                const availableWidth = window.innerWidth - margin;
                
                // 手機版畫布應該更大，更接近螢幕邊緣
                size = Math.min(availableWidth, availableHeight);
                
                // 確保畫布不會太小
                if (size < 300) {
                    size = Math.min(window.innerWidth - 10, window.innerHeight - 280);
                }
                
                // 手機版畫布優先使用寬度，讓畫布更寬
                if (availableWidth > availableHeight) {
                    size = availableWidth;
                }
                
                // 手機版畫布置中調整
                const canvasArea = document.querySelector('.canvas-area');
                if (canvasArea) {
                    canvasArea.style.justifyContent = 'center';
                    canvasArea.style.alignItems = 'center';
                }
            } else {
                // 桌面版：考慮側邊欄寬度
                const containerWidth = canvasArea.clientWidth - 40;
                const containerHeight = canvasArea.clientHeight - 40;
                size = Math.min(containerWidth, containerHeight);
            }
            
            // 確保最小尺寸
            size = Math.max(size, 200);
            
            canvas.width = size;
            canvas.height = size;
            
            // 重新繪製歷史記錄
            if (history.length > 0) {
                redrawFromHistory();
            } else {
                clearCanvas(false);
            }
        }

        function clearCanvas(save = true) {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            if (save) {
                saveState();
            }
        }

        function initializeCanvas() {
            resizeCanvas();
            clearCanvas(true);
        }

        // --- Drawing Logic ---
        function getEventCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            const x = clientX - rect.left;
            const y = clientY - rect.top;
            return { x, y };
        }

        function handleCanvasMouseDown(e) {
            e.preventDefault();
            const coords = getEventCoordinates(e);
            
            if (currentShape === 'freehand') {
                isDrawing = true;
                [lastX, lastY] = [coords.x, coords.y];
            } else {
                isDraggingShape = true;
                [startX, startY] = [coords.x, coords.y];
            }
        }

        function handleCanvasMouseMove(e) {
            if (isDrawing && currentShape === 'freehand') {
                const coords = getEventCoordinates(e);
                drawSymmetricalLines(lastX, lastY, coords.x, coords.y);
                [lastX, lastY] = [coords.x, coords.y];
            } else if (isDraggingShape) {
                drawPreview(e);
            }
        }
        
        function handleCanvasMouseUp(e) {
            if (isDrawing) {
                isDrawing = false;
                ctx.beginPath();
                saveState();
            } else if (isDraggingShape) {
                isDraggingShape = false;
                const coords = getEventCoordinates(e);
                drawFinalShape(startX, startY, coords.x, coords.y);
                saveState();
            }
            
            redrawFromHistory();
        }
        
        function drawSymmetricalLines(x1, y1, x2, y2) {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const segments = symmetry === 0 ? 1 : symmetry;

            for (let i = 0; i < segments; i++) {
                const angle = (Math.PI * 2 / segments) * i;
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(angle);
                
                ctx.beginPath();
                ctx.moveTo(x1 - centerX, y1 - centerY);
                ctx.lineTo(x2 - centerX, y2 - centerY);
                ctx.strokeStyle = brushColor;
                ctx.lineWidth = brushSize;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.stroke();
                
                if (symmetry > 0) {
                    ctx.scale(1, -1);
                    ctx.beginPath();
                    ctx.moveTo(x1 - centerX, y1 - centerY);
                    ctx.lineTo(x2 - centerX, y2 - centerY);
                    ctx.stroke();
                }
                ctx.restore();
            }
        }

        function drawFinalShape(x1, y1, x2, y2) {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const segments = symmetry === 0 ? 1 : symmetry;

            for (let i = 0; i < segments; i++) {
                const angle = (Math.PI * 2 / segments) * i;
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(angle);
                
                drawShape(x1 - centerX, y1 - centerY, x2 - centerX, y2 - centerY);
                
                if (symmetry > 0) {
                    ctx.scale(1, -1);
                    drawShape(x1 - centerX, y1 - centerY, x2 - centerX, y2 - centerY);
                }
                ctx.restore();
            }
        }

        function drawShape(x1, y1, x2, y2, isPreview = false) {
            // 重置畫布狀態
            ctx.setLineDash([]);
            ctx.globalAlpha = 1.0;
            
            if (isPreview) {
                ctx.strokeStyle = "rgba(100, 100, 100, 0.7)";
                ctx.lineWidth = Math.max(2, brushSize / 10);
                ctx.setLineDash([8, 6]);
            } else {
                ctx.strokeStyle = brushColor;
                ctx.lineWidth = brushSize;
            }

            switch (currentShape) {
                case 'line':
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();
                    break;
                case 'freehand':
                    // 自由筆繪製 - 由drawSymmetricalLines處理
                    break;
            }
        }

        function drawPreview(e) {
            redrawFromHistory();
            const coords = getEventCoordinates(e);
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const segments = symmetry === 0 ? 1 : symmetry;

            for (let i = 0; i < segments; i++) {
                const angle = (Math.PI * 2 / segments) * i;
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(angle);
                
                drawShape(startX - centerX, startY - centerY, coords.x - centerX, coords.y - centerY, true);
                
                if (symmetry > 0) {
                    ctx.scale(1, -1);
                    drawShape(startX - centerX, startY - centerY, coords.x - centerX, coords.y - centerY, true);
                }
                ctx.restore();
            }
        }

        // --- History (Undo/Redo) Logic ---
        function saveState() {
            if (historyIndex < history.length - 1) {
                history.splice(historyIndex + 1);
            }
            history.push(canvas.toDataURL());
            historyIndex++;
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                redrawFromHistory();
            }
        }

        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                redrawFromHistory();
            }
        }
        
        function redrawFromHistory() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (history[historyIndex]) {
                const img = new Image();
                img.src = history[historyIndex];
                img.onload = () => {
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                };
            }
        }
        
        // --- Control Handlers ---
        function handleBrushSizeChange(e) {
            brushSize = parseInt(e.target.value, 10);
            // 同步桌面版和手機版的畫筆大小
            if (desktopControls.brushSize) {
                desktopControls.brushSize.value = brushSize;
            }
            if (mobileControls.brushSize) {
                mobileControls.brushSize.value = brushSize;
            }
        }

        function handleColorChange(e) {
            const button = e.target.closest('.color-btn');
            if (!button) return;
            
            brushColor = button.dataset.color;
            lastSelectedColor = brushColor;
            
            // Sync active classes across both palettes
            if (desktopControls.colorPalette) {
                desktopControls.colorPalette.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
                const desktopBtn = desktopControls.colorPalette.querySelector(`button[data-color="${brushColor}"]`);
                if (desktopBtn) desktopBtn.classList.add('active');
            }
            
            if (mobileControls.colorPalette) {
                mobileControls.colorPalette.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
                const mobileBtn = mobileControls.colorPalette.querySelector(`button[data-color="${brushColor}"]`);
                if (mobileBtn) mobileBtn.classList.add('active');
            }
            
            updateActiveTool(document.querySelector(`button[data-shape="freehand"]`));
        }

        function handleShapeChange(e) {
            const button = e.target.closest('.icon-btn[data-shape]');
            if (!button) return;
            
            currentShape = button.dataset.shape;
            updateActiveTool(button);
            
            // Reset colors and eraser state when changing shape
            brushColor = lastSelectedColor;
            if (desktopControls.eraserBtn) {
                desktopControls.eraserBtn.classList.remove('active');
            }
            if (mobileControls.eraserBtn) {
                mobileControls.eraserBtn.classList.remove('active');
            }
            
            if (desktopControls.colorPalette) {
                desktopControls.colorPalette.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
                const desktopBtn = desktopControls.colorPalette.querySelector(`button[data-color="${lastSelectedColor}"]`);
                if (desktopBtn) desktopBtn.classList.add('active');
            }
            
            if (mobileControls.colorPalette) {
                mobileControls.colorPalette.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
                const mobileBtn = mobileControls.colorPalette.querySelector(`button[data-color="${lastSelectedColor}"]`);
                if (mobileBtn) mobileBtn.classList.add('active');
            }
        }

        function handleEraserToggle() {
            const eraserIsActive = (desktopControls.eraserBtn && desktopControls.eraserBtn.classList.contains('active')) || 
                                  (mobileControls.eraserBtn && mobileControls.eraserBtn.classList.contains('active'));
            
            if (eraserIsActive) {
                // Deactivate eraser: revert to last selected color and freehand mode
                brushColor = lastSelectedColor;
                currentShape = 'freehand';
                updateActiveTool(document.querySelector(`button[data-shape="freehand"]`));
                if (desktopControls.colorPalette) {
                    const desktopBtn = desktopControls.colorPalette.querySelector(`button[data-color="${brushColor}"]`);
                    if (desktopBtn) desktopBtn.classList.add('active');
                }
                if (mobileControls.colorPalette) {
                    const mobileBtn = mobileControls.colorPalette.querySelector(`button[data-color="${brushColor}"]`);
                    if (mobileBtn) mobileBtn.classList.add('active');
                }
            } else {
                // Activate eraser: set color to white and mark as active
                brushColor = '#ffffff';
                currentShape = 'freehand';
                updateActiveTool(desktopControls.eraserBtn || mobileControls.eraserBtn);
                if (desktopControls.colorPalette) {
                    desktopControls.colorPalette.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
                }
                if (mobileControls.colorPalette) {
                    mobileControls.colorPalette.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
                }
            }
        }
        
        function updateActiveTool(activeButton) {
            // Remove 'active' from all shape and eraser buttons on both toolbars
            if (desktopControls.shapeTools) {
                desktopControls.shapeTools.querySelectorAll('.icon-btn').forEach(btn => btn.classList.remove('active'));
            }
            if (mobileControls.shapeTools) {
                mobileControls.shapeTools.querySelectorAll('.icon-btn').forEach(btn => btn.classList.remove('active'));
            }
            if (desktopControls.eraserBtn) {
                desktopControls.eraserBtn.classList.remove('active');
            }
            if (mobileControls.eraserBtn) {
                mobileControls.eraserBtn.classList.remove('active');
            }
            
            // Add 'active' to the corresponding buttons
            if (activeButton && activeButton.dataset && activeButton.dataset.shape) {
                const shape = activeButton.dataset.shape;
                if (desktopControls.shapeTools) {
                    const desktopBtn = desktopControls.shapeTools.querySelector(`[data-shape="${shape}"]`);
                    if (desktopBtn) desktopBtn.classList.add('active');
                }
                if (mobileControls.shapeTools) {
                    const mobileBtn = mobileControls.shapeTools.querySelector(`[data-shape="${shape}"]`);
                    if (mobileBtn) mobileBtn.classList.add('active');
                }
            } else if (activeButton && (activeButton.id === 'eraser-btn' || activeButton.id === 'eraser-btn-mobile')) {
                // This is an eraser button
                if (desktopControls.eraserBtn) {
                    desktopControls.eraserBtn.classList.add('active');
                }
                if (mobileControls.eraserBtn) {
                    mobileControls.eraserBtn.classList.add('active');
                }
            }
        }

        function handleSymmetryChange(e) {
            symmetry = parseInt(e.target.value, 10);
            if (desktopControls.symmetrySelect) {
                desktopControls.symmetrySelect.value = symmetry;
            }
            if (mobileControls.symmetrySelect) {
                mobileControls.symmetrySelect.value = symmetry;
            }
        }

        function saveCanvas() {
            const link = document.createElement('a');
            link.download = 'mandala.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        // --- Event Listeners ---
        canvas.addEventListener('mousedown', handleCanvasMouseDown);
        canvas.addEventListener('mousemove', handleCanvasMouseMove);
        canvas.addEventListener('mouseup', handleCanvasMouseUp);
        canvas.addEventListener('mouseleave', () => {
            if (isDrawing || isDraggingShape) {
                isDrawing = false;
                isDraggingShape = false;
                redrawFromHistory();
            }
        });
        canvas.addEventListener('touchstart', handleCanvasMouseDown, { passive: false });
        canvas.addEventListener('touchmove', handleCanvasMouseMove, { passive: false });
        canvas.addEventListener('touchend', handleCanvasMouseUp);
        
        window.addEventListener('resize', resizeCanvas);

        // Desktop controls listeners
        if (desktopControls.brushSize) {
            desktopControls.brushSize.addEventListener('input', handleBrushSizeChange);
        }
        if (desktopControls.colorPalette) {
            desktopControls.colorPalette.addEventListener('click', handleColorChange);
        }
        if (desktopControls.shapeTools) {
            desktopControls.shapeTools.addEventListener('click', handleShapeChange);
        }
        if (desktopControls.eraserBtn) {
            desktopControls.eraserBtn.addEventListener('click', handleEraserToggle);
        }
        if (desktopControls.symmetrySelect) {
            desktopControls.symmetrySelect.addEventListener('change', handleSymmetryChange);
        }
        if (desktopControls.undoBtn) {
            desktopControls.undoBtn.addEventListener('click', undo);
        }
        if (desktopControls.redoBtn) {
            desktopControls.redoBtn.addEventListener('click', redo);
        }
        if (desktopControls.clearBtn) {
            desktopControls.clearBtn.addEventListener('click', () => clearCanvas(true));
        }
        if (desktopControls.saveBtn) {
            desktopControls.saveBtn.addEventListener('click', saveCanvas);
        }

        // Mobile controls listeners
        if (mobileControls.brushSize) {
            mobileControls.brushSize.addEventListener('input', handleBrushSizeChange);
        }
        if (mobileControls.colorPalette) {
            mobileControls.colorPalette.addEventListener('click', handleColorChange);
        }
        if (mobileControls.shapeTools) {
            mobileControls.shapeTools.addEventListener('click', handleShapeChange);
        }
        if (mobileControls.eraserBtn) {
            mobileControls.eraserBtn.addEventListener('click', handleEraserToggle);
        }
        if (mobileControls.symmetrySelect) {
            mobileControls.symmetrySelect.addEventListener('change', handleSymmetryChange);
        }
        if (mobileControls.undoBtn) {
            mobileControls.undoBtn.addEventListener('click', undo);
        }
        if (mobileControls.redoBtn) {
            mobileControls.redoBtn.addEventListener('click', redo);
        }
        if (mobileControls.clearBtn) {
            mobileControls.clearBtn.addEventListener('click', () => clearCanvas(true));
        }
        if (mobileControls.saveBtn) {
            mobileControls.saveBtn.addEventListener('click', saveCanvas);
        }

        // Mobile sidebar listeners
        hamburgerBtn.addEventListener('click', function() {
            sidebarNav.classList.toggle('show');
        });
        
        sidebarClose.addEventListener('click', function() {
            sidebarNav.classList.remove('show');
        });
        
        // --- Initialization ---
        initializeCanvas();
    });
</script>
</body>
</html>