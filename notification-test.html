<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>通知功能測試</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#00aaff" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="通知測試" />
  <meta name="mobile-web-app-capable" content="yes" />
  
  <!-- Manifest -->
  <link rel="manifest" href="/manifest.json" />
  
  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="/icons/icon-152x152.png" />
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192x192.png" />
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', Arial, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: #ffffff;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    h1 {
      text-align: center;
      color: #00aaff;
      margin-bottom: 30px;
      font-size: 2em;
    }
    
    .status-card {
      background: rgba(0, 170, 255, 0.1);
      border: 1px solid rgba(0, 170, 255, 0.3);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }
    
    .status-label {
      font-weight: bold;
      color: #e0e0e0;
    }
    
    .status-value {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: bold;
    }
    
    .status-success {
      background: rgba(76, 175, 80, 0.2);
      color: #4caf50;
      border: 1px solid rgba(76, 175, 80, 0.3);
    }
    
    .status-error {
      background: rgba(244, 67, 54, 0.2);
      color: #f44336;
      border: 1px solid rgba(244, 67, 54, 0.3);
    }
    
    .status-warning {
      background: rgba(255, 152, 0, 0.2);
      color: #ff9800;
      border: 1px solid rgba(255, 152, 0, 0.3);
    }
    
    .test-buttons {
      display: grid;
      gap: 15px;
      margin-top: 30px;
    }
    
    .test-btn {
      background: linear-gradient(45deg, #00aaff, #0088cc);
      color: white;
      border: none;
      padding: 15px 25px;
      border-radius: 12px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 170, 255, 0.3);
    }
    
    .test-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 170, 255, 0.4);
    }
    
    .test-btn:active {
      transform: translateY(0);
    }
    
    .test-btn:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .back-btn {
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 12px 20px;
      border-radius: 8px;
      text-decoration: none;
      display: inline-block;
      margin-top: 20px;
      transition: all 0.3s ease;
    }
    
    .back-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .log {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.9em;
    }
    
    .log-entry {
      margin-bottom: 5px;
      padding: 5px;
      border-radius: 4px;
    }
    
    .log-info {
      background: rgba(0, 170, 255, 0.1);
      color: #00aaff;
    }
    
    .log-success {
      background: rgba(76, 175, 80, 0.1);
      color: #4caf50;
    }
    
    .log-error {
      background: rgba(244, 67, 54, 0.1);
      color: #f44336;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔔 通知功能測試</h1>
    
    <div class="status-card">
      <h3>系統狀態檢查</h3>
      <div class="status-item">
        <span class="status-label">Service Worker 支援</span>
        <span class="status-value" id="sw-support">檢查中...</span>
      </div>
      <div class="status-item">
        <span class="status-label">推送通知支援</span>
        <span class="status-value" id="push-support">檢查中...</span>
      </div>
      <div class="status-item">
        <span class="status-label">通知權限</span>
        <span class="status-value" id="notification-permission">檢查中...</span>
      </div>
      <div class="status-item">
        <span class="status-label">PWA 安裝狀態</span>
        <span class="status-value" id="pwa-status">檢查中...</span>
      </div>
    </div>
    
    <div class="test-buttons">
      <button class="test-btn" id="request-permission">請求通知權限</button>
      <button class="test-btn" id="test-notification">測試基本通知</button>
      <button class="test-btn" id="test-sw-notification">測試 Service Worker 通知</button>
      <button class="test-btn" id="test-reminder">測試冥想提醒</button>
      <button class="test-btn" id="clear-log">清除日誌</button>
    </div>
    
    <div class="log" id="log">
      <div class="log-entry log-info">系統初始化中...</div>
    </div>
    
    <a href="/meditation.html" class="back-btn">← 返回冥想頁面</a>
  </div>
  
  <script>
    // 日誌功能
    function addLog(message, type = 'info') {
      const log = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
    }
    
    // 更新狀態顯示
    function updateStatus(elementId, status, type = 'success') {
      const element = document.getElementById(elementId);
      element.textContent = status;
      element.className = `status-value status-${type}`;
    }
    
    // 檢查系統狀態
    function checkSystemStatus() {
      addLog('開始檢查系統狀態...');
      
      // 檢查 Service Worker 支援
      if ('serviceWorker' in navigator) {
        updateStatus('sw-support', '支援', 'success');
        addLog('Service Worker 支援已啟用', 'success');
      } else {
        updateStatus('sw-support', '不支援', 'error');
        addLog('Service Worker 不支援', 'error');
      }
      
      // 檢查推送通知支援
      if ('PushManager' in window) {
        updateStatus('push-support', '支援', 'success');
        addLog('推送通知支援已啟用', 'success');
      } else {
        updateStatus('push-support', '不支援', 'error');
        addLog('推送通知不支援', 'error');
      }
      
      // 檢查通知權限
      if ('Notification' in window) {
        const permission = Notification.permission;
        if (permission === 'granted') {
          updateStatus('notification-permission', '已授權', 'success');
          addLog('通知權限已授權', 'success');
        } else if (permission === 'denied') {
          updateStatus('notification-permission', '已拒絕', 'error');
          addLog('通知權限已被拒絕', 'error');
        } else {
          updateStatus('notification-permission', '未設定', 'warning');
          addLog('通知權限未設定', 'warning');
        }
      } else {
        updateStatus('notification-permission', '不支援', 'error');
        addLog('通知功能不支援', 'error');
      }
      
      // 檢查 PWA 狀態
      if (window.matchMedia('(display-mode: standalone)').matches) {
        updateStatus('pwa-status', '已安裝', 'success');
        addLog('PWA 已安裝', 'success');
      } else {
        updateStatus('pwa-status', '未安裝', 'warning');
        addLog('PWA 未安裝', 'warning');
      }
    }
    
    // 註冊 Service Worker
    async function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.register('/service-worker.js');
          addLog('Service Worker 註冊成功', 'success');
          return registration;
        } catch (error) {
          addLog(`Service Worker 註冊失敗: ${error.message}`, 'error');
          return null;
        }
      }
      return null;
    }
    
    // 請求通知權限
    async function requestNotificationPermission() {
      if ('Notification' in window) {
        try {
          const permission = await Notification.requestPermission();
          if (permission === 'granted') {
            addLog('通知權限已獲得', 'success');
            updateStatus('notification-permission', '已授權', 'success');
          } else {
            addLog('通知權限被拒絕', 'error');
            updateStatus('notification-permission', '已拒絕', 'error');
          }
        } catch (error) {
          addLog(`請求權限失敗: ${error.message}`, 'error');
        }
      } else {
        addLog('通知功能不支援', 'error');
      }
    }
    
    // 測試基本通知
    function testBasicNotification() {
      if ('Notification' in window && Notification.permission === 'granted') {
        try {
          new Notification('基本通知測試', {
            body: '這是一個基本通知測試',
            icon: '/favicon.ico'
          });
          addLog('基本通知已發送', 'success');
        } catch (error) {
          addLog(`基本通知失敗: ${error.message}`, 'error');
        }
      } else {
        addLog('無法發送基本通知，請先授權', 'error');
      }
    }
    
    // 測試 Service Worker 通知
    async function testServiceWorkerNotification() {
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.ready;
          await registration.showNotification('Service Worker 通知測試', {
            body: '這是一個 Service Worker 通知測試',
            icon: '/favicon.ico',
            badge: '/favicon.ico',
            tag: 'test-notification',
            requireInteraction: true,
            actions: [
              {
                action: 'open',
                title: '開啟應用',
                icon: '/favicon.ico'
              }
            ],
            data: {
              url: window.location.href,
              timestamp: Date.now()
            }
          });
          addLog('Service Worker 通知已發送', 'success');
        } catch (error) {
          addLog(`Service Worker 通知失敗: ${error.message}`, 'error');
        }
      } else {
        addLog('Service Worker 不支援', 'error');
      }
    }
    
    // 測試冥想提醒
    async function testReminder() {
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.ready;
          await registration.showNotification('冥想提醒測試', {
            body: '該是冥想的時候了！讓我們一起靜心，感受內在的寧靜。',
            icon: '/favicon.ico',
            badge: '/favicon.ico',
            tag: 'meditation-reminder',
            requireInteraction: true,
            actions: [
              {
                action: 'open',
                title: '開始冥想',
                icon: '/favicon.ico'
              },
              {
                action: 'snooze',
                title: '稍後提醒',
                icon: '/favicon.ico'
              }
            ],
            data: {
              url: '/meditation.html',
              timestamp: Date.now()
            }
          });
          addLog('冥想提醒測試已發送', 'success');
        } catch (error) {
          addLog(`冥想提醒測試失敗: ${error.message}`, 'error');
        }
      } else {
        addLog('Service Worker 不支援', 'error');
      }
    }
    
    // 清除日誌
    function clearLog() {
      const log = document.getElementById('log');
      log.innerHTML = '<div class="log-entry log-info">日誌已清除</div>';
    }
    
    // 事件監聽器
    document.addEventListener('DOMContentLoaded', async () => {
      addLog('頁面載入完成');
      
      // 檢查系統狀態
      checkSystemStatus();
      
      // 註冊 Service Worker
      await registerServiceWorker();
      
      // 綁定按鈕事件
      document.getElementById('request-permission').addEventListener('click', requestNotificationPermission);
      document.getElementById('test-notification').addEventListener('click', testBasicNotification);
      document.getElementById('test-sw-notification').addEventListener('click', testServiceWorkerNotification);
      document.getElementById('test-reminder').addEventListener('click', testReminder);
      document.getElementById('clear-log').addEventListener('click', clearLog);
      
      addLog('初始化完成', 'success');
    });
  </script>
</body>
</html>
