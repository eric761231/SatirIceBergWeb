<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>安裝冥想音樂應用程式</title>
  <link rel="manifest" href="../manifest.json">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="../icons/icon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../icons/icon-16x16.png">
  <style>
    :root {
      --bg-primary: #131314;
      --bg-secondary: #1e1f20;
      --accent-cyan: #00aaff;
      --text-primary: #e8eaed;
      --text-secondary: #9aa0a6;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', Arial, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      color: var(--accent-cyan);
      font-size: 28px;
      margin-bottom: 10px;
    }
    
    .header p {
      color: var(--text-secondary);
      font-size: 16px;
    }
    
    .install-steps {
      margin-bottom: 30px;
    }
    
    .step {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid var(--accent-cyan);
    }
    
    .step h3 {
      color: var(--accent-cyan);
      margin-bottom: 10px;
      font-size: 18px;
    }
    
    .step p {
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 15px;
    }
    
    .step img {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 10px;
    }
    
    .step ol {
      color: var(--text-secondary);
      padding-left: 20px;
    }
    
    .step ol li {
      margin-bottom: 8px;
      line-height: 1.5;
    }
    
    .device-specific {
      background: rgba(0,170,255,0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .device-specific h3 {
      color: var(--accent-cyan);
      margin-bottom: 15px;
      text-align: center;
    }
    
    .device-tabs {
      display: flex;
      margin-bottom: 20px;
      border-radius: 8px;
      overflow: hidden;
      background: var(--bg-primary);
    }
    
    .device-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      background: transparent;
      color: var(--text-secondary);
    }
    
    .device-tab.active {
      background: var(--accent-cyan);
      color: var(--bg-primary);
    }
    
    .device-content {
      display: none;
    }
    
    .device-content.active {
      display: block;
    }
    
    .benefits {
      background: rgba(76, 175, 80, 0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .benefits h3 {
      color: #4caf50;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .benefit-list {
      list-style: none;
    }
    
    .benefit-list li {
      padding: 8px 0;
      color: var(--text-secondary);
      position: relative;
      padding-left: 25px;
    }
    
    .benefit-list li::before {
      content: '✓';
      position: absolute;
      left: 0;
      color: #4caf50;
      font-weight: bold;
    }
    
    .back-btn {
      display: inline-block;
      background: var(--accent-cyan);
      color: var(--bg-primary);
      padding: 12px 24px;
      border-radius: 25px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }
    
    .back-btn:hover {
      background: #0099e6;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,170,255,0.3);
    }
    
    .install-btn {
      display: inline-block;
      background: #4caf50;
      color: white;
      padding: 15px 30px;
      border-radius: 25px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      font-size: 18px;
      margin-left: 15px;
    }
    
    .install-btn:hover:not(:disabled) {
      background: #45a049;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(76,175,80,0.3);
    }
    
    .install-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }
    
    .cache-btn {
      background: #ff9800;
      margin-left: 10px;
    }
    
    .cache-btn:hover:not(:disabled) {
      background: #e68900;
    }
    
    .actions {
      text-align: center;
      margin-top: 30px;
    }
    
    .debug-info {
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 12px;
      color: var(--text-secondary);
      display: none;
    }
    
    .debug-info.show {
      display: block;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 20px;
        margin: 10px;
      }
      
      .header h1 {
        font-size: 24px;
      }
      
      .device-tabs {
        flex-direction: column;
      }
      
      .actions {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      
      .back-btn, .install-btn, .cache-btn {
        margin: 0;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>📱 安裝冥想音樂應用程式</h1>
      <p>將應用程式安裝到手機主頁面，享受更好的使用體驗</p>
    </div>
    
    <div class="install-steps">
      <div class="step">
        <h3>🎯 為什麼要安裝應用程式？</h3>
        <p>安裝後，您可以：</p>
        <ul class="benefit-list">
          <li>在手機主頁面直接開啟應用程式</li>
          <li>接收冥想提醒通知，即使應用程式未開啟</li>
          <li>享受離線播放功能</li>
          <li>獲得原生應用程式般的體驗</li>
        </ul>
      </div>
    </div>
    
    <div class="device-specific">
      <h3>📱 安裝說明</h3>
      
      <div class="device-tabs">
        <button class="device-tab active" data-device="android">Android</button>
        <button class="device-tab" data-device="ios">iOS</button>
        <button class="device-tab" data-device="desktop">桌面版</button>
      </div>
      
      <div id="android" class="device-content active">
        <h4>Android 手機安裝步驟：</h4>
        <ol>
          <li>使用 Chrome 瀏覽器開啟冥想音樂頁面</li>
          <li>點擊瀏覽器選單（三個點）</li>
          <li>選擇「安裝應用程式」或「加入主畫面」</li>
          <li>點擊「安裝」確認</li>
          <li>應用程式將出現在主頁面上</li>
        </ol>
      </div>
      
      <div id="ios" class="device-content">
        <h4>iPhone/iPad 安裝步驟：</h4>
        <ol>
          <li>使用 Safari 瀏覽器開啟冥想音樂頁面</li>
          <li>點擊底部的「分享」按鈕</li>
          <li>選擇「加入主畫面」</li>
          <li>點擊「加入」確認</li>
          <li>應用程式將出現在主頁面上</li>
        </ol>
      </div>
      
      <div id="desktop" class="device-content">
        <h4>桌面版安裝步驟：</h4>
        <ol>
          <li>使用支援 PWA 的瀏覽器（Chrome、Edge、Firefox）</li>
          <li>在網址列右側會出現安裝圖標</li>
          <li>點擊安裝圖標</li>
          <li>選擇「安裝」確認</li>
          <li>應用程式將出現在開始選單和桌面</li>
        </ol>
      </div>
    </div>
    
    <div class="benefits">
      <h3>✨ 安裝後的功能</h3>
      <ul class="benefit-list">
        <li>手機主頁面直接開啟</li>
        <li>背景推送通知提醒</li>
        <li>離線音樂播放</li>
        <li>全螢幕沉浸體驗</li>
        <li>快速存取播放清單</li>
        <li>自動更新和同步</li>
      </ul>
    </div>
    
    <div class="actions">
      <a href="../meditation.html" class="back-btn">返回音樂播放器</a>
      <button class="install-btn" onclick="installApp()">立即安裝</button>
      <button class="install-btn cache-btn" onclick="clearCacheAndReload()">清除快取</button>
    </div>
    
    <div class="debug-info" id="debugInfo">
      <h4>調試信息：</h4>
      <div id="debugContent"></div>
    </div>
  </div>
  
  <script>
    // 全域變數
    let deferredPrompt = null;
    let isInstallable = false;
    
    // 調試函數
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const prefix = type === 'error' ? '❌' : type === 'warning' ? '⚠️' : type === 'success' ? '✅' : '🔍';
      console.log(`${prefix} [${timestamp}] ${message}`);
      
      // 更新調試信息顯示
      const debugContent = document.getElementById('debugContent');
      if (debugContent) {
        debugContent.innerHTML += `<div>${prefix} [${timestamp}] ${message}</div>`;
        debugContent.scrollTop = debugContent.scrollHeight;
      }
    }
    
    // 切換調試信息顯示
    function toggleDebugInfo() {
      const debugInfo = document.getElementById('debugInfo');
      debugInfo.classList.toggle('show');
    }
    
    // 監聽 beforeinstallprompt 事件
    window.addEventListener('beforeinstallprompt', (e) => {
      log('beforeinstallprompt 事件觸發！');
      
      // 阻止瀏覽器預設的安裝提示
      e.preventDefault();
      // 儲存事件以便稍後使用
      deferredPrompt = e;
      isInstallable = true;
      
      log('安裝提示已準備就緒', 'success');
      
      // 更新安裝按鈕
      updateInstallButton('立即安裝', false, '#4caf50');
    });
    
    // 監聽 appinstalled 事件
    window.addEventListener('appinstalled', (evt) => {
      log('應用程式已安裝！', 'success');
      showNotification('🎉 應用程式安裝成功！', 'success');
      
      updateInstallButton('已安裝', true, '#4caf50');
      deferredPrompt = null;
      isInstallable = false;
    });
    
    // 顯示通知函數
    function showNotification(message, type = 'info') {
      // 簡單的通知實現
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3'};
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        max-width: 300px;
        font-size: 14px;
        animation: slideIn 0.3s ease-out;
      `;
      
      // 添加動畫樣式
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
      `;
      document.head.appendChild(style);
      
      notification.textContent = message;
      document.body.appendChild(notification);
      
      // 3秒後自動移除
      setTimeout(() => {
        notification.remove();
        style.remove();
      }, 3000);
    }
    
    // 檢查 PWA 安裝條件
    async function checkPWAInstallability() {
      log('檢查 PWA 安裝條件...');
      
      // 檢測設備類型
      const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const isAndroid = /Android/i.test(navigator.userAgent);
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      
      log(`設備類型: ${isMobile ? '手機' : '桌面'}`);
      if (isMobile) {
        log(`手機類型: ${isAndroid ? 'Android' : isIOS ? 'iOS' : '其他'}`);
      }
      
      const checks = {
        serviceWorker: 'serviceWorker' in navigator,
        manifest: !!document.querySelector('link[rel="manifest"]'),
        https: location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1',
        manifestAccessible: false, // 預設為 false
        userAgent: navigator.userAgent,
        isMobile: isMobile
      };
      
      log(`Service Worker 支援: ${checks.serviceWorker}`);
      log(`Manifest 存在: ${checks.manifest}`);
      log(`HTTPS/Localhost: ${checks.https}`);
      
      // 檢查 manifest 文件是否可訪問
      if (checks.manifest) {
        try {
          const manifestLink = document.querySelector('link[rel="manifest"]');
          const response = await fetch(manifestLink.href);
          if (response.ok) {
            const manifest = await response.json();
            log('Manifest 文件可訪問', 'success');
            checks.manifestAccessible = true;
            
            // 檢查 manifest 的關鍵屬性
            const requiredFields = ['name', 'short_name', 'start_url', 'display', 'icons'];
            const missingFields = requiredFields.filter(field => !manifest[field]);
            
            if (missingFields.length > 0) {
              log(`Manifest 缺少必要欄位: ${missingFields.join(', ')}`, 'error');
            } else {
              log('Manifest 格式正確', 'success');
            }
            
            // 檢查圖標
            if (manifest.icons && manifest.icons.length > 0) {
              const hasRequiredSizes = manifest.icons.some(icon => 
                ['192x192', '512x512'].includes(icon.sizes)
              );
              if (hasRequiredSizes) {
                log('Manifest 包含必要圖標尺寸', 'success');
              } else {
                log('Manifest 缺少必要圖標尺寸 (192x192, 512x512)', 'error');
              }
            }
            
          } else {
            log(`Manifest 文件無法訪問: ${response.status}`, 'error');
            checks.manifestAccessible = false;
          }
        } catch (error) {
          log(`Manifest 文件載入失敗: ${error.message}`, 'error');
          checks.manifestAccessible = false;
        }
      } else {
        log('Manifest 連結不存在', 'error');
      }
      
      // 手機特殊檢查
      if (isMobile) {
        if (!checks.https && !location.hostname.includes('localhost')) {
          log('⚠️ 手機上需要 HTTPS 才能安裝 PWA', 'warning');
        }
        
        if (isAndroid) {
          log('Android 設備建議使用 Chrome 瀏覽器', 'info');
        } else if (isIOS) {
          log('iOS 設備必須使用 Safari 瀏覽器', 'info');
        }
      }
      
      // 詳細記錄每個檢查結果
      log(`檢查結果詳情:`, 'info');
      log(`- Service Worker: ${checks.serviceWorker}`, checks.serviceWorker ? 'success' : 'error');
      log(`- Manifest 連結: ${checks.manifest}`, checks.manifest ? 'success' : 'error');
      log(`- Manifest 可訪問: ${checks.manifestAccessible}`, checks.manifestAccessible ? 'success' : 'error');
      log(`- HTTPS/Localhost: ${checks.https}`, checks.https ? 'success' : 'error');
      
      const allChecksPass = Object.values(checks).every(check => 
        typeof check === 'boolean' ? check : true
      );
      log(`PWA 安裝條件檢查結果: ${allChecksPass ? '通過' : '失敗'}`, allChecksPass ? 'success' : 'error');
      
      return allChecksPass;
    }
    
    // 更新安裝按鈕狀態
    function updateInstallButton(text, disabled, backgroundColor) {
      const installBtn = document.querySelector('.install-btn:not(.cache-btn)');
      if (installBtn) {
        installBtn.textContent = text;
        installBtn.disabled = disabled;
        if (backgroundColor) {
          installBtn.style.background = backgroundColor;
        }
        log(`安裝按鈕狀態更新: ${text}, 禁用: ${disabled}`);
      }
    }
    
    // 清除快取和重新載入
    async function clearCacheAndReload() {
      try {
        log('開始清除快取...');
        
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = '清除中...';
        button.disabled = true;
        
        // 清除所有快取
        if ('caches' in window) {
          const cacheNames = await caches.keys();
          await Promise.all(
            cacheNames.map(cacheName => caches.delete(cacheName))
          );
          log('快取已清除', 'success');
        }
        
        // 取消註冊所有 Service Worker
        if ('serviceWorker' in navigator) {
          const registrations = await navigator.serviceWorker.getRegistrations();
          await Promise.all(
            registrations.map(registration => registration.unregister())
          );
          log('Service Worker 已取消註冊', 'success');
        }
        
        showNotification('快取已清除，即將重新載入頁面...', 'success');
        
        // 延遲重新載入以顯示通知
        setTimeout(() => {
          window.location.reload(true);
        }, 1500);
        
      } catch (error) {
        log(`清除快取失敗: ${error.message}`, 'error');
        showNotification('清除快取失敗，請手動重新整理頁面', 'error');
        
        // 恢復按鈕狀態
        const button = event.target;
        button.textContent = '清除快取';
        button.disabled = false;
      }
    }
    
    // 裝置標籤切換
    function showDevice(device) {
      // 隱藏所有內容
      document.querySelectorAll('.device-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // 移除所有標籤的活動狀態
      document.querySelectorAll('.device-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // 顯示選中的內容
      const targetContent = document.getElementById(device);
      if (targetContent) {
        targetContent.classList.add('active');
      }
      
      // 設置選中標籤的活動狀態
      const clickedTab = document.querySelector(`[data-device="${device}"]`);
      if (clickedTab) {
        clickedTab.classList.add('active');
      }
      
      log(`切換到 ${device} 裝置說明`);
    }
    
    // 顯示手動安裝指導
    function showManualInstallGuide() {
      const isAndroid = /Android/i.test(navigator.userAgent);
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isChrome = /Chrome/i.test(navigator.userAgent);
      const isSafari = /Safari/i.test(navigator.userAgent) && !/Chrome/i.test(navigator.userAgent);
      const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      let message = '';
      
      if (isAndroid && isChrome) {
        message = `📱 Android Chrome 安裝步驟：
 
 1️⃣ 點擊瀏覽器右上角的「⋮」選單
 2️⃣ 尋找「安裝應用程式」或「加入主畫面」
 3️⃣ 點擊該選項並確認安裝
 4️⃣ 應用程式將出現在主頁面
 
 💡 如果看不到安裝選項：
 • 確保使用最新版 Chrome
 • 重新整理頁面後再試
 • 檢查是否已安裝過此應用`;
      } else if (isAndroid && !isChrome) {
        message = `📱 Android 其他瀏覽器安裝步驟：
 
 1️⃣ 點擊瀏覽器選單（三個點或三條線）
 2️⃣ 尋找「加入主畫面」或「安裝應用程式」
 3️⃣ 點擊該選項並確認安裝
 
 💡 建議使用 Chrome 瀏覽器以獲得最佳體驗`;
      } else if (isIOS && isSafari) {
        message = `📱 iPhone/iPad Safari 安裝步驟：
 
 1️⃣ 點擊底部的「分享」按鈕 📤
 2️⃣ 向下滑動找到「加入主畫面」
 3️⃣ 點擊「加入主畫面」
 4️⃣ 點擊右上角「加入」確認
 
 💡 注意：必須使用 Safari 瀏覽器`;
      } else if (isIOS && !isSafari) {
        message = `📱 iPhone/iPad 其他瀏覽器：
 
 ⚠️ iOS 設備只能使用 Safari 瀏覽器安裝 PWA
 
 請切換到 Safari 瀏覽器，然後：
 1️⃣ 點擊底部的「分享」按鈕
 2️⃣ 選擇「加入主畫面」`;
      } else if (!isMobile) {
        message = `💻 桌面版安裝步驟：
 
 1️⃣ 查看網址列右側的安裝圖標
 2️⃣ 點擊安裝圖標
 3️⃣ 在彈出視窗中點擊「安裝」
 4️⃣ 應用程式將出現在系統中
 
 💡 支援的瀏覽器：Chrome、Edge、Firefox`;
      } else {
        message = `📱 手動安裝步驟：
 
 請根據您的裝置選擇相應的安裝方法：
 
 Android: 使用 Chrome 瀏覽器，點選選單中的「安裝應用程式」
 iPhone: 使用 Safari 瀏覽器，點選分享按鈕中的「加入主畫面」
 桌面版: 點擊網址列旁的安裝圖標
 
 如仍有問題，請嘗試重新整理頁面或清除快取`;
      }
      
      // 添加手機特定的額外提示
      if (isMobile) {
        message += `\n\n🔧 手機安裝常見問題：
 • 確保網路連線穩定
 • 清除瀏覽器快取後重試
 • 檢查瀏覽器是否為最新版本
 • 某些瀏覽器可能不支援 PWA 安裝`;
      }
      
      showNotification(message, 'info');
    }
    
    // 主要安裝函數
    async function installApp() {
      log('安裝按鈕被點擊');
      
      try {
        // 檢查是否已經安裝
        if (window.matchMedia('(display-mode: standalone)').matches) {
          showNotification('✅ 應用程式已經安裝！', 'success');
          updateInstallButton('已安裝', true, '#4caf50');
          return;
        }
        
        // 如果有 deferredPrompt，使用它
        if (deferredPrompt && isInstallable) {
          log('使用 beforeinstallprompt 觸發安裝');
          
          // 顯示安裝提示
          deferredPrompt.prompt();
          
          // 等待用戶選擇
          const { outcome } = await deferredPrompt.userChoice;
          log(`用戶選擇: ${outcome}`);
          
          if (outcome === 'accepted') {
            log('用戶接受安裝', 'success');
            showNotification('🎉 安裝成功！', 'success');
            updateInstallButton('已安裝', true, '#4caf50');
          } else {
            log('用戶拒絕安裝', 'warning');
            showNotification('安裝被取消', 'warning');
          }
          
          // 清除 deferredPrompt
          deferredPrompt = null;
          isInstallable = false;
          return;
        }
        
        // 如果沒有 deferredPrompt，嘗試手機特定的方法
        log('沒有自動安裝提示可用，嘗試手機特定方法', 'warning');
        
        const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile) {
          // 手機上嘗試強制觸發安裝提示
          log('嘗試手機特定的安裝方法...');
          
          // 嘗試訪問主頁面來觸發 beforeinstallprompt
          try {
            const response = await fetch('/meditation.html');
            if (response.ok) {
              log('主頁面可訪問，嘗試觸發安裝提示', 'success');
              
              // 等待一下看是否觸發了 beforeinstallprompt
              await new Promise(resolve => setTimeout(resolve, 2000));
              
              if (deferredPrompt && isInstallable) {
                log('成功觸發 beforeinstallprompt！', 'success');
                updateInstallButton('立即安裝', false, '#4caf50');
                
                // 立即觸發安裝提示
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                  log('用戶接受安裝', 'success');
                  showNotification('🎉 安裝成功！', 'success');
                  updateInstallButton('已安裝', true, '#4caf50');
                } else {
                  log('用戶拒絕安裝', 'warning');
                  showNotification('安裝被取消', 'warning');
                }
                
                deferredPrompt = null;
                isInstallable = false;
                return;
              }
            }
          } catch (error) {
            log(`主頁面訪問失敗: ${error.message}`, 'error');
          }
          
          // 如果還是沒有觸發，嘗試在新視窗中打開
          log('嘗試在新視窗中打開主頁面...');
          const newWindow = window.open('/meditation.html', '_blank');
          
          if (newWindow) {
            showNotification('📱 已在新視窗中打開主頁面，請在新視窗中查看安裝提示！', 'info');
          } else {
            log('無法打開新視窗，顯示手動安裝指導', 'warning');
            showManualInstallGuide();
          }
        } else {
          // 桌面版顯示手動安裝指導
          showManualInstallGuide();
        }
        
      } catch (error) {
        log(`安裝過程發生錯誤: ${error.message}`, 'error');
        showNotification('❌ 安裝過程發生錯誤，請按照頁面說明手動安裝', 'error');
        showManualInstallGuide();
      }
    }
    
    // 註冊 Service Worker
    async function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        try {
          log('開始註冊 Service Worker...');
          const registration = await navigator.serviceWorker.register('../service-worker.js', {
            scope: '/'
          });
          
          log('Service Worker 註冊成功', 'success');
          
          // 等待 Service Worker 啟動
          if (registration.installing) {
            log('Service Worker 安裝中...');
            await new Promise(resolve => {
              registration.installing.addEventListener('statechange', (e) => {
                if (e.target.state === 'activated') {
                  log('Service Worker 已啟動', 'success');
                  resolve();
                }
              });
            });
          }
          
          return registration;
        } catch (error) {
          log(`Service Worker 註冊失敗: ${error.message}`, 'error');
          return null;
        }
      } else {
        log('此瀏覽器不支援 Service Worker', 'warning');
        return null;
      }
    }
    
    // 頁面載入時的初始化
    document.addEventListener('DOMContentLoaded', async () => {
      log('頁面已載入，開始初始化...');
      
      // 設置裝置標籤點擊事件
      document.querySelectorAll('.device-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          const device = e.target.getAttribute('data-device');
          showDevice(device);
        });
      });
      
      // 添加調試信息切換（雙擊標題）
      document.querySelector('h1').addEventListener('dblclick', toggleDebugInfo);
      
      // 檢查是否已安裝
      if (window.matchMedia('(display-mode: standalone)').matches) {
        log('檢測到應用程式已安裝', 'success');
        updateInstallButton('已安裝', true, '#4caf50');
        return;
      }
      
       // 檢查 PWA 安裝條件
       let canInstall = await checkPWAInstallability();
       
       if (!canInstall) {
         log('PWA 安裝條件不滿足，嘗試自動修復...', 'warning');
         
         // 嘗試修復 manifest 問題
         const manifestLink = document.querySelector('link[rel="manifest"]');
         if (!manifestLink) {
           log('動態添加 manifest 連結...');
           const link = document.createElement('link');
           link.rel = 'manifest';
           link.href = '../manifest.json';
           document.head.appendChild(link);
           
           // 等待一下再檢查
           await new Promise(resolve => setTimeout(resolve, 1000));
           canInstall = await checkPWAInstallability();
         }
       }
       
       if (canInstall) {
         log('PWA 安裝條件已滿足', 'success');
         
         // 註冊 Service Worker
         await registerServiceWorker();
         
         // 如果還沒有觸發 beforeinstallprompt，等待一下
         if (!isInstallable) {
           log('等待 beforeinstallprompt 事件...');
           updateInstallButton('準備中...', true, '#ff9800');
           
           // 等待最多 5 秒
           setTimeout(() => {
             if (!isInstallable) {
               log('beforeinstallprompt 事件未觸發，啟用手動安裝', 'warning');
               updateInstallButton('立即安裝', false, '#ff9800');
             }
           }, 5000);
         }
       } else {
         log('PWA 安裝條件仍然不滿足', 'error');
         updateInstallButton('立即安裝', false, '#f44336');
       }
      
      log('初始化完成');
    });
    
  </script>
</body>
</html>