<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®‰è£å†¥æƒ³éŸ³æ¨‚æ‡‰ç”¨ç¨‹å¼</title>
  <link rel="manifest" href="../manifest.json">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="../icons/icon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../icons/icon-16x16.png">
  <style>
    :root {
      --bg-primary: #131314;
      --bg-secondary: #1e1f20;
      --accent-cyan: #00aaff;
      --text-primary: #e8eaed;
      --text-secondary: #9aa0a6;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', Arial, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      color: var(--accent-cyan);
      font-size: 28px;
      margin-bottom: 10px;
    }
    
    .header p {
      color: var(--text-secondary);
      font-size: 16px;
    }
    
    .install-steps {
      margin-bottom: 30px;
    }
    
    .step {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid var(--accent-cyan);
    }
    
    .step h3 {
      color: var(--accent-cyan);
      margin-bottom: 10px;
      font-size: 18px;
    }
    
    .step p {
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 15px;
    }
    
    .step img {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 10px;
    }
    
    .step ol {
      color: var(--text-secondary);
      padding-left: 20px;
    }
    
    .step ol li {
      margin-bottom: 8px;
      line-height: 1.5;
    }
    
    .device-specific {
      background: rgba(0,170,255,0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .device-specific h3 {
      color: var(--accent-cyan);
      margin-bottom: 15px;
      text-align: center;
    }
    
    .device-tabs {
      display: flex;
      margin-bottom: 20px;
      border-radius: 8px;
      overflow: hidden;
      background: var(--bg-primary);
    }
    
    .device-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      background: transparent;
      color: var(--text-secondary);
    }
    
    .device-tab.active {
      background: var(--accent-cyan);
      color: var(--bg-primary);
    }
    
    .device-content {
      display: none;
    }
    
    .device-content.active {
      display: block;
    }
    
    .benefits {
      background: rgba(76, 175, 80, 0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .benefits h3 {
      color: #4caf50;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .benefit-list {
      list-style: none;
    }
    
    .benefit-list li {
      padding: 8px 0;
      color: var(--text-secondary);
      position: relative;
      padding-left: 25px;
    }
    
    .benefit-list li::before {
      content: 'âœ“';
      position: absolute;
      left: 0;
      color: #4caf50;
      font-weight: bold;
    }
    
    .back-btn {
      display: inline-block;
      background: var(--accent-cyan);
      color: var(--bg-primary);
      padding: 12px 24px;
      border-radius: 25px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }
    
    .back-btn:hover {
      background: #0099e6;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,170,255,0.3);
    }
    
    .install-btn {
      display: inline-block;
      background: #4caf50;
      color: white;
      padding: 15px 30px;
      border-radius: 25px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      font-size: 18px;
      margin-left: 15px;
    }
    
    .install-btn:hover:not(:disabled) {
      background: #45a049;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(76,175,80,0.3);
    }
    
    .install-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }
    
    .cache-btn {
      background: #ff9800;
      margin-left: 10px;
    }
    
    .cache-btn:hover:not(:disabled) {
      background: #e68900;
    }
    
    .actions {
      text-align: center;
      margin-top: 30px;
    }
    
    .debug-info {
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 12px;
      color: var(--text-secondary);
      display: none;
    }
    
    .debug-info.show {
      display: block;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 20px;
        margin: 10px;
      }
      
      .header h1 {
        font-size: 24px;
      }
      
      .device-tabs {
        flex-direction: column;
      }
      
      .actions {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      
      .back-btn, .install-btn, .cache-btn {
        margin: 0;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“± å®‰è£å†¥æƒ³éŸ³æ¨‚æ‡‰ç”¨ç¨‹å¼</h1>
      <p>å°‡æ‡‰ç”¨ç¨‹å¼å®‰è£åˆ°æ‰‹æ©Ÿä¸»é é¢ï¼Œäº«å—æ›´å¥½çš„ä½¿ç”¨é«”é©—</p>
    </div>
    
    <div class="install-steps">
      <div class="step">
        <h3>ğŸ¯ ç‚ºä»€éº¼è¦å®‰è£æ‡‰ç”¨ç¨‹å¼ï¼Ÿ</h3>
        <p>å®‰è£å¾Œï¼Œæ‚¨å¯ä»¥ï¼š</p>
        <ul class="benefit-list">
          <li>åœ¨æ‰‹æ©Ÿä¸»é é¢ç›´æ¥é–‹å•Ÿæ‡‰ç”¨ç¨‹å¼</li>
          <li>æ¥æ”¶å†¥æƒ³æé†’é€šçŸ¥ï¼Œå³ä½¿æ‡‰ç”¨ç¨‹å¼æœªé–‹å•Ÿ</li>
          <li>äº«å—é›¢ç·šæ’­æ”¾åŠŸèƒ½</li>
          <li>ç²å¾—åŸç”Ÿæ‡‰ç”¨ç¨‹å¼èˆ¬çš„é«”é©—</li>
        </ul>
      </div>
    </div>
    
    <div class="device-specific">
      <h3>ğŸ“± å®‰è£èªªæ˜</h3>
      
      <div class="device-tabs">
        <button class="device-tab active" data-device="android">Android</button>
        <button class="device-tab" data-device="ios">iOS</button>
        <button class="device-tab" data-device="desktop">æ¡Œé¢ç‰ˆ</button>
      </div>
      
      <div id="android" class="device-content active">
        <h4>Android æ‰‹æ©Ÿå®‰è£æ­¥é©Ÿï¼š</h4>
        <ol>
          <li>ä½¿ç”¨ Chrome ç€è¦½å™¨é–‹å•Ÿå†¥æƒ³éŸ³æ¨‚é é¢</li>
          <li>é»æ“Šç€è¦½å™¨é¸å–®ï¼ˆä¸‰å€‹é»ï¼‰</li>
          <li>é¸æ“‡ã€Œå®‰è£æ‡‰ç”¨ç¨‹å¼ã€æˆ–ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</li>
          <li>é»æ“Šã€Œå®‰è£ã€ç¢ºèª</li>
          <li>æ‡‰ç”¨ç¨‹å¼å°‡å‡ºç¾åœ¨ä¸»é é¢ä¸Š</li>
        </ol>
      </div>
      
      <div id="ios" class="device-content">
        <h4>iPhone/iPad å®‰è£æ­¥é©Ÿï¼š</h4>
        <ol>
          <li>ä½¿ç”¨ Safari ç€è¦½å™¨é–‹å•Ÿå†¥æƒ³éŸ³æ¨‚é é¢</li>
          <li>é»æ“Šåº•éƒ¨çš„ã€Œåˆ†äº«ã€æŒ‰éˆ•</li>
          <li>é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</li>
          <li>é»æ“Šã€ŒåŠ å…¥ã€ç¢ºèª</li>
          <li>æ‡‰ç”¨ç¨‹å¼å°‡å‡ºç¾åœ¨ä¸»é é¢ä¸Š</li>
        </ol>
      </div>
      
      <div id="desktop" class="device-content">
        <h4>æ¡Œé¢ç‰ˆå®‰è£æ­¥é©Ÿï¼š</h4>
        <ol>
          <li>ä½¿ç”¨æ”¯æ´ PWA çš„ç€è¦½å™¨ï¼ˆChromeã€Edgeã€Firefoxï¼‰</li>
          <li>åœ¨ç¶²å€åˆ—å³å´æœƒå‡ºç¾å®‰è£åœ–æ¨™</li>
          <li>é»æ“Šå®‰è£åœ–æ¨™</li>
          <li>é¸æ“‡ã€Œå®‰è£ã€ç¢ºèª</li>
          <li>æ‡‰ç”¨ç¨‹å¼å°‡å‡ºç¾åœ¨é–‹å§‹é¸å–®å’Œæ¡Œé¢</li>
        </ol>
      </div>
    </div>
    
    <div class="benefits">
      <h3>âœ¨ å®‰è£å¾Œçš„åŠŸèƒ½</h3>
      <ul class="benefit-list">
        <li>æ‰‹æ©Ÿä¸»é é¢ç›´æ¥é–‹å•Ÿ</li>
        <li>èƒŒæ™¯æ¨é€é€šçŸ¥æé†’</li>
        <li>é›¢ç·šéŸ³æ¨‚æ’­æ”¾</li>
        <li>å…¨è¢å¹•æ²‰æµ¸é«”é©—</li>
        <li>å¿«é€Ÿå­˜å–æ’­æ”¾æ¸…å–®</li>
        <li>è‡ªå‹•æ›´æ–°å’ŒåŒæ­¥</li>
      </ul>
    </div>
    
    <div class="actions">
      <a href="../meditation.html" class="back-btn">è¿”å›éŸ³æ¨‚æ’­æ”¾å™¨</a>
      <button class="install-btn" onclick="installApp()">ç«‹å³å®‰è£</button>
      <button class="install-btn cache-btn" onclick="clearCacheAndReload()">æ¸…é™¤å¿«å–</button>
    </div>
    
    <div class="debug-info" id="debugInfo">
      <h4>èª¿è©¦ä¿¡æ¯ï¼š</h4>
      <div id="debugContent"></div>
    </div>
  </div>
  
  <script>
    // å…¨åŸŸè®Šæ•¸
    let deferredPrompt = null;
    let isInstallable = false;
    
    // èª¿è©¦å‡½æ•¸
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const prefix = type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : type === 'success' ? 'âœ…' : 'ğŸ”';
      console.log(`${prefix} [${timestamp}] ${message}`);
      
      // æ›´æ–°èª¿è©¦ä¿¡æ¯é¡¯ç¤º
      const debugContent = document.getElementById('debugContent');
      if (debugContent) {
        debugContent.innerHTML += `<div>${prefix} [${timestamp}] ${message}</div>`;
        debugContent.scrollTop = debugContent.scrollHeight;
      }
    }
    
    // åˆ‡æ›èª¿è©¦ä¿¡æ¯é¡¯ç¤º
    function toggleDebugInfo() {
      const debugInfo = document.getElementById('debugInfo');
      debugInfo.classList.toggle('show');
    }
    
    // ç›£è½ beforeinstallprompt äº‹ä»¶
    window.addEventListener('beforeinstallprompt', (e) => {
      log('beforeinstallprompt äº‹ä»¶è§¸ç™¼ï¼');
      
      // é˜»æ­¢ç€è¦½å™¨é è¨­çš„å®‰è£æç¤º
      e.preventDefault();
      // å„²å­˜äº‹ä»¶ä»¥ä¾¿ç¨å¾Œä½¿ç”¨
      deferredPrompt = e;
      isInstallable = true;
      
      log('å®‰è£æç¤ºå·²æº–å‚™å°±ç·’', 'success');
      
      // æ›´æ–°å®‰è£æŒ‰éˆ•
      updateInstallButton('ç«‹å³å®‰è£', false, '#4caf50');
    });
    
    // ç›£è½ appinstalled äº‹ä»¶
    window.addEventListener('appinstalled', (evt) => {
      log('æ‡‰ç”¨ç¨‹å¼å·²å®‰è£ï¼', 'success');
      showNotification('ğŸ‰ æ‡‰ç”¨ç¨‹å¼å®‰è£æˆåŠŸï¼', 'success');
      
      updateInstallButton('å·²å®‰è£', true, '#4caf50');
      deferredPrompt = null;
      isInstallable = false;
    });
    
    // é¡¯ç¤ºé€šçŸ¥å‡½æ•¸
    function showNotification(message, type = 'info') {
      // ç°¡å–®çš„é€šçŸ¥å¯¦ç¾
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3'};
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        max-width: 300px;
        font-size: 14px;
        animation: slideIn 0.3s ease-out;
      `;
      
      // æ·»åŠ å‹•ç•«æ¨£å¼
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
      `;
      document.head.appendChild(style);
      
      notification.textContent = message;
      document.body.appendChild(notification);
      
      // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
      setTimeout(() => {
        notification.remove();
        style.remove();
      }, 3000);
    }
    
    // æª¢æŸ¥ PWA å®‰è£æ¢ä»¶
    async function checkPWAInstallability() {
      log('æª¢æŸ¥ PWA å®‰è£æ¢ä»¶...');
      
      // æª¢æ¸¬è¨­å‚™é¡å‹
      const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const isAndroid = /Android/i.test(navigator.userAgent);
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      
      log(`è¨­å‚™é¡å‹: ${isMobile ? 'æ‰‹æ©Ÿ' : 'æ¡Œé¢'}`);
      if (isMobile) {
        log(`æ‰‹æ©Ÿé¡å‹: ${isAndroid ? 'Android' : isIOS ? 'iOS' : 'å…¶ä»–'}`);
      }
      
      const checks = {
        serviceWorker: 'serviceWorker' in navigator,
        manifest: !!document.querySelector('link[rel="manifest"]'),
        https: location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1',
        manifestAccessible: false, // é è¨­ç‚º false
        userAgent: navigator.userAgent,
        isMobile: isMobile
      };
      
      log(`Service Worker æ”¯æ´: ${checks.serviceWorker}`);
      log(`Manifest å­˜åœ¨: ${checks.manifest}`);
      log(`HTTPS/Localhost: ${checks.https}`);
      
      // æª¢æŸ¥ manifest æ–‡ä»¶æ˜¯å¦å¯è¨ªå•
      if (checks.manifest) {
        try {
          const manifestLink = document.querySelector('link[rel="manifest"]');
          const response = await fetch(manifestLink.href);
          if (response.ok) {
            const manifest = await response.json();
            log('Manifest æ–‡ä»¶å¯è¨ªå•', 'success');
            checks.manifestAccessible = true;
            
            // æª¢æŸ¥ manifest çš„é—œéµå±¬æ€§
            const requiredFields = ['name', 'short_name', 'start_url', 'display', 'icons'];
            const missingFields = requiredFields.filter(field => !manifest[field]);
            
            if (missingFields.length > 0) {
              log(`Manifest ç¼ºå°‘å¿…è¦æ¬„ä½: ${missingFields.join(', ')}`, 'error');
            } else {
              log('Manifest æ ¼å¼æ­£ç¢º', 'success');
            }
            
            // æª¢æŸ¥åœ–æ¨™
            if (manifest.icons && manifest.icons.length > 0) {
              const hasRequiredSizes = manifest.icons.some(icon => 
                ['192x192', '512x512'].includes(icon.sizes)
              );
              if (hasRequiredSizes) {
                log('Manifest åŒ…å«å¿…è¦åœ–æ¨™å°ºå¯¸', 'success');
              } else {
                log('Manifest ç¼ºå°‘å¿…è¦åœ–æ¨™å°ºå¯¸ (192x192, 512x512)', 'error');
              }
            }
            
          } else {
            log(`Manifest æ–‡ä»¶ç„¡æ³•è¨ªå•: ${response.status}`, 'error');
            checks.manifestAccessible = false;
          }
        } catch (error) {
          log(`Manifest æ–‡ä»¶è¼‰å…¥å¤±æ•—: ${error.message}`, 'error');
          checks.manifestAccessible = false;
        }
      } else {
        log('Manifest é€£çµä¸å­˜åœ¨', 'error');
      }
      
      // æ‰‹æ©Ÿç‰¹æ®Šæª¢æŸ¥
      if (isMobile) {
        if (!checks.https && !location.hostname.includes('localhost')) {
          log('âš ï¸ æ‰‹æ©Ÿä¸Šéœ€è¦ HTTPS æ‰èƒ½å®‰è£ PWA', 'warning');
        }
        
        if (isAndroid) {
          log('Android è¨­å‚™å»ºè­°ä½¿ç”¨ Chrome ç€è¦½å™¨', 'info');
        } else if (isIOS) {
          log('iOS è¨­å‚™å¿…é ˆä½¿ç”¨ Safari ç€è¦½å™¨', 'info');
        }
      }
      
      // è©³ç´°è¨˜éŒ„æ¯å€‹æª¢æŸ¥çµæœ
      log(`æª¢æŸ¥çµæœè©³æƒ…:`, 'info');
      log(`- Service Worker: ${checks.serviceWorker}`, checks.serviceWorker ? 'success' : 'error');
      log(`- Manifest é€£çµ: ${checks.manifest}`, checks.manifest ? 'success' : 'error');
      log(`- Manifest å¯è¨ªå•: ${checks.manifestAccessible}`, checks.manifestAccessible ? 'success' : 'error');
      log(`- HTTPS/Localhost: ${checks.https}`, checks.https ? 'success' : 'error');
      
      const allChecksPass = Object.values(checks).every(check => 
        typeof check === 'boolean' ? check : true
      );
      log(`PWA å®‰è£æ¢ä»¶æª¢æŸ¥çµæœ: ${allChecksPass ? 'é€šé' : 'å¤±æ•—'}`, allChecksPass ? 'success' : 'error');
      
      return allChecksPass;
    }
    
    // æ›´æ–°å®‰è£æŒ‰éˆ•ç‹€æ…‹
    function updateInstallButton(text, disabled, backgroundColor) {
      const installBtn = document.querySelector('.install-btn:not(.cache-btn)');
      if (installBtn) {
        installBtn.textContent = text;
        installBtn.disabled = disabled;
        if (backgroundColor) {
          installBtn.style.background = backgroundColor;
        }
        log(`å®‰è£æŒ‰éˆ•ç‹€æ…‹æ›´æ–°: ${text}, ç¦ç”¨: ${disabled}`);
      }
    }
    
    // æ¸…é™¤å¿«å–å’Œé‡æ–°è¼‰å…¥
    async function clearCacheAndReload() {
      try {
        log('é–‹å§‹æ¸…é™¤å¿«å–...');
        
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'æ¸…é™¤ä¸­...';
        button.disabled = true;
        
        // æ¸…é™¤æ‰€æœ‰å¿«å–
        if ('caches' in window) {
          const cacheNames = await caches.keys();
          await Promise.all(
            cacheNames.map(cacheName => caches.delete(cacheName))
          );
          log('å¿«å–å·²æ¸…é™¤', 'success');
        }
        
        // å–æ¶ˆè¨»å†Šæ‰€æœ‰ Service Worker
        if ('serviceWorker' in navigator) {
          const registrations = await navigator.serviceWorker.getRegistrations();
          await Promise.all(
            registrations.map(registration => registration.unregister())
          );
          log('Service Worker å·²å–æ¶ˆè¨»å†Š', 'success');
        }
        
        showNotification('å¿«å–å·²æ¸…é™¤ï¼Œå³å°‡é‡æ–°è¼‰å…¥é é¢...', 'success');
        
        // å»¶é²é‡æ–°è¼‰å…¥ä»¥é¡¯ç¤ºé€šçŸ¥
        setTimeout(() => {
          window.location.reload(true);
        }, 1500);
        
      } catch (error) {
        log(`æ¸…é™¤å¿«å–å¤±æ•—: ${error.message}`, 'error');
        showNotification('æ¸…é™¤å¿«å–å¤±æ•—ï¼Œè«‹æ‰‹å‹•é‡æ–°æ•´ç†é é¢', 'error');
        
        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
        const button = event.target;
        button.textContent = 'æ¸…é™¤å¿«å–';
        button.disabled = false;
      }
    }
    
    // è£ç½®æ¨™ç±¤åˆ‡æ›
    function showDevice(device) {
      // éš±è—æ‰€æœ‰å…§å®¹
      document.querySelectorAll('.device-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // ç§»é™¤æ‰€æœ‰æ¨™ç±¤çš„æ´»å‹•ç‹€æ…‹
      document.querySelectorAll('.device-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // é¡¯ç¤ºé¸ä¸­çš„å…§å®¹
      const targetContent = document.getElementById(device);
      if (targetContent) {
        targetContent.classList.add('active');
      }
      
      // è¨­ç½®é¸ä¸­æ¨™ç±¤çš„æ´»å‹•ç‹€æ…‹
      const clickedTab = document.querySelector(`[data-device="${device}"]`);
      if (clickedTab) {
        clickedTab.classList.add('active');
      }
      
      log(`åˆ‡æ›åˆ° ${device} è£ç½®èªªæ˜`);
    }
    
    // é¡¯ç¤ºæ‰‹å‹•å®‰è£æŒ‡å°
    function showManualInstallGuide() {
      const isAndroid = /Android/i.test(navigator.userAgent);
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isChrome = /Chrome/i.test(navigator.userAgent);
      const isSafari = /Safari/i.test(navigator.userAgent) && !/Chrome/i.test(navigator.userAgent);
      const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      let message = '';
      
      if (isAndroid && isChrome) {
        message = `ğŸ“± Android Chrome å®‰è£æ­¥é©Ÿï¼š
 
 1ï¸âƒ£ é»æ“Šç€è¦½å™¨å³ä¸Šè§’çš„ã€Œâ‹®ã€é¸å–®
 2ï¸âƒ£ å°‹æ‰¾ã€Œå®‰è£æ‡‰ç”¨ç¨‹å¼ã€æˆ–ã€ŒåŠ å…¥ä¸»ç•«é¢ã€
 3ï¸âƒ£ é»æ“Šè©²é¸é …ä¸¦ç¢ºèªå®‰è£
 4ï¸âƒ£ æ‡‰ç”¨ç¨‹å¼å°‡å‡ºç¾åœ¨ä¸»é é¢
 
 ğŸ’¡ å¦‚æœçœ‹ä¸åˆ°å®‰è£é¸é …ï¼š
 â€¢ ç¢ºä¿ä½¿ç”¨æœ€æ–°ç‰ˆ Chrome
 â€¢ é‡æ–°æ•´ç†é é¢å¾Œå†è©¦
 â€¢ æª¢æŸ¥æ˜¯å¦å·²å®‰è£éæ­¤æ‡‰ç”¨`;
      } else if (isAndroid && !isChrome) {
        message = `ğŸ“± Android å…¶ä»–ç€è¦½å™¨å®‰è£æ­¥é©Ÿï¼š
 
 1ï¸âƒ£ é»æ“Šç€è¦½å™¨é¸å–®ï¼ˆä¸‰å€‹é»æˆ–ä¸‰æ¢ç·šï¼‰
 2ï¸âƒ£ å°‹æ‰¾ã€ŒåŠ å…¥ä¸»ç•«é¢ã€æˆ–ã€Œå®‰è£æ‡‰ç”¨ç¨‹å¼ã€
 3ï¸âƒ£ é»æ“Šè©²é¸é …ä¸¦ç¢ºèªå®‰è£
 
 ğŸ’¡ å»ºè­°ä½¿ç”¨ Chrome ç€è¦½å™¨ä»¥ç²å¾—æœ€ä½³é«”é©—`;
      } else if (isIOS && isSafari) {
        message = `ğŸ“± iPhone/iPad Safari å®‰è£æ­¥é©Ÿï¼š
 
 1ï¸âƒ£ é»æ“Šåº•éƒ¨çš„ã€Œåˆ†äº«ã€æŒ‰éˆ• ğŸ“¤
 2ï¸âƒ£ å‘ä¸‹æ»‘å‹•æ‰¾åˆ°ã€ŒåŠ å…¥ä¸»ç•«é¢ã€
 3ï¸âƒ£ é»æ“Šã€ŒåŠ å…¥ä¸»ç•«é¢ã€
 4ï¸âƒ£ é»æ“Šå³ä¸Šè§’ã€ŒåŠ å…¥ã€ç¢ºèª
 
 ğŸ’¡ æ³¨æ„ï¼šå¿…é ˆä½¿ç”¨ Safari ç€è¦½å™¨`;
      } else if (isIOS && !isSafari) {
        message = `ğŸ“± iPhone/iPad å…¶ä»–ç€è¦½å™¨ï¼š
 
 âš ï¸ iOS è¨­å‚™åªèƒ½ä½¿ç”¨ Safari ç€è¦½å™¨å®‰è£ PWA
 
 è«‹åˆ‡æ›åˆ° Safari ç€è¦½å™¨ï¼Œç„¶å¾Œï¼š
 1ï¸âƒ£ é»æ“Šåº•éƒ¨çš„ã€Œåˆ†äº«ã€æŒ‰éˆ•
 2ï¸âƒ£ é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€`;
      } else if (!isMobile) {
        message = `ğŸ’» æ¡Œé¢ç‰ˆå®‰è£æ­¥é©Ÿï¼š
 
 1ï¸âƒ£ æŸ¥çœ‹ç¶²å€åˆ—å³å´çš„å®‰è£åœ–æ¨™
 2ï¸âƒ£ é»æ“Šå®‰è£åœ–æ¨™
 3ï¸âƒ£ åœ¨å½ˆå‡ºè¦–çª—ä¸­é»æ“Šã€Œå®‰è£ã€
 4ï¸âƒ£ æ‡‰ç”¨ç¨‹å¼å°‡å‡ºç¾åœ¨ç³»çµ±ä¸­
 
 ğŸ’¡ æ”¯æ´çš„ç€è¦½å™¨ï¼šChromeã€Edgeã€Firefox`;
      } else {
        message = `ğŸ“± æ‰‹å‹•å®‰è£æ­¥é©Ÿï¼š
 
 è«‹æ ¹æ“šæ‚¨çš„è£ç½®é¸æ“‡ç›¸æ‡‰çš„å®‰è£æ–¹æ³•ï¼š
 
 Android: ä½¿ç”¨ Chrome ç€è¦½å™¨ï¼Œé»é¸é¸å–®ä¸­çš„ã€Œå®‰è£æ‡‰ç”¨ç¨‹å¼ã€
 iPhone: ä½¿ç”¨ Safari ç€è¦½å™¨ï¼Œé»é¸åˆ†äº«æŒ‰éˆ•ä¸­çš„ã€ŒåŠ å…¥ä¸»ç•«é¢ã€
 æ¡Œé¢ç‰ˆ: é»æ“Šç¶²å€åˆ—æ—çš„å®‰è£åœ–æ¨™
 
 å¦‚ä»æœ‰å•é¡Œï¼Œè«‹å˜—è©¦é‡æ–°æ•´ç†é é¢æˆ–æ¸…é™¤å¿«å–`;
      }
      
      // æ·»åŠ æ‰‹æ©Ÿç‰¹å®šçš„é¡å¤–æç¤º
      if (isMobile) {
        message += `\n\nğŸ”§ æ‰‹æ©Ÿå®‰è£å¸¸è¦‹å•é¡Œï¼š
 â€¢ ç¢ºä¿ç¶²è·¯é€£ç·šç©©å®š
 â€¢ æ¸…é™¤ç€è¦½å™¨å¿«å–å¾Œé‡è©¦
 â€¢ æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦ç‚ºæœ€æ–°ç‰ˆæœ¬
 â€¢ æŸäº›ç€è¦½å™¨å¯èƒ½ä¸æ”¯æ´ PWA å®‰è£`;
      }
      
      showNotification(message, 'info');
    }
    
    // ä¸»è¦å®‰è£å‡½æ•¸
    async function installApp() {
      log('å®‰è£æŒ‰éˆ•è¢«é»æ“Š');
      
      try {
        // æª¢æŸ¥æ˜¯å¦å·²ç¶“å®‰è£
        if (window.matchMedia('(display-mode: standalone)').matches) {
          showNotification('âœ… æ‡‰ç”¨ç¨‹å¼å·²ç¶“å®‰è£ï¼', 'success');
          updateInstallButton('å·²å®‰è£', true, '#4caf50');
          return;
        }
        
        // å¦‚æœæœ‰ deferredPromptï¼Œä½¿ç”¨å®ƒ
        if (deferredPrompt && isInstallable) {
          log('ä½¿ç”¨ beforeinstallprompt è§¸ç™¼å®‰è£');
          
          // é¡¯ç¤ºå®‰è£æç¤º
          deferredPrompt.prompt();
          
          // ç­‰å¾…ç”¨æˆ¶é¸æ“‡
          const { outcome } = await deferredPrompt.userChoice;
          log(`ç”¨æˆ¶é¸æ“‡: ${outcome}`);
          
          if (outcome === 'accepted') {
            log('ç”¨æˆ¶æ¥å—å®‰è£', 'success');
            showNotification('ğŸ‰ å®‰è£æˆåŠŸï¼', 'success');
            updateInstallButton('å·²å®‰è£', true, '#4caf50');
          } else {
            log('ç”¨æˆ¶æ‹’çµ•å®‰è£', 'warning');
            showNotification('å®‰è£è¢«å–æ¶ˆ', 'warning');
          }
          
          // æ¸…é™¤ deferredPrompt
          deferredPrompt = null;
          isInstallable = false;
          return;
        }
        
        // å¦‚æœæ²’æœ‰ deferredPromptï¼Œå˜—è©¦æ‰‹æ©Ÿç‰¹å®šçš„æ–¹æ³•
        log('æ²’æœ‰è‡ªå‹•å®‰è£æç¤ºå¯ç”¨ï¼Œå˜—è©¦æ‰‹æ©Ÿç‰¹å®šæ–¹æ³•', 'warning');
        
        const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile) {
          // æ‰‹æ©Ÿä¸Šå˜—è©¦å¼·åˆ¶è§¸ç™¼å®‰è£æç¤º
          log('å˜—è©¦æ‰‹æ©Ÿç‰¹å®šçš„å®‰è£æ–¹æ³•...');
          
          // å˜—è©¦è¨ªå•ä¸»é é¢ä¾†è§¸ç™¼ beforeinstallprompt
          try {
            const response = await fetch('/meditation.html');
            if (response.ok) {
              log('ä¸»é é¢å¯è¨ªå•ï¼Œå˜—è©¦è§¸ç™¼å®‰è£æç¤º', 'success');
              
              // ç­‰å¾…ä¸€ä¸‹çœ‹æ˜¯å¦è§¸ç™¼äº† beforeinstallprompt
              await new Promise(resolve => setTimeout(resolve, 2000));
              
              if (deferredPrompt && isInstallable) {
                log('æˆåŠŸè§¸ç™¼ beforeinstallpromptï¼', 'success');
                updateInstallButton('ç«‹å³å®‰è£', false, '#4caf50');
                
                // ç«‹å³è§¸ç™¼å®‰è£æç¤º
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                  log('ç”¨æˆ¶æ¥å—å®‰è£', 'success');
                  showNotification('ğŸ‰ å®‰è£æˆåŠŸï¼', 'success');
                  updateInstallButton('å·²å®‰è£', true, '#4caf50');
                } else {
                  log('ç”¨æˆ¶æ‹’çµ•å®‰è£', 'warning');
                  showNotification('å®‰è£è¢«å–æ¶ˆ', 'warning');
                }
                
                deferredPrompt = null;
                isInstallable = false;
                return;
              }
            }
          } catch (error) {
            log(`ä¸»é é¢è¨ªå•å¤±æ•—: ${error.message}`, 'error');
          }
          
          // å¦‚æœé‚„æ˜¯æ²’æœ‰è§¸ç™¼ï¼Œå˜—è©¦åœ¨æ–°è¦–çª—ä¸­æ‰“é–‹
          log('å˜—è©¦åœ¨æ–°è¦–çª—ä¸­æ‰“é–‹ä¸»é é¢...');
          const newWindow = window.open('/meditation.html', '_blank');
          
          if (newWindow) {
            showNotification('ğŸ“± å·²åœ¨æ–°è¦–çª—ä¸­æ‰“é–‹ä¸»é é¢ï¼Œè«‹åœ¨æ–°è¦–çª—ä¸­æŸ¥çœ‹å®‰è£æç¤ºï¼', 'info');
          } else {
            log('ç„¡æ³•æ‰“é–‹æ–°è¦–çª—ï¼Œé¡¯ç¤ºæ‰‹å‹•å®‰è£æŒ‡å°', 'warning');
            showManualInstallGuide();
          }
        } else {
          // æ¡Œé¢ç‰ˆé¡¯ç¤ºæ‰‹å‹•å®‰è£æŒ‡å°
          showManualInstallGuide();
        }
        
      } catch (error) {
        log(`å®‰è£éç¨‹ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
        showNotification('âŒ å®‰è£éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æŒ‰ç…§é é¢èªªæ˜æ‰‹å‹•å®‰è£', 'error');
        showManualInstallGuide();
      }
    }
    
    // è¨»å†Š Service Worker
    async function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        try {
          log('é–‹å§‹è¨»å†Š Service Worker...');
          const registration = await navigator.serviceWorker.register('../service-worker.js', {
            scope: '/'
          });
          
          log('Service Worker è¨»å†ŠæˆåŠŸ', 'success');
          
          // ç­‰å¾… Service Worker å•Ÿå‹•
          if (registration.installing) {
            log('Service Worker å®‰è£ä¸­...');
            await new Promise(resolve => {
              registration.installing.addEventListener('statechange', (e) => {
                if (e.target.state === 'activated') {
                  log('Service Worker å·²å•Ÿå‹•', 'success');
                  resolve();
                }
              });
            });
          }
          
          return registration;
        } catch (error) {
          log(`Service Worker è¨»å†Šå¤±æ•—: ${error.message}`, 'error');
          return null;
        }
      } else {
        log('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Service Worker', 'warning');
        return null;
      }
    }
    
    // é é¢è¼‰å…¥æ™‚çš„åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async () => {
      log('é é¢å·²è¼‰å…¥ï¼Œé–‹å§‹åˆå§‹åŒ–...');
      
      // è¨­ç½®è£ç½®æ¨™ç±¤é»æ“Šäº‹ä»¶
      document.querySelectorAll('.device-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          const device = e.target.getAttribute('data-device');
          showDevice(device);
        });
      });
      
      // æ·»åŠ èª¿è©¦ä¿¡æ¯åˆ‡æ›ï¼ˆé›™æ“Šæ¨™é¡Œï¼‰
      document.querySelector('h1').addEventListener('dblclick', toggleDebugInfo);
      
      // æª¢æŸ¥æ˜¯å¦å·²å®‰è£
      if (window.matchMedia('(display-mode: standalone)').matches) {
        log('æª¢æ¸¬åˆ°æ‡‰ç”¨ç¨‹å¼å·²å®‰è£', 'success');
        updateInstallButton('å·²å®‰è£', true, '#4caf50');
        return;
      }
      
       // æª¢æŸ¥ PWA å®‰è£æ¢ä»¶
       let canInstall = await checkPWAInstallability();
       
       if (!canInstall) {
         log('PWA å®‰è£æ¢ä»¶ä¸æ»¿è¶³ï¼Œå˜—è©¦è‡ªå‹•ä¿®å¾©...', 'warning');
         
         // å˜—è©¦ä¿®å¾© manifest å•é¡Œ
         const manifestLink = document.querySelector('link[rel="manifest"]');
         if (!manifestLink) {
           log('å‹•æ…‹æ·»åŠ  manifest é€£çµ...');
           const link = document.createElement('link');
           link.rel = 'manifest';
           link.href = '../manifest.json';
           document.head.appendChild(link);
           
           // ç­‰å¾…ä¸€ä¸‹å†æª¢æŸ¥
           await new Promise(resolve => setTimeout(resolve, 1000));
           canInstall = await checkPWAInstallability();
         }
       }
       
       if (canInstall) {
         log('PWA å®‰è£æ¢ä»¶å·²æ»¿è¶³', 'success');
         
         // è¨»å†Š Service Worker
         await registerServiceWorker();
         
         // å¦‚æœé‚„æ²’æœ‰è§¸ç™¼ beforeinstallpromptï¼Œç­‰å¾…ä¸€ä¸‹
         if (!isInstallable) {
           log('ç­‰å¾… beforeinstallprompt äº‹ä»¶...');
           updateInstallButton('æº–å‚™ä¸­...', true, '#ff9800');
           
           // ç­‰å¾…æœ€å¤š 5 ç§’
           setTimeout(() => {
             if (!isInstallable) {
               log('beforeinstallprompt äº‹ä»¶æœªè§¸ç™¼ï¼Œå•Ÿç”¨æ‰‹å‹•å®‰è£', 'warning');
               updateInstallButton('ç«‹å³å®‰è£', false, '#ff9800');
             }
           }, 5000);
         }
       } else {
         log('PWA å®‰è£æ¢ä»¶ä»ç„¶ä¸æ»¿è¶³', 'error');
         updateInstallButton('ç«‹å³å®‰è£', false, '#f44336');
       }
      
      log('åˆå§‹åŒ–å®Œæˆ');
    });
    
  </script>
</body>
</html>