<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>安裝 Obyssey App</title>
    <link rel="manifest" href="/manifest.json">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Obyssey">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #131314;
            --bg-secondary: #1e1f20;
            --bg-tertiary: #2a2b2c;
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --border-color: #3c4043;
            --accent-blue: #8ab4f8;
        }
        body {
            font-family: 'Noto Sans TC', 'Google Sans', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .container {
            max-width: 480px;
            width: 100%;
            margin: 40px 20px;
            background: var(--bg-secondary);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            padding: 40px 28px;
            box-sizing: border-box;
        }
        h1 {
            font-size: 2rem;
            color: var(--accent-blue);
            text-align: center;
            margin-bottom: 22px;
            font-weight: 700;
            letter-spacing: 1px;
        }
        .guide {
            margin-top: 22px;
        }
        .guide h2 {
            font-size: 1.15rem;
            color: var(--accent-blue);
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 4px;
            font-weight: 500;
        }
        .guide ul {
            padding-left: 20px;
            margin: 0 0 18px 0;
        }
        .guide li {
            margin-bottom: 10px;
            font-size: 1.05rem;
            color: var(--text-primary);
            line-height: 1.6;
        }
        .note {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-top: 16px;
            text-align: center;
        }
        .install-app-btn {
            margin-top: 28px;
            padding: 14px 28px;
            border-radius: 10px;
            background: var(--accent-blue);
            color: var(--bg-primary);
            border: none;
            font-size: 1.15rem;
            font-weight: bold;
            cursor: pointer;
            display: none; /* 由 JS 控制顯示 */
            width: 100%;
            box-sizing: border-box;
            box-shadow: 0 2px 8px #0002;
            transition: background-color 0.3s, opacity 0.3s;
        }
        .install-app-btn:disabled {
            background-color: var(--border-color);
            color: var(--text-secondary);
            cursor: not-allowed;
        }
        .centered {
            text-align: center;
        }
        .share-icon {
            display: inline-block;
            vertical-align: middle;
            width: 20px;
            height: 20px;
            margin: 0 4px;
        }
        #ios-guide, #android-guide {
            display: none; /* 由 JS 控制顯示 */
        }
        @media (max-width: 600px) {
            .container {
                margin: 20px;
                padding: 20px;
            }
            h1 { font-size: 1.6rem; }
            .guide h2 { font-size: 1rem; }
            .guide li { font-size: 0.95rem; }
            .install-app-btn {
                padding: 12px 24px;
                font-size: 1rem;
            }
        }

        /* utilities */
        .section-spacer { margin-top: 20px; }
        .danger-btn {
            background: #e53935;
            color: #fff;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>安裝 Obyssey App</h1>
        <div class="centered">
            <button id="installAppBtn" class="install-app-btn">安裝 App 到手機</button>
        </div>
        
        <div class="guide">
            <h2>安裝前提醒</h2>
            <ul>
                <li>請「使用手機預設瀏覽器」(iOS 請用 Safari，Android 請用 Chrome) 開啟本頁面。</li>
                <li>若您在 LINE 或 Facebook 等 App 中開啟，請先複製網址並貼到預設瀏覽器中。</li>
            </ul>

            <div id="ios-guide">
                <h2>iOS / iPad 安裝教學</h2>
                <ul>
                    <li>1. 請點選 Safari 瀏覽器下方的「分享」按鈕 <svg class="share-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" fill="#8ab4f8"><path d="M25,3A22,22,0,1,0,47,25,22,22,0,0,0,25,3Zm0,41A19,19,0,1,1,44,25,19,19,0,0,1,25,44Z"/><path d="M26.21,30.13a1.5,1.5,0,0,0,2.12,0l8.49-8.49a1.5,1.5,0,0,0-2.12-2.12L28,26.29V11.5a1.5,1.5,0,0,0-3,0V26.29l-6.72-6.77a1.5,1.5,0,0,0-2.12,2.12Z"/></svg></li>
                    <li>2. 在彈出的選單中，向下滑動並選擇「加入主畫面」(Add to Home Screen)</li>
                    <li>3. 點擊右上角的「新增」，即可在桌面上看到 App 圖示</li>
                </ul>
            </div>
            <div id="android-guide">
                <h2>Android 安裝教學</h2>
                <ul>
                    <li>1. 點擊上方的「安裝 App 到手機」按鈕</li>
                    <li>2. 若按鈕無效或未出現，請點選瀏覽器右上角的「選單 ⋮」</li>
                    <li>3. 選擇「<b>安裝應用程式</b>」(Install app)</li>
                    <li>4. 按照提示完成安裝，桌面將會出現 App 圖示</li>
                </ul>
            </div>
        </div>
        <div class="note">若安裝遇到問題，請確保您的瀏覽器為最新版本。</div>
        <div class="centered section-spacer">
            <button id="clearCacheBtn" class="danger-btn">清除快取 (解決安裝異常)</button>
        </div>
        
    </div>

    <script>
        // DOM 元素
        const installBtn = document.getElementById('installAppBtn');
        const iosGuide = document.getElementById('ios-guide');
        const androidGuide = document.getElementById('android-guide');
        const clearCacheBtn = document.getElementById('clearCacheBtn');
        let deferredPrompt = null;

        // --- 1. Service Worker 註冊 ---
        if ('serviceWorker' in navigator) {
            // 註冊根目錄的 service worker，確保 scope 包含 start_url (/meditation.html)
            navigator.serviceWorker.register('/service-worker.js')
            .then(registration => {
                console.log('Service Worker 註冊成功:', registration);
            })
            .catch(error => {
                console.error('Service Worker 註冊失敗:', error);
            });
        }

        // --- 2. 設備與環境檢測 ---
        const isIOS = () => {
            const userAgent = navigator.userAgent;
            // 檢測 iPhone, iPad, iPod
            const isAppleDevice = /iPhone|iPad|iPod/.test(userAgent);
            // 檢測 iPad on iOS 13+
            const isMacAndHasTouch = navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1;
            return isAppleDevice || isMacAndHasTouch;
        };

        const isInStandaloneMode = () => 
            (window.matchMedia('(display-mode: standalone)').matches) || (window.navigator.standalone);

        // --- 3. PWA 安裝邏輯 ---

        // 監聽 PWA 安裝事件 (僅限支援的瀏覽器，如 Chrome)
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // 只有在可以安裝時，才顯示按鈕
            if (installBtn) {
                installBtn.style.display = 'block';
            }
        });

        // 安裝按鈕點擊事件
        installBtn.addEventListener('click', async () => {
            if (isIOS()) {
                // iOS 用戶點擊按鈕時，平滑滾動到教學區塊
                alert('iOS 用戶請依照下方的教學手動安裝。');
                iosGuide.scrollIntoView({ behavior: 'smooth' });
            } else if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    installBtn.textContent = '安裝成功！';
                    installBtn.disabled = true;
                }
                deferredPrompt = null;
            } else {
                alert('應用程式可能已經安裝，或您的瀏覽器不支援自動安裝。請參考下方的 Android 教學手動操作。');
                androidGuide.scrollIntoView({ behavior: 'smooth' });
            }
        });

        // --- 4. 頁面初始化邏輯 ---

        // 頁面載入時檢查並顯示正確的內容
        window.addEventListener('DOMContentLoaded', () => {
            if (isInStandaloneMode()) {
                installBtn.textContent = '已透過主畫面開啟';
                installBtn.disabled = true;
                installBtn.style.display = 'block';
            } else if (isIOS()) {
                installBtn.textContent = '查看 iOS 手動安裝教學';
                installBtn.style.display = 'block';
                iosGuide.style.display = 'block';
                androidGuide.style.display = 'none';
            } else {
                androidGuide.style.display = 'block';
                // 對於 Android，按鈕的顯示由 beforeinstallprompt 事件控制
                // 如果瀏覽器不支援或已安裝，按鈕將保持隱藏
            }
        });

        // --- 5. 清除快取功能 ---
        clearCacheBtn.addEventListener('click', async () => {
            try {
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                }
                if ('serviceWorker' in navigator) {
                    const regs = await navigator.serviceWorker.getRegistrations();
                    await Promise.all(regs.map(reg => reg.unregister()));
                }
                alert('快取與 Service Worker 已清除，請手動重新整理頁面！');
                // 可選擇自動重整： location.reload();
            } catch(e) {
                console.error('清除失敗:', e);
                alert('清除快取失敗，請手動清除瀏覽器資料。');
            }
        });

        
    </script>
</body>
</html>