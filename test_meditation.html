<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>冥想4測試頁面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a2e;
            color: white;
            padding: 20px;
        }
        .test-container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(30, 30, 45, 0.95);
            padding: 20px;
            border-radius: 10px;
        }
        .music-item {
            background: rgba(45, 45, 60, 0.8);
            margin-bottom: 20px;
            border-radius: 12px;
            padding: 20px;
        }
        .music-title {
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        audio {
            width: 100%;
            margin-bottom: 15px;
        }
        .creed-container {
            margin-top: 15px;
        }
        .creed-toggle {
            background: #0f3460;
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .creed-content {
            background: rgba(45, 45, 60, 0.7);
            border-radius: 8px;
            padding: 15px;
            color: #f5f5f5;
            white-space: pre-line;
        }
        .hide {
            display: none;
        }
        .creed-pair {
            margin-bottom: 10px;
            opacity: 0;
            transition: opacity 0.8s ease-in-out;
        }
        .debug-info {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🧘‍♂️ 冥想4 戰士信條測試</h1>
        
        <div class="music-item">
            <div class="music-title">溯源冥想4 Warrior's Creed</div>
            <audio controls preload="none" id="warrior-audio">
                <source src="meditationMusic/meditation4_warriorscreed.mp3" type="audio/mpeg">
                您的瀏覽器不支援音頻播放。
            </audio>
            <div class="creed-container">
                <button class="creed-toggle" id="creed-toggle" aria-expanded="false">
                    ▶ 戰士的信條
                </button>
                <div class="creed-content hide" id="creed-content"></div>
            </div>
        </div>
        
        <div class="debug-info" id="debug-info">
            調試信息將顯示在這裡...
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const toggle = document.getElementById('creed-toggle');
            const content = document.getElementById('creed-content');
            const warriorAudio = document.getElementById('warrior-audio');
            const debugInfo = document.getElementById('debug-info');
            
            let loaded = false;
            
            function log(message) {
                const timestamp = new Date().toLocaleTimeString();
                debugInfo.innerHTML += `[${timestamp}] ${message}<br>`;
                console.log(message);
            }
            
            log('頁面載入完成');
            log(`找到音頻元素: ${warriorAudio ? '是' : '否'}`);
            log(`找到切換按鈕: ${toggle ? '是' : '否'}`);
            log(`找到內容區域: ${content ? '是' : '否'}`);
            
            function showCreedAnimated(pairs) {
                content.innerHTML = '';
                let idx = 0;
                
                function showNext() {
                    if (idx >= pairs.length) return;
                    var group = document.createElement('div');
                    group.className = 'creed-pair';
                    group.style.opacity = 0;
                    group.innerHTML = `<div>${pairs[idx][0]}</div><div>${pairs[idx][1]}</div>`;
                    content.appendChild(group);
                    setTimeout(() => {
                        group.style.transition = 'opacity 0.4s ease-in-out';
                        group.style.opacity = 1;
                        idx++;
                        setTimeout(showNext, 180);
                    }, 10);
                }
                showNext();
            }
            
            function autoExpandCreed() {
                log('自動展開信條被調用');
                var expanded = toggle.getAttribute('aria-expanded') === 'true';
                if (!expanded) {
                    toggle.setAttribute('aria-expanded', 'true');
                    content.classList.remove('hide');
                    toggle.innerHTML = '▼ 戰士的信條';
                    
                    if (!loaded) {
                        var base = "./warrior'sCreed/warror'sCreed.txt";
                        log(`正在載入戰士信條文件: ${base}`);
                        
                        fetch(base)
                            .then(function(response) { 
                                log('戰士信條文件載入成功');
                                return response.text(); 
                            })
                            .then(function(text) {
                                log(`戰士信條文本內容載入完成，長度: ${text.length}`);
                                var lines = text.split(/\r?\n/).filter(Boolean);
                                var pairs = [];
                                for (var i = 0; i < lines.length - 1; i += 2) {
                                    pairs.push([lines[i], lines[i + 1]]);
                                }
                                log(`解析出 ${pairs.length} 對信條內容`);
                                showCreedAnimated(pairs);
                                content.setAttribute('data-lines', lines.join(','));
                                loaded = true;
                            })
                            .catch(function(error) {
                                log(`載入戰士信條文件失敗: ${error}`);
                                content.textContent = '無法載入信條內容。';
                            });
                    } else {
                        var lines = content.getAttribute('data-lines').split(',').filter(Boolean);
                        var pairs = [];
                        for (var i = 0; i < lines.length - 1; i += 2) {
                            pairs.push([lines[i], lines[i + 1]]);
                        }
                        showCreedAnimated(pairs);
                    }
                }
            }
            
            // 手動點擊切換
            toggle.addEventListener('click', function() {
                log('手動點擊切換按鈕');
                var expanded = toggle.getAttribute('aria-expanded') === 'true';
                toggle.setAttribute('aria-expanded', !expanded);
                
                if (expanded) {
                    content.classList.add('hide');
                    toggle.innerHTML = '▶ 戰士的信條';
                } else {
                    content.classList.remove('hide');
                    toggle.innerHTML = '▼ 戰士的信條';
                    
                    if (!loaded) {
                        var base = "./warrior'sCreed/warror'sCreed.txt";
                        log(`手動點擊載入戰士信條文件: ${base}`);
                        
                        fetch(base)
                            .then(function(response) { 
                                log('手動載入戰士信條文件成功');
                                return response.text(); 
                            })
                            .then(function(text) {
                                log(`手動載入戰士信條文本完成，長度: ${text.length}`);
                                var lines = text.split(/\r?\n/).filter(Boolean);
                                var pairs = [];
                                for (var i = 0; i < lines.length - 1; i += 2) {
                                    pairs.push([lines[i], lines[i + 1]]);
                                }
                                log(`手動解析出 ${pairs.length} 對信條內容`);
                                showCreedAnimated(pairs);
                                content.setAttribute('data-lines', lines.join(','));
                                loaded = true;
                            })
                            .catch(function(error) {
                                log(`手動載入戰士信條文件失敗: ${error}`);
                                content.textContent = '無法載入信條內容。';
                            });
                    } else {
                        var lines = content.getAttribute('data-lines').split(',').filter(Boolean);
                        var pairs = [];
                        for (var i = 0; i < lines.length - 1; i += 2) {
                            pairs.push([lines[i], lines[i + 1]]);
                        }
                        showCreedAnimated(pairs);
                    }
                }
            });
            
            // 音頻播放事件
            if (warriorAudio) {
                log('綁定音頻播放事件');
                warriorAudio.addEventListener('play', function() {
                    log('戰士音頻開始播放，準備自動展開信條');
                    setTimeout(autoExpandCreed, 200);
                });
                
                warriorAudio.addEventListener('pause', function() {
                    log('戰士音頻暫停');
                });
                
                warriorAudio.addEventListener('ended', function() {
                    log('戰士音頻播放結束');
                });
            } else {
                log('錯誤：未找到戰士音頻元素');
            }
        });
    </script>
</body>
</html>
